<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Auditor√≠a DACP - Contrataci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <style>
        /* Estilos base y fuentes */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* Color de fondo suave */
            margin: 0;
            padding: 0;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        /* Estilo para √°reas de texto dentro de la tabla */
        .table-textarea {
            width: 100%;
            min-height: 40px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 0.875rem; /* sm */
        }
        /* Clase para pesta√±as activas */
        .tab-active {
            border-bottom-width: 3px;
            border-bottom-color: rgb(37 99 235); /* blue-600 */
            color: rgb(37 99 235); /* blue-600 */
        }
    </style>
</head>
<body>
    <div id="root">
        </div>

    <script>
        // =================================================================
        // 0. CONFIGURACI√ìN EN LA NUBE (Apps Script URL)
        // =================================================================

        // ‚ö†Ô∏è ¬°IMPORTANTE! REEMPLAZA ESTA URL con la URL de tu Web App de Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbyw-61FNV9SfJQpwew18SxSiOYnLsANhSRZ9_E3g-DJ3THJUjDsZ7raTp22ozMy4MYA/exec'; // ‚¨ÖÔ∏è ¬°REEMPLAZA ESTO!
        const INITIAL_CONTRACT_ID = 'NUEVO_CONTRATO_001';


        // =================================================================
        // 1. DATA DEL DEPARTAMENTO ADMINISTRATIVO DE CONTRATACI√ìN P√öBLICA (DACP)
        // =================================================================

        // 1.1. Actividades (Matriz Principal) - (Sin cambios, se mantiene la lista de 16)
        const DEFAULT_DACP_ACTIVITIES = [
            { id: 1, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'ESTRUCTURACI√ìN DEL PROCESO DE CONTRATACI√ìN', informe: 'PENDIENTE DEFINIR', frecuencia: 'TRIMESTRAL', reportaA: 'PENDIENTE DEFINIR', importancia: 95, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 2, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'VALIDACION APLICATIVO CONTRATISTA', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 85, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 3, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'VALIDACION HOJA DE VIDA DE SIGEP', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 80, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 4, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'VALIDACION DE DOCUMENTOS CONTRACTUALES', informe: 'PENDIENTE DEFINIR', frecuencia: '3 DIAS A LA EJECUCI√ìN DEL CONTRATO', reportaA: 'PENDIENTE DEFINIR', importancia: 90, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 5, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'AFILIACI√ìN ARL', informe: 'PENDIENTE DEFINIR', frecuencia: '5 primeros dias de cada mes (mes vencido)', reportaA: 'PENDIENTE DEFINIR', importancia: 75, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 6, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'REQUERIR Y APOYAR EN LA ELABORACION DEL PLAN DE TRABAJO', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 85, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 7, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'REVISION DE INFORMES DE GESTI√ìN', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 85, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 8, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'SEGUIMIENTO A ACTIVIDADES DESIGNADAS', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 80, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 9, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'Actividades contractuales vs actividades presentadas', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 90, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 10, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'Informes mensual contratos de prestacion de servicios', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 85, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 11, tipo: 'Interna', proceso: 'DELEGACIONES', funcion: 'PENDIENTE DEFINIR', actividad: 'Gesti√≥n de solicitudes de delegaci√≥n especial de facultades contractuales', informe: 'PENDIENTE DEFINIR', frecuencia: 'Seg√∫n necesidad', reportaA: 'PENDIENTE DEFINIR', importancia: 95, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 12, tipo: 'Externa', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'Publicaciones informes de supervision en el SECOP II', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 90, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 13, tipo: 'Externa', proceso: 'DELEGACIONES', funcion: 'PENDIENTE DEFINIR', actividad: 'Remisi√≥n de solicitud formal con documentos precontractuales', informe: 'PENDIENTE DEFINIR', frecuencia: 'Seg√∫n necesidad', reportaA: 'PENDIENTE DEFINIR', importancia: 90, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 14, tipo: 'Externa', proceso: 'EVALUACI√ìN DE PROVEEDORES', funcion: 'PENDIENTE DEFINIR', actividad: 'Revaluaci√≥n de proveedores - Consolidaci√≥n en hoja de c√°lculo', informe: 'PENDIENTE DEFINIR', frecuencia: 'Semestralmente', reportaA: 'PENDIENTE DEFINIR', importancia: 70, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 15, tipo: 'Externa', proceso: 'GESTI√ìN DEL CONOCIMIENTO', funcion: 'PENDIENTE DEFINIR', actividad: 'Lecciones Aprendidas - Compras p√∫blicas frecuentes, riesgosas, complejas', informe: 'PENDIENTE DEFINIR', frecuencia: 'Anualmente', reportaA: 'PENDIENTE DEFINIR', importancia: 65, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 16, tipo: 'Externa', proceso: 'COMPRAS RESPONSABLES', funcion: 'PENDIENTE DEFINIR', actividad: 'Formatos de seguimiento - Sostenibilidad Ambiental, Inclusi√≥n Social e Innovaci√≥n', informe: 'PENDIENTE DEFINIR', frecuencia: 'Febrero y julio', reportaA: 'PENDIENTE DEFINIR', importancia: 70, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
        ];

        // 1.2. Plantilla de Lista de Chequeo (ACTUALIZADA con las 31 actividades del usuario)
        const INITIAL_ACTIVITIES = [
            // ETAPA: PLANEACI√ìN DEL CONTRATO (Items 1-9)
            { id: 1, etapa: 'Planeaci√≥n del Contrato', aspecto: 'Se cuenta con certificado de idoneidad', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 2, etapa: 'Planeaci√≥n del Contrato', aspecto: 'Acto de delegaci√≥n para contratar', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 3, etapa: 'Planeaci√≥n del Contrato', aspecto: 'Ficha tecnica', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 4, etapa: 'Planeaci√≥n del Contrato', aspecto: 'La necesidad del servicio est√° justificada y documentada.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 5, etapa: 'Planeaci√≥n del Contrato', aspecto: 'El contrato est√° incluido en el Plan Anual de Adquisiciones (PAA).', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 6, etapa: 'Planeaci√≥n del Contrato', aspecto: 'Se cuenta con estudio previo (El perfil, los costos, requisitos minimos de formaci√≥n y experiencia, tabla de honorarios acorde al valor asignado) y estudio de mercado.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 7, etapa: 'Planeaci√≥n del Contrato', aspecto: 'El objeto contractual est√° claramente definido y alineado con las funciones del √°rea.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 8, etapa: 'Planeaci√≥n del Contrato', aspecto: 'Existen CDP y RP debidamente aprobados.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 9, etapa: 'Planeaci√≥n del Contrato', aspecto: 'Se cuenta con p√≥liza o garant√≠a, si aplica.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            // ETAPA: SELECCI√ìN Y CONTRATACI√ìN (Items 10-14)
            { id: 10, etapa: 'Selecci√≥n y Contrataci√≥n', aspecto: 'Se cumpli√≥ con el procedimiento de selecci√≥n (ej. M√≠nima cuant√≠a, licitaci√≥n).', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 11, etapa: 'Selecci√≥n y Contrataci√≥n', aspecto: 'La comunicaci√≥n/notificaci√≥n del proceso fue oportuna.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 12, etapa: 'Selecci√≥n y Contrataci√≥n', aspecto: 'El contratista cumpli√≥ con los requisitos habilitantes.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 13, etapa: 'Selecci√≥n y Contrataci√≥n', aspecto: 'Existe acta de inicio y designaci√≥n formal de supervisor.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 14, etapa: 'Selecci√≥n y Contrataci√≥n', aspecto: 'El contrato fue suscrito por la persona competente.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            // ETAPA: EJECUCI√ìN (Items 15-18)
            { id: 15, etapa: 'Ejecuci√≥n', aspecto: 'Se cumpli√≥ con las condiciones y plazos del contrato.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 16, etapa: 'Ejecuci√≥n', aspecto: 'Se realizaron los pagos de seguridad social del contratista.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 17, etapa: 'Ejecuci√≥n', aspecto: 'Si hubo modificaciones (adiciones, prorrogas), est√°n debidamente soportadas.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 18, etapa: 'Ejecuci√≥n', aspecto: 'La ejecuci√≥n del contrato es coherente con el PAA.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            // ETAPA: CONTROL Y SUPERVISI√ìN (Items 19-21)
            { id: 19, etapa: 'Control y Supervisi√≥n', aspecto: 'El supervisor tiene designaci√≥n oficial y cumple sus funciones.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 20, etapa: 'Control y Supervisi√≥n', aspecto: 'Existen informes de supervisi√≥n con fechas y firmas.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 21, etapa: 'Control y Supervisi√≥n', aspecto: 'Entrega de documentos por parte del Supervisor a la DACP.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            // ETAPA: CIERRE Y LIQUIDACI√ìN (Items 22-24)
            { id: 22, etapa: 'Cierre y Liquidaci√≥n', aspecto: 'Existe acta de recibo final o informe de cumplimiento.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 23, etapa: 'Cierre y Liquidaci√≥n', aspecto: 'Se realiz√≥ la liquidaci√≥n del contrato (bilateral o unilateral).', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 24, etapa: 'Cierre y Liquidaci√≥n', aspecto: 'El cierre y liquidaci√≥n est√°n publicados en SECOP.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            // ETAPA: CALIDAD (ISO 9001) (Items 25-27)
            { id: 25, etapa: 'Calidad (ISO 9001)', aspecto: 'Se controla la documentaci√≥n y registros del proceso.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 26, etapa: 'Calidad (ISO 9001)', aspecto: 'El personal a cargo del proceso es competente y tiene formaci√≥n adecuada.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 27, etapa: 'Calidad (ISO 9001)', aspecto: 'Se hace seguimiento a indicadores del proceso (tiempos, cumplimiento, satisfacci√≥n).', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            // ETAPA: TRANSPARENCIA Y CUMPLIMIENTO (Items 28-31)
            { id: 28, etapa: 'Transparencia y Cumplimiento', aspecto: 'Cumple con la Ley 80, Ley 1150 y Decreto 1082 de 2015.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 29, etapa: 'Transparencia y Cumplimiento', aspecto: 'Toda la informaci√≥n contractual est√° publicada en SECOP.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 30, etapa: 'Transparencia y Cumplimiento', aspecto: 'El expediente f√≠sico est√° organizado, foliado y completo.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 31, etapa: 'Transparencia y Cumplimiento', aspecto: 'Se realiza la revaluaci√≥n de proveedores.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" }
        ];


        // =================================================================
        // 2. ESTADO DE LA APLICACI√ìN Y PERSISTENCIA (MIGRADO A LA NUBE)
        // =================================================================
        let state = {
            activeTab: 'dashboard',
            dacpActivities: [], // Se cargar√° desde la nube
            contracts: {}, // Objeto: { 'ID_Contrato': [Array de checklist] }
            currentContractId: INITIAL_CONTRACT_ID, // ID usado en la pesta√±a 'Lista de Chequeo'
            consolidatedContractId: null, // NUEVO: ID usado en la pesta√±a 'Manager'
            filtroTipo: 'Todos',
            filtroCumplimiento: 'Todos',
            charts: {}
        };

        /**
         * Funci√≥n central para actualizar el estado y re-renderizar.
         * @param {object} newState - El objeto de estado parcial a fusionar.
         */
        function setState(newState) {
            state = { ...state, ...newState };
            destroyCharts();
            renderApp();
        }

        // =================================================================
        // 3. PERSISTENCIA EN LA NUBE (Apps Script) - L√ìGICA CORREGIDA
        // =================================================================

        /**
         * ‚ö†Ô∏è CORREGIDO: Guarda SOLAMENTE el array de Actividades DACP (el JSON peque√±o).
         * Llama a doPost en Apps Script, que lo guarda en A1 de la hoja 'DACP_Activities'.
         * @param {Array} dacpActivities El array de actividades.
         */
        async function saveActivitiesToCloud(dacpActivities) {
            const dataToSave = {
                dacpActivities: dacpActivities,
                contracts: {} // Se env√≠a vac√≠o para asegurar que doPost solo actualice Actividades
            };

            try {
                // Petici√≥n POST al Apps Script (doPost)
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(dataToSave)
                });
                console.log("‚úÖ Actividades DACP guardadas correctamente.");
            } catch (error) {
                console.error("‚ùå Error al guardar actividades DACP:", error);
            }
        }


        /**
         * üèÜ NUEVO y CR√çTICO: Guarda UN √öNICO CONTRATO. SOLUCI√ìN AL L√çMITE DE 50K.
         * Usa google.script.run para llamar a la funci√≥n Apps Script 'saveContractToCloud', 
         * que guardar√° el contrato en una fila separada.
         * @param {string} contractId El ID del contrato modificado.
         * @param {object} contractData El objeto de datos del contrato (checklist).
         */
        async function saveContractToCloud(contractId, contractData) {
            // Asegurar que estamos en el entorno de Google Apps Script para usar google.script.run
            if (typeof google === 'undefined' || !google.script || !google.script.run) {
                console.warn("No se puede guardar en la nube. 'google.script.run' no est√° disponible (ejecutando localmente).");
                return;
            }

            const payload = {
                contractId: contractId,
                contractData: contractData
            };

            try {
                // Llama a la funci√≥n del lado del servidor (Apps Script)
                google.script.run
                    .withSuccessHandler(() => console.log(`‚úÖ Contrato ${contractId} guardado con √©xito por fila.`))
                    .withFailureHandler(error => console.error(`‚ùå Error al guardar contrato ${contractId}:`, error))
                    .saveContractToCloud(payload); // Nombre de la funci√≥n en Apps Script
            } catch (e) {
                console.error('Error al iniciar google.script.run para contrato:', e);
            }
        }

        /**
         * Obtiene el estado inicial (Actividades + Contratos) desde la nube.
         * Llama a doGet en Apps Script.
         */
        async function fetchStateFromCloud() {
            try {
                // Petici√≥n GET al Apps Script (doGet)
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Si la data.dacpActivities es v√°lida, usarla. Sino, usar la por defecto.
                const activities = (data && data.dacpActivities && data.dacpActivities.length > 0) 
                    ? data.dacpActivities
                    : DEFAULT_DACP_ACTIVITIES;

                // Si la data.contracts es v√°lida, usarla. Sino, empezar con un contrato base.
                const contracts = (data && data.contracts && Object.keys(data.contracts).length > 0)
                    ? data.contracts
                    : { [INITIAL_CONTRACT_ID]: INITIAL_ACTIVITIES.map(a => ({ ...a })) }; // Clonar plantilla

                setState({ 
                    dacpActivities: activities,
                    contracts: contracts,
                    currentContractId: Object.keys(contracts)[0] || INITIAL_CONTRACT_ID,
                    consolidatedContractId: Object.keys(contracts)[0] || null,
                });
                console.log("‚úÖ Datos cargados de la nube.");

            } catch (error) {
                console.error("‚ùå Error al cargar datos de la nube. Usando datos por defecto:", error);
                // Si falla la carga, inicializar con el estado por defecto
                setState({
                    dacpActivities: DEFAULT_DACP_ACTIVITIES,
                    contracts: { [INITIAL_CONTRACT_ID]: INITIAL_ACTIVITIES.map(a => ({ ...a })) },
                    currentContractId: INITIAL_CONTRACT_ID,
                    consolidatedContractId: INITIAL_CONTRACT_ID
                });
            }
        }


        // =================================================================
        // 4. MANEJO DE EVENTOS (HANDLERS) - ACTUALIZADOS
        // =================================================================

        /**
         * Maneja el cambio de cumplimiento, observaci√≥n o fecha en las actividades DACP.
         */
        async function handleActivityChange(event) {
            const { name, value } = event.target;
            const parts = name.split('_'); // ej. cumplimiento_1

            if (parts.length === 2) {
                const field = parts[0]; // cumplimiento, observaciones, fechaEvaluacion
                const id = parseInt(parts[1]);

                // 1. Clonar y aplicar el cambio al √≠tem correcto
                const newActivities = state.dacpActivities.map(item => {
                    if (item.id === id) {
                        return { ...item, [field]: value };
                    }
                    return item;
                });

                // 2. Actualizar estado local
                setState({ dacpActivities: newActivities });

                // 3. üíæ Guardar SOLO Actividades en la nube
                await saveActivitiesToCloud(newActivities); 
            }
        }

        /**
         * Maneja el cambio de radio o textarea en la lista de chequeo de contratos.
         */
        async function handleChecklistChange(id, campo, valor) {
            const currentChecklist = getCurrentChecklist();
            const contractId = state.currentContractId;

            // 1. Clonar y aplicar el cambio al √≠tem correcto
            const newChecklist = currentChecklist.map(item => {
                if (item.id === id) {
                    const newItem = { ...item };
                    
                    // L√≥gica para radio buttons (borrar 'X' de otros campos)
                    if (['SECOP II - Cumple', 'SECOP II - No Cumple', 'CARPETA FISICA - Cumple', 'CARPETA FISICA - No Cumple', 'CARPETA FISICA - No Aplica/ Parcialmente'].includes(campo)) {
                        const baseName = campo.split(' - ')[0]; // 'SECOP II' o 'CARPETA FISICA'
                        // Limpiar los campos del mismo grupo
                        Object.keys(newItem).forEach(key => {
                            if (key.includes(baseName)) {
                                newItem[key] = '';
                            }
                        });
                        // Poner la 'X' en el campo seleccionado
                        newItem[campo] = valor === 'X' ? 'X' : ''; // Asegura que solo se pone 'X'
                    } else {
                        // Para textareas (evidencia, obs_fisica, obs_secop)
                        newItem[campo] = valor;
                    }

                    return newItem;
                }
                return item;
            });

            // 2. Clonar el objeto de contratos y actualizar el contrato actual
            const newContracts = {
                ...state.contracts,
                [contractId]: newChecklist
            };

            // 3. Actualizar estado local
            setState({ contracts: newContracts });

            // 4. üèÜ Guardar SOLO el contrato modificado en la nube
            await saveContractToCloud(contractId, newChecklist); 
        }

        /**
         * Crea un nuevo contrato en el estado y lo selecciona.
         */
        async function handleCreateNewContract() {
            const newContractId = prompt("Ingrese el ID del nuevo contrato (Ej: C-2025-001):");
            if (newContractId && !state.contracts[newContractId]) {
                const newChecklist = INITIAL_ACTIVITIES.map(a => ({ ...a })); // Clonar plantilla
                
                const newContracts = {
                    ...state.contracts,
                    [newContractId]: newChecklist
                };

                setState({
                    contracts: newContracts,
                    currentContractId: newContractId,
                    consolidatedContractId: newContractId,
                    activeTab: 'checklist' // Mueve a la pesta√±a de chequeo del nuevo contrato
                });

                // üíæ Guardar el nuevo contrato inmediatamente
                await saveContractToCloud(newContractId, newChecklist); 
            } else if (newContractId) {
                alert("Ese ID de contrato ya existe. Por favor, ingrese un ID √∫nico.");
            }
        }
        
        // ... (resto de funciones del frontend: handleTabClick, handleContractSelectChange, etc.)

        // =================================================================
        // 5. IMPORTACI√ìN CSV (ACTUALIZADO: SIN GUARDADO AUTOM√ÅTICO DE TODO EL ESTADO)
        // =================================================================

        /**
         * Convierte una fila de datos CSV en un objeto de checklist.
         * @param {Array<string>} row - Fila de datos del CSV.
         * @param {Array<string>} headers - Encabezados de la tabla.
         * @returns {object|null} Objeto del √≠tem de la checklist o null si es inv√°lido.
         */
        function mapCsvRowToChecklist(row, headers) {
            // Se asume que la fila debe tener al menos 10 columnas (ID, Etapa, Aspecto + 7 campos)
            if (row.length < 10) return null; 

            // Clonar la plantilla del item 1 (solo para obtener la estructura base de las llaves)
            const templateItem = INITIAL_ACTIVITIES[0];
            const item = { ...templateItem };

            // Mapeo basado en la posici√≥n de las columnas
            item.id = parseInt(row[0]);
            item.etapa = row[1];
            item.aspecto = row[2];
            
            // Los campos que son radio buttons est√°n en las posiciones 3 a 7
            item["SECOP II - Cumple"] = row[3];
            item["SECOP II - No Cumple"] = row[4];
            item["CARPETA FISICA - Cumple"] = row[5];
            item["CARPETA FISICA - No Cumple"] = row[6];
            item["CARPETA FISICA - No Aplica/ Parcialmente"] = row[7];
            
            // Campos de observaci√≥n y evidencia
            item.evidencia = ''; // No se encuentra en el CSV de ejemplo, se deja vac√≠o
            item.obs_fisica = row[8] || '';
            item.obs_secop = row[9] || '';

            return item;
        }

        /**
         * Procesa los archivos CSV importados.
         * ESTA FUNCI√ìN AHORA S√ìLO CARGA LOS DATOS EN EL ESTADO LOCAL.
         */
        function processCSVFiles(files) {
            if (!files || files.length === 0) return;

            const newContracts = { ...state.contracts };
            let lastContractId = state.currentContractId;

            let filesProcessed = 0;
            const totalFiles = files.length;

            const processNextFile = (index) => {
                if (index >= totalFiles) {
                    setState({ contracts: newContracts, currentContractId: lastContractId });
                    alert(`‚úÖ ¬°Importaci√≥n completa! Se procesaron ${filesProcessed} contratos.`);
                    // ‚ö†Ô∏è NOTA CR√çTICA: NO HAY LLAMADA A saveStateToCloud() AQU√ç.
                    // Los datos est√°n en memoria. El usuario debe guardar los cambios manuales o usar la exportaci√≥n CSV.
                    return;
                }

                const file = files[index];
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const csvContent = e.target.result;
                        const lines = csvContent.split('\n').filter(line => line.trim() !== '');
                        if (lines.length < 2) return processNextFile(index + 1);

                        // 1. Obtener los encabezados (asumimos la primera l√≠nea)
                        const headers = lines[0].split(';');

                        // 2. Extraer el ID del contrato del nombre del archivo (Ej: Checklist_Contrato_4125.010.26.1.003-2025.csv)
                        const match = file.name.match(/Contrato_([^.]+)/);
                        const contractId = match ? match[1].replace(/_/g, '.') : file.name.replace('.csv', '');

                        const checklist = [];
                        for (let i = 1; i < lines.length; i++) {
                            // Usar una expresi√≥n regular simple para dividir por ; pero ignorar los que est√°n dentro de comillas ""
                            const row = lines[i].match(/(".*?"|[^;]+)(;|$)/g).map(s => s.replace(/;$/, '').replace(/"/g, ''));
                            if (row.length > 0 && row[0].trim() !== 'ID') { // Evitar l√≠neas vac√≠as o encabezados repetidos
                                const item = mapCsvRowToChecklist(row, headers);
                                if (item) {
                                    checklist.push(item);
                                }
                            }
                        }

                        if (checklist.length > 0) {
                            newContracts[contractId] = checklist;
                            lastContractId = contractId;
                            filesProcessed++;
                        }

                    } catch (error) {
                        console.error(`Error al procesar el archivo ${file.name}:`, error);
                    } finally {
                        processNextFile(index + 1); // Procesar el siguiente archivo
                    }
                };

                reader.readAsText(file, 'iso-8859-1'); // Usar codificaci√≥n com√∫n para CSV de Excel

            };
            
            // Iniciar el procesamiento secuencial
            processNextFile(0);
        }
        
        // ... (resto de funciones de ayuda, renderizado de gr√°ficos, etc. que se mantienen igual)
        
        // =================================================================
        // 5. EXPORTACI√ìN A EXCEL (CSV) (Se mantienen igual)
        // =================================================================

        /**
         * Funci√≥n auxiliar para obtener el contenido del contrato actual para exportar.
         * @returns {string} Contenido CSV.
         */
        function getChecklistCsvContent(checklist) {
            const headers = ["ID", "Etapa / Criterio", "Aspecto a Verificar", "SECOP II (Cumple)", "SECOP II (No Cumple)", "CARPETA FISICA (Cumple)", "CARPETA FISICA (No Cumple)", "CARPETA FISICA (Parcial/N/A)", "Evidencia Documental", "Observaciones Carpeta Fisica", "Observaciones SECOP II"];
            let csv = headers.join(';') + '\n';
            
            checklist.forEach(item => {
                const row = [
                    item.id,
                    `"${item.etapa}"`,
                    `"${item.aspecto}"`,
                    item["SECOP II - Cumple"],
                    item["SECOP II - No Cumple"],
                    item["CARPETA FISICA - Cumple"],
                    item["CARPETA FISICA - No Cumple"],
                    item["CARPETA FISICA - No Aplica/ Parcialmente"],
                    `"${item.evidencia.replace(/"/g, '""').replace(/\n/g, ' ')}"`, // Limpiar saltos de l√≠nea para CSV
                    `"${item.obs_fisica.replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                    `"${item.obs_secop.replace(/"/g, '""').replace(/\n/g, ' ')}"`
                ];
                csv += row.join(';') + '\n';
            });
            return csv;
        }

        /**
         * Exporta la lista de chequeo del contrato actual a un archivo CSV.
         */
        function exportChecklistToExcel() {
            const checklist = getCurrentChecklist();
            if (checklist.length === 0) {
                alert("No hay datos de checklist para exportar.");
                return;
            }
            
            const csvContent = getChecklistCsvContent(checklist);
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `Checklist_Contrato_${state.currentContractId}.csv`);
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        /**
         * Exporta la matriz de actividades DACP a un archivo CSV.
         */
        function exportToExcel() {
            const activities = state.dacpActivities;
            if (activities.length === 0) {
                alert("No hay datos de actividades DACP para exportar.");
                return;
            }

            const headers = ["ID", "Tipo", "Proceso", "Funcion", "Actividad", "Informe", "Frecuencia", "Reporta A", "Importancia (%)", "Cumplimiento", "Observaciones", "Fecha Evaluaci√≥n"];
            let csv = headers.join(';') + '\n';

            activities.forEach(item => {
                const row = [
                    item.id,
                    item.tipo,
                    item.proceso,
                    item.funcion,
                    `"${item.actividad.replace(/"/g, '""')}"`,
                    item.informe,
                    item.frecuencia,
                    item.reportaA,
                    item.importancia,
                    item.cumplimiento || '',
                    `"${item.observaciones.replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                    item.fechaEvaluacion
                ];
                csv += row.join(';') + '\n';
            });

            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'Matriz_Actividades_DACP.csv');
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        /**
         * NUEVA FUNCI√ìN: Exporta el resumen de estad√≠sticas del manager.
         */
        function exportManagerStatsToExcel(contractId, stats) {
            if (!stats) {
                alert("No hay estad√≠sticas para exportar.");
                return;
            }

            const data = [
                ["M√ìDULO MANAGER - RESUMEN CONTRATO: " + contractId],
                [""],
                ["√çTEM", "VALOR"],
                ["Total √çtems de Chequeo", stats.total],
                ["√çtems con SECOP Cumple", stats.cumplidasSECOP],
                ["√çtems con F√çSICA Cumple", stats.cumplidasFisica],
                ["Total Cumplidas (SECOP o F√çSICA)", stats.cumplidasTotal],
                ["Total No Cumplidas", stats.noCumplidas],
                ["Porcentaje de Cumplimiento Consolidado (Total Cumplidas / (Total √çtems * 2))", (stats.pctCumplimientoTotal).toFixed(2) + "%"],
                [""],
                ["CUMPLIMIENTO POR ETAPA"],
                ["ETAPA", "Total √çtems", "% Cumplimiento (Doble Chequeo)"]
            ];

            Object.keys(stats.porEtapa).forEach(etapa => {
                data.push([
                    etapa,
                    stats.porEtapa[etapa].total,
                    (stats.porEtapa[etapa].pctCumplimiento).toFixed(2) + "%"
                ]);
            });

            // Convertir la matriz de datos a CSV
            let csv = data.map(row => 
                row.map(cell => {
                    // Si el valor es una cadena, escapar comillas y encerrar en comillas para CSV
                    if (typeof cell === 'string') {
                        return `"${cell.replace(/"/g, '""')}"`;
                    }
                    return cell;
                }).join(';')
            ).join('\n');


            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `Estadisticas_Manager_${contractId}.csv`);
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }


        // =================================================================
        // 6. FUNCIONES DE C√ÅLCULO Y UTILITY (Se mantienen igual)
        // =================================================================

        /**
         * Filtra la lista de actividades DACP bas√°ndose en los filtros del estado.
         */
        function getActividadesFiltradas() {
            return state.dacpActivities.filter(item => {
                const tipoMatch = state.filtroTipo === 'Todos' || item.tipo === state.filtroTipo;
                const cumplimientoMatch = state.filtroCumplimiento === 'Todos' || item.cumplimiento === state.filtroCumplimiento;
                return tipoMatch && cumplimientoMatch;
            });
        }

        /**
         * Obtiene la lista de chequeo del contrato actualmente seleccionado.
         */
        function getCurrentChecklist() {
            return state.contracts[state.currentContractId] || INITIAL_ACTIVITIES;
        }

        /**
         * Obtiene la lista de chequeo del contrato seleccionado en la pesta√±a Manager.
         */
        function getManagerChecklist() {
            return state.contracts[state.consolidatedContractId] || [];
        }


        /**
         * Calcula las estad√≠sticas de cumplimiento para la Matriz DACP.
         */
        function calcularEstadisticas(activities) {
            const stats = {
                total: activities.length,
                cumplidas: 0,
                noCumplidas: 0,
                pendientes: 0,
                porCumplimiento: {},
                pctCumplimiento: 0
            };

            activities.forEach(item => {
                if (item.cumplimiento === 'Cumple') {
                    stats.cumplidas++;
                } else if (item.cumplimiento === 'No Cumple') {
                    stats.noCumplidas++;
                } else {
                    stats.pendientes++;
                }

                // Agrupar por cumplimiento para el Pie Chart
                const key = item.cumplimiento || 'Pendiente';
                stats.porCumplimiento[key] = (stats.porCumplimiento[key] || 0) + 1;
            });

            // Calcular porcentaje de cumplimiento
            if (stats.total > 0) {
                stats.pctCumplimiento = (stats.cumplidas / stats.total) * 100;
            }

            return stats;
        }

        /**
         * Calcula las estad√≠sticas de cumplimiento consolidadas para un contrato individual.
         */
        function calcularEstadisticasContrato(checklist) {
            const stats = {
                total: checklist.length,
                cumplidasSECOP: 0,
                noCumplidasSECOP: 0,
                cumplidasFisica: 0,
                noCumplidasFisica: 0,
                noAplicaParcialFisica: 0,
                cumplidasTotal: 0, // Cumple en SECOP O F√≠sica
                noCumplidas: 0, // No cumple en ambas o no aplica en ambas
                pendientes: 0, // No tiene chequeo en ninguna
                pctCumplimientoTotal: 0,
                porEtapa: {}
            };

            // 1. Calcular estad√≠sticas consolidadas
            checklist.forEach(item => {
                const secopCumple = item["SECOP II - Cumple"] === 'X';
                const secopNoCumple = item["SECOP II - No Cumple"] === 'X';
                const fisicaCumple = item["CARPETA FISICA - Cumple"] === 'X';
                const fisicaNoCumple = item["CARPETA FISICA - No Cumple"] === 'X';
                const fisicaNoAplicaParcial = item["CARPETA FISICA - No Aplica/ Parcialmente"] === 'X';

                if (secopCumple) stats.cumplidasSECOP++;
                if (secopNoCumple) stats.noCumplidasSECOP++;
                if (fisicaCumple) stats.cumplidasFisica++;
                if (fisicaNoCumple) stats.noCumplidasFisica++;
                if (fisicaNoAplicaParcial) stats.noAplicaParcialFisica++;

                // Cumplimiento Consolidado
                if (secopCumple || fisicaCumple) {
                    stats.cumplidasTotal++;
                } else if (secopNoCumple && (fisicaNoCumple || fisicaNoAplicaParcial)) {
                    stats.noCumplidas++;
                } else if (!secopCumple && !secopNoCumple && !fisicaCumple && !fisicaNoCumple && !fisicaNoAplicaParcial) {
                    stats.pendientes++;
                }
            });

            // El porcentaje se calcula sobre el total de chequeos posibles (items * 2: SECOP + FISICA)
            const totalChequeosPosibles = stats.total * 2;
            stats.pctCumplimientoTotal = totalChequeosPosibles > 0 ? ((stats.cumplidasSECOP + stats.cumplidasFisica) / totalChequeosPosibles) * 100 : 0;


            // 2. Calcular estad√≠sticas por Etapa (para el Radar Chart)
            const checklistByEtapa = checklist.reduce((acc, item) => {
                const etapa = item.etapa;
                if (!acc[etapa]) {
                    acc[etapa] = [];
                }
                acc[etapa].push(item);
                return acc;
            }, {});

            Object.keys(checklistByEtapa).forEach(etapa => {
                const totalEtapa = checklistByEtapa[etapa].length;
                let cumplidasTotalEtapa = 0;

                checklistByEtapa[etapa].forEach(item => {
                    // Contar si el √≠tem est√° 'Cumplido' en SECOP o 'Cumplido' en FISICA
                    if (item["SECOP II - Cumple"] === 'X') cumplidasTotalEtapa++;
                    if (item["CARPETA FISICA - Cumple"] === 'X') cumplidasTotalEtapa++;
                });

                // Total de chequeos posibles en la etapa (√≠tem * 2)
                const totalChequeosEtapa = totalEtapa * 2;
                stats.porEtapa[etapa] = {
                    total: totalEtapa,
                    // Porcentaje de cumplimiento basado en las 2 verificaciones por √≠tem
                    pctCumplimiento: totalChequeosEtapa > 0 ? (cumplidasTotalEtapa / totalChequeosEtapa) * 100 : 0
                };
            });

            return stats;
        }


        // ... (Funciones de renderizado de gr√°ficos y HTML que se mantienen igual)
        
        function renderDashboardCharts(actStats) {
            // Chart 1: Pie Chart (Cumplimiento General)
            if (state.charts.pieChart) state.charts.pieChart.destroy();
            const pieCtx = document.getElementById('compliancePieChart')?.getContext('2d');
            if (pieCtx) {
                const data = {
                    labels: ['Cumple', 'No Cumple', 'Pendiente'],
                    datasets: [{
                        data: [actStats.cumplidas, actStats.noCumplidas, actStats.pendientes],
                        backgroundColor: ['#10B981', '#EF4444', '#F59E0B'],
                        hoverOffset: 4
                    }]
                };
                state.charts.pieChart = new Chart(pieCtx, {
                    type: 'pie',
                    data: data,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Cumplimiento General (Matriz DACP)'
                            }
                        }
                    }
                });
            }

            // Chart 2: Radar Chart (Importancia vs Cumplimiento)
            if (state.charts.radarChart) state.charts.radarChart.destroy();
            const radarCtx = document.getElementById('importanceRadarChart')?.getContext('2d');
            if (radarCtx) {
                const labels = state.dacpActivities.map(a => a.actividad.substring(0, 30) + '...');
                const complianceScores = state.dacpActivities.map(a => a.cumplimiento === 'Cumple' ? 100 : a.cumplimiento === 'No Cumple' ? 0 : 50);
                const importanceScores = state.dacpActivities.map(a => a.importancia);

                const data = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Puntuaci√≥n de Cumplimiento (0=No, 50=Pendiente, 100=Cumple)',
                            data: complianceScores,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgb(54, 162, 235)',
                            pointBackgroundColor: 'rgb(54, 162, 235)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(54, 162, 235)'
                        },
                        {
                            label: 'Importancia Asignada',
                            data: importanceScores,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgb(255, 99, 132)',
                            pointBackgroundColor: 'rgb(255, 99, 132)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(255, 99, 132)'
                        }
                    ]
                };

                state.charts.radarChart = new Chart(radarCtx, {
                    type: 'radar',
                    data: data,
                    options: {
                        responsive: true,
                        elements: {
                            line: {
                                borderWidth: 3
                            }
                        },
                        scales: {
                            r: {
                                suggestedMin: 0,
                                suggestedMax: 100,
                                pointLabels: {
                                    font: {
                                        size: 10 // Tama√±o de fuente peque√±o para etiquetas
                                    }
                                },
                                ticks: {
                                    display: false // Oculta los ticks de la escala radial
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Importancia vs. Cumplimiento por Actividad'
                            }
                        }
                    }
                });
            }
        }

        /**
         * NUEVA FUNCI√ìN: Renderiza el gr√°fico de Radar para el Manager
         */
        function renderManagerRadarChart(stats) {
            if (state.charts.managerRadarChart) state.charts.managerRadarChart.destroy();
            
            const etapas = Object.keys(stats.porEtapa);
            const scores = etapas.map(e => stats.porEtapa[e].pctCumplimiento);

            const ctx = document.getElementById('managerRadarChart')?.getContext('2d');
            
            if (ctx) {
                state.charts.managerRadarChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: etapas,
                        datasets: [
                            {
                                label: 'Cumplimiento (%)',
                                data: scores,
                                backgroundColor: 'rgba(16, 185, 129, 0.2)', // green-500
                                borderColor: 'rgb(16, 185, 129)',
                                pointBackgroundColor: 'rgb(16, 185, 129)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgb(16, 185, 129)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        elements: {
                            line: {
                                borderWidth: 3
                            }
                        },
                        scales: {
                            r: {
                                suggestedMin: 0,
                                suggestedMax: 100,
                                pointLabels: {
                                    font: {
                                        size: 10
                                    }
                                },
                                ticks: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        /**
         * Funci√≥n auxiliar para generar tarjetas de estad√≠sticas.
         */
        function renderStatsCard(stats, title, value, colorClass) {
            return `
                <div class="bg-white p-5 rounded-lg shadow border border-gray-200">
                    <p class="text-sm font-medium text-gray-500">${title}</p>
                    <p class="text-2xl font-bold ${colorClass}">${value}</p>
                </div>
            `;
        }

        /**
         * Funci√≥n para alternar entre pesta√±as.
         */
        function handleTabClick(tab) {
            setState({ activeTab: tab });
        }
        
        /**
         * Maneja el cambio de selecci√≥n de contrato en la pesta√±a 'Lista de Chequeo'.
         */
        function handleContractSelectChange(e) {
            setState({ currentContractId: e.target.value });
        }

        /**
         * NUEVA FUNCI√ìN: Maneja el cambio en el selector de contrato en la pesta√±a 'Manager'.
         */
        function handleManagerSelectChange(e) {
            setState({ consolidatedContractId: e.target.value });
        }


        /**
         * Destruye todas las instancias de Chart.js para evitar fugas de memoria y errores de re-renderizado.
         */
        function destroyCharts() {
            Object.keys(state.charts).forEach(key => {
                if (state.charts[key]) {
                    state.charts[key].destroy();
                    state.charts[key] = null;
                }
            });
        }
        
        // =================================================================
        // 7. RENDERING DE PESTA√ëAS (Vistas)
        // =================================================================

        function renderDACPActivities() {
            const filteredActivities = getActividadesFiltradas();
            const stats = calcularEstadisticas(state.dacpActivities);

            // Renderiza los gr√°ficos del Dashboard
            setTimeout(() => renderDashboardCharts(stats), 0);

            return `
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Matriz de Auditor√≠a DACP</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        ${renderStatsCard(stats, "Actividades Totales", stats.total, "text-gray-900")}
                        ${renderStatsCard(stats, "Cumplimiento (%)", `${stats.pctCumplimiento.toFixed(2)}%`, stats.pctCumplimiento >= 80 ? "text-green-600" : stats.pctCumplimiento >= 50 ? "text-yellow-600" : "text-red-600")}
                        ${renderStatsCard(stats, "Cumplidas (N¬∞)", stats.cumplidas, "text-green-600")}
                        ${renderStatsCard(stats, "Pendientes (N¬∞)", stats.pendientes, "text-blue-600")}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <canvas id="compliancePieChart"></canvas>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <canvas id="importanceRadarChart"></canvas>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-center space-x-4 mb-6 p-4 bg-white rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="filtroTipo" class="text-sm font-medium text-gray-700">Tipo:</label>
                            <select id="filtroTipo" onchange="handleFilterChange('filtroTipo', this.value)" class="p-2 border rounded text-sm">
                                <option value="Todos" ${state.filtroTipo === 'Todos' ? 'selected' : ''}>Todos</option>
                                <option value="Interna" ${state.filtroTipo === 'Interna' ? 'selected' : ''}>Interna</option>
                                <option value="Externa" ${state.filtroTipo === 'Externa' ? 'selected' : ''}>Externa</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="filtroCumplimiento" class="text-sm font-medium text-gray-700">Cumplimiento:</label>
                            <select id="filtroCumplimiento" onchange="handleFilterChange('filtroCumplimiento', this.value)" class="p-2 border rounded text-sm">
                                <option value="Todos" ${state.filtroCumplimiento === 'Todos' ? 'selected' : ''}>Todos</option>
                                <option value="Cumple" ${state.filtroCumplimiento === 'Cumple' ? 'selected' : ''}>Cumple</option>
                                <option value="No Cumple" ${state.filtroCumplimiento === 'No Cumple' ? 'selected' : ''}>No Cumple</option>
                                <option value="Pendiente" ${state.filtroCumplimiento === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                            </select>
                        </div>
                        <button onclick="exportToExcel()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded shadow transition duration-150 text-sm">
                            Exportar Matriz DACP a CSV
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase w-10">ID</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Tipo</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Proceso</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase w-80">Actividad</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Frecuencia</th>
                                    <th scope="col" class="p-3 text-center text-xs font-semibold text-gray-600 uppercase w-16">Importancia (%)</th>
                                    <th scope="col" class="p-3 text-center text-xs font-semibold text-gray-600 uppercase w-32">Cumplimiento</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase w-64">Observaciones</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase w-32">Fecha Evaluaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${filteredActivities.map(item => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-3 whitespace-nowrap text-sm font-medium text-gray-900">${item.id}</td>
                                        <td class="p-3 whitespace-nowrap text-sm text-gray-500">${item.tipo}</td>
                                        <td class="p-3 whitespace-nowrap text-sm text-gray-500">${item.proceso}</td>
                                        <td class="p-3 text-sm text-gray-500">${item.actividad}</td>
                                        <td class="p-3 whitespace-nowrap text-sm text-gray-500">${item.frecuencia}</td>
                                        <td class="p-3 whitespace-nowrap text-sm text-center font-bold text-blue-600">${item.importancia}</td>
                                        <td class="p-3 whitespace-nowrap text-sm">
                                            <select name="cumplimiento_${item.id}" onchange="handleActivityChange(event)" class="p-1 border rounded text-xs ${item.cumplimiento === 'Cumple' ? 'bg-green-100 text-green-800 border-green-300' : item.cumplimiento === 'No Cumple' ? 'bg-red-100 text-red-800 border-red-300' : 'bg-yellow-100 text-yellow-800 border-yellow-300'}">
                                                <option value="" ${!item.cumplimiento ? 'selected' : ''}>Pendiente</option>
                                                <option value="Cumple" ${item.cumplimiento === 'Cumple' ? 'selected' : ''}>Cumple</option>
                                                <option value="No Cumple" ${item.cumplimiento === 'No Cumple' ? 'selected' : ''}>No Cumple</option>
                                            </select>
                                        </td>
                                        <td class="p-1 text-sm">
                                            <textarea name="observaciones_${item.id}" onchange="handleActivityChange(event)" class="table-textarea">${item.observaciones}</textarea>
                                        </td>
                                        <td class="p-3 whitespace-nowrap text-sm">
                                            <input type="date" name="fechaEvaluacion_${item.id}" value="${item.fechaEvaluacion}" onchange="handleActivityChange(event)" class="p-1 border rounded text-xs w-full">
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }


        function renderChecklist() {
            const currentChecklist = getCurrentChecklist();
            const contractIds = Object.keys(state.contracts);

            return `
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Lista de Chequeo y Auditor√≠a de Contratos</h2>
                    
                    <div class="flex flex-wrap items-center space-x-4 mb-6 p-4 bg-white rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="contract-select" class="text-sm font-medium text-gray-700">Contrato Actual:</label>
                            <select id="contract-select" onchange="handleContractSelectChange(event)" class="p-2 border rounded text-sm w-64">
                                ${contractIds.map(id => 
                                    `<option value="${id}" ${state.currentContractId === id ? 'selected' : ''}>${id}</option>`
                                ).join('')}
                            </select>
                        </div>

                        <button onclick="handleCreateNewContract()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded shadow transition duration-150 text-sm">
                            + Nuevo Contrato
                        </button>
                        
                        <input type="file" id="csvFileInput" multiple accept=".csv" style="display: none;" onchange="processCSVFiles(this.files)">
                        <button onclick="document.getElementById('csvFileInput').click()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded shadow transition duration-150 text-sm">
                            Importar Checklists (CSV)
                        </button>

                        <button onclick="exportChecklistToExcel()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded shadow transition duration-150 text-sm">
                            Exportar Checklist Actual a CSV
                        </button>
                    </div>

                    ${currentChecklist.length === 0 ? 
                        `<p class="text-center text-lg text-gray-500 mt-10">Seleccione un contrato o cree uno nuevo para empezar a chequear.</p>`
                        : `
                        <div class="bg-white rounded-lg shadow overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" rowspan="2" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase w-10">ID</th>
                                        <th scope="col" rowspan="2" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase w-32">ETAPA / CRITERIO</th>
                                        <th scope="col" rowspan="2" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase w-96">ASPECTO A VERIFICAR</th>
                                        <th scope="col" colspan="2" class="p-3 text-center font-semibold text-gray-600 uppercase border-b border-gray-200">SECOP II</th>
                                        <th scope="col" colspan="3" class="p-3 text-center font-semibold text-gray-600 uppercase border-b border-gray-200">CARPETA FISICA</th>
                                        <th scope="col" rowspan="2" class="p-3 text-left font-semibold text-gray-600 uppercase w-48">EVIDENCIA DOCUMENTAL</th>
                                        <th scope="col" rowspan="2" class="p-3 text-left font-semibold text-gray-600 uppercase w-48">OBSERVACI√ìN CARPETA FISICA</th>
                                        <th scope="col" rowspan="2" class="p-3 text-left font-semibold text-gray-600 uppercase w-48">OBSERVACI√ìN SECOP II</th>
                                    </tr>
                                    <tr>
                                        <th scope="col" class="p-3 text-center text-xs font-semibold text-gray-600 uppercase w-16">Cumple</th>
                                        <th scope="col" class="p-3 text-center text-xs font-semibold text-gray-600 uppercase w-16">No Cumple</th>
                                        <th scope="col" class="p-3 text-center text-xs font-semibold text-gray-600 uppercase w-16">Cumple</th>
                                        <th scope="col" class="p-3 text-center text-xs font-semibold text-gray-600 uppercase w-16">No Cumple</th>
                                        <th scope="col" class="p-3 text-center text-xs font-semibold text-gray-600 uppercase w-16">Parcial/N/A</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${currentChecklist.map(item => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="p-3 text-sm font-medium text-gray-900">${item.id}</td>
                                            <td class="p-3 text-sm text-gray-500">${item.etapa}</td>
                                            <td class="p-3 text-sm text-gray-500">${item.aspecto}</td>
                                            
                                            <td class="p-3 text-center">
                                                <input type="radio" 
                                                    name="secop_ii_${item.id}" 
                                                    value="Cumple" 
                                                    ${item["SECOP II - Cumple"] === 'X' ? 'checked' : ''}
                                                    onclick="handleChecklistChange(${item.id}, 'SECOP II - Cumple', 'X')" 
                                                    class="form-radio text-green-500 h-5 w-5">
                                            </td>
                                            
                                            <td class="p-3 text-center">
                                                <input type="radio" 
                                                    name="secop_ii_${item.id}" 
                                                    value="No Cumple" 
                                                    ${item["SECOP II - No Cumple"] === 'X' ? 'checked' : ''}
                                                    onclick="handleChecklistChange(${item.id}, 'SECOP II - No Cumple', 'X')" 
                                                    class="form-radio text-red-500 h-5 w-5">
                                            </td>
                                            
                                            <td class="p-3 text-center">
                                                <input type="radio" 
                                                    name="fisica_${item.id}" 
                                                    value="Cumple" 
                                                    ${item["CARPETA FISICA - Cumple"] === 'X' ? 'checked' : ''}
                                                    onclick="handleChecklistChange(${item.id}, 'CARPETA FISICA - Cumple', 'X')" 
                                                    class="form-radio text-green-500 h-5 w-5">
                                            </td>

                                            <td class="p-3 text-center">
                                                <input type="radio" 
                                                    name="fisica_${item.id}" 
                                                    value="No Cumple" 
                                                    ${item["CARPETA FISICA - No Cumple"] === 'X' ? 'checked' : ''}
                                                    onclick="handleChecklistChange(${item.id}, 'CARPETA FISICA - No Cumple', 'X')" 
                                                    class="form-radio text-red-500 h-5 w-5">
                                            </td>
                                            
                                            <td class="p-3 text-center">
                                                <input type="radio" 
                                                    name="fisica_${item.id}" 
                                                    value="No Aplica/ Parcialmente" 
                                                    ${item["CARPETA FISICA - No Aplica/ Parcialmente"] === 'X' ? 'checked' : ''}
                                                    onclick="handleChecklistChange(${item.id}, 'CARPETA FISICA - No Aplica/ Parcialmente', 'X')" 
                                                    class="form-radio text-yellow-500 h-5 w-5">
                                            </td>

                                            <td class="p-1 text-sm">
                                                <textarea 
                                                    onchange="handleChecklistChange(${item.id}, 'evidencia', this.value)" 
                                                    class="table-textarea">${item.evidencia}</textarea>
                                            </td>
                                            
                                            <td class="p-1 text-sm">
                                                <textarea 
                                                    onchange="handleChecklistChange(${item.id}, 'obs_fisica', this.value)" 
                                                    class="table-textarea">${item.obs_fisica}</textarea>
                                            </td>

                                            <td class="p-1 text-sm">
                                                <textarea 
                                                    onchange="handleChecklistChange(${item.id}, 'obs_secop', this.value)" 
                                                    class="table-textarea">${item.obs_secop}</textarea>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            `;
        }
        
        function renderManager() {
            const contractIds = Object.keys(state.contracts);
            const selectedId = state.consolidatedContractId;
            const checklist = getManagerChecklist();
            const stats = checklist.length > 0 ? calcularEstadisticasContrato(checklist) : null;

            // Renderiza el gr√°fico de Radar para el Manager
            if (stats) {
                setTimeout(() => renderManagerRadarChart(stats), 0);
            }

            return `
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">M√≥dulo Manager: Resumen de Cumplimiento de Contratos</h2>
                    <p class="text-gray-600 mb-6">Seleccione un contrato para ver su resumen estad√≠stico de cumplimiento consolidado.</p>
                    
                    <div class="flex flex-wrap items-center space-x-4 mb-6 p-4 bg-white rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="manager-select" class="text-sm font-medium text-gray-700">Contrato Seleccionado:</label>
                            <select id="manager-select" onchange="handleManagerSelectChange(event)" class="p-2 border rounded text-sm w-64">
                                ${contractIds.map(id => 
                                    `<option value="${id}" ${selectedId === id ? 'selected' : ''}>${id}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        ${stats ? 
                            `<button onclick="exportManagerStatsToExcel('${selectedId}', ${JSON.stringify(stats).replace(/"/g, '&quot;')})" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded shadow transition duration-150 text-sm">
                                Exportar Resumen a CSV
                            </button>`
                            : ''
                        }
                    </div>

                    ${stats ? `
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                            ${renderStatsCard(stats, "Total √çtems de Chequeo", stats.total, "text-gray-900")}
                            ${renderStatsCard(stats, "Cumplimiento Consolidado (%)", `${stats.pctCumplimientoTotal.toFixed(2)}%`, stats.pctCumplimientoTotal >= 80 ? "text-green-600" : stats.pctCumplimientoTotal >= 50 ? "text-yellow-600" : "text-red-600")}
                            ${renderStatsCard(stats, "√çtems con SECOP Cumple (N¬∞)", stats.cumplidasSECOP, "text-blue-600")}
                            ${renderStatsCard(stats, "√çtems con F√çSICA Cumple (N¬∞)", stats.cumplidasFisica, "text-blue-600")}
                            ${renderStatsCard(stats, "Total Cumplidas (SECOP O F√çSICA)", stats.cumplidasTotal, "text-green-600")}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Cumplimiento por Etapa (Doble Chequeo)</h3>
                                <canvas id="managerRadarChart"></canvas>
                                <p class="text-xs text-gray-500 mt-2">Puntuaci√≥n basada en el cumplimiento de los dos chequeos (SECOP y Carpeta F√≠sica) por √≠tem.</p>
                            </div>

                            <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Detalle por Etapa</h3>
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Etapa</th>
                                            <th scope="col" class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">Total √çtems</th>
                                            <th scope="col" class="p-3 text-center text-xs font-semibold text-gray-600 uppercase">% Cumplimiento</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${Object.keys(stats.porEtapa).map(etapa => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="p-3 text-sm font-medium text-gray-900">${etapa}</td>
                                                <td class="p-3 text-center text-sm text-gray-500">${stats.porEtapa[etapa].total}</td>
                                                <td class="p-3 text-center text-sm font-bold ${stats.porEtapa[etapa].pctCumplimiento >= 80 ? "text-green-600" : "text-red-600"}">
                                                    ${stats.porEtapa[etapa].pctCumplimiento.toFixed(2)}%
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                    ` : `<p class="text-center text-lg text-gray-500 mt-10">Por favor, seleccione un contrato para generar las estad√≠sticas.</p>`}
                </div>
            `;
        }

        /**
         * Funci√≥n principal para renderizar la aplicaci√≥n.
         */
        function renderApp() {
            const root = document.getElementById('root');
            let content;

            switch (state.activeTab) {
                case 'dashboard':
                    content = renderDACPActivities();
                    break;
                case 'checklist':
                    content = renderChecklist();
                    break;
                case 'manager':
                    content = renderManager();
                    break;
                default:
                    content = renderDACPActivities();
            }

            root.innerHTML = `
                <div class="container mx-auto p-4 md:p-8">
                    <header class="mb-8">
                        <h1 class="text-3xl font-extrabold text-gray-900">Dashboard de Auditor√≠a de Contrataci√≥n P√∫blica (DACP)</h1>
                        <p class="text-gray-600">Herramienta para la gesti√≥n y control del proceso contractual.</p>
                    </header>
                    
                    <nav class="border-b border-gray-200 mb-6">
                        <div class="flex space-x-8 -mb-px">
                            <button onclick="handleTabClick('dashboard')" class="py-2 px-1 font-medium text-sm transition duration-150 ${state.activeTab === 'dashboard' ? 'tab-active' : 'text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 border-transparent'}">
                                üìä Matriz DACP
                            </button>
                            <button onclick="handleTabClick('checklist')" class="py-2 px-1 font-medium text-sm transition duration-150 ${state.activeTab === 'checklist' ? 'tab-active' : 'text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 border-transparent'}">
                                üìù Checklist de Contratos
                            </button>
                            <button onclick="handleTabClick('manager')" class="py-2 px-1 font-medium text-sm transition duration-150 ${state.activeTab === 'manager' ? 'tab-active' : 'text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 border-transparent'}">
                                üìà Manager / Consolidaci√≥n
                            </button>
                        </div>
                    </nav>

                    ${content}
                </div>
            `;
        }
        
        // Funci√≥n auxiliar para el manejo de filtros (se mantiene igual)
        function handleFilterChange(field, value) {
            if (field === 'filtroTipo') {
                setState({ filtroTipo: value });
            } else if (field === 'filtroCumplimiento') {
                // Mapear 'Pendiente' del filtro a un valor nulo para el estado
                const status = value === 'Pendiente' ? null : value;
                setState({ filtroCumplimiento: status });
            }
        }
        
        
        // =================================================================
        // 8. INICIO DE LA APLICACI√ìN
        // =================================================================

        window.onload = async function() {
            // Exponer las funciones al √°mbito global para que el HTML pueda llamarlas
            window.handleActivityChange = handleActivityChange;
            window.handleChecklistChange = handleChecklistChange;
            window.handleCreateNewContract = handleCreateNewContract;
            window.handleContractSelectChange = handleContractSelectChange;
            window.handleManagerSelectChange = handleManagerSelectChange; // NUEVO
            window.exportToExcel = exportToExcel;
            window.exportChecklistToExcel = exportChecklistToExcel;
            window.exportManagerStatsToExcel = exportManagerStatsToExcel; // NUEVO
            window.getActividadesFiltradas = getActividadesFiltradas;
            window.getCurrentChecklist = getCurrentChecklist;
            window.getManagerChecklist = getManagerChecklist; // NUEVO
            window.processCSVFiles = processCSVFiles; // NUEVO: Importaci√≥n CSV
            window.handleFilterChange = handleFilterChange; // NUEVO

            
            // ‚ö†Ô∏è NUEVO: Mostrar mensaje de carga
            const root = document.getElementById('root');
            const loadingMessage = document.createElement('div');
            loadingMessage.innerHTML = '<p class="text-center text-xl text-blue-600 mt-20">Cargando datos de la nube, por favor espere...</p>';
            root.appendChild(loadingMessage);

            // Esperar a cargar los datos de la nube antes de renderizar
            await fetchStateFromCloud();
            
            // Remover el mensaje de carga
            root.removeChild(loadingMessage);

            // Finalmente, renderizar la aplicaci√≥n con los datos cargados
            renderApp();
        };

    </script>
</body>
</html>
