<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Auditor√≠a DACP - Contrataci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <style>
        /* Estilos base */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        /* === NUEVO CSS PARA LISTA DE CHEQUEO MULTI-CONTRATO === */
        .table-textarea {
            width: 100%;
            min-height: 40px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 0.875rem; /* sm */
        }
        /* Clase para pesta√±as activas */
        .tab-active {
            border-bottom-width: 2px;
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6; /* blue-500 */
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">

    <div id="root" class="p-4 sm:p-6">
    </div>

    <script>
        // =================================================================
        // 0. CONFIGURACI√ìN EN LA NUBE (Apps Script URL)
        // =================================================================

        // üü¢ ¬°URL ACTUALIZADA! Este es el √∫nico cambio.
        const API_URL = 'https://script.google.com/macros/s/AKfycbzD-DiWojvY3OdMkr_Bjy414kF7ltp3ZrEX-AvcptSleYDSMJ968GVU2Vuh8c7xdtZP/exec';


        // =================================================================
        // 1. DATA DEL DEPARTAMENTO ADMINISTRATIVO DE CONTRATACI√ìN P√öBLICA (DACP)
        // =================================================================

        // 1.1. Actividades (Matriz Principal) - (La matriz original de 16 √≠tems)
        const DEFAULT_DACP_ACTIVITIES = [
            { id: 1, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'ESTRUCTURACI√ìN DEL PROCESO DE CONTRATACI√ìN', informe: 'PENDIENTE DEFINIR', frecuencia: 'TRIMESTRAL', reportaA: 'PENDIENTE DEFINIR', importancia: 95, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 2, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'VALIDACION APLICATIVO CONTRATISTA', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 85, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 3, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'VALIDACION HOJA DE VIDA DE SIGEP', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 80, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 4, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'VALIDACION DE DOCUMENTOS CONTRACTUALES', informe: 'PENDIENTE DEFINIR', frecuencia: '3 DIAS A LA EJECUCI√ìN DEL CONTRATO', reportaA: 'PENDIENTE DEFINIR', importancia: 90, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 5, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'AFILIACI√ìN ARL', informe: 'PENDIENTE DEFINIR', frecuencia: '5 primeros dias de cada mes (mes vencido)', reportaA: 'PENDIENTE DEFINIR', importancia: 75, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 6, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'REQUERIR Y APOYAR EN LA ELABORACION DEL PLAN DE TRABAJO', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 85, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 7, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'REVISION DE INFORMES DE GESTI√ìN', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 85, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 8, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'SEGUIMIENTO A ACTIVIDADES DESIGNADAS', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 80, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 9, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'Actividades contractuales vs actividades presentadas', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 90, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 10, tipo: 'Interna', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'Informes mensual contratos de prestacion de servicios', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 85, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 11, tipo: 'Interna', proceso: 'DELEGACIONES', funcion: 'PENDIENTE DEFINIR', actividad: 'Gesti√≥n de solicitudes de delegaci√≥n especial de facultades contractuales', informe: 'PENDIENTE DEFINIR', frecuencia: 'Seg√∫n necesidad', reportaA: 'PENDIENTE DEFINIR', importancia: 95, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 12, tipo: 'Externa', proceso: 'GESTI√ìN CONTRACTUAL', funcion: 'PENDIENTE DEFINIR', actividad: 'Publicaciones informes de supervision en el SECOP II', informe: 'PENDIENTE DEFINIR', frecuencia: 'Mensualizada', reportaA: 'PENDIENTE DEFINIR', importancia: 90, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 13, tipo: 'Externa', proceso: 'DELEGACIONES', funcion: 'PENDIENTE DEFINIR', actividad: 'Remisi√≥n de solicitud formal con documentos precontractuales', informe: 'PENDIENTE DEFINIR', frecuencia: 'Seg√∫n necesidad', reportaA: 'PENDIENTE DEFINIR', importancia: 90, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 14, tipo: 'Externa', proceso: 'EVALUACI√ìN DE PROVEEDORES', funcion: 'PENDIENTE DEFINIR', actividad: 'Revaluaci√≥n de proveedores - Consolidaci√≥n en hoja de c√°lculo', informe: 'PENDIENTE DEFINIR', frecuencia: 'Semestralmente', reportaA: 'PENDIENTE DEFINIR', importancia: 70, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 15, tipo: 'Externa', proceso: 'GESTI√ìN DEL CONOCIMIENTO', funcion: 'PENDIENTE DEFINIR', actividad: 'Lecciones Aprendidas - Compras p√∫blicas frecuentes, riesgosas, complejas', informe: 'PENDIENTE DEFINIR', frecuencia: 'Anualmente', reportaA: 'PENDIENTE DEFINIR', importancia: 65, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 16, tipo: 'Externa', proceso: 'COMPRAS RESPONSABLES', funcion: 'PENDIENTE DEFINIR', actividad: 'Formatos de seguimiento - Sostenibilidad Ambiental, Inclusi√≥n Social e Innovaci√≥n', informe: 'PENDIENTE DEFINIR', frecuencia: 'Febrero y julio', reportaA: 'PENDIENTE DEFINIR', importancia: 70, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
        ];

        // 1.2. Plantilla de Lista de Chequeo (ACTUALIZADA con las 31 actividades del usuario)
        const INITIAL_ACTIVITIES = [
            // ETAPA: PLANEACI√ìN DEL CONTRATO (Items 1-9)
            { id: 1, etapa: 'Planeaci√≥n del Contrato', aspecto: 'Se cuenta con certificado de idoneidad', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 2, etapa: 'Planeaci√≥n del Contrato', aspecto: 'Acto de delegaci√≥n para contratar', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 3, etapa: 'Planeaci√≥n del Contrato', aspecto: 'Ficha tecnica', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 4, etapa: 'Planeaci√≥n del Contrato', aspecto: 'La necesidad del servicio est√° justificada y documentada.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 5, etapa: 'Planeaci√≥n del Contrato', aspecto: 'El contrato est√° incluido en el Plan Anual de Adquisiciones (PAA).', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 6, etapa: 'Planeaci√≥n del Contrato', aspecto: 'Se cuenta con estudio previo (El perfil, los costos, requisitos minimos de formaci√≥n y experiencia, tabla de honorarios acorde al valor asignado) y estudio de mercado.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 7, etapa: 'Planeaci√≥n del Contrato', aspecto: 'El objeto contractual est√° claramente definido y alineado con las funciones del √°rea.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 8, etapa: 'Planeaci√≥n del Contrato', aspecto: 'Existen CDP y RP debidamente aprobados.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 9, etapa: 'Planeaci√≥n del Contrato', aspecto: 'Se verificaron inhabilidades e incompatibilidades del contratista.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            
            // ETAPA: SELECCI√ìN Y CONTRATACI√ìN (Items 10-13)
            { id: 10, etapa: 'Selecci√≥n y Contrataci√≥n', aspecto: 'La modalidad de contrataci√≥n fue correctamente aplicada (OPS).', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 11, etapa: 'Selecci√≥n y Contrataci√≥n', aspecto: 'El proceso fue publicado en SECOP con los documentos requeridos.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 12, etapa: 'Selecci√≥n y Contrataci√≥n', aspecto: 'El contrato est√° firmado con todas las cl√°usulas exigidas.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 13, etapa: 'Selecci√≥n y Contrataci√≥n', aspecto: 'Existe acta de inicio y designaci√≥n formal de supervisor.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            
            // ETAPA: EJECUCI√ìN DEL CONTRATO (Items 14-18)
            { id: 14, etapa: 'Ejecuci√≥n del Contrato', aspecto: 'ARL (Afiliaci√≥n).', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 15, etapa: 'Ejecuci√≥n del Contrato', aspecto: 'Documento equivalente (Seguridad Social).', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 16, etapa: 'Ejecuci√≥n del Contrato', aspecto: 'El contratista entrega informes mensuales de gesti√≥n de actividades.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 17, etapa: 'Ejecuci√≥n del Contrato', aspecto: 'Los productos o entregables cumplen con el objeto contractual.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 18, etapa: 'Ejecuci√≥n del Contrato', aspecto: 'Los pagos se realizan solo contra informes aprobados por el supervisor (SECOP).', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },

            // ETAPA: CONTROL Y SUPERVISI√ìN (Items 19-21)
            { id: 19, etapa: 'Control y Supervisi√≥n', aspecto: 'El supervisor tiene designaci√≥n oficial y cumple sus funciones.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 20, etapa: 'Control y Supervisi√≥n', aspecto: 'Existen informes de supervisi√≥n con fechas y firmas.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 21, etapa: 'Control y Supervisi√≥n', aspecto: 'Entrega de documentos por parte del Supervisor a la DACP.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },

            // ETAPA: CIERRE Y LIQUIDACI√ìN (Items 22-24)
            { id: 22, etapa: 'Cierre y Liquidaci√≥n', aspecto: 'Existe acta de recibo final o informe de cumplimiento.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 23, etapa: 'Cierre y Liquidaci√≥n', aspecto: 'Se realiz√≥ la liquidaci√≥n del contrato (bilateral o unilateral).', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 24, etapa: 'Cierre y Liquidaci√≥n', aspecto: 'El cierre y liquidaci√≥n est√°n publicados en SECOP.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },

            // ETAPA: CALIDAD (ISO 9001) (Items 25-27)
            { id: 25, etapa: 'Calidad (ISO 9001)', aspecto: 'Se controla la documentaci√≥n y registros del proceso.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 26, etapa: 'Calidad (ISO 9001)', aspecto: 'El personal a cargo del proceso es competente y tiene formaci√≥n adecuada.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 27, etapa: 'Calidad (ISO 9001)', aspecto: 'Se hace seguimiento a indicadores del proceso (tiempos, cumplimiento, satisfacci√≥n).', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },

            // ETAPA: TRANSPARENCIA Y CUMPLIMIENTO (Items 28-31)
            { id: 28, etapa: 'Transparencia y Cumplimiento', aspecto: 'Cumple con la Ley 80, Ley 1150 y Decreto 1082 de 2015.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 29, etapa: 'Transparencia y Cumplimiento', aspecto: 'Toda la informaci√≥n contractual est√° publicada en SECOP.', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 30, etapa: 'Transparencia y Cumplimiento', aspecto: 'Se aplica la Ley 1712 de 2014 (Transparencia).', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 31, etapa: 'Transparencia y Cumplimiento', aspecto: 'Contratista y supervisor declaran ausencia de conflicto de intereses', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" }
        ];

        const INITIAL_CONTRACT_ID = "4125.010.26.1.001-2025";
        
        // Funci√≥n para inicializar datos de contrato de ejemplo (solo si la nube est√° vac√≠a)
        function loadInitialContracts() {
            // Devuelve un objeto con la plantilla como el primer contrato
            return {
                [INITIAL_CONTRACT_ID]: JSON.parse(JSON.stringify(INITIAL_ACTIVITIES))
            };
        }


        // =================================================================
        // 2. ESTADO DE LA APLICACI√ìN Y PERSISTENCIA (MIGRADO A LA NUBE)
        // =================================================================

        let state = {
            activeTab: 'dashboard',
            dacpActivities: [], // Se cargar√° desde la nube
            contracts: {},      // Objeto: { 'ID_Contrato': [Array de checklist] }
            currentContractId: INITIAL_CONTRACT_ID, // ID usado en la pesta√±a 'Lista de Chequeo'
            consolidatedContractId: null, // NUEVO: ID usado en la pesta√±a 'Manager'
            filtroTipo: 'Todos',
            filtroCumplimiento: 'Todos',
            charts: {
                barChart: null,
                pieChart: null,
                radarChart: null,
                stageChart: null,
                // NUEVO: Gr√°ficos del Manager
                managerRadarChart: null, 
                managerPieChart: null
            },
        };


        /**
         * LECTURA: Carga el estado inicial de la aplicaci√≥n desde Google Sheets.
         */
        async function fetchStateFromCloud() {
            console.log("Iniciando carga de datos desde Google Sheets...");
            try {
                // Petici√≥n GET al Apps Script (doGet)
                const response = await fetch(API_URL); 
                const data = await response.json();
                
                console.log("Datos cargados de la nube:", data);

                // --- 1. Cargar Actividades DACP ---
                const dacp = Array.isArray(data.dacpActivities) && data.dacpActivities.length > 0 
                    ? data.dacpActivities 
                    : DEFAULT_DACP_ACTIVITIES;

                // --- 2. Cargar Contratos (Checklists) ---
                const contracts = data.contracts && Object.keys(data.contracts).length > 0 
                    ? data.contracts 
                    : loadInitialContracts();
                    
                // --- 3. Establecer Contratos Activos y Manager IDs ---
                const contractKeys = Object.keys(contracts);
                const firstContractId = contractKeys[0] || INITIAL_CONTRACT_ID;
                
                const currentId = contractKeys.includes(state.currentContractId) 
                    ? state.currentContractId 
                    : firstContractId;
                
                // Si consolidatedContractId no existe, usa el primer ID disponible
                const consolidatedId = contractKeys.includes(state.consolidatedContractId) 
                    ? state.consolidatedContractId
                    : firstContractId;

                // Actualizar el estado global
                state.dacpActivities = dacp;
                state.contracts = contracts;
                state.currentContractId = currentId;
                state.consolidatedContractId = consolidatedId; // NUEVO
                state.activeTab = 'dashboard'; 

            } catch (error) {
                console.error("Error al cargar datos de la nube. Usando datos iniciales locales de emergencia.", error);
                // Fallback: usar datos iniciales si la carga falla
                state.dacpActivities = DEFAULT_DACP_ACTIVITIES;
                state.contracts = loadInitialContracts();
                state.consolidatedContractId = INITIAL_CONTRACT_ID;
            }
        }

        /**
         * ESCRITURA: Env√≠a todo el estado de persistencia (Activities y Contracts) a Google Sheets.
         */
        async function saveStateToCloud(newState) {
            // Actualiza el estado localmente primero
            state = { ...state, ...newState };

            const dataToSave = {
                dacpActivities: state.dacpActivities,
                contracts: state.contracts,
            };

            try {
                // Petici√≥n POST al Apps Script (doPost)
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Necesario para el flujo simple de Apps Script
                    headers: {
                        'Content-Type': 'text/plain', // Usar 'text/plain' para el Apps Script simple
                    },
                    body: JSON.stringify(dataToSave)
                });
                console.log("‚úÖ Datos enviados para guardar en la nube. Re-renderizando...");
            } catch (error) {
                console.error("‚ùå Error al guardar datos en la nube.", error);
                // NOTA: Con 'no-cors' la respuesta es opaca, este catch solo captura errores de red (ej. URL incorrecta).
                alert("Advertencia: No se pudieron guardar los cambios en la nube. Revisa la URL o la configuraci√≥n del Apps Script.");
            }
            
            // Una vez que se intenta guardar, se actualiza la interfaz
            destroyCharts();
            renderApp();
        }


        // Funci√≥n principal de actualizaci√≥n de estado que ahora llama a saveStateToCloud
        function setState(newState) {
            // Clonar la data para evitar mutaciones directas y asegurar que saveStateToCloud tenga la √∫ltima versi√≥n.
            const newDacpActivities = newState.dacpActivities ? JSON.parse(JSON.stringify(newState.dacpActivities)) : state.dacpActivities;
            const newContracts = newState.contracts ? JSON.parse(JSON.stringify(newState.contracts)) : state.contracts;
            
            saveStateToCloud({ 
                ...newState, 
                dacpActivities: newDacpActivities,
                contracts: newContracts 
            });
        }


        // =================================================================
        // 3. FUNCIONES DE MANEJO DE EVENTOS (Adaptadas a la nueva persistencia)
        // =================================================================
        
        /**
         * Retorna el checklist del contrato actualmente seleccionado en la pesta√±a 'Lista de Chequeo'.
         */
        function getCurrentChecklist() {
            return state.contracts[state.currentContractId] || INITIAL_ACTIVITIES;
        }

        /**
         * Retorna el checklist del contrato actualmente seleccionado en la pesta√±a 'Manager'.
         */
        function getManagerChecklist() {
            return state.contracts[state.consolidatedContractId] || [];
        }


        /**
         * Actualiza el valor de un campo espec√≠fico en una actividad DACP.
         */
        function actualizarItem(id, campo, valor) {
            const newData = state.dacpActivities.map(item =>
                item.id === id ? { ...item, [campo]: valor } : item
            );
            setState({ dacpActivities: newData });
        }

        /**
         * Manejador para los cambios de campos en la Matriz DACP.
         */
        function handleActivityChange(e) {
            const { name, value } = e.target;
            const [field, id] = name.split('_');
            const itemId = parseInt(id);

            if (field === 'cumplimiento') {
                const fecha = value ? new Date().toISOString().slice(0, 10) : '';
                const newData = state.dacpActivities.map(item =>
                    item.id === itemId ? { ...item, cumplimiento: value || null, fechaEvaluacion: fecha } : item
                );
                setState({ dacpActivities: newData });
            } else if (field === 'observaciones') {
                actualizarItem(itemId, 'observaciones', value);
            } else if (field === 'filtroTipo') {
                setState({ filtroTipo: value });
            } else if (field === 'filtroCumplimiento') {
                setState({ filtroCumplimiento: value });
            }
        }
        
        /**
         * Maneja el cambio de radio o textarea en la lista de chequeo de contratos.
         */
        function handleChecklistChange(id, campo, valor) {
            const currentChecklist = getCurrentChecklist();
            
            // 1. Clonar y aplicar el cambio al √≠tem correcto
            const newChecklist = currentChecklist.map(item => {
                if (item.id === id) {
                    const newItem = { ...item };
                    
                    // Si es un campo de cumplimiento (checkbox), desmarca los campos opuestos de la misma categor√≠a
                    if (campo.includes('Cumple') || campo.includes('No Cumple') || campo.includes('No Aplica')) {
                        const keysToClear = [
                            "SECOP II - Cumple", "SECOP II - No Cumple", 
                            "CARPETA FISICA - Cumple", "CARPETA FISICA - No Cumple", "CARPETA FISICA - No Aplica/ Parcialmente"
                        ].filter(key => key.includes(campo.split(' - ')[0]) && key !== campo); // Borra los hermanos de la misma columna
                        
                        // Si el checkbox se est√° *activando*
                        if (valor === 'X') {
                            keysToClear.forEach(key => newItem[key] = ""); // Borra los hermanos
                            newItem[campo] = 'X'; // Activa el propio campo
                        } else {
                             // Si el checkbox se est√° *desactivando*
                            newItem[campo] = '';
                        }
                    } else {
                        // Si es un textarea (evidencia, obs_fisica, obs_secop)
                        newItem[campo] = valor;
                    }
                    return newItem;
                }
                return item;
            });

            // 2. Crear el nuevo objeto de contratos actualizado
            const newContracts = {
                ...state.contracts,
                [state.currentContractId]: newChecklist
            };

            // 3. Llamar a setState para guardar en la nube y re-renderizar
            setState({ contracts: newContracts });
        }

        /**
         * Crea un nuevo contrato en el estado y lo activa.
         */
        function handleCreateNewContract() {
            const newId = prompt("Ingrese el ID del nuevo contrato:");
            if (newId && newId.trim() !== "" && !state.contracts[newId]) {
                // IMPORTANTE: Asegurar que se clona la lista de 31 √≠tems
                const newContracts = {
                    ...state.contracts,
                    [newId]: JSON.parse(JSON.stringify(INITIAL_ACTIVITIES)) // Clonar la plantilla de 31
                };
                setState({ contracts: newContracts, currentContractId: newId, consolidatedContractId: newId });
                alert(`Contrato ${newId} creado y activado.`);
            } else if (newId) {
                alert("El ID del contrato es inv√°lido o ya existe.");
            }
        }

        /**
         * Maneja el cambio de selecci√≥n del contrato activo en la pesta√±a de 'Lista de Chequeo'.
         */
        function handleContractSelectChange(e) {
            const newId = e.target.value;
            if (newId) {
                setState({ currentContractId: newId });
            }
        }

        /**
         * NUEVO: Maneja el cambio de selecci√≥n del contrato activo en la pesta√±a de 'Manager'.
         */
        function handleManagerSelectChange(e) {
            const newId = e.target.value;
            if (newId) {
                setState({ consolidatedContractId: newId });
            }
        }


        function destroyCharts() {
            if (state.charts.pieChart) state.charts.pieChart.destroy();
            if (state.charts.barChart) state.charts.barChart.destroy();
            if (state.charts.radarChart) state.charts.radarChart.destroy();
            if (state.charts.stageChart) state.charts.stageChart.destroy();
            if (state.charts.managerRadarChart) state.charts.managerRadarChart.destroy(); // NUEVO
            if (state.charts.managerPieChart) state.charts.managerPieChart.destroy(); // NUEVO
        }

        // =================================================================
        // 4. FUNCIONES DE EXPORTACI√ìN Y FILTRADO (Se mantienen igual)
        // =================================================================

        function exportToExcel(data, filename) {
            const csvRows = [];
            const headers = ["ID", "Tipo", "Proceso", "Funcion", "Actividad", "Frecuencia", "Importancia", "Cumplimiento", "Observaciones", "Fecha Evaluacion", "Informe", "Reporta A"];
            csvRows.push(headers.join(';'));
            for (const item of data) {
                const values = [
                    item.id,
                    item.tipo,
                    `"${String(item.proceso).replace(/"/g, '""')}"`,
                    `"${String(item.funcion).replace(/"/g, '""')}"`,
                    `"${String(item.actividad).replace(/"/g, '""')}"`,
                    `"${String(item.frecuencia).replace(/"/g, '""')}"`,
                    item.importancia,
                    item.cumplimiento || 'Pendiente',
                    `"${String(item.observaciones).replace(/"/g, '""')}"`,
                    item.fechaEvaluacion,
                    `"${String(item.informe).replace(/"/g, '""')}"`,
                    `"${String(item.reportaA).replace(/"/g, '""')}"`
                ];
                csvRows.push(values.join(';'));
            }
            const csvString = csvRows.join('\n');
            const blob = new Blob(["\uFEFF", csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function exportChecklistToExcel(contractId, data) {
            if (!data || data.length === 0) {
                alert("No hay datos para exportar.");
                return;
            }
            const csvRows = [];
            const headersRow1 = [ 
                "N¬∞", "Etapa / Criterio", "Aspecto a Verificar", 
                "SECOP II", "", 
                "CARPETA FISICA", "", "", 
                "Evidencia", "Observaciones Carpeta Fisica", "Observaciones SECOP II" 
            ];
            const headersRow2 = [ 
                "", "", "", 
                "Cumple", "No Cumple", 
                "Cumple", "No Cumple", "No Aplica/ Parcialmente",
                "", "", ""
            ];
            
            // Unir encabezados
            csvRows.push(headersRow1.join(';'));
            csvRows.push(headersRow2.join(';'));
            
            // Datos
            for (const item of data) {
                const values = [
                    item.id,
                    `"${String(item.etapa).replace(/"/g, '""')}"`,
                    `"${String(item.aspecto).replace(/"/g, '""')}"`,
                    item["SECOP II - Cumple"] === 'X' ? 'X' : '',
                    item["SECOP II - No Cumple"] === 'X' ? 'X' : '',
                    item["CARPETA FISICA - Cumple"] === 'X' ? 'X' : '',
                    item["CARPETA FISICA - No Cumple"] === 'X' ? 'X' : '',
                    item["CARPETA FISICA - No Aplica/ Parcialmente"] === 'X' ? 'X' : '',
                    `"${String(item.evidencia).replace(/"/g, '""')}"`,
                    `"${String(item.obs_fisica).replace(/"/g, '""')}"`,
                    `"${String(item.obs_secop).replace(/"/g, '""')}"`
                ];
                csvRows.push(values.join(';'));
            }

            const csvString = csvRows.join('\n');
            const filename = `Checklist_Contrato_${contractId || 'SinID'}.csv`;
            const blob = new Blob(["\uFEFF", csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        /**
         * NUEVA FUNCION: Exporta el resumen estad√≠stico de un contrato para el Manager.
         */
        function exportManagerStatsToExcel(contractId, stats) {
            const csvData = [];
            // Encabezados
            csvData.push(["M√©trica", "Valor"]);
            
            // M√©tricas principales
            csvData.push(["ID Contrato", contractId]);
            csvData.push(["Total √çtems (31)", stats.total]);
            csvData.push(["SECOP Cumple", stats.cumplidasSECOP]);
            csvData.push(["F√çSICA Cumple", stats.cumplidasFISICA]);
            csvData.push(["No Aplica/Parcial", stats.noAplicaParcial]);
            csvData.push(["Pendiente Evaluar", stats.pendienteNoEvaluado]);
            csvData.push(["Cumplimiento Total (%)", stats.pctCumplimientoTotal.toFixed(1) + "%"]);

            // Separador para detalle por etapa
            csvData.push([]);
            csvData.push(["DETALLE POR ETAPA", "Cumplimiento (%)"]);
            
            // Detalle por etapa
            Object.keys(stats.porEtapa).forEach(etapa => {
                csvData.push([
                    etapa, 
                    stats.porEtapa[etapa].pctCumplimiento.toFixed(1) + "%"
                ]);
            });

            // Convertir a CSV String
            const csvRows = csvData.map(row => row.join(';'));
            const csvString = csvRows.join('\n');
            const filename = `Resumen_Contrato_${contractId || 'SinID'}_Manager.csv`;
            const blob = new Blob(["\uFEFF", csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function getActividadesFiltradas() {
            return state.dacpActivities.filter(act => {
                const matchTipo = state.filtroTipo === 'Todos' || act.tipo === state.filtroTipo;
                const matchCumplimiento = state.filtroCumplimiento === 'Todos' || 
                                          (state.filtroCumplimiento === 'Pendiente' && (act.cumplimiento === null || act.cumplimiento === '')) || 
                                          act.cumplimiento === state.filtroCumplimiento;
                return matchTipo && matchCumplimiento;
            });
        }

        // =================================================================
        // 5. C√ÅLCULO DE ESTAD√çSTICAS Y RENDERING
        // =================================================================

        function calcularEstadisticas(data, complianceField = 'cumplimiento') {
            const evaluadas = data.filter(a => a[complianceField] !== null && a[complianceField] !== '');
            const cumple = evaluadas.filter(a => a[complianceField] === 'Cumple').length;
            const noCumple = evaluadas.filter(a => a[complianceField] === 'No Cumple').length;
            const parcial = evaluadas.filter(a => a[complianceField] === 'Parcial').length;
            const pendiente = data.length - evaluadas.length;

            return {
                total: data.length,
                evaluadas: evaluadas.length,
                pendiente: pendiente,
                cumple: cumple,
                noCumple: noCumple,
                parcial: parcial,
                pctCumple: evaluadas.length > 0 ? (cumple / evaluadas.length) * 100 : 0
            };
        }

        /**
         * Calcula estad√≠sticas para la Lista de Chequeo de Contrataci√≥n (31 √≠tems).
         */
        function calculateChecklistStats(checklist) {
            const stats = {
                total: checklist.length,
                cumplidasSECOP: 0,
                noCumplidasSECOP: 0,
                cumplidasFISICA: 0,
                noCumplidasFISICA: 0,
                noAplicaParcial: 0,
                pendienteNoEvaluado: 0,
                porEtapa: {}
            };

            const etapas = Array.from(new Set(checklist.map(item => item.etapa)));

            // 1. Inicializar y calcular totales globales
            checklist.forEach(item => {
                const secopCumple = item["SECOP II - Cumple"] === 'X';
                const fisicaCumple = item["CARPETA FISICA - Cumple"] === 'X';
                // Se considera "no evaluado" si NO hay NING√öN checkbox marcado en NINGUNA de las 5 columnas
                const noEvaluada = !secopCumple && item["SECOP II - No Cumple"] !== 'X' && 
                                   !fisicaCumple && item["CARPETA FISICA - No Cumple"] !== 'X' && item["CARPETA FISICA - No Aplica/ Parcialmente"] !== 'X';

                if (secopCumple) stats.cumplidasSECOP++;
                if (item["SECOP II - No Cumple"] === 'X') stats.noCumplidasSECOP++;
                
                if (fisicaCumple) stats.cumplidasFISICA++;
                if (item["CARPETA FISICA - No Cumple"] === 'X') stats.noCumplidasFISICA++;
                if (item["CARPETA FISICA - No Aplica/ Parcialmente"] === 'X') stats.noAplicaParcial++;
                
                if (noEvaluada) stats.pendienteNoEvaluado++;
            });
            
            // C√ÅLCULO DE CUMPLIMIENTO TOTAL
            // Contamos los cumplimientos totales (SECOP Cumple + FISICA Cumple)
            const cumplimientosTotales = stats.cumplidasSECOP + stats.cumplidasFISICA;
            // El total de posibles √≠tems de cumplimiento a evaluar es: Total de √≠tems * 2 (SECOP y FISICA)
            // Se asume que, idealmente, todos deber√≠an ser "Cumple" en ambas categor√≠as.
            const totalItemsPotenciales = stats.total * 2; 

            stats.pctCumplimientoTotal = totalItemsPotenciales > 0 
                ? (cumplimientosTotales / totalItemsPotenciales) * 100 
                : 0;

            // 2. Calcular estad√≠sticas por etapa (para el Radar Chart)
            etapas.forEach(etapa => {
                const itemsEtapa = checklist.filter(item => item.etapa === etapa);
                const totalEtapa = itemsEtapa.length;
                let secopCumple = 0;
                let fisicaCumple = 0;
                
                itemsEtapa.forEach(item => {
                    if (item["SECOP II - Cumple"] === 'X') secopCumple++;
                    if (item["CARPETA FISICA - Cumple"] === 'X') fisicaCumple++;
                });

                const cumplidasTotalEtapa = secopCumple + fisicaCumple;

                // Porcentaje de cumplimiento basado en las 2 verificaciones por √≠tem (SECOP y F√çSICA)
                const totalPotencialEtapa = totalEtapa * 2; 

                stats.porEtapa[etapa] = {
                    total: totalEtapa,
                    pctCumplimiento: totalPotencialEtapa > 0 ? (cumplidasTotalEtapa / totalPotencialEtapa) * 100 : 0
                };
            });

            return stats;
        }

        function renderDashboardCharts(actStats) {
            // Destruir gr√°ficos anteriores
            if (state.charts.pieChart) state.charts.pieChart.destroy();
            if (state.charts.barChart) state.charts.barChart.destroy();
            
            // Gr√°fico de Pastel (Cumplimiento General)
            const pieCtx = document.getElementById('compliancePieChart')?.getContext('2d');
            if (pieCtx) {
                state.charts.pieChart = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: ['‚úì Cumple', '‚úó No Cumple', '‚óê Parcialmente', 'Pendiente'],
                        datasets: [{
                            data: [actStats.cumple, actStats.noCumple, actStats.parcial, actStats.pendiente],
                            backgroundColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)', 'rgb(245, 158, 11)', 'rgb(107, 114, 128)'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Gr√°fico de Barras (Cumplimiento por Tipo de Actividad)
            const barCtx = document.getElementById('typeBarChart')?.getContext('2d');
            if (barCtx) {
                const interna = state.dacpActivities.filter(a => a.tipo === 'Interna');
                const externa = state.dacpActivities.filter(a => a.tipo === 'Externa');
                const statsInterna = calcularEstadisticas(interna);
                const statsExterna = calcularEstadisticas(externa);

                state.charts.barChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Interna', 'Externa'],
                        datasets: [
                            {
                                label: 'Cumple',
                                data: [statsInterna.cumple, statsExterna.cumple],
                                backgroundColor: 'rgb(34, 197, 94)',
                            },
                            {
                                label: 'No Cumple',
                                data: [statsInterna.noCumple, statsExterna.noCumple],
                                backgroundColor: 'rgb(239, 68, 68)',
                            },
                            {
                                label: 'Parcial',
                                data: [statsInterna.parcial, statsExterna.parcial],
                                backgroundColor: 'rgb(245, 158, 11)',
                            },
                            {
                                label: 'Pendiente',
                                data: [statsInterna.pendiente, statsExterna.pendiente],
                                backgroundColor: 'rgb(107, 114, 128)',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function renderChecklistStageRadar(checklist) {
            // Destruir gr√°fico anterior
            if (state.charts.stageChart) state.charts.stageChart.destroy();
            
            const stats = calculateChecklistStats(checklist);
            const etapas = Object.keys(stats.porEtapa);
            const scores = etapas.map(e => stats.porEtapa[e].pctCumplimiento);

            const ctx = document.getElementById('checklistRadarChart')?.getContext('2d');
            if (ctx) {
                state.charts.stageChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: etapas,
                        datasets: [{
                            label: '% Cumplimiento (SECOP + Carpeta F√≠sica)',
                            data: scores,
                            backgroundColor: 'rgba(16, 185, 129, 0.2)', // emerald-500
                            borderColor: 'rgba(16, 185, 129, 1)',
                            pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                            pointBorderColor: '#fff',
                            borderWidth: 1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                suggestedMin: 0,
                                suggestedMax: 100,
                                pointLabels: {
                                    font: { size: 10 }
                                },
                                ticks: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: true, position: 'bottom' }
                        }
                    }
                });
            }
        }

        // NUEVA FUNCI√ìN: Renderiza el gr√°fico de Radar para el Manager
        function renderManagerRadarChart(stats) {
            if (state.charts.managerRadarChart) state.charts.managerRadarChart.destroy();
            
            const etapas = Object.keys(stats.porEtapa);
            const scores = etapas.map(e => stats.porEtapa[e].pctCumplimiento);

            const ctx = document.getElementById('managerRadarChart')?.getContext('2d');
            if (ctx) {
                state.charts.managerRadarChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: etapas,
                        datasets: [{
                            label: '% Cumplimiento por Etapa',
                            data: scores,
                            backgroundColor: 'rgba(251, 191, 36, 0.4)', // amber-400
                            borderColor: 'rgb(251, 191, 36)',
                            pointBackgroundColor: 'rgb(251, 191, 36)',
                            pointBorderColor: '#fff',
                            borderWidth: 1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                suggestedMin: 0,
                                suggestedMax: 100,
                                pointLabels: {
                                    font: { size: 12 }
                                },
                                ticks: { 
                                    display: true, 
                                    stepSize: 25, 
                                    backdropColor: 'rgba(0, 0, 0, 0)' // Fondo transparente para los ticks
                                } 
                            }
                        },
                        plugins: {
                            legend: { display: true, position: 'bottom' }
                        }
                    }
                });
            }
        }

        // NUEVA FUNCI√ìN: Renderiza el gr√°fico de Pastel/Donut para el Manager
        function renderManagerPieChart(stats) {
            if (state.charts.managerPieChart) state.charts.managerPieChart.destroy();
            
            // Cumplidas = SECOP Cumple + F√çSICA Cumple
            const cumplidas = stats.cumplidasSECOP + stats.cumplidasFISICA; 
            // No Cumplidas = SECOP No Cumple + F√çSICA No Cumple
            const noCumplidas = stats.noCumplidasSECOP + stats.noCumplidasFISICA;
            const noAplicaParcial = stats.noAplicaParcial;
            const pendienteNoEvaluado = stats.pendienteNoEvaluado;

            const ctx = document.getElementById('managerPieChart')?.getContext('2d');
            if (ctx) {
                state.charts.managerPieChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['‚úì Cumple', '‚úó No Cumple', '‚óê N/A o Parcial', 'Pendiente Evaluar'],
                        datasets: [{
                            data: [cumplidas, noCumplidas, noAplicaParcial, pendienteNoEvaluado > 0 ? pendienteNoEvaluado : 0],
                            backgroundColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)', 'rgb(251, 191, 36)', 'rgb(107, 114, 128)'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: `Cumplimiento Total (${stats.pctCumplimientoTotal.toFixed(1)}%)`,
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
            }
        }


        // --- Componentes de UI (Cards) ---

        function renderStatsCard(stats) {
            return `
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    ${renderStatItem('Total Actividades', stats.total, 'bg-blue-100 text-blue-800')}
                    ${renderStatItem('Evaluadas', stats.evaluadas, 'bg-indigo-100 text-indigo-800')}
                    ${renderStatItem('Pendientes', stats.pendiente, 'bg-gray-100 text-gray-800')}
                    ${renderStatItem('Cumplimiento (%)', stats.evaluadas > 0 ? (stats.cumple / stats.evaluadas * 100).toFixed(1) : 0, 'bg-green-100 text-green-800')}
                </div>
            `;
        }

        function renderStatItem(title, value, colorClass) {
            return `
                <div class="p-4 bg-white rounded-lg shadow-md border border-gray-200">
                    <p class="text-sm font-medium text-gray-500">${title}</p>
                    <p class="text-2xl font-bold ${colorClass}">${value}</p>
                </div>
            `;
        }

        // --- Funciones de Renderizaci√≥n de Pesta√±as ---

        function renderDACPActivities() {
            const filteredActivities = getActividadesFiltradas();
            const stats = calcularEstadisticas(state.dacpActivities);
            const activitiesHtml = filteredActivities.map(act => {
                const bgColor = act.cumplimiento === 'Cumple' ? 'bg-green-50' : 
                                act.cumplimiento === 'No Cumple' ? 'bg-red-50' : 
                                act.cumplimiento === 'Parcial' ? 'bg-amber-50' : 
                                'bg-white';
                
                return `
                    <tr class="hover:bg-gray-50 ${bgColor}">
                        <td class="p-3 whitespace-nowrap text-sm font-medium text-gray-900">${act.id}</td>
                        <td class="p-3 whitespace-nowrap text-xs text-gray-500">${act.tipo}</td>
                        <td class="p-3 text-sm text-gray-500">${act.proceso}</td>
                        <td class="p-3 text-sm text-gray-700 font-medium">${act.actividad}</td>
                        <td class="p-3 whitespace-nowrap text-center text-sm font-semibold text-indigo-600">${act.importancia}</td>
                        <td class="p-3 whitespace-nowrap w-32">
                            <select name="cumplimiento_${act.id}" onchange="handleActivityChange(event)" class="p-1 border rounded-md text-xs w-full ${act.cumplimiento === 'Cumple' ? 'bg-green-100 border-green-400' : act.cumplimiento === 'No Cumple' ? 'bg-red-100 border-red-400' : act.cumplimiento === 'Parcial' ? 'bg-amber-100 border-amber-400' : 'bg-white border-gray-300'}">
                                <option value="">Pendiente</option>
                                <option value="Cumple" ${act.cumplimiento === 'Cumple' ? 'selected' : ''}>Cumple</option>
                                <option value="No Cumple" ${act.cumplimiento === 'No Cumple' ? 'selected' : ''}>No Cumple</option>
                                <option value="Parcial" ${act.cumplimiento === 'Parcial' ? 'selected' : ''}>Parcial</option>
                            </select>
                        </td>
                        <td class="p-3 text-sm text-gray-500">${act.fechaEvaluacion || 'N/A'}</td>
                        <td class="p-3">
                            <textarea 
                                name="observaciones_${act.id}" 
                                onchange="handleActivityChange(event)" 
                                rows="2" 
                                class="table-textarea text-gray-700" 
                                placeholder="Escriba aqu√≠ las observaciones..."
                            >${act.observaciones}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');

            // Dibuja los gr√°ficos del dashboard
            renderDashboardCharts(stats);

            return `
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Matriz de Actividades DACP</h2>
                    
                    ${renderStatsCard(stats)}
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Distribuci√≥n General de Cumplimiento</h3>
                            <div style="height: 300px;">
                                <canvas id="compliancePieChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Cumplimiento por Tipo de Actividad</h3>
                            <div style="height: 250px;">
                                <canvas id="typeBarChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-center space-x-4 mb-6 p-4 bg-white rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="filtroTipo" class="text-sm font-medium text-gray-700">Filtrar por Tipo:</label>
                            <select id="filtroTipo" name="filtroTipo" onchange="handleActivityChange(event)" class="p-2 border rounded-lg text-sm">
                                <option value="Todos" ${state.filtroTipo === 'Todos' ? 'selected' : ''}>Todos</option>
                                <option value="Interna" ${state.filtroTipo === 'Interna' ? 'selected' : ''}>Interna</option>
                                <option value="Externa" ${state.filtroTipo === 'Externa' ? 'selected' : ''}>Externa</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="filtroCumplimiento" class="text-sm font-medium text-gray-700">Filtrar por Cumplimiento:</label>
                            <select id="filtroCumplimiento" name="filtroCumplimiento" onchange="handleActivityChange(event)" class="p-2 border rounded-lg text-sm">
                                <option value="Todos" ${state.filtroCumplimiento === 'Todos' ? 'selected' : ''}>Todos</option>
                                <option value="Cumple" ${state.filtroCumplimiento === 'Cumple' ? 'selected' : ''}>Cumple</option>
                                <option value="No Cumple" ${state.filtroCumplimiento === 'No Cumple' ? 'selected' : ''}>No Cumple</option>
                                <option value="Parcial" ${state.filtroCumplimiento === 'Parcial' ? 'selected' : ''}>Parcial</option>
                                <option value="Pendiente" ${state.filtroCumplimiento === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                            </select>
                        </div>
                        <button onclick="exportToExcel(getActividadesFiltradas(), 'Matriz_DACP_Auditoria.csv')" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 text-sm">
                            Exportar a Excel
                        </button>
                    </div>

                    <div class="overflow-x-auto bg-white shadow-lg rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">ID</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Tipo</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Proceso</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Actividad</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Imp.</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase w-32">Cumplimiento</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">F. Evaluaci√≥n</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase w-64">Observaciones</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${activitiesHtml}
                            </tbody>
                        </table>
                        ${filteredActivities.length === 0 ? '<p class="text-center p-4 text-gray-500">No hay actividades que coincidan con los filtros.</p>' : ''}
                    </div>
                </div>
            `;
        }

        function renderContractChecklist() {
            const contractIds = Object.keys(state.contracts);
            const checklist = getCurrentChecklist();
            const stats = calculateChecklistStats(checklist);

            // Dibuja el gr√°fico de radar
            renderChecklistStageRadar(checklist);

            const checklistHtml = checklist.map(item => {
                const etapa = item.etapa;
                const isEtapaHeader = item.id === checklist.find(i => i.etapa === etapa)?.id; // Solo el primer √≠tem de cada etapa

                return `
                    <tr class="hover:bg-gray-50 ${isEtapaHeader ? 'border-t-4 border-blue-200' : ''}">
                        ${isEtapaHeader ? `<td rowspan="${checklist.filter(i => i.etapa === etapa).length}" class="p-3 text-center text-sm font-semibold text-blue-700 align-top bg-blue-50">${etapa}</td>` : ''}
                        
                        <td class="p-3 whitespace-nowrap text-sm font-medium text-gray-900">${item.id}</td>
                        <td class="p-3 text-sm text-gray-700">${item.aspecto}</td>
                        
                        <td class="p-3 text-center">
                            <input type="checkbox" name="secop_cumple_${item.id}" 
                                   onchange="handleChecklistChange(${item.id}, 'SECOP II - Cumple', this.checked ? 'X' : '')"
                                   ${item["SECOP II - Cumple"] === 'X' ? 'checked' : ''} 
                                   class="form-checkbox h-5 w-5 text-green-600 rounded">
                        </td>
                        <td class="p-3 text-center">
                            <input type="checkbox" name="secop_no_cumple_${item.id}"
                                   onchange="handleChecklistChange(${item.id}, 'SECOP II - No Cumple', this.checked ? 'X' : '')"
                                   ${item["SECOP II - No Cumple"] === 'X' ? 'checked' : ''} 
                                   class="form-checkbox h-5 w-5 text-red-600 rounded">
                        </td>

                        <td class="p-3 text-center">
                            <input type="checkbox" name="fisica_cumple_${item.id}" 
                                   onchange="handleChecklistChange(${item.id}, 'CARPETA FISICA - Cumple', this.checked ? 'X' : '')"
                                   ${item["CARPETA FISICA - Cumple"] === 'X' ? 'checked' : ''} 
                                   class="form-checkbox h-5 w-5 text-green-600 rounded">
                        </td>
                        <td class="p-3 text-center">
                            <input type="checkbox" name="fisica_no_cumple_${item.id}" 
                                   onchange="handleChecklistChange(${item.id}, 'CARPETA FISICA - No Cumple', this.checked ? 'X' : '')"
                                   ${item["CARPETA FISICA - No Cumple"] === 'X' ? 'checked' : ''} 
                                   class="form-checkbox h-5 w-5 text-red-600 rounded">
                        </td>
                        <td class="p-3 text-center">
                            <input type="checkbox" name="fisica_no_aplica_${item.id}" 
                                   onchange="handleChecklistChange(${item.id}, 'CARPETA FISICA - No Aplica/ Parcialmente', this.checked ? 'X' : '')"
                                   ${item["CARPETA FISICA - No Aplica/ Parcialmente"] === 'X' ? 'checked' : ''} 
                                   class="form-checkbox h-5 w-5 text-amber-600 rounded">
                        </td>
                        
                        <td class="p-3 w-48">
                            <textarea 
                                onchange="handleChecklistChange(${item.id}, 'evidencia', this.value)" 
                                rows="1" 
                                class="table-textarea text-xs" 
                                placeholder="Evidencia (Ej. Link/Doc)"
                            >${item.evidencia}</textarea>
                        </td>

                        <td class="p-3 w-48">
                            <textarea 
                                onchange="handleChecklistChange(${item.id}, 'obs_fisica', this.value)" 
                                rows="1" 
                                class="table-textarea text-xs" 
                                placeholder="Obs. Carpeta F√≠sica"
                            >${item.obs_fisica}</textarea>
                        </td>

                        <td class="p-3 w-48">
                            <textarea 
                                onchange="handleChecklistChange(${item.id}, 'obs_secop', this.value)" 
                                rows="1" 
                                class="table-textarea text-xs" 
                                placeholder="Obs. SECOP II"
                            >${item.obs_secop}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Lista de Chequeo de Contrataci√≥n</h2>
                    
                    <div class="flex flex-wrap items-center space-x-4 mb-6 p-4 bg-white rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="contract-select" class="text-sm font-medium text-gray-700">Contrato Activo:</label>
                            <select id="contract-select" onchange="handleContractSelectChange(event)" class="p-2 border rounded-lg text-sm font-bold">
                                ${contractIds.map(id => 
                                    `<option value="${id}" ${state.currentContractId === id ? 'selected' : ''}>${id}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <button onclick="handleCreateNewContract()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 text-sm">
                            + Nuevo Contrato
                        </button>
                        <button onclick="exportChecklistToExcel(state.currentContractId, getCurrentChecklist())" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 text-sm">
                            Exportar Checklist a Excel
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        ${renderStatItem('Total √çtems', stats.total, 'bg-blue-100 text-blue-800')}
                        ${renderStatItem('SECOP Cumple', stats.cumplidasSECOP, 'bg-green-100 text-green-800')}
                        ${renderStatItem('F√çSICA Cumple', stats.cumplidasFISICA, 'bg-green-100 text-green-800')}
                        ${renderStatItem('Cumplimiento Global', `${stats.pctCumplimientoTotal.toFixed(1)}%`, 'bg-indigo-100 text-indigo-800')}
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg mb-6 max-w-xl mx-auto">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">Cumplimiento por Etapa del Contrato</h3>
                        <div style="height: 350px;">
                            <canvas id="checklistRadarChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto bg-white shadow-lg rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200 text-xs">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th rowspan="2" scope="col" class="p-3 text-left font-semibold text-gray-600 uppercase border-b-2">Etapa / Criterio</th>
                                    <th rowspan="2" scope="col" class="p-3 text-left font-semibold text-gray-600 uppercase border-b-2">N¬∞</th>
                                    <th rowspan="2" scope="col" class="p-3 text-left font-semibold text-gray-600 uppercase border-b-2 w-48">Aspecto a Verificar</th>
                                    <th colspan="2" scope="colgroup" class="p-3 text-center font-semibold text-gray-600 uppercase border-b-2 bg-blue-100">SECOP II</th>
                                    <th colspan="3" scope="colgroup" class="p-3 text-center font-semibold text-gray-600 uppercase border-b-2 bg-green-100">CARPETA F√çSICA</th>
                                    <th rowspan="2" scope="col" class="p-3 text-left font-semibold text-gray-600 uppercase border-b-2 w-48">Evidencia</th>
                                    <th rowspan="2" scope="col" class="p-3 text-left font-semibold text-gray-600 uppercase border-b-2 w-48">Obs. Carpeta F√≠sica</th>
                                    <th rowspan="2" scope="col" class="p-3 text-left font-semibold text-gray-600 uppercase border-b-2 w-48">Obs. SECOP II</th>
                                </tr>
                                <tr>
                                    <th scope="col" class="p-3 text-center font-semibold text-green-700 uppercase bg-blue-100">Cumple</th>
                                    <th scope="col" class="p-3 text-center font-semibold text-red-700 uppercase bg-blue-100">No Cumple</th>
                                    <th scope="col" class="p-3 text-center font-semibold text-green-700 uppercase bg-green-100">Cumple</th>
                                    <th scope="col" class="p-3 text-center font-semibold text-red-700 uppercase bg-green-100">No Cumple</th>
                                    <th scope="col" class="p-3 text-center font-semibold text-amber-700 uppercase bg-green-100">N/A o Parcial</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${checklistHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // NUEVA FUNCI√ìN: Renderiza la pesta√±a Manager/Consolidado
        function renderConsolidatedManager() {
            const contractIds = Object.keys(state.contracts);
            const selectedContract = state.consolidatedContractId;

            if (!selectedContract) {
                return `<p class="text-center text-xl text-gray-500 mt-20">No hay contratos disponibles para consolidar.</p>`;
            }
            
            const checklist = getManagerChecklist();
            const stats = calculateChecklistStats(checklist);

            // Dibuja los gr√°ficos del manager
            renderManagerRadarChart(stats);
            renderManagerPieChart(stats);

            return `
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">M√≥dulo Manager: Consolidaci√≥n por Contrato</h2>
                    <p class="text-gray-600 mb-6">Seleccione un contrato para ver su resumen estad√≠stico de cumplimiento.</p>

                    <div class="flex flex-wrap items-center space-x-4 mb-6 p-4 bg-white rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="manager-select" class="text-sm font-medium text-gray-700">Contrato Seleccionado:</label>
                            <select id="manager-select" onchange="handleManagerSelectChange(event)" class="p-2 border rounded-lg text-sm font-bold text-blue-700">
                                ${contractIds.map(id => 
                                    `<option value="${id}" ${selectedContract === id ? 'selected' : ''}>${id}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <button onclick="exportManagerStatsToExcel(state.consolidatedContractId, calculateChecklistStats(getManagerChecklist()))" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 text-sm">
                            Exportar Resumen
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                        ${renderStatItem('ID Contrato', selectedContract, 'bg-blue-100 text-blue-800 col-span-1')}
                        ${renderStatItem('Cumplimiento Total', `${stats.pctCumplimientoTotal.toFixed(1)}%`, 'bg-green-100 text-green-800 col-span-2')}
                        ${renderStatItem('√çtems Pendientes', stats.pendienteNoEvaluado, 'bg-gray-100 text-gray-800 col-span-1')}
                        ${renderStatItem('N/A o Parcial', stats.noAplicaParcial, 'bg-amber-100 text-amber-800 col-span-1')}
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">Cumplimiento por Etapa del Contrato</h3>
                            <div style="height: 350px;">
                                <canvas id="managerRadarChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col justify-center">
                            <div style="height: 300px;">
                                <canvas id="managerPieChart"></canvas>
                            </div>
                            <p class="text-center text-sm text-gray-500 mt-4">La gr√°fica muestra la distribuci√≥n de cumplimiento de los 31 √≠tems.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Funci√≥n principal que renderiza el contenido seg√∫n la pesta√±a activa.
         */
        function renderApp() {
            const root = document.getElementById('root');
            if (!root) return;

            // 1. Renderizar la estructura base y la navegaci√≥n (fuera del 'root' pero en el mismo div)
            const navHtml = `
                <header class="bg-white shadow-sm sticky top-0 z-10 border-b border-gray-200">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center py-4">
                            <h1 class="text-3xl font-extrabold text-blue-700">Auditor√≠a DACP</h1>
                            <nav class="flex space-x-6">
                                <a href="#" id="tab-dashboard" onclick="setState({ activeTab: 'dashboard' })" class="py-2 text-lg font-medium text-gray-500 hover:text-blue-600 transition duration-150 ${state.activeTab === 'dashboard' ? 'tab-active' : ''}">Dashboard</a>
                                <a href="#" id="tab-checklist" onclick="setState({ activeTab: 'checklist' })" class="py-2 text-lg font-medium text-gray-500 hover:text-blue-600 transition duration-150 ${state.activeTab === 'checklist' ? 'tab-active' : ''}">Lista de Chequeo</a>
                                <a href="#" id="tab-manager" onclick="setState({ activeTab: 'manager' })" class="py-2 text-lg font-medium text-gray-500 hover:text-blue-600 transition duration-150 ${state.activeTab === 'manager' ? 'tab-active' : ''}">Manager</a>
                            </nav>
                        </div>
                    </div>
                </header>
            `;
            // Reemplazar el contenido de 'root' con la navegaci√≥n + contenido de la pesta√±a
            
            let contentHtml = '';
            if (state.activeTab === 'checklist') {
                contentHtml = renderContractChecklist();
            } else if (state.activeTab === 'manager') {
                contentHtml = renderConsolidatedManager();
            } else {
                contentHtml = renderDACPActivities();
            }
            
            root.innerHTML = navHtml + `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-10">${contentHtml}</div>`;
        }


        // =================================================================
        // 6. INICIO DE LA APLICACI√ìN
        // =================================================================

        window.onload = async function() {
            // 1. Exponer las funciones al √°mbito global para que el HTML pueda llamarlas
            window.setState = setState;
            window.handleActivityChange = handleActivityChange;
            window.handleChecklistChange = handleChecklistChange;
            window.handleCreateNewContract = handleCreateNewContract;
            window.handleContractSelectChange = handleContractSelectChange;
            window.handleManagerSelectChange = handleManagerSelectChange; 
            window.exportToExcel = exportToExcel;
            window.exportChecklistToExcel = exportChecklistToExcel;
            window.exportManagerStatsToExcel = exportManagerStatsToExcel; 
            window.getActividadesFiltradas = getActividadesFiltradas;
            window.getCurrentChecklist = getCurrentChecklist;
            window.getManagerChecklist = getManagerChecklist; 
            
            // ‚ö†Ô∏è NUEVO: Mostrar mensaje de carga
            const root = document.getElementById('root');
            const loadingMessage = document.createElement('div');
            loadingMessage.innerHTML = '<p class="text-center text-xl text-blue-600 mt-20">Cargando datos de la nube, por favor espere...</p>';
            root.appendChild(loadingMessage);

            // 2. Esperar a cargar los datos de la nube antes de renderizar
            await fetchStateFromCloud();
            
            // 3. Remover el mensaje de carga
            root.removeChild(loadingMessage);

            // 4. Finalmente, renderizar la aplicaci√≥n con los datos cargados
            renderApp();
        };

    </script>
</body>
</html>
