<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Consolidaci贸n DACP - Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <style>
        /* Estilos base */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        /* Estilos para el texto y textarea de la tabla */
        .table-textarea {
            width: 100%;
            min-height: 40px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 0.875rem; /* sm */
        }
        /* Clase para pesta帽as activas */
        .tab-active {
            border-bottom-width: 2px;
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6; /* blue-500 */
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">

    <div id="root" class="p-4 sm:p-6 max-w-7xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6">Panel de Consolidaci贸n y An谩lisis Contractual (Manager)</h1>
        
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <a id="tab-consolidacion" href="#" class="tab-item border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                    Consolidaci贸n de Datos
                </a>
                <a id="tab-analisis_general" href="#" class="tab-item border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">
                    An谩lisis General
                </a>
            </nav>
        </div>

        <div id="content-area" class="bg-white p-6 rounded-lg shadow-xl">
            <p class="text-center py-10 text-gray-500">Cargando contenido... Si este mensaje persiste, aseg煤rese de que el JavaScript est茅 habilitado.</p>
        </div>
    </div>

    <script>
        // =================================================================
        // 1. DATA CHECKLIST: LISTA DE CHEQUEO (31 TEMS) - BASE
        // =================================================================

        const INITIAL_CHECKLIST_ACTIVITIES = [
            // -------------------------
            // 1. Planeaci贸n del Contrato (tems 1 al 9)
            // -------------------------
            { id: 1, etapa: "Planeaci贸n del Contrato", aspecto: "Se cuenta con certificado de idoneidad", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 2, etapa: "Planeaci贸n del Contrato", aspecto: "Acto de delegaci贸n para contratar", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 3, etapa: "Planeaci贸n del Contrato", aspecto: "Ficha tecnica", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 4, etapa: "Planeaci贸n del Contrato", aspecto: "La necesidad del servicio est谩 justificada y documentada.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 5, etapa: "Planeaci贸n del Contrato", aspecto: "El contrato est谩 incluido en el Plan Anual de Adquisiciones (PAA).", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 6, etapa: "Planeaci贸n del Contrato", aspecto: "Se cuenta con estudio previo (El perfil, los costos, requisitos minimos de formaci贸n y experiencia, tabla de honorarios acorde al valor asignado) y estudio de mercado.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 7, etapa: "Planeaci贸n del Contrato", aspecto: "El objeto contractual est谩 claramente definido y alineado con las funciones del 谩rea.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 8, etapa: "Planeaci贸n del Contrato", aspecto: "Existen CDP y RP debidamente aprobados.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 9, etapa: "Planeaci贸n del Contrato", aspecto: "Se verificaron inhabilidades e incompatibilidades del contratista.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },

            // -------------------------
            // 2. Selecci贸n y Contrataci贸n (tems 10 al 13)
            // -------------------------
            { id: 10, etapa: "Selecci贸n y Contrataci贸n", aspecto: "La modalidad de contrataci贸n fue correctamente aplicada (OPS).", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 11, etapa: "Selecci贸n y Contrataci贸n", aspecto: "El proceso fue publicado en SECOP con los documentos requeridos.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 12, etapa: "Selecci贸n y Contrataci贸n", aspecto: "El contrato est谩 firmado con todas las cl谩usulas exigidas.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 13, etapa: "Selecci贸n y Contrataci贸n", aspecto: "Existe acta de inicio y designaci贸n formal de supervisor.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },

            // -------------------------
            // 3. Ejecuci贸n del Contrato (tems 14 al 18)
            // -------------------------
            { id: 14, etapa: "Ejecuci贸n del Contrato", aspecto: "ARL", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 15, etapa: "Ejecuci贸n del Contrato", aspecto: "Documento equivalente", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 16, etapa: "Ejecuci贸n del Contrato", aspecto: "El contratista entrega informes mensuales de gesti贸n de actividades.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 17, etapa: "Ejecuci贸n del Contrato", aspecto: "Los productos o entregables cumplen con el objeto contractual.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 18, etapa: "Ejecuci贸n del Contrato", aspecto: "Los pagos se realizan solo contra informes aprobados por el supervisor (SECOP).", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },

            // -------------------------
            // 4. Control y Supervisi贸n (tems 19 al 21)
            // -------------------------
            { id: 19, etapa: "Control y Supervisi贸n", aspecto: "El supervisor tiene designaci贸n oficial y cumple sus funciones.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 20, etapa: "Control y Supervisi贸n", aspecto: "Existen informes de supervisi贸n con fechas y firmas.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 21, etapa: "Control y Supervisi贸n", aspecto: "Entrega de documentos por parte del Supervisor a la DACP.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },

            // -------------------------
            // 5. Cierre y Liquidaci贸n (tems 22 al 24)
            // -------------------------
            { id: 22, etapa: "Cierre y Liquidaci贸n", aspecto: "Existe acta de recibo final o informe de cumplimiento.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 23, etapa: "Cierre y Liquidaci贸n", aspecto: "Se realiz贸 la liquidaci贸n del contrato (bilateral o unilateral).", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 24, etapa: "Cierre y Liquidaci贸n", aspecto: "El cierre y liquidaci贸n est谩n publicados en SECOP.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },

            // -------------------------
            // 6. Calidad (ISO 9001) (tems 25 al 27)
            // -------------------------
            { id: 25, etapa: "Calidad (ISO 9001)", aspecto: "Se controla la documentaci贸n y registros del proceso.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 26, etapa: "Calidad (ISO 9001)", aspecto: "El personal a cargo del proceso es competente y tiene formaci贸n adecuada.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 27, etapa: "Calidad (ISO 9001)", aspecto: "Se hace seguimiento a indicadores del proceso (tiempos, cumplimiento, satisfacci贸n).", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },

            // -------------------------
            // 7. Transparencia y Cumplimiento (tems 28 al 31)
            // -------------------------
            { id: 28, etapa: "Transparencia y Cumplimiento", aspecto: "Cumple con la Ley 80, Ley 1150 y Decreto 1082 de 2015.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 29, etapa: "Transparencia y Cumplimiento", aspecto: "Toda la informaci贸n contractual est谩 publicada en SECOP.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 30, etapa: "Transparencia y Cumplimiento", aspecto: "Se aplica la Ley 1712 de 2014 (Transparencia).", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 31, etapa: "Transparencia y Cumplimiento", aspecto: "Contratista y supervisor declaran ausencia de conflicto de intereses.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' }
        ];

        // =================================================================
        // 2. ESTADO Y LGICA DE ALMACENAMIENTO
        // =================================================================

        const ALL_CONTRACT_DATA_KEY = 'all_contract_data'; // Base de datos de consolidaci贸n

        // Funci贸n para cargar TODOS los datos de checklist
        function loadAllContractData() {
            const storedData = localStorage.getItem(ALL_CONTRACT_DATA_KEY);
            try {
                return storedData ? JSON.parse(storedData) : {};
            } catch (e) {
                console.error("Error al cargar la base de datos de consolidaci贸n:", e);
                return {};
            }
        }

        // Funci贸n para guardar TODOS los datos de checklist
        function saveAllContractData(data) {
            localStorage.setItem(ALL_CONTRACT_DATA_KEY, JSON.stringify(data));
        }

        // Carga la lista de contratos existentes a partir de los datos consolidados
        function loadContractList() {
            return Object.keys(loadAllContractData()).sort();
        }

        let state = {
            allContracts: loadContractList(),
            activeTab: 'consolidacion', // Default tab
            consolidatedData: loadAllContractData(),
            consolidatedContractId: null
        };

        // Inicializa el ID del contrato a mostrar si hay datos
        function loadConsolidationInitialState() {
            if (state.allContracts.length > 0) {
                state.consolidatedContractId = state.allContracts[0];
            }
        }
        loadConsolidationInitialState();

        function setState(newState) {
            state = { ...state, ...newState };

            // Guardar cambios en localStorage
            if (newState.consolidatedData) {
                 saveAllContractData(state.consolidatedData);
            }
            // Recargar la lista de contratos si hubo cambios en la consolidaci贸n
            state.allContracts = loadContractList(); 

            renderApp();
        }


        // =================================================================
        // 3. LGICA DE IMPORTACIN Y ANLISIS
        // =================================================================

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 3) return { headers: [], data: [] }; // Necesita al menos 3 filas (2 encabezados + 1 dato)

            // Usar un detector de separador (semicolon or comma)
            const getSeparator = (line) => line.includes(';') ? ';' : ',';
            const separator = getSeparator(lines[0]);

            // Funci贸n para limpiar y tokenizar una l铆nea CSV
            const tokenizeLine = (line) => {
                const row = [];
                let inQuotes = false;
                let currentField = '';
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    // Manejo de comillas para campos que contienen el separador
                    if (char === '"') {
                        inQuotes = !inQuotes;
                        continue;
                    }

                    if (char === separator && !inQuotes) {
                        row.push(currentField.trim().replace(/""/g, '"'));
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                row.push(currentField.trim().replace(/""/g, '"')); // ltimo campo
                return row.map(field => field.replace(/^\uFEFF/, '').trim()); // Quitar BOM y espacios
            };

            // Primera fila de encabezados (T铆tulos Generales)
            const headersRow1 = tokenizeLine(lines[0]);
            // Segunda fila de encabezados (Subt铆tulos de Cumplimiento)
            const headersRow2 = tokenizeLine(lines[1]);
            
            // Construir los encabezados funcionales de una sola fila
            const functionalHeaders = [];
            let currentGeneralHeader = ''; // Almacena el 煤ltimo header de la fila 1 que no est谩 vac铆o

            headersRow1.forEach((h1, index) => {
                const h2 = headersRow2[index] || '';
                
                const h1Trim = h1.trim();
                const h2Trim = h2.trim();

                if (h1Trim !== '') {
                    // Normalizar el header general: ASPECTO A VERIFICAR -> ASPECTO_A_VERIFICAR
                    currentGeneralHeader = h1Trim.toUpperCase().replace(/[\s\-\/\(\)]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
                }

                let finalHeader = '';

                if (h2Trim !== '') {
                    // Si hay subt铆tulo (Cumple, No Cumple, Parcialmente), se combina con el 煤ltimo header general
                    const h2Clean = h2Trim.toUpperCase().replace(/[\s\-\/\(\)]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
                    finalHeader = `${currentGeneralHeader}_${h2Clean}`;
                } else if (h1Trim !== '' && h2Trim === '') {
                    // Si es un header de una sola columna (N掳, Etapa, Aspecto, Evidencia, Obs)
                    finalHeader = currentGeneralHeader;
                } else if (h1Trim === '' && h2Trim !== '') {
                     // Si h1 es vac铆o pero h2 no (ej: la columna de "No Cumple" bajo "SECOP II")
                     const h2Clean = h2Trim.toUpperCase().replace(/[\s\-\/\(\)]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
                     finalHeader = `${currentGeneralHeader}_${h2Clean}`;
                } else {
                    // Columna completamente vac铆a (basura)
                    finalHeader = `COL_EXTRA_${index}`;
                }
                
                functionalHeaders.push(finalHeader);
            });
            
            // Mapeo final para asegurar la consistencia de los headers
            const finalNormalizedHeaders = functionalHeaders.map(h => {
                const clean = h.replace(/_+/g, '_').replace(/_$/, '');
                if (clean.startsWith('N_') || clean === 'ID') return 'ID';
                if (clean === 'ETAPA_CRITERIO') return 'ETAPA';
                // ** FIX APLICADO AQU **: Buscar cualquier header que contenga 'ASPECTO' o 'VERIFICAR'
                if (clean.includes('ASPECTO') || clean.includes('VERIFICAR')) return 'ASPECTO'; 
                
                if (clean === 'OBSERVACIONES_CARPETA_FISICA') return 'OBSERVACIONES_CARPETA_FISICA';
                if (clean === 'OBSERVACIONES_SECOP_II') return 'OBSERVACIONES_SECOP_II';
                
                // Mapeo de columnas de cumplimiento (para dar flexibilidad al usuario)
                if (clean === 'SECOP_II_CUMPLE') return 'SECOP_CUM';
                if (clean === 'SECOP_II_NO_CUMPLE') return 'SECOP_NCUM';
                if (clean === 'CARPETA_FISICA_CUMPLE') return 'FISICA_CUM';
                if (clean === 'CARPETA_FISICA_NO_CUMPLE') return 'FISICA_NCUM';
                if (clean.includes('CARPETA_FISICA_NO_APLICA') || clean.includes('CARPETA_FISICA_PARCIALMENTE')) return 'FISICA_PARCIAL';
                
                return clean;
            });
            
            // Limitar los datos a partir de la TERCERA fila
            const rows = lines.slice(2).map(tokenizeLine);

            // Mapear filas a objetos usando los encabezados funcionales
            const structuredData = rows.map(row => {
                const obj = {};
                finalNormalizedHeaders.forEach((header, index) => {
                    obj[header] = row[index] || '';
                });
                return obj;
            }).filter(obj => Object.values(obj).some(val => val.trim() !== '')); // Filtrar filas completamente vac铆as

            return { headers: finalNormalizedHeaders, data: structuredData, rawHeaders: { row1: headersRow1, row2: headersRow2 } };
        }

        function importCSV(file) {
            const reader = new FileReader();

            reader.onload = (e) => {
                const text = e.target.result;
                const { data: importedData, headers: functionalHeaders, rawHeaders } = parseCSV(text);

                // =================================================================
                // 1. Detecci贸n del ID del Contrato (CRUCIAL)
                // =================================================================
                
                let contractId = null;

                // Buscar el header largo que contenga el ID del Contrato (ej: NMERO DE CONTRATO No. 4125...)
                const contractHeaderIndex = rawHeaders.row1.findIndex(h => h.toUpperCase().includes('NMERO DE CONTRATO'));
                
                if (contractHeaderIndex !== -1) {
                    const longHeader = rawHeaders.row1[contractHeaderIndex];
                    // Usar Regex para extraer el ID: busca "No." o "No " seguido del ID
                    const match = longHeader.match(/No\.?\s*(.*)/i); 
                    if (match && match[1]) {
                        contractId = match[1].trim();
                    }
                }
                
                // Fallback final si a煤n no se encuentra (Usar nombre de archivo sin extensi贸n)
                if (!contractId || contractId.length < 5) {
                     contractId = file.name.replace(/\.[^/.]+$/, "").substring(0, 50); // Usar nombre de archivo
                     console.warn(`ID de contrato no encontrado en el archivo. Se usar谩 el nombre de archivo como ID: ${contractId}`);
                }


                if (importedData.length === 0) {
                    alert('El archivo CSV no contiene datos v谩lidos.');
                    return;
                }

                // =================================================================
                // 2. Mapeo de datos (USANDO EL TEXTO DEL ASPECTO)
                // =================================================================
                
                // Funci贸n de utilidad para normalizar texto (quita puntuaci贸n, convierte a may煤sculas, limpia espacios)
                const normalizeText = (text) => (text || '').toUpperCase().replace(/[^A-Z0-9\s]/g, '').replace(/\s+/g, ' ').trim();
                
                // Nombres de las columnas clave en los datos importados
                const ASPECTO_COL = functionalHeaders.find(h => h === 'ASPECTO');
                
                if (!ASPECTO_COL) {
                    alert('Error: La columna "Aspecto a Verificar" no se pudo identificar en el archivo. Aseg煤rese que el formato de encabezado sea correcto.');
                    return;
                }

                const newChecklist = INITIAL_CHECKLIST_ACTIVITIES.map(templateItem => {
                    
                    const normalizedTemplateAspect = normalizeText(templateItem.aspecto);
                    
                    // Buscar la fila de datos importados por el aspecto normalizado
                    const importedItem = importedData.find(item => {
                         const importedAspect = normalizeText(item[ASPECTO_COL]);
                         // Se usa una coincidencia flexible (uno incluye al otro) por si hay truncamiento
                         return importedAspect.includes(normalizedTemplateAspect) || normalizedTemplateAspect.includes(importedAspect);
                    });


                    if (importedItem) {
                        // Funci贸n de ayuda para obtener el valor del encabezado
                        const getVal = (internalField) => {
                            const actualHeaderKey = functionalHeaders.find(h => h === internalField);
                            return actualHeaderKey ? (importedItem[actualHeaderKey] || '').trim() : '';
                        };

                        // Mapear los datos importados a la estructura del state
                        // Se verifica si el campo contiene 'X', 'CUM', 'SI', o 'PARCIAL'
                        return {
                            ...templateItem,
                            SECOP_CUM: getVal('SECOP_CUM').toUpperCase().includes('X') || getVal('SECOP_CUM').toUpperCase().includes('CUM') || getVal('SECOP_CUM').toUpperCase().includes('SI') ? 'CUM' : null,
                            SECOP_NCUM: getVal('SECOP_NCUM').toUpperCase().includes('X') || getVal('SECOP_NCUM').toUpperCase().includes('NCUM') ? 'NCUM' : null,
                            FISICA_CUM: getVal('FISICA_CUM').toUpperCase().includes('X') || getVal('FISICA_CUM').toUpperCase().includes('CUM') || getVal('FISICA_CUM').toUpperCase().includes('SI') ? 'CUM' : null,
                            FISICA_NCUM: getVal('FISICA_NCUM').toUpperCase().includes('X') || getVal('FISICA_NCUM').toUpperCase().includes('NCUM') ? 'NCUM' : null,
                            // Parcial se acepta con 'X', 'PARCIAL', 'PARCIALMENTE', o 'APLICA' (por la columna)
                            FISICA_PARCIAL: getVal('FISICA_PARCIAL').toUpperCase().includes('X') || getVal('FISICA_PARCIAL').toUpperCase().includes('PARCIAL') || getVal('FISICA_PARCIAL').toUpperCase().includes('APLICA') ? 'PARCIAL' : null,

                            // Las observaciones se copian directamente
                            obs_fisica: getVal('OBSERVACIONES_CARPETA_FISICA'),
                            obs_secop: getVal('OBSERVACIONES_SECOP_II'),
                        };
                    }
                    return templateItem; // Si no se encuentra, devuelve la plantilla original (vac铆a)
                });

                // Actualizar la base de datos de consolidaci贸n
                const newConsolidatedData = {
                    ...state.consolidatedData,
                    [contractId]: newChecklist
                };

                alert(`隆Archivo de Contrato ${contractId} importado y consolidado exitosamente!`);

                setState({
                    consolidatedData: newConsolidatedData,
                    consolidatedContractId: contractId // Muestra el contrato reci茅n importado
                });
            };

            reader.onerror = () => {
                alert('Error al leer el archivo.');
            };

            // Intentar leer como UTF-8
            reader.readAsText(file, 'utf-8');
        }
        
        // Funci贸n para calcular estad铆sticas generales del Checklist consolidado (SIN CAMBIOS)
        function calculateChecklistStats() {
            const consolidatedData = state.consolidatedData;
            const stats = {
                totalContracts: Object.keys(consolidatedData).length,
                totalItems: 0,
                porEtapa: {}
            };

            // Inicializar las etapas
            const etapasUnicas = [...new Set(INITIAL_CHECKLIST_ACTIVITIES.map(item => item.etapa))];
            etapasUnicas.forEach(etapa => {
                 // Total de 铆tems de plantilla en esta etapa * Total de contratos
                 const itemsPerContract = INITIAL_CHECKLIST_ACTIVITIES.filter(i => i.etapa === etapa).length;
                 stats.porEtapa[etapa] = { total: itemsPerContract * stats.totalContracts, cum: 0, ncum: 0, parcial: 0 };
            });
            
            if (stats.totalContracts === 0) return stats;

            const allItems = Object.values(consolidatedData).flat();
            stats.totalItems = allItems.length; // Total Items Evaluados (Contratos * 31)


            allItems.forEach(item => {
                if (stats.porEtapa[item.etapa]) {
                    
                    // L贸gica para determinar el estado consolidado (SECOP O FISICA CUMPLEN)
                    
                    // Se considera CUMPLIDO si CUMPLE en FSICA o CUMPLE en SECOP
                    const isCum = item.FISICA_CUM === 'CUM' || item.SECOP_CUM === 'CUM';
                    // Se considera NO CUMPLIDO si NO CUMPLE en FSICA o NO CUMPLE en SECOP
                    // Se considera NO CUMPLIDO si es NCUM en CUALQUIERA
                    const isNcum = item.FISICA_NCUM === 'NCUM' || item.SECOP_NCUM === 'NCUM';
                    
                    // Se considera PARCIAL si est谩 marcado como PARCIAL en FSICA.
                    const isParcial = item.FISICA_PARCIAL === 'PARCIAL';
                    
                    // Prioridad de Conteo: NCUM > PARCIAL > CUM
                    if (isNcum) {
                        stats.porEtapa[item.etapa].ncum++;
                    } else if (isParcial) {
                         stats.porEtapa[item.etapa].parcial++;
                    } else if (isCum) {
                        stats.porEtapa[item.etapa].cum++;
                    } 
                    // Si no tiene marca, se queda sin contar en cum/ncum/parcial (se asume PENDIENTE).
                }
            });

            return stats;
        }

        // Funci贸n para calcular estad铆sticas de cumplimiento de un solo contrato
        function calculateSingleContractStats(contractId) {
            const checklist = state.consolidatedData[contractId];
            if (!checklist || checklist.length === 0) return null;

            const totalItems = INITIAL_CHECKLIST_ACTIVITIES.length; // Siempre 31 items
            let cum = 0;
            let ncum = 0;
            let parcial = 0;

            checklist.forEach(item => {
                // L贸gica para determinar el estado consolidado de CUMPLIMIENTO (SECOP O FISICA CUMPLEN)
                const isCum = item.FISICA_CUM === 'CUM' || item.SECOP_CUM === 'CUM';
                const isNcum = item.FISICA_NCUM === 'NCUM' || item.SECOP_NCUM === 'NCUM';
                const isParcial = item.FISICA_PARCIAL === 'PARCIAL';
                
                // Prioridad de Conteo: NCUM > PARCIAL > CUM
                if (isNcum) {
                    ncum++;
                } else if (isParcial) {
                     parcial++;
                } else if (isCum) {
                    cum++;
                }
                // Items sin marcar se cuentan como PENDIENTE
            });

            const evaluated = cum + ncum + parcial;
            const pendiente = totalItems - evaluated;

            return {
                id: contractId,
                totalItems: totalItems,
                cum: cum,
                ncum: ncum,
                parcial: parcial,
                pendiente: pendiente,
                // Porcentajes basados en el total de 31 铆tems
                pctCum: totalItems > 0 ? ((cum / totalItems) * 100).toFixed(1) : 0,
                pctNcum: totalItems > 0 ? ((ncum / totalItems) * 100).toFixed(1) : 0,
                pctParcial: totalItems > 0 ? ((parcial / totalItems) * 100).toFixed(1) : 0,
                pctPendiente: totalItems > 0 ? ((pendiente / totalItems) * 100).toFixed(1) : 0
            };
        }

        // =================================================================
        // 4. FUNCIONES DE RENDERIZADO
        // =================================================================

        // Renderizado para la tabla 
        function renderChecklistTable(activities) {
            const currentContractId = state.consolidatedContractId; 
            if (!activities || activities.length === 0) return '<p class="text-center py-4 text-gray-500">No hay 铆tems en la lista de chequeo para este contrato.</p>';

            let html = `
                <div class="overflow-x-auto shadow-md sm:rounded-lg mb-6">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="py-3 px-4 w-[5%]">ID</th>
                            <th scope="col" class="py-3 px-4 w-[15%]">Etapa</th>
                            <th scope="col" class="py-3 px-4 w-[30%]">Aspecto a Verificar</th>
                            <th scope="col" class="py-3 px-2 text-center" colspan="2">SECOP II</th>
                            <th scope="col" class="py-3 px-2 text-center" colspan="3">CARPETA FSICA</th>
                            <th scope="col" class="py-3 px-4 w-[15%]">Obs. Carpeta F铆sica</th>
                            <th scope="col" class="py-3 px-4 w-[15%]">Obs. SECOP II</th>
                        </tr>
                        <tr>
                            <th scope="col" class="py-2 px-4"></th>
                            <th scope="col" class="py-2 px-4"></th>
                            <th scope="col" class="py-2 px-4"></th>
                            <th scope="col" class="py-2 px-2 text-center">CUM</th>
                            <th scope="col" class="py-2 px-2 text-center">NCUM</th>
                            <th scope="col" class="py-2 px-2 text-center">CUM</th>
                            <th scope="col" class="py-2 px-2 text-center">NCUM</th>
                            <th scope="col" class="py-2 px-2 text-center">PARCIAL</th>
                            <th scope="col" class="py-2 px-4"></th>
                            <th scope="col" class="py-2 px-4"></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            activities.forEach(item => {
                html += `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="py-4 px-4 font-medium text-gray-900">${item.id}</td>
                        <td class="py-4 px-4">${item.etapa}</td>
                        <td class="py-4 px-4">${item.aspecto}</td>

                        <td class="text-center px-2 py-2">
                            <input type="checkbox"
                                data-item-id="${item.id}"
                                data-field="SECOP_CUM"
                                data-group="SECOP_II"
                                onchange="handleStatusChange(this)"
                                class="w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 cursor-pointer"
                                ${item.SECOP_CUM === 'CUM' ? 'checked' : ''}
                            >
                        </td>
                        <td class="text-center px-2 py-2">
                            <input type="checkbox"
                                data-item-id="${item.id}"
                                data-field="SECOP_NCUM"
                                data-group="SECOP_II"
                                onchange="handleStatusChange(this)"
                                class="w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500 cursor-pointer"
                                ${item.SECOP_NCUM === 'NCUM' ? 'checked' : ''}
                            >
                        </td>

                        <td class="text-center px-2 py-2">
                            <input type="checkbox"
                                data-item-id="${item.id}"
                                data-field="FISICA_CUM"
                                data-group="FISICA"
                                class="w-4 h-4 text-green-600 bg-gray-200 border-gray-300 rounded focus:ring-green-500 cursor-not-allowed"
                                ${item.FISICA_CUM === 'CUM' ? 'checked' : ''}
                                disabled
                            >
                        </td>
                        <td class="text-center px-2 py-2">
                            <input type="checkbox"
                                data-item-id="${item.id}"
                                data-field="FISICA_NCUM"
                                data-group="FISICA"
                                class="w-4 h-4 text-red-600 bg-gray-200 border-gray-300 rounded focus:ring-red-500 cursor-not-allowed"
                                ${item.FISICA_NCUM === 'NCUM' ? 'checked' : ''}
                                disabled
                            >
                        </td>
                        <td class="text-center px-2 py-2">
                            <input type="checkbox"
                                data-item-id="${item.id}"
                                data-field="FISICA_PARCIAL"
                                data-group="FISICA"
                                class="w-4 h-4 text-yellow-600 bg-gray-200 border-gray-300 rounded focus:ring-yellow-500 cursor-not-allowed"
                                ${item.FISICA_PARCIAL === 'PARCIAL' ? 'checked' : ''}
                                disabled
                            >
                        </td>

                        <td class="py-2 px-4">
                            <textarea 
                                class="table-textarea border border-gray-300 bg-gray-100 cursor-not-allowed" 
                                data-item-id="${item.id}" 
                                data-field="obs_fisica" 
                                rows="${(item.obs_fisica || '').split('\n').length + 1}"
                                disabled
                            >${item.obs_fisica || ''}</textarea>
                        </td>
                        <td class="py-2 px-4">
                            <textarea 
                                class="table-textarea border border-gray-300 focus:ring-blue-500 focus:border-blue-500" 
                                data-item-id="${item.id}" 
                                data-field="obs_secop" 
                                onblur="handleObsChange(this)"
                                rows="${(item.obs_secop || '').split('\n').length + 1}"
                            >${item.obs_secop || ''}</textarea>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                </div>
            `;
            return html;
        }


        // Renderizado para la pesta帽a CONSOLIDACIN (Manager)
        function renderConsolidationView() {
            const consolidatedIds = state.allContracts;
            let optionsHtml = consolidatedIds.map(id =>
                `<option value="${id}" ${id === state.consolidatedContractId ? 'selected' : ''}>Contrato ${id}</option>`
            ).join('');
            
            // Determinar si se puede exportar (si hay contratos cargados)
            const canExport = consolidatedIds.length > 0;
            const currentChecklist = state.consolidatedData[state.consolidatedContractId] || INITIAL_CHECKLIST_ACTIVITIES;

            let html = `
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Consolidaci贸n de Datos (Vista de Contratos)</h2>
                <div class="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 p-4 mb-6" role="alert">
                    <p class="font-bold">Vista del Consolidador</p>
                    <p>Utilice esta pesta帽a para **importar** los archivos CSV. Los campos de **Cumplimiento y Observaciones SECOP II** son **editables**. Los campos de **Carpeta F铆sica** est谩n **bloqueados** (solo lectura).</p>
                </div>

                <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-white shadow rounded-lg">
                    <label for="import-csv-file" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-md hover:bg-purple-600 transition duration-150 cursor-pointer">
                        Importar Archivo(s) CSV 
                    </label>
                    <input type="file" id="import-csv-file" accept=".csv" multiple class="hidden" />
                    
                    <button id="export-excel-btn" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 transition duration-150 ${!canExport ? 'opacity-50 cursor-not-allowed' : ''}" ${!canExport ? 'disabled' : ''}>
                        Exportar a Excel 猬锔
                    </button>

                    <label for="consolidated-contract-select" class="font-semibold text-gray-700 ml-8">Contrato Consolidado a Ver:</label>
                    <select id="consolidated-contract-select" class="p-2 border border-gray-300 rounded-md shadow-sm bg-white min-w-[150px]">
                        ${optionsHtml || '<option value="">-- Importe Contratos --</option>'}
                    </select>
                </div>
            `;

            if (consolidatedIds.length === 0) {
                html += '<p class="text-center text-gray-500 mt-10 p-10 bg-gray-50 rounded-lg shadow-inner">No hay datos consolidados. Por favor, importe uno o varios archivos CSV para comenzar.</p>';
            } else {
                // Renderizar la tabla en modo editable (con el bloqueo aplicado)
                html += renderChecklistTable(currentChecklist);
            }
            return html;
        }
        
        // Renderizado para la pesta帽a ANLISIS GENERAL (SIN CAMBIOS)
        function renderAnalisisGeneralView() {
            const chkStats = calculateChecklistStats();
            
            // Suma total de 铆tems Cumplidos y No Cumplidos a nivel consolidado
            const totalCumplidos = Object.values(chkStats.porEtapa).reduce((sum, etapa) => sum + etapa.cum, 0);
            const totalNoCumplidos = Object.values(chkStats.porEtapa).reduce((sum, etapa) => sum + etapa.ncum, 0);
            const totalItemsEvaluados = Object.values(chkStats.porEtapa).reduce((sum, etapa) => sum + etapa.total, 0);

            if (chkStats.totalContracts === 0) {
                 return `
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">An谩lisis Consolidado de la Auditor铆a</h2>
                    <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 mb-6" role="alert">
                        <p class="font-bold">Vista de An谩lisis</p>
                        <p>Muestra el rendimiento general de los contratos consolidados.</p>
                    </div>
                    <p class="text-center text-gray-500 mt-10 p-10 bg-gray-50 rounded-lg shadow-inner">
                        No hay contratos importados para generar el an谩lisis. Importe archivos CSV en la pesta帽a de Consolidaci贸n.
                    </p>
                `;
            }
            
            let html = `
                <h2 class="text-2xl font-bold text-gray-700 mb-4">An谩lisis Consolidado de la Auditor铆a</h2>
                
                <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 mb-6" role="alert">
                    <p class="font-bold">Vista de An谩lisis</p>
                    <p>Muestra el rendimiento general de los contratos consolidados.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-indigo-500 text-white p-6 rounded-lg shadow-md">
                        <p class="text-sm font-medium">Total de Contratos Consolidados</p>
                        <p class="text-4xl font-extrabold">${chkStats.totalContracts}</p>
                    </div>
                    <div class="bg-green-500 text-white p-6 rounded-lg shadow-md">
                        <p class="text-sm font-medium">tems Consolidados CUMPLEN</p>
                        <p class="text-4xl font-extrabold">${totalCumplidos}</p>
                        <p class="text-sm mt-1">${totalItemsEvaluados > 0 ? ((totalCumplidos / totalItemsEvaluados) * 100).toFixed(1) : 0}% del total</p>
                    </div>
                     <div class="bg-red-500 text-white p-6 rounded-lg shadow-md">
                        <p class="text-sm font-medium">tems Consolidados NO CUMPLEN</p>
                         <p class="text-4xl font-extrabold">${totalNoCumplidos}</p>
                         <p class="text-sm mt-1">${totalItemsEvaluados > 0 ? ((totalNoCumplidos / totalItemsEvaluados) * 100).toFixed(1) : 0}% del total</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md mb-8">
                    <h3 class="text-xl font-semibold mb-4">Cumplimiento Consolidado por Etapa</h3>
                    <canvas id="barChartEtapa"></canvas>
                </div>

                <h3 class="text-xl font-semibold mb-3">Estad铆sticas Detalladas de Cumplimiento por Etapa</h3>
                <div class="overflow-x-auto shadow-md sm:rounded-lg mb-8">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="py-3 px-6">Etapa</th>
                                <th scope="col" class="py-3 px-6 text-center">Total tems (Contratos*N)</th>
                                <th scope="col" class="py-3 px-6 text-center text-green-600">CUMPLEN (CUM)</th>
                                <th scope="col" class="py-3 px-6 text-center text-red-600">NO CUMPLEN (NCUM)</th>
                                <th scope="col" class="py-3 px-6 text-center text-yellow-600">PARCIAL / PENDIENTE</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.keys(chkStats.porEtapa).map(etapa => {
                                const data = chkStats.porEtapa[etapa];
                                const totalItemsEtapa = data.total;
                                // Parcial + Pendiente = Total de tems de la Etapa - Cumplen - No Cumplen
                                const pendienteParcial = totalItemsEtapa - data.cum - data.ncum; 
                                
                                return `
                                    <tr class="bg-white border-b hover:bg-gray-50">
                                        <td class="py-4 px-6 font-medium text-gray-900">${etapa}</td>
                                        <td class="py-4 px-6 text-center">${totalItemsEtapa}</td>
                                        <td class="py-4 px-6 text-center text-green-600 font-bold">${data.cum} (${totalItemsEtapa > 0 ? ((data.cum / totalItemsEtapa) * 100).toFixed(1) : 0}%)</td>
                                        <td class="py-4 px-6 text-center text-red-600 font-bold">${data.ncum} (${totalItemsEtapa > 0 ? ((data.ncum / totalItemsEtapa) * 100).toFixed(1) : 0}%)</td>
                                        <td class="py-4 px-6 text-center">${pendienteParcial}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <hr class="my-8 border-gray-200">
                
                <h3 class="text-2xl font-bold text-gray-700 mb-4">An谩lisis Detallado por Contrato</h3>
                <p class="mb-4 text-gray-600">Muestra el rendimiento de cada contrato individualmente respecto a los 31 铆tems de la lista de chequeo (Considerando CUM si es CUM en FSICA o SECOP).</p>

                <div class="overflow-x-auto shadow-md sm:rounded-lg">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="py-3 px-6">Contrato ID</th>
                                <th scope="col" class="py-3 px-6 text-center">Total tems</th>
                                <th scope="col" class="py-3 px-6 text-center text-green-600">CUMPLEN</th>
                                <th scope="col" class="py-3 px-6 text-center text-red-600">NO CUMPLEN</th>
                                <th scope="col" class="py-3 px-6 text-center text-yellow-600">PARCIAL</th>
                                <th scope="col" class="py-3 px-6 text-center text-gray-600">PENDIENTE</th>
                                <th scope="col" class="py-3 px-6 text-center font-bold text-indigo-600">Cumplimiento (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.allContracts.map(contractId => {
                                const contractStats = calculateSingleContractStats(contractId);
                                if (!contractStats) return ''; 

                                // Calcular el porcentaje total de CUMPLIMIENTO (Cumplen / Total de tems)
                                const overallPctCum = contractStats.pctCum;

                                return `
                                    <tr class="bg-white border-b hover:bg-gray-50">
                                        <td class="py-4 px-6 font-medium text-gray-900">${contractId}</td>
                                        <td class="py-4 px-6 text-center">${contractStats.totalItems}</td>
                                        <td class="py-4 px-6 text-center text-green-600 font-bold">${contractStats.cum} (${contractStats.pctCum}%)</td>
                                        <td class="py-4 px-6 text-center text-red-600 font-bold">${contractStats.ncum} (${contractStats.pctNcum}%)</td>
                                        <td class="py-4 px-6 text-center text-yellow-600 font-bold">${contractStats.parcial} (${contractStats.pctParcial}%)</td>
                                        <td class="py-4 px-6 text-center text-gray-600">${contractStats.pendiente} (${contractStats.pctPendiente}%)</td>
                                        <td class="py-4 px-6 text-center text-lg font-extrabold ${overallPctCum >= 90 ? 'text-green-700' : overallPctCum >= 70 ? 'text-orange-500' : 'text-red-700'}">${overallPctCum}%</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>

            `;
            return html;
        }

        function renderAnalysisCharts(chkStats) {
            // 1. Gr谩fico de Barras (Cumplimiento de Checklist por Etapa)
            const etapas = Object.keys(chkStats.porEtapa);
            const cumplidas = etapas.map(etapa => chkStats.porEtapa[etapa].cum);
            const noCumplidas = etapas.map(etapa => chkStats.porEtapa[etapa].ncum);

            const barCtx = document.getElementById('barChartEtapa')?.getContext('2d');
            if (barCtx) {
                // Destruir chart existente si lo hay
                if (window.barChartEtapa) {
                    window.barChartEtapa.destroy();
                }

                window.barChartEtapa = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: etapas,
                        datasets: [
                            {
                                label: 'Cumple',
                                data: cumplidas,
                                backgroundColor: 'rgba(16, 185, 129, 0.8)', // green-500
                            },
                            {
                                label: 'No Cumple',
                                data: noCumplidas,
                                backgroundColor: 'rgba(239, 68, 68, 0.8)', // red-500
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { stacked: true },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: { display: true, text: 'N煤mero de tems (Contratos Consolidados)' }
                            }
                        },
                        plugins: {
                            tooltip: { mode: 'index', intersect: false }
                        }
                    }
                });
            }
        }


        // Funci贸n principal de renderizado
        function renderApp() {
            const contentArea = document.getElementById('content-area');
            const tabItems = document.querySelectorAll('.tab-item');

            // 1. Activar pesta帽a correcta
            tabItems.forEach(item => {
                item.classList.remove('tab-active');
                if (item.id === `tab-${state.activeTab}`) {
                    item.classList.add('tab-active');
                }
            });

            // 2. Renderizar contenido
            let contentHtml = '';

            switch (state.activeTab) {
                case 'consolidacion':
                    contentHtml = renderConsolidationView();
                    break;
                case 'analisis_general':
                    contentHtml = renderAnalisisGeneralView();
                    break;
                default:
                    contentHtml = renderConsolidationView();
            }

            contentArea.innerHTML = contentHtml;

            // 3. Renderizar gr谩ficos y adjuntar listeners
            setTimeout(() => {
                if (state.activeTab === 'analisis_general' && state.allContracts.length > 0) {
                    const chkStats = calculateChecklistStats();
                    renderAnalysisCharts(chkStats);
                }

                // === LISTENERS GENERALES ===
                document.getElementById('tab-consolidacion')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    setState({ activeTab: 'consolidacion' });
                });
                document.getElementById('tab-analisis_general')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    setState({ activeTab: 'analisis_general' });
                });

                // === LISTENERS ESPECFICOS POR TAB ===
                if (state.activeTab === 'consolidacion') {
                    attachConsolidationListeners();
                }
            }, 50);
        }

        // =================================================================
        // 5. MANEJO DE EDICIN Y EXPORTACIN
        // =================================================================
        
        // Funci贸n para manejar el cambio de estado de cumplimiento (CUM/NCUM/PARCIAL)
        function handleStatusChange(checkboxElement) {
            // Esta funci贸n se llama SOLO para los checkboxes NO deshabilitados (SECOP II)
            const contractId = state.consolidatedContractId;
            const itemId = parseInt(checkboxElement.getAttribute('data-item-id'), 10);
            const field = checkboxElement.getAttribute('data-field'); // e.g., 'SECOP_CUM'
            const group = checkboxElement.getAttribute('data-group'); // Debe ser 'SECOP_II'
            const isChecked = checkboxElement.checked;

            if (!contractId || isNaN(itemId) || !state.consolidatedData[contractId]) {
                 console.error("Error: Datos insuficientes para actualizar el estado.");
                 return;
            }
            
            // Si por alguna raz贸n un checkbox deshabilitado llama esto, salir
            if (group !== 'SECOP_II') return;

            const checklist = state.consolidatedData[contractId];
            const itemIndex = checklist.findIndex(item => item.id === itemId);

            if (itemIndex !== -1) {
                const item = checklist[itemIndex];
                const currentItemElement = checkboxElement.closest('tr');

                // 1. L贸gica de exclusi贸n mutua: si se marca uno, se desmarcan los otros de su grupo
                let fieldsToClear = ['SECOP_CUM', 'SECOP_NCUM'];
                let newValue = null;

                if (field === 'SECOP_CUM') newValue = 'CUM';
                else if (field === 'SECOP_NCUM') newValue = 'NCUM';

                if (isChecked) {
                    // Desmarcar todos los dem谩s en el estado y en el DOM
                    fieldsToClear.filter(f => f !== field).forEach(otherField => {
                        item[otherField] = null;
                        const otherCheckbox = currentItemElement.querySelector(`input[data-field="${otherField}"]`);
                        if (otherCheckbox) otherCheckbox.checked = false;
                    });
                    
                    // Establecer el valor actual en el estado
                    item[field] = newValue;
                } else {
                    // Si el campo actual se desmarca, establecerlo a null
                    item[field] = null;
                }

                // 2. Guardar el estado
                saveAllContractData(state.consolidatedData);
                
                // 3. Dar feedback visual de que se guard贸
                currentItemElement.style.transition = 'background-color 0.2s';
                currentItemElement.classList.remove('bg-gray-50'); 
                currentItemElement.classList.add('bg-blue-100'); 
                setTimeout(() => {
                     currentItemElement.classList.remove('bg-blue-100');
                }, 500);
            }
        }
        
        // Funci贸n para manejar la edici贸n de observaciones (SECOP II)
        function handleObsChange(textareaElement) {
            // Esta funci贸n se llama SOLO para el textarea NO deshabilitado (Obs. SECOP II)
            if (textareaElement.disabled) return; 

            const contractId = state.consolidatedContractId;
            // Asegurarse de que el ID del item sea un n煤mero entero
            const itemId = parseInt(textareaElement.getAttribute('data-item-id'), 10); 
            const field = textareaElement.getAttribute('data-field'); // Debe ser 'obs_secop'
            const newValue = textareaElement.value;

            if (!contractId || isNaN(itemId) || !state.consolidatedData[contractId]) {
                 console.error("Error: Datos insuficientes para actualizar la observaci贸n.");
                 return;
            }

            const checklist = state.consolidatedData[contractId];
            const itemIndex = checklist.findIndex(item => item.id === itemId);

            if (itemIndex !== -1) {
                // Actualizar el valor en el objeto de estado directamente
                state.consolidatedData[contractId][itemIndex][field] = newValue;
                
                // Guardar la base de datos completa en localStorage.
                saveAllContractData(state.consolidatedData);
                
                // Dar feedback visual de que se guard贸 (borde del textarea)
                textareaElement.style.transition = 'border-color 0.2s';
                textareaElement.style.borderColor = 'green';
                setTimeout(() => {
                    textareaElement.style.borderColor = '#ddd'; // Revertir al color est谩ndar
                }, 1000);
            }
        }

        // **NUEVA FUNCIN** para Exportar datos a CSV/Excel
        function exportContractToCSV(contractId) {
            const checklist = state.consolidatedData[contractId];
            if (!checklist || checklist.length === 0) {
                alert('No hay datos para exportar en el contrato seleccionado.');
                return;
            }

            // Definici贸n de las cabeceras (2 filas para que coincida con el formato de importaci贸n)
            const headerRow1 = [
                "ID", "Etapa", "Aspecto a Verificar", 
                "SECOP II", "", 
                "CARPETA FSICA", "", "", 
                "Obs. Carpeta F铆sica", "Obs. SECOP II"
            ].join(';');

            const headerRow2 = [
                "", "", "", 
                "Cumple", "No Cumple", 
                "Cumple", "No Cumple", "Parcial", 
                "", ""
            ].join(';');

            let csvContent = headerRow1 + '\n' + headerRow2 + '\n';

            // Funci贸n para escapar comillas y manejar saltos de l铆nea dentro de un campo CSV
            const escapeCSV = (value) => {
                if (value === null || value === undefined) return '';
                let str = String(value).replace(/"/g, '""'); // Escapar comillas dobles
                // El punto y coma (;) es el separador. Si el campo contiene ';', '\n' o '"', lo rodeamos con comillas.
                if (str.includes(';') || str.includes('\n') || str.includes('"')) {
                    str = `"${str}"`; 
                }
                return str;
            };

            // Generar las filas de datos
            checklist.forEach(item => {
                const row = [
                    escapeCSV(item.id),
                    escapeCSV(item.etapa),
                    escapeCSV(item.aspecto),
                    // SECOP II
                    escapeCSV(item.SECOP_CUM ? 'X' : ''),
                    escapeCSV(item.SECOP_NCUM ? 'X' : ''),
                    // CARPETA FSICA (Campos bloqueados, pero se exportan sus valores)
                    escapeCSV(item.FISICA_CUM ? 'X' : ''),
                    escapeCSV(item.FISICA_NCUM ? 'X' : ''),
                    escapeCSV(item.FISICA_PARCIAL ? 'X' : ''),
                    // Observaciones
                    escapeCSV(item.obs_fisica),
                    escapeCSV(item.obs_secop)
                ].join(';');

                csvContent += row + '\n';
            });
            
            // Crear Blob y descargar el archivo con BOM para UTF-8, lo que ayuda a Excel
            const blob = new Blob([`\ufeff${csvContent}`], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement('a');
            
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `Consolidacion_Contrato_${contractId}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Su navegador no soporta la descarga autom谩tica. Intente usar un navegador moderno.');
            }
        }


        // Listeners para la Consolidaci贸n (Manager)
        function attachConsolidationListeners() {
            // Listener para Importar CSV
            document.getElementById('import-csv-file')?.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files.length > 0) {
                    // Procesar cada archivo individualmente
                    Array.from(files).forEach(file => {
                        importCSV(file);
                    });
                    // Limpiar el input para permitir la carga del mismo archivo de nuevo
                    e.target.value = null;
                }
            });

            // Listener para Exportar a Excel (CSV)
            document.getElementById('export-excel-btn')?.addEventListener('click', (e) => {
                const contractId = state.consolidatedContractId;
                if (contractId) {
                    exportContractToCSV(contractId);
                } else {
                    alert('Por favor, seleccione un contrato para exportar.');
                }
            });

            // Listener para selecci贸n de contrato consolidado
            document.getElementById('consolidated-contract-select')?.addEventListener('change', (e) => {
                const newId = e.target.value;
                setState({
                    consolidatedContractId: newId
                });
            });
        }


        // =================================================================
        // 6. INICIO DE LA APLICACIN
        // =================================================================

        window.onload = function() {
            // Exponer las funciones al 谩mbito global para que el HTML pueda llamarlas
            window.handleObsChange = handleObsChange;
            window.handleStatusChange = handleStatusChange;
            
            // Establecer la pesta帽a inicial como activa al cargar
            const initialTab = document.getElementById(`tab-${state.activeTab}`);
            if (initialTab) {
                 initialTab.classList.add('tab-active');
            }
            renderApp();
        };

    </script>
</body>
</html>