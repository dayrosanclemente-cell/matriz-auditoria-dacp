<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Auditoría DACP - Contratación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <style>
        /* Estilos base */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        /* === NUEVO CSS PARA LISTA DE CHEQUEO MULTI-CONTRATO === */
        .table-textarea {
            width: 100%;
            min-height: 40px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 0.875rem; /* sm */
        }
        /* Clase para pestañas activas */
        .tab-active {
            border-bottom-width: 2px;
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6; /* blue-500 */
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">

    <div id="root" class="p-4 sm:p-6">
        </div>

    <script>
        // =================================================================
        // 0. CONFIGURACIÓN EN LA NUBE (Apps Script URL)
        // =================================================================

        // ⚠️ ¡IMPORTANTE! REEMPLAZA ESTA URL con la URL de tu Web App de Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbxgOKML7_LAQ8BaEZC1Q1-3CmOxlCU5oSpuNQSgIpubX3je7G_o6cXYmiKXvTNAM_Ak/exec'; 


        // =================================================================
        // 1. DATA DEL DEPARTAMENTO ADMINISTRATIVO DE CONTRATACIÓN PÚBLICA (DACP)
        // =================================================================

        // 1.1. Actividades (Matriz Principal)
        const DEFAULT_DACP_ACTIVITIES = [
            { 
                id: 1, 
                tipo: 'Interna', 
                proceso: 'GESTIÓN CONTRACTUAL', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'ESTRUCTURACIÓN DEL PROCESO DE CONTRATACIÓN', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'TRIMESTRAL', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 95, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 2, 
                tipo: 'Interna', 
                proceso: 'GESTIÓN CONTRACTUAL', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'VALIDACION APLICATIVO CONTRATISTA', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'Mensualizada', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 85, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 3, 
                tipo: 'Interna', 
                proceso: 'GESTIÓN CONTRACTUAL', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'VALIDACION HOJA DE VIDA DE SIGEP', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'Mensualizada', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 80, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 4, 
                tipo: 'Interna', 
                proceso: 'GESTIÓN CONTRACTUAL', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'VALIDACION DE DOCUMENTOS CONTRACTUALES', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: '3 DIAS A LA EJECUCIÓN DEL CONTRATO', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 90, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 5, 
                tipo: 'Interna', 
                proceso: 'GESTIÓN CONTRACTUAL', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'AFILIACIÓN ARL', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: '5 primeros dias de cada mes (mes vencido)', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 75, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 6, 
                tipo: 'Interna', 
                proceso: 'GESTIÓN CONTRACTUAL', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'REQUERIR Y APOYAR EN LA ELABORACION DEL PLAN DE TRABAJO', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'Mensualizada', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 85, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 7, 
                tipo: 'Interna', 
                proceso: 'GESTIÓN CONTRACTUAL', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'REVISION DE INFORMES DE GESTIÓN', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'Mensualizada', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 85, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 8, 
                tipo: 'Interna', 
                proceso: 'GESTIÓN CONTRACTUAL', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'SEGUIMIENTO A ACTIVIDADES DESIGNADAS', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'Mensualizada', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 80, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 9, 
                tipo: 'Interna', 
                proceso: 'GESTIÓN CONTRACTUAL', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'Actividades contractuales vs actividades presentadas', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'Mensualizada', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 90, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 10, 
                tipo: 'Interna', 
                proceso: 'GESTIÓN CONTRACTUAL', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'Informes mensual contratos de prestacion de servicios', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'Mensualizada', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 85, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 11, 
                tipo: 'Interna', 
                proceso: 'DELEGACIONES', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'Gestión de solicitudes de delegación especial de facultades contractuales', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'Según necesidad', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 95, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },

            // ACTIVIDADES EXTERNAS (5)
            { 
                id: 12, 
                tipo: 'Externa', 
                proceso: 'GESTIÓN CONTRACTUAL', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'Publicaciones informes de supervision en el SECOP II', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'Mensualizada', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 90, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 13, 
                tipo: 'Externa', 
                proceso: 'DELEGACIONES', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'Remisión de solicitud formal con documentos precontractuales', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'Según necesidad', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 90, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 14, 
                tipo: 'Externa', 
                proceso: 'EVALUACIÓN DE PROVEEDORES', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'Revaluación de proveedores - Consolidación en hoja de cálculo', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'Semestralmente', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 70, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 15, 
                tipo: 'Externa', 
                proceso: 'GESTIÓN DEL CONOCIMIENTO', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'Lecciones Aprendidas - Compras públicas frecuentes, riesgosas, complejas', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'Anualmente', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 65, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
            { 
                id: 16, 
                tipo: 'Externa', 
                proceso: 'COMPRAS RESPONSABLES', 
                funcion: 'PENDIENTE DEFINIR', 
                actividad: 'Formatos de seguimiento - Sostenibilidad Ambiental, Inclusión Social e Innovación', 
                informe: 'PENDIENTE DEFINIR', 
                frecuencia: 'Febrero y julio', 
                reportaA: 'PENDIENTE DEFINIR', 
                importancia: 70, 
                cumplimiento: null, 
                observaciones: '', 
                fechaEvaluacion: '' 
            },
        ];

        // 1.2. Plantilla de Lista de Chequeo (54 ÍTEMS)
        const INITIAL_ACTIVITIES = [
            // ETAPA PRECONTRACTUAL (12 ítems)
            { id: 1, etapa: 'Precontractual', aspecto: 'Certificado de Disponibilidad Presupuestal (CDP)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 2, etapa: 'Precontractual', aspecto: 'Solicitud de disponibilidad (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 3, etapa: 'Precontractual', aspecto: 'Certificado de idoneidad y experiencia del contratista (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 4, etapa: 'Precontractual', aspecto: 'Registro Único Tributario (RUT)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 5, etapa: 'Precontractual', aspecto: 'Cédula de ciudadanía', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 6, etapa: 'Precontractual', aspecto: 'Certificado de antecedentes disciplinarios (procuraduría)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 7, etapa: 'Precontractual', aspecto: 'Certificado de antecedentes fiscales (contraloría)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 8, etapa: 'Precontractual', aspecto: 'Certificado de antecedentes judiciales (policía)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 9, etapa: 'Precontractual', aspecto: 'Certificado de la Contaduría General de la Nación (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 10, etapa: 'Precontractual', aspecto: 'Certificado de aportes al Sistema de Seguridad Social Integral (SSSI)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 11, etapa: 'Precontractual', aspecto: 'Declaración juramentada de bienes y rentas', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 12, etapa: 'Precontractual', aspecto: 'Formato único de hoja de vida', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            // ETAPA PLANEACIÓN DEL CONTRATO (12 ítems)
            { id: 13, etapa: 'Planeación del Contrato', aspecto: 'Justificación de la necesidad del contrato (Estudios Previos)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 14, etapa: 'Planeación del Contrato', aspecto: 'Acto de delegación para contratar (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 15, etapa: 'Planeación del Contrato', aspecto: 'Estudios del sector', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 16, etapa: 'Planeación del Contrato', aspecto: 'Análisis y justificación de las garantías', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 17, etapa: 'Planeación del Contrato', aspecto: 'Existencia y justificación de la matriz de riesgos', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 18, etapa: 'Planeación del Contrato', aspecto: 'Plan de Compras (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 19, etapa: 'Planeación del Contrato', aspecto: 'Costo del contrato y su justificación', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 20, etapa: 'Planeación del Contrato', aspecto: 'Modalidad de selección y su justificación', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 21, etapa: 'Planeación del Contrato', aspecto: 'Declaración de ausencia de conflicto de intereses', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 22, etapa: 'Planeación del Contrato', aspecto: 'Existencia de las pólizas que amparan el contrato', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 23, etapa: 'Planeación del Contrato', aspecto: 'Contrato y sus anexos', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 24, etapa: 'Planeación del Contrato', aspecto: 'Estudio de Mercado (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            // ETAPA SELECCIÓN Y ADJUDICACIÓN (4 ítems)
            { id: 25, etapa: 'Selección y Adjudicación', aspecto: 'Publicación del Proceso en SECOP II', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 26, etapa: 'Selección y Adjudicación', aspecto: 'Acto Administrativo de inicio del proceso', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 27, etapa: 'Selección y Adjudicación', aspecto: 'Acto de Adjudicación o Declaratoria de Desierta', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 28, etapa: 'Selección y Adjudicación', aspecto: 'Evaluación de las ofertas recibidas (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            // ETAPA EJECUCIÓN DEL CONTRATO (14 ítems)
            { id: 29, etapa: 'Ejecución del Contrato', aspecto: 'Contrato o acto administrativo que lo aprueba (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 30, etapa: 'Ejecución del Contrato', aspecto: 'Pólizas o garantías (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 31, etapa: 'Ejecución del Contrato', aspecto: 'Registro Presupuestal (RP)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 32, etapa: 'Ejecución del Contrato', aspecto: 'Acta de inicio', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 33, etapa: 'Ejecución del Contrato', aspecto: 'Plazo del contrato (cumplimiento)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 34, etapa: 'Ejecución del Contrato', aspecto: 'Informes de supervisión/interventoría', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 35, etapa: 'Ejecución del Contrato', aspecto: 'Comprobantes de pago/facturas', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 36, etapa: 'Ejecución del Contrato', aspecto: 'Modificaciones/adiciones (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 37, etapa: 'Ejecución del Contrato', aspecto: 'Cesiones/subcontratación (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 38, etapa: 'Ejecución del Contrato', aspecto: 'Acta de suspensión y/o reinicio (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 39, etapa: 'Ejecución del Contrato', aspecto: 'Soporte del SSSI (Seguridad Social) al día', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 40, etapa: 'Ejecución del Contrato', aspecto: 'Garantías/Pólizas actualizadas (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 41, etapa: 'Ejecución del Contrato', aspecto: 'Existencia de mecanismos de supervisión', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 42, etapa: 'Ejecución del Contrato', aspecto: 'Publicación de informes de gestión en SECOP II', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            // ETAPA LIQUIDACIÓN Y CIERRE (12 ítems)
            { id: 43, etapa: 'Liquidación y Cierre', aspecto: 'Informe Final de Supervisión/Interventoría', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 44, etapa: 'Liquidación y Cierre', aspecto: 'Acta de recibo final/satisfacción', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 45, etapa: 'Liquidación y Cierre', aspecto: 'Acta de liquidación bilateral o unilateral', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 46, etapa: 'Liquidación y Cierre', aspecto: 'Paz y salvo del contratista/proveedor', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 47, etapa: 'Liquidación y Cierre', aspecto: 'Paz y salvo del supervisor/interventor', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 48, etapa: 'Liquidación y Cierre', aspecto: 'Constancia de terminación', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 49, etapa: 'Liquidación y Cierre', aspecto: 'Informe de gestión del conocimiento (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 50, etapa: 'Liquidación y Cierre', aspecto: 'Publicación del acta de liquidación en SECOP II', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 51, etapa: 'Liquidación y Cierre', aspecto: 'Traslado del expediente al archivo (si aplica)', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 52, etapa: 'Liquidación y Cierre', aspecto: 'Copia del contrato y anexos al contratista', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 53, etapa: 'Liquidación y Cierre', aspecto: 'Conciliación presupuestal', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
            { id: 54, etapa: 'Liquidación y Cierre', aspecto: 'Información oportuna a la oficina de talento humano', "SECOP II - Cumple": "", "SECOP II - No Cumple": "", "CARPETA FISICA - Cumple": "", "CARPETA FISICA - No Cumple": "", "CARPETA FISICA - No Aplica/ Parcialmente": "", evidencia: "", obs_fisica: "", obs_secop: "" },
        ];

        // 1.3. Estado Inicial
        const INITIAL_CONTRACT_ID = 'CONTRATO_001';
        const INITIAL_STATE = {
            dacpActivities: DEFAULT_DACP_ACTIVITIES,
            contracts: {
                [INITIAL_CONTRACT_ID]: JSON.parse(JSON.stringify(INITIAL_ACTIVITIES)) // Clonar
            },
            currentContractId: INITIAL_CONTRACT_ID,
            activeTab: 'dashboard',
            filtroTipo: 'Todos',
            filtroCumplimiento: 'Todos',
            charts: {} // Para guardar las instancias de Chart.js
        };

        let state = INITIAL_STATE;


        // =================================================================
        // 2. FUNCIONES DE UTILIDAD Y PERSISTENCIA (Cloud/Local)
        // =================================================================

        /**
         * Simula la carga de contratos iniciales si no hay datos de la nube.
         * En una app real, podrías cargar un contrato base o desde localStorage.
         */
        function loadInitialContracts() {
            return {
                [INITIAL_CONTRACT_ID]: JSON.parse(JSON.stringify(INITIAL_ACTIVITIES))
            };
        }

        /**
         * Carga el estado de la aplicación desde Google Sheets/Apps Script.
         * @returns {Promise<object>} El estado de la aplicación.
         */
        async function fetchStateFromCloud() {
            console.log("Intentando cargar datos de la nube...");
            if (API_URL === 'TU_URL_DE_APPS_SCRIPT') {
                console.warn("API_URL no configurada. Usando datos iniciales locales.");
                return;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    redirect: 'follow', // Necesario para algunas configuraciones de Apps Script
                    headers: { 'Content-Type': 'application/json' },
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();

                // Manejo de la estructura de datos que viene de Apps Script
                console.log("Datos cargados de la nube:", data);

                // --- 1. Cargar Actividades DACP ---
                // Si la nube devuelve actividades, las usa. Si no, usa la plantilla.
                const dacp = Array.isArray(data.dacpActivities) && data.dacpActivities.length > 0 
                    ? data.dacpActivities 
                    : DEFAULT_DACP_ACTIVITIES;
                
                // --- 2. Cargar Contratos (Checklists) ---
                // Si la nube devuelve contratos válidos, los usa. Si no, usa la plantilla inicial.
                const contracts = data.contracts && Object.keys(data.contracts).length > 0 
                    ? data.contracts 
                    : loadInitialContracts();

                // --- 3. Establecer el Contrato Activo ---
                // Si el ID inicial existe en los datos cargados, lo mantiene. Si no, toma el primer ID disponible.
                const currentId = Object.keys(contracts).includes(state.currentContractId) 
                    ? state.currentContractId 
                    : Object.keys(contracts)[0] || INITIAL_CONTRACT_ID;

                // Actualizar el estado global
                state.dacpActivities = dacp;
                state.contracts = contracts;
                state.currentContractId = currentId;
                state.activeTab = 'dashboard'; // Siempre vuelve al dashboard al cargar

            } catch (error) {
                console.error("Error al cargar datos de la nube. Usando datos iniciales locales de emergencia.", error);
                // Fallback: usar datos iniciales si la carga falla
                state.dacpActivities = DEFAULT_DACP_ACTIVITIES;
                state.contracts = loadInitialContracts();
            }
        }

        /**
         * ESCRITURA: Envía todo el estado de persistencia (Activities y Contracts) a Google Sheets.
         */
        async function saveStateToCloud(currentState) {
            if (API_URL === 'TU_URL_DE_APPS_SCRIPT') {
                console.warn("API_URL no configurada. Los datos no se guardan en la nube.");
                return;
            }

            console.log("Intentando guardar estado en la nube...");
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors', // Necesario para peticiones entre dominios
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    redirect: 'follow',
                    body: JSON.stringify({ action: 'saveState', data: currentState })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const result = await response.json();
                console.log("Guardado en la nube exitoso:", result);

            } catch (error) {
                console.error("Error al guardar estado en la nube:", error);
                alert("Error al guardar los datos en la nube. Verifique la configuración de API_URL o el script de Google Apps Script.");
            }
        }


        /**
         * Función central para actualizar el estado de la aplicación.
         * Llama a saveStateToCloud para persistir y a renderApp para actualizar la UI.
         */
        function setState(newState) {
            // Actualizar el estado local
            state = { ...state, ...newState };
            
            // Re-renderizar la aplicación con el nuevo estado
            renderApp();

            // Preparar una copia profunda para guardar, evitando mutaciones
            const newDacpActivities = newState.dacpActivities ? 
                JSON.parse(JSON.stringify(newState.dacpActivities)) : state.dacpActivities;
            const newContracts = newState.contracts ? 
                JSON.parse(JSON.stringify(newState.contracts)) : state.contracts;

            // Guardar el estado en la nube de forma asíncrona
            saveStateToCloud({ 
                ...newState, 
                dacpActivities: newDacpActivities, 
                contracts: newContracts 
            });
        }


        // =================================================================
        // 3. FUNCIONES DE MANEJO DE EVENTOS (Adaptadas a la nueva persistencia)
        // =================================================================

        /**
         * Actualiza el valor de un campo específico en una actividad DACP.
         */
        function actualizarItem(id, campo, valor) {
            const newData = state.dacpActivities.map(item => 
                item.id === id ? { ...item, [campo]: valor } : item 
            );
            setState({ dacpActivities: newData });
        }

        /**
         * Manejador para los cambios de campos en la Matriz DACP.
         */
        function handleActivityChange(e) {
            const { name, value } = e.target;
            const [field, id] = name.split('_');
            const itemId = parseInt(id);

            if (field === 'cumplimiento') {
                const fecha = value ? new Date().toISOString().slice(0, 10) : '';
                const newData = state.dacpActivities.map(item => 
                    item.id === itemId ? { ...item, cumplimiento: value || null, fechaEvaluacion: fecha } : item 
                );
                setState({ dacpActivities: newData });

            } else if (field === 'observaciones') {
                actualizarItem(itemId, 'observaciones', value);

            } else if (field === 'filtroTipo') {
                setState({ filtroTipo: value });
            } else if (field === 'filtroCumplimiento') {
                setState({ filtroCumplimiento: value });
            }
        }


        /**
         * Retorna el checklist del contrato actualmente seleccionado.
         */
        function getCurrentChecklist() {
            // Asegura que siempre devuelva un array (ya sea el del contrato o la plantilla)
            return state.contracts[state.currentContractId] || INITIAL_ACTIVITIES;
        }


        /**
         * Manejador para los cambios en la Lista de Chequeo de Contratación.
         * Se encarga de actualizar el estado de un contrato específico.
         * @param {number} itemId - El ID del ítem (fila) del checklist.
         * @param {string} campo - El nombre de la columna a actualizar.
         * @param {string} valor - El nuevo valor.
         */
        function handleChecklistChange(itemId, campo, valor) {
            // 1. Clonar y actualizar el checklist del contrato activo
            const currentChecklist = getCurrentChecklist();
            const newChecklist = currentChecklist.map(item => {
                if (item.id === itemId) {
                    const newItem = { ...item };
                    
                    // Si es un radio button (Cumple/No Cumple/No Aplica)
                    if (campo.includes('Cumple') || campo.includes('No Cumple') || campo.includes('No Aplica')) {
                        // Limpiar todas las otras opciones de radio de esa misma fila y columna (SECOP II o CARPETA FISICA)
                        const columnPrefix = campo.includes('SECOP II') ? 'SECOP II' : 'CARPETA FISICA';
                        
                        // Opciones a resetear
                        const resetFields = [
                            `${columnPrefix} - Cumple`,
                            `${columnPrefix} - No Cumple`,
                            `${columnPrefix} - No Aplica/ Parcialmente`
                        ];

                        resetFields.forEach(field => {
                            newItem[field] = '';
                        });

                        // Marcar la opción seleccionada con 'X'
                        newItem[campo] = valor === 'X' ? 'X' : ''; // Solo permite marcar o desmarcar con 'X'
                        
                    } else {
                        // Si es un textarea (evidencia, obs_fisica, obs_secop)
                        newItem[campo] = valor;
                    }

                    return newItem;
                }
                return item;
            });

            // 2. Crear el nuevo objeto de contratos actualizado
            const newContracts = {
                ...state.contracts,
                [state.currentContractId]: newChecklist
            };

            // 3. Llamar a setState para guardar en la nube y re-renderizar
            setState({ contracts: newContracts });
        }


        /**
         * Crea un nuevo contrato en el estado y lo activa.
         */
        function handleCreateNewContract() {
            const newId = prompt("Ingrese el ID del nuevo contrato (ej: CONTRATO_002):");
            if (newId && newId.trim() !== "" && !state.contracts[newId]) {
                const newContracts = { 
                    ...state.contracts, 
                    [newId]: JSON.parse(JSON.stringify(INITIAL_ACTIVITIES)) // Clonar la plantilla
                };
                setState({ contracts: newContracts, currentContractId: newId });
                alert(`Contrato ${newId} creado y activado.`);
            } else if (newId) {
                alert("El ID del contrato es inválido o ya existe.");
            }
        }

        /**
         * Maneja el cambio de selección del contrato activo.
         */
        function handleContractSelectChange(e) {
            const newId = e.target.value;
            if (newId) {
                setState({ currentContractId: newId });
            }
        }

        /**
         * Destruye todas las instancias de Chart.js para evitar fugas de memoria.
         */
        function destroyCharts() {
            if (state.charts.pieChart) state.charts.pieChart.destroy();
            if (state.charts.barChart) state.charts.barChart.destroy();
            if (state.charts.radarChart) state.charts.radarChart.destroy();
            if (state.charts.stageChart) state.charts.stageChart.destroy();
            state.charts = {}; // Limpiar el registro
        }


        // =================================================================
        // 4. FUNCIONES DE EXPORTACIÓN Y FILTRADO (Se mantienen igual)
        // =================================================================

        function exportToExcel(data, filename) {
            const csvRows = [];
            
            // 1. Obtener cabeceras
            // Solo para DACP Activities
            const headers = ["ID", "Tipo", "Proceso", "Funcion", "Actividad", "Informe", "Frecuencia", "ReportaA", "Importancia", "Cumplimiento", "Observaciones", "FechaEvaluacion"];
            csvRows.push(headers.join(';'));
            
            // 2. Mapear datos
            for (const item of data) {
                const values = headers.map(header => {
                    // Asegura que todos los campos existan y maneja caracteres especiales
                    const value = item[header] || '';
                    return `"${String(value).replace(/"/g, '""').replace(/\n/g, ' | ')}"`;
                });
                csvRows.push(values.join(';'));
            }

            // 3. Crear y descargar el archivo
            const csvString = csvRows.join('\n');
            const blob = new Blob(["\uFEFF", csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function exportChecklistToExcel(contractId, data) {
            const csvRows = [];
            
            // 1. Obtener cabeceras
            const fieldKeys = ["id", "etapa", "aspecto", "SECOP II - Cumple", "SECOP II - No Cumple", "CARPETA FISICA - Cumple", "CARPETA FISICA - No Cumple", "CARPETA FISICA - No Aplica/ Parcialmente", "evidencia", "obs_fisica", "obs_secop" ];
            csvRows.push(fieldKeys.join(';'));
            
            // 2. Mapear datos
            for (const item of data) {
                const values = fieldKeys.map(key => {
                    let value;
                    if (key.includes('Cumple') || key.includes('No Cumple') || key.includes('No Aplica')) {
                        value = item[key] === 'X' ? 'X' : '';
                    } else {
                        value = item[key] || '';
                    }
                    // Quitar saltos de línea y escapar comillas para CSV
                    return `"${String(value).replace(/"/g, '""').replace(/\n/g, ' | ')}"`;
                });
                csvRows.push(values.join(';'));
            }

            // 3. Crear y descargar el archivo
            const csvString = csvRows.join('\n');
            const filename = `Checklist_Contrato_${contractId || 'SinID'}.csv`;
            const blob = new Blob(["\uFEFF", csvString], { type: 'text/csv;charset=utf-8;' }); // \uFEFF para el BOM que ayuda con UTF-8 en Excel
            const link = document.createElement('a');

            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }


        function getActividadesFiltradas() {
            return state.dacpActivities.filter(act => {
                const matchTipo = state.filtroTipo === 'Todos' || act.tipo === state.filtroTipo;
                const matchCumplimiento = state.filtroCumplimiento === 'Todos' || 
                    (state.filtroCumplimiento === 'Pendiente' && (act.cumplimiento === null || act.cumplimiento === '')) || 
                    act.cumplimiento === state.filtroCumplimiento;
                return matchTipo && matchCumplimiento;
            });
        }


        // =================================================================
        // 5. FUNCIONES DE ESTADÍSTICAS Y GRÁFICOS
        // =================================================================

        /**
         * Calcula las estadísticas de la Matriz DACP (Actividades).
         */
        function calculateActivityStats() {
            const total = state.dacpActivities.length;
            let cumple = 0;
            let noCumple = 0;
            let parcial = 0;
            let pendiente = 0;
            const procesoStats = {};
            const tipoStats = { 'Interna': { total: 0, cumple: 0 }, 'Externa': { total: 0, cumple: 0 } };

            state.dacpActivities.forEach(act => {
                const proceso = act.proceso;
                procesoStats[proceso] = procesoStats[proceso] || { total: 0, cumple: 0 };
                procesoStats[proceso].total++;

                if (act.tipo) {
                    tipoStats[act.tipo].total++;
                }

                if (act.cumplimiento === 'Cumple') {
                    cumple++;
                    procesoStats[proceso].cumple++;
                    if (act.tipo) {
                        tipoStats[act.tipo].cumple++;
                    }
                } else if (act.cumplimiento === 'No Cumple') {
                    noCumple++;
                } else if (act.cumplimiento === 'Parcial') {
                    parcial++;
                } else {
                    pendiente++;
                }
            });

            // Convertir estadísticas de proceso a porcentajes
            const procesoScores = Object.keys(procesoStats).map(proceso => ({
                proceso,
                pctCumplimiento: procesoStats[proceso].total > 0 
                    ? (procesoStats[proceso].cumple / procesoStats[proceso].total) * 100 
                    : 0
            }));


            return {
                total,
                cumple,
                noCumple,
                parcial,
                pendiente,
                evaluadas: cumple + noCumple + parcial,
                procesoScores,
                tipoStats
            };
        }

        /**
         * Calcula las estadísticas de la Lista de Chequeo de Contratación.
         */
        function calculateChecklistStats(checklist) {
            const stats = {
                totalItems: checklist.length,
                totalAspectos: checklist.length * 2, // 2 aspectos por fila (SECOP II y FÍSICA)
                totalCumplimiento: 0,
                totalNoCumplimiento: 0,
                totalParcial: 0,
                totalPendiente: 0,
                porEtapa: {}
            };

            const etapas = ['Precontractual', 'Planeación del Contrato', 'Selección y Adjudicación', 'Ejecución del Contrato', 'Liquidación y Cierre'];

            etapas.forEach(etapa => {
                stats.porEtapa[etapa] = { total: 0, pctCumplimiento: 0 };
                const itemsEtapa = checklist.filter(item => item.etapa === etapa);
                let totalEtapa = itemsEtapa.length;
                
                let secopCumple = itemsEtapa.filter(item => item["SECOP II - Cumple"] === 'X').length;
                let fisicaCumple = itemsEtapa.filter(item => item["CARPETA FISICA - Cumple"] === 'X').length;

                // Suma heurística: 
                // Un ítem "cumple" si al menos una de las dos (SECOP II o FÍSICA) es "Cumple".
                // Esto es una simplificación. Para un cálculo exacto, debería ser más granular.
                // Aquí usamos una suma simple de 'X' en ambas columnas (max 2 por ítem).

                itemsEtapa.forEach(item => {
                    const secop = item["SECOP II - Cumple"] === 'X' ? 1 : (item["SECOP II - No Cumple"] === 'X' ? -1 : (item["SECOP II - No Aplica/ Parcialmente"] === 'X' ? 0.5 : 0));
                    const fisica = item["CARPETA FISICA - Cumple"] === 'X' ? 1 : (item["CARPETA FISICA - No Cumple"] === 'X' ? -1 : (item["CARPETA FISICA - No Aplica/ Parcialmente"] === 'X' ? 0.5 : 0));
                    
                    stats.totalCumplimiento += (secop === 1) ? 1 : 0;
                    stats.totalCumplimiento += (fisica === 1) ? 1 : 0;
                    
                    stats.totalNoCumplimiento += (secop === -1) ? 1 : 0;
                    stats.totalNoCumplimiento += (fisica === -1) ? 1 : 0;

                    stats.totalParcial += (secop === 0.5) ? 1 : 0;
                    stats.totalParcial += (fisica === 0.5) ? 1 : 0;
                    
                    stats.totalPendiente += (secop === 0) ? 1 : 0;
                    stats.totalPendiente += (fisica === 0) ? 1 : 0;
                });


                const cumplidasEtapa = itemsEtapa.reduce((sum, item) => {
                    let c = 0;
                    if (item["SECOP II - Cumple"] === 'X' || item["SECOP II - No Aplica/ Parcialmente"] === 'X') c += 1;
                    if (item["CARPETA FISICA - Cumple"] === 'X' || item["CARPETA FISICA - No Aplica/ Parcialmente"] === 'X') c += 1;
                    return sum + c;
                }, 0);
                
                // El cumplimiento total para la etapa es el número de checks positivos dividido por el número total de posibles checks (ítems * 2)
                stats.porEtapa[etapa] = { 
                    total: totalEtapa * 2,
                    pctCumplimiento: totalEtapa > 0 ? (cumplidasEtapa / (totalEtapa * 2)) * 100 : 0
                };
            });

            return stats;
        }


        function renderDashboardCharts(actStats) {
            // Destruir instancias previas
            destroyCharts();

            // Gráfico de Torta (Pie Chart) para Cumplimiento General DACP
            const pieCtx = document.getElementById('compliancePieChart')?.getContext('2d');
            if (pieCtx) {
                state.charts.pieChart = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: ['✓ Cumple', '✗ No Cumple', '◐ Parcialmente', 'Pendiente'],
                        datasets: [{
                            data: [actStats.cumple, actStats.noCumple, actStats.parcial, actStats.pendiente],
                            backgroundColor: [
                                'rgb(34, 197, 94)',   // green-500
                                'rgb(239, 68, 68)',   // red-500
                                'rgb(245, 158, 11)',  // amber-500
                                'rgb(107, 114, 128)'  // gray-500
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Gráfico de Barras (Bar Chart) para Cumplimiento por Tipo
            const barCtx = document.getElementById('typeBarChart')?.getContext('2d');
            if (barCtx) {
                const interna = actStats.tipoStats['Interna'];
                const externa = actStats.tipoStats['Externa'];
                
                state.charts.barChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Interna', 'Externa'],
                        datasets: [{
                            label: 'Cumplidas',
                            data: [interna.cumple, externa.cumple],
                            backgroundColor: 'rgb(34, 197, 94)', // green-500
                        }, {
                            label: 'Pendientes/No Cumplidas',
                            data: [interna.total - interna.cumple, externa.total - externa.cumple],
                            backgroundColor: 'rgb(239, 68, 68)', // red-500
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true, beginAtZero: true }
                        },
                        plugins: {
                            legend: { position: 'top' }
                        }
                    }
                });
            }


            // Gráfico de Radar para Cumplimiento por Proceso
            const radarCtx = document.getElementById('procesoRadarChart')?.getContext('2d');
            if (radarCtx) {
                const labels = actStats.procesoScores.map(s => s.proceso);
                const data = actStats.procesoScores.map(s => s.pctCumplimiento);
                
                state.charts.radarChart = new Chart(radarCtx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '% Cumplimiento',
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)', // blue-500
                            borderColor: 'rgba(59, 130, 246, 1)',
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            pointBorderColor: '#fff',
                            borderWidth: 1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                suggestedMin: 0,
                                suggestedMax: 100,
                                pointLabels: {
                                    font: { size: 10 }
                                },
                                ticks: { display: false }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }


        function renderChecklistStageRadar(checklist) {
            // Destruir solo el gráfico de esta vista
            if (state.charts.stageChart) state.charts.stageChart.destroy();
            
            const stats = calculateChecklistStats(checklist);
            const etapas = Object.keys(stats.porEtapa);
            const scores = etapas.map(e => stats.porEtapa[e].pctCumplimiento);

            const ctx = document.getElementById('checklistRadarChart')?.getContext('2d');
            if (ctx) {
                state.charts.stageChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: etapas,
                        datasets: [{
                            label: '% Cumplimiento Promedio por Etapa',
                            data: scores,
                            backgroundColor: 'rgba(16, 185, 129, 0.2)', // emerald-500
                            borderColor: 'rgba(16, 185, 129, 1)',
                            pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                            pointBorderColor: '#fff',
                            borderWidth: 1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                suggestedMin: 0,
                                suggestedMax: 100,
                                pointLabels: {
                                    font: { size: 10 }
                                },
                                ticks: { display: false }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        // =================================================================
        // 6. FUNCIONES DE RENDERIZADO HTML
        // =================================================================

        function renderStatItem(title, value, bgColorClass) {
            return `
                <div class="p-4 ${bgColorClass} rounded-xl shadow-lg flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium">${title}</p>
                        <p class="text-2xl font-bold">${value}</p>
                    </div>
                </div>
            `;
        }

        function renderDashboardView() {
            const stats = calculateActivityStats();

            // Renderizar los gráficos después de que el HTML se haya insertado
            setTimeout(() => {
                renderDashboardCharts(stats);
            }, 0);

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Resumen General de Actividades DACP</h3>
                            ${renderStatsCard(stats)}
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Cumplimiento por Proceso</h3>
                            <div style="height: 300px;">
                                <canvas id="procesoRadarChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Distribución de Cumplimiento</h3>
                            <div style="height: 250px;">
                                <canvas id="compliancePieChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Cumplimiento por Tipo de Actividad</h3>
                            <div style="height: 250px;">
                                <canvas id="typeBarChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStatsCard(stats) {
            return `
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    ${renderStatItem('Total Actividades', stats.total, 'bg-blue-100 text-blue-800')}
                    ${renderStatItem('Evaluadas', stats.evaluadas, 'bg-indigo-100 text-indigo-800')}
                    ${renderStatItem('Pendientes', stats.pendiente, 'bg-gray-100 text-gray-800')}
                    ${renderStatItem('Cumplimiento (%)', stats.evaluadas > 0 ? (stats.cumple / stats.evaluadas * 100).toFixed(1) : 0, 'bg-green-100 text-green-800')}
                </div>
            `;
        }
        
        function renderActivityMatrix() {
            const stats = calculateActivityStats();
            const actividades = getActividadesFiltradas();

            const tableRows = actividades.map(item => {
                const selectId = `cumplimiento_${item.id}`;
                const obsId = `observaciones_${item.id}`;
                
                const getRowClass = (cumplimiento) => {
                    if (cumplimiento === 'Cumple') return 'bg-green-50 hover:bg-green-100';
                    if (cumplimiento === 'No Cumple') return 'bg-red-50 hover:bg-red-100';
                    if (cumplimiento === 'Parcial') return 'bg-yellow-50 hover:bg-yellow-100';
                    return 'hover:bg-gray-50';
                };

                return `
                    <tr class="${getRowClass(item.cumplimiento)} border-b border-gray-200">
                        <td class="p-3 text-sm font-medium">${item.id}</td>
                        <td class="p-3 text-sm">${item.tipo}</td>
                        <td class="p-3 text-sm">${item.proceso}</td>
                        <td class="p-3 text-sm font-semibold">${item.actividad}</td>
                        <td class="p-3 text-sm">${item.frecuencia}</td>
                        <td class="p-3 text-sm text-center font-bold">${item.importancia}</td>
                        <td class="p-3 text-sm">
                            <select id="${selectId}" name="cumplimiento_${item.id}" onchange="handleActivityChange(event)" class="p-2 border rounded-lg text-sm w-full ${item.cumplimiento === 'Cumple' ? 'bg-green-100' : (item.cumplimiento === 'No Cumple' ? 'bg-red-100' : (item.cumplimiento === 'Parcial' ? 'bg-yellow-100' : ''))}">
                                <option value="" ${!item.cumplimiento ? 'selected' : ''}>Pendiente</option>
                                <option value="Cumple" ${item.cumplimiento === 'Cumple' ? 'selected' : ''}>Cumple</option>
                                <option value="No Cumple" ${item.cumplimiento === 'No Cumple' ? 'selected' : ''}>No Cumple</option>
                                <option value="Parcial" ${item.cumplimiento === 'Parcial' ? 'selected' : ''}>Parcial</option>
                            </select>
                        </td>
                        <td class="p-3 text-sm">
                            <textarea id="${obsId}" name="observaciones_${item.id}" oninput="handleActivityChange(event)" rows="1" class="w-full p-2 border rounded-lg text-sm resize-y">${item.observaciones}</textarea>
                        </td>
                        <td class="p-3 text-sm">${item.fechaEvaluacion}</td>
                    </tr>
                `;
            }).join('');


            return `
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Matriz de Actividades DACP</h2>
                    ${renderStatsCard(stats)}
                    
                    <div class="flex flex-wrap gap-4 mb-4">
                        <div class="flex items-center space-x-2">
                            <label for="filtroTipo" class="text-sm font-medium text-gray-700">Filtrar por Tipo:</label>
                            <select id="filtroTipo" name="filtroTipo" onchange="handleActivityChange(event)" class="p-2 border rounded-lg text-sm">
                                <option value="Todos" ${state.filtroTipo === 'Todos' ? 'selected' : ''}>Todos</option>
                                <option value="Interna" ${state.filtroTipo === 'Interna' ? 'selected' : ''}>Interna</option>
                                <option value="Externa" ${state.filtroTipo === 'Externa' ? 'selected' : ''}>Externa</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="filtroCumplimiento" class="text-sm font-medium text-gray-700">Filtrar por Cumplimiento:</label>
                            <select id="filtroCumplimiento" name="filtroCumplimiento" onchange="handleActivityChange(event)" class="p-2 border rounded-lg text-sm">
                                <option value="Todos" ${state.filtroCumplimiento === 'Todos' ? 'selected' : ''}>Todos</option>
                                <option value="Cumple" ${state.filtroCumplimiento === 'Cumple' ? 'selected' : ''}>Cumple</option>
                                <option value="No Cumple" ${state.filtroCumplimiento === 'No Cumple' ? 'selected' : ''}>No Cumple</option>
                                <option value="Parcial" ${state.filtroCumplimiento === 'Parcial' ? 'selected' : ''}>Parcial</option>
                                <option value="Pendiente" ${state.filtroCumplimiento === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                            </select>
                        </div>
                        <button onclick="exportToExcel(getActividadesFiltradas(), 'Matriz_DACP_Auditoria.csv')" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 text-sm">
                            Exportar a Excel
                        </button>
                    </div>

                    <div class="overflow-x-auto bg-white shadow-lg rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                    <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proceso</th>
                                    <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actividad</th>
                                    <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frecuencia</th>
                                    <th class="p-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Imp. (%)</th>
                                    <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cumplimiento</th>
                                    <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observaciones</th>
                                    <th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Evaluación</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderChecklistView() {
            const checklist = getCurrentChecklist();
            const contractIds = Object.keys(state.contracts);
            const stats = calculateChecklistStats(checklist);


            // Helper para renderizar los radio buttons
            const renderRadio = (type, label, itemId) => {
                const baseName = `${type}_${itemId}`;
                const fullName = `${columnPrefix} - ${label}`;
                const columnPrefix = type === 'secop' ? 'SECOP II' : 'CARPETA FISICA';
                const actualField = `${columnPrefix} - ${label}`;
                
                // Determinar el valor actual
                const currentValue = checklist.find(item => item.id === itemId)?.[actualField] || '';
                const isChecked = currentValue === 'X';

                let colorClass = 'text-gray-400';
                let valueLabel = '';
                if (label === 'Cumple') {
                    colorClass = 'text-green-500';
                    valueLabel = '✓';
                } else if (label === 'No Cumple') {
                    colorClass = 'text-red-500';
                    valueLabel = '✗';
                } else if (label === 'No Aplica/ Parcialmente') {
                    colorClass = 'text-yellow-500';
                    valueLabel = '◐';
                }


                return `
                    <label class="inline-flex items-center mx-1 cursor-pointer" title="${label}">
                        <input type="radio" 
                               name="${baseName}" 
                               value="${actualField}"
                               ${isChecked ? 'checked' : ''}
                               onclick="handleChecklistChange(${itemId}, '${actualField}', this.checked ? 'X' : '')"
                               class="form-radio h-4 w-4 ${colorClass} transition duration-150 ease-in-out">
                        <span class="text-sm ${colorClass}">${valueLabel}</span>
                    </label>
                `;
            };


            const tableRows = checklist.map(item => {
                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="p-2 text-xs font-medium sticky left-0 bg-white">${item.id}</td>
                        <td class="p-2 text-xs font-medium">${item.etapa}</td>
                        <td class="p-2 text-sm font-semibold min-w-40">${item.aspecto}</td>
                        
                        <td class="p-2 text-center flex justify-center space-x-2">
                            ${renderRadio('secop', 'Cumple', item.id)}
                            ${renderRadio('secop', 'No Cumple', item.id)}
                            ${renderRadio('secop', 'No Aplica/ Parcialmente', item.id)}
                        </td>

                        <td class="p-2 text-center flex justify-center space-x-2">
                            ${renderRadio('fisica', 'Cumple', item.id)}
                            ${renderRadio('fisica', 'No Cumple', item.id)}
                            ${renderRadio('fisica', 'No Aplica/ Parcialmente', item.id)}
                        </td>
                        
                        <td class="p-2 min-w-60">
                            <textarea oninput="handleChecklistChange(${item.id}, 'evidencia', event.target.value)" 
                                      class="table-textarea" 
                                      rows="1" 
                                      placeholder="Ej: Link a carpeta/Archivo">${item.evidencia}</textarea>
                        </td>
                        <td class="p-2 min-w-60">
                            <textarea oninput="handleChecklistChange(${item.id}, 'obs_fisica', event.target.value)" 
                                      class="table-textarea" 
                                      rows="1"
                                      placeholder="Observaciones de Carpeta Física">${item.obs_fisica}</textarea>
                        </td>
                        <td class="p-2 min-w-60">
                            <textarea oninput="handleChecklistChange(${item.id}, 'obs_secop', event.target.value)" 
                                      class="table-textarea" 
                                      rows="1"
                                      placeholder="Observaciones de SECOP II">${item.obs_secop}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');


            // Renderizar el gráfico de radar después de que el HTML se haya insertado
            setTimeout(() => {
                renderChecklistStageRadar(checklist);
            }, 0);


            return `
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Lista de Chequeo de Contratación</h2>

                    <div class="flex flex-wrap items-center space-x-4 mb-6 p-4 bg-white rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="contract-select" class="text-sm font-medium text-gray-700">Contrato Activo:</label>
                            <select id="contract-select" onchange="handleContractSelectChange(event)" class="p-2 border rounded-lg text-sm font-bold">
                                ${contractIds.map(id => 
                                    `<option value="${id}" ${state.currentContractId === id ? 'selected' : ''}>${id}</option>`
                                ).join('')}
                            </select>
                        </div>

                        <button onclick="handleCreateNewContract()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 text-sm">
                            + Nuevo Contrato
                        </button>
                        
                        <button onclick="exportChecklistToExcel(state.currentContractId, getCurrentChecklist())" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 text-sm">
                            Exportar Checklist a Excel
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Resumen General del Contrato (${state.currentContractId})</h3>
                            <div class="grid grid-cols-2 gap-4">
                                ${renderStatItem('Total de Aspectos', stats.totalAspectos, 'bg-blue-100 text-blue-800')}
                                ${renderStatItem('Aspectos Cumplidos', stats.totalCumplimiento, 'bg-green-100 text-green-800')}
                                ${renderStatItem('Aspectos No Cumplidos', stats.totalNoCumplimiento, 'bg-red-100 text-red-800')}
                                ${renderStatItem('Aspectos Parciales/N.A.', stats.totalParcial, 'bg-yellow-100 text-yellow-800')}
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Cumplimiento por Etapa del Contrato</h3>
                            <div style="height: 200px;">
                                <canvas id="checklistRadarChart"></canvas>
                            </div>
                        </div>
                    </div>


                    <div class="overflow-x-auto bg-white shadow-lg rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200 table-fixed">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th rowspan="2" class="p-2 w-12 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r">ID</th>
                                    <th rowspan="2" class="p-2 w-32 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r">Etapa</th>
                                    <th rowspan="2" class="p-2 w-64 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r">Aspecto a Evaluar</th>
                                    <th colspan="2" class="p-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Verificación de Documentos</th>
                                    <th colspan="3" class="p-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Observaciones y Evidencia</th>
                                </tr>
                                <tr>
                                    <th class="p-2 w-32 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">SECOP II</th>
                                    <th class="p-2 w-32 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r">CARPETA FÍSICA</th>
                                    <th class="p-2 w-64 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Evidencia</th>
                                    <th class="p-2 w-64 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Obs. Física</th>
                                    <th class="p-2 w-64 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Obs. SECOP</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }


        function renderApp() {
            const root = document.getElementById('root');
            let content = '';

            // Renderizar la navegación
            const nav = `
                <nav class="mb-6">
                    <div class="flex border-b border-gray-200">
                        <button onclick="setState({ activeTab: 'dashboard' })" class="px-4 py-2 text-sm font-medium ${state.activeTab === 'dashboard' ? 'tab-active' : 'text-gray-500 hover:text-blue-500'} transition duration-150">
                            Dashboard (Matriz DACP)
                        </button>
                        <button onclick="setState({ activeTab: 'checklist' })" class="px-4 py-2 text-sm font-medium ${state.activeTab === 'checklist' ? 'tab-active' : 'text-gray-500 hover:text-blue-500'} transition duration-150">
                            Lista de Chequeo de Contratación
                        </button>
                    </div>
                </nav>
            `;

            // Renderizar el contenido de la pestaña activa
            if (state.activeTab === 'dashboard') {
                content = renderActivityMatrix();
            } else if (state.activeTab === 'checklist') {
                content = renderChecklistView();
            }

            // Unir navegación y contenido
            root.innerHTML = nav + content;

            // La lógica de renderización de gráficos se ejecuta dentro de cada renderView mediante setTimeout(..., 0)
        }


        // =================================================================
        // 7. INICIO DE LA APLICACIÓN (ASÍNCRONO PARA LA NUBE)
        // =================================================================

        window.onload = async function() {
            // Exponer las funciones al ámbito global para que el HTML pueda llamarlas
            window.handleActivityChange = handleActivityChange;
            window.handleChecklistChange = handleChecklistChange;
            window.handleCreateNewContract = handleCreateNewContract;
            window.handleContractSelectChange = handleContractSelectChange;
            window.exportToExcel = exportToExcel;
            window.exportChecklistToExcel = exportChecklistToExcel;
            window.getActividadesFiltradas = getActividadesFiltradas;
            window.getCurrentChecklist = getCurrentChecklist;
            
            // ⚠️ NUEVO: Mostrar mensaje de carga
            const root = document.getElementById('root');
            const loadingMessage = document.createElement('div');
            loadingMessage.innerHTML = '<p class="text-center text-xl text-blue-600 mt-20">Cargando datos de la nube, por favor espere...</p>';
            root.appendChild(loadingMessage);

            // Esperar a cargar los datos de la nube antes de renderizar
            await fetchStateFromCloud();
            
            // Remover el mensaje de carga
            root.removeChild(loadingMessage);

            // Finalmente, renderizar la aplicación con los datos cargados
            renderApp();
        };

    </script>
</body>
</html>
