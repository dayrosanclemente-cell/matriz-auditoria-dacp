<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Auditor√≠a DACP - Contrataci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <style>
        /* Estilos base y fuentes */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* Color de fondo suave */
            margin: 0;
            padding: 0;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        /* Estilo para √°reas de texto dentro de la tabla */
        .table-textarea {
            width: 100%;
            min-height: 40px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 0.875rem; /* sm */
        }
        /* Clase para pesta√±as activas */
        .tab-active {
            border-bottom-width: 2px;
            border-color: #3b82f6; /* blue-500 */
        }
    </style>
</head>
<body>
    <div id="root" class="min-h-screen p-4 sm:p-8">
        <header class="mb-6 pb-4 border-b-2 border-gray-200 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">Dashboard de Auditor√≠a DACP</h1>
            <div class="flex flex-col items-end">
                <div id="save-message" class="text-sm mt-2 font-semibold"></div> 
                <div class="mt-4 flex items-center space-x-4">
                    <label for="contract-select" class="text-gray-600 font-medium">Contrato:</label>
                    <select id="contract-select" onchange="window.handleContractSelectChange(this.value)" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </select>
                </div>
            </div>
        </header>

        <nav class="flex space-x-2 border-b border-gray-300 mb-6">
            <button onclick="window.renderTab('overview')" id="tab-overview" class="py-2 px-4 text-sm font-medium text-gray-700 hover:text-blue-600 focus:outline-none tab-active">
                Resumen General
            </button>
            <button onclick="window.renderTab('activities')" id="tab-activities" class="py-2 px-4 text-sm font-medium text-gray-700 hover:text-blue-600 focus:outline-none">
                Matriz de Contrataci√≥n
            </button>
            <button onclick="window.renderTab('checklist')" id="tab-checklist" class="py-2 px-4 text-sm font-medium text-gray-700 hover:text-blue-600 focus:outline-none">
                Lista de Chequeo
            </button>
            <button onclick="window.renderTab('stats')" id="tab-stats" class="py-2 px-4 text-sm font-medium text-gray-700 hover:text-blue-600 focus:outline-none">
                Estad√≠sticas Gestores
            </button>
        </nav>

        <main id="content-container">
            <p class="text-center text-gray-500">Cargando la aplicaci√≥n...</p>
        </main>
    </div>

    <script>
        
        // =================================================================
        // === GESTI√ìN DE ESTADO Y PERSISTENCIA (GOOGLE SCRIPT / SHEETS) ===
        // =================================================================

        // ‚ö†Ô∏è IMPORTANTE: URL de tu Google App Script
        const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyw-61FNV9SfJQpwew18SxSiOYnLsANhSRZ9_E3g-DJ3THJUjDsZ7raTp22ozMy4MYA/exec'; // DEBE SER TU URL

        let state = {
            actividades: [],
            checklists: {}, // Almacena las listas de chequeo por ContractoID
            selectedContractId: null,
            selectedManagerId: null,
            activityFilter: 'ALL',
            currentTab: 'overview'
        };

        // =================================================================
        // === CONEXI√ìN CON GOOGLE SHEETS (FETCH) ===
        // =================================================================

        // 1. Cargar el estado completo desde la nube (Google Sheet)
        async function fetchStateFromCloud() {
            try {
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'loadState' })
                });
                const result = await response.json();
                if (result && result.success && result.data) {
                    // Actualizar el estado con los datos cargados
                    state.actividades = result.data.actividades || [];
                    state.checklists = result.data.checklists || {};
                    // Intentar seleccionar el primer contrato o mantener el anterior si existe
                    if (state.actividades.length > 0 && !state.selectedContractId) {
                        state.selectedContractId = state.actividades[0].ID_CONTRATO;
                    } else if (state.actividades.length > 0 && state.selectedContractId) {
                        // Asegurar que el contrato seleccionado a√∫n existe
                        const exists = state.actividades.some(a => a.ID_CONTRATO === state.selectedContractId);
                        if (!exists) {
                            state.selectedContractId = state.actividades[0].ID_CONTRATO;
                        }
                    }
                } else {
                    console.error('Error al cargar el estado desde la nube:', result);
                }
            } catch (error) {
                console.error('Error de red al cargar el estado:', error);
            }
        }

        // 2. Guardar el estado completo en la nube (Google Sheet) - ACTUALIZADO
        async function saveStateToCloud(isAutoSave = false) {
            const saveMessageEl = document.getElementById('save-message');
            
            // Muestra el mensaje "Guardando..." inmediatamente
            if (saveMessageEl) {
                saveMessageEl.textContent = (isAutoSave ? 'Auto-Guardando...' : 'Guardando cambios...');
                saveMessageEl.className = 'text-yellow-600 text-sm mt-2 font-semibold';
            }
            
            console.log((isAutoSave ? 'Auto-Guardando' : 'Guardando') + ' estado en la nube...');

            try {
                // Prepara solo los datos esenciales para guardar
                const dataToSave = {
                    actividades: state.actividades,
                    checklists: state.checklists
                };

                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        action: 'saveState', 
                        data: dataToSave 
                    })
                });
                const result = await response.json();
                
                // Mostrar un feedback al usuario
                const now = new Date();
                const timeString = now.toLocaleTimeString();

                if (result && result.success) {
                    console.log((isAutoSave ? 'Auto-Guardado' : 'Guardado manual') + ' exitoso a las ' + timeString);
                    if (saveMessageEl) {
                        saveMessageEl.textContent = (isAutoSave ? '‚úÖ Auto-Guardado' : '‚úÖ Guardado manual') + '. √öltima actualizaci√≥n: ' + timeString;
                        saveMessageEl.className = 'text-green-600 text-sm mt-2 font-semibold';
                    }
                } else {
                    console.error('‚õî Error al guardar el estado:', result);
                    if (saveMessageEl) {
                        saveMessageEl.textContent = '‚õî Error al guardar. Revisar consola para m√°s detalles.';
                        saveMessageEl.className = 'text-red-600 text-sm mt-2 font-bold';
                    }
                }

                // Auto-ocultar mensaje de guardado manual despu√©s de un tiempo
                if (!isAutoSave) {
                    setTimeout(() => {
                        if (saveMessageEl && !saveMessageEl.textContent.includes('Auto-Guardado')) {
                            saveMessageEl.textContent = '';
                        }
                    }, 5000);
                }

                return result;

            } catch (error) {
                console.error('üåê Error de red al guardar el estado:', error);
                if (saveMessageEl) {
                    saveMessageEl.textContent = 'üåê Error de red al guardar. ¬øGoogle Sheet ca√≠do?';
                    saveMessageEl.className = 'text-red-600 text-sm mt-2 font-bold';
                }
                return { success: false, error: error.toString() };
            }
        }

        // 3. Funci√≥n de Guardado Inteligente (debounce)
        function triggerSave() {
            // Un peque√±o retraso para agrupar cambios y no saturar el servidor
            clearTimeout(window.saveTimer);
            window.saveTimer = setTimeout(async () => {
                await saveStateToCloud(false); // Guardado manual (no autosave)
            }, 1000); // Guarda 1 segundo despu√©s de la √∫ltima modificaci√≥n
        }

        // 4. Iniciar el Guardado Autom√°tico Peri√≥dico - NUEVO
        function startAutoSave() {
            // Guarda autom√°ticamente cada 5 minutos (300000 ms)
            const interval = 300000; 
            
            // Inicia el autosave
            console.log('Iniciando auto-guardado cada ' + (interval / 60000) + ' minutos.');
            setInterval(async () => {
                // Solo ejecuta el autosave si hay datos cargados (actividades)
                if (state.actividades && state.actividades.length > 0) {
                    console.log('Auto-Guardado peri√≥dico activado.');
                    await saveStateToCloud(true); // Pasar 'true' para indicar que es un autosave
                } else {
                    console.log('Omitiendo auto-guardado: No hay actividades cargadas.');
                }
            }, interval);
        }

        // =================================================================
        // === L√ìGICA DE MANEJO DE ESTADO Y UI (Necesaria para que el c√≥digo funcione) ===
        // =================================================================

        // --- Funciones Auxiliares de L√≥gica ---
        
        function parseCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return [];

            const headers = lines[0].split(';').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(';');
                if (values.length !== headers.length) continue; 

                const item = {};
                headers.forEach((header, index) => {
                    item[header] = values[index].trim().replace(/"/g, '');
                });
                data.push(item);
            }
            return data;
        }

        async function importChecklistFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const csvContent = e.target.result;
                const checklistData = parseCSV(csvContent);
                
                if (checklistData.length > 0 && state.selectedContractId) {
                    const contractId = state.selectedContractId;
                    state.checklists[contractId] = checklistData.map(item => ({
                        ID: item['ID'] || '',
                        EtapaCriterio: item['Etapa / Criterio'] || '',
                        Aspecto: item['Aspecto a Verificar'] || '',
                        SECOPCumple: item['SECOP II (Cumple)'] === 'X' || false,
                        SECOPNoCumple: item['SECOP II (No Cumple)'] === 'X' || false,
                        CARPETACumple: item['CARPETA FISICA (Cumple)'] === 'X' || false,
                        CARPETANoCumple: item['CARPETA FISICA (No Cumple)'] === 'X' || false,
                        CARPETAParcialNA: item['CARPETA FISICA (Parcial/N/A)'] === 'X' || false,
                        ObsCarpeta: item['Observaciones Carpeta Fisica'] || '',
                        ObsSECOP: item['Observaciones SECOP II'] || ''
                    }));
                    
                    renderApp(); 
                    await triggerSave(); 
                    alert(`Checklist importado exitosamente para el contrato ${contractId}.`);
                } else {
                    alert('Error: No hay datos v√°lidos en el archivo CSV o no hay un contrato seleccionado.');
                }
            };
            reader.readAsText(file);
        }

        function handleChecklistChange(contractId, aspectID, field, value) {
            const checklist = state.checklists[contractId];
            if (!checklist) return;

            const item = checklist.find(i => i.ID === aspectID);
            if (!item) return;

            if (field.includes('Cumple') || field.includes('NoCumple') || field.includes('ParcialNA')) {
                // L√≥gica de checkboxes, solo uno puede ser 'X'
                if (value) {
                    item.SECOPCumple = false;
                    item.SECOPNoCumple = false;
                    item.CARPETACumple = false;
                    item.CARPETANoCumple = false;
                    item.CARPETAParcialNA = false;

                    item[field] = true;
                } else {
                    item[field] = false;
                }
            } else {
                // L√≥gica para √°reas de texto
                item[field] = value;
            }

            renderApp();
            triggerSave();
        }

        function handleActivityChange(activityID, field, value) {
            const activity = state.actividades.find(a => a.ID_ACTIVIDAD === activityID);
            if (activity) {
                activity[field] = value;
                renderApp();
                triggerSave();
            }
        }

        function handleCreateNewContract() {
            const newContractId = prompt("Ingrese el ID del nuevo contrato:");
            if (newContractId && !state.actividades.some(a => a.ID_CONTRATO === newContractId)) {
                state.actividades.unshift({
                    ID_CONTRATO: newContractId,
                    ID_ACTIVIDAD: `${newContractId}-A1`,
                    NOMBRE_CONTRATISTA: 'NUEVO CONTRATISTA',
                    ESTADO: 'PENDIENTE',
                    MONTO: 0,
                    FECHA_INICIO: '',
                    FECHA_FIN: '',
                    DURACION_DIAS: 0,
                    GESTOR_ASIGNADO: 'SIN ASIGNAR'
                });
                state.checklists[newContractId] = [];
                state.selectedContractId = newContractId;
                renderApp();
                triggerSave();
            } else if (newContractId) {
                alert("Ese ID de contrato ya existe.");
            }
        }

        function handleContractSelectChange(contractId) {
            state.selectedContractId = contractId;
            renderApp();
        }

        function handleManagerSelectChange(managerId) {
            state.selectedManagerId = managerId;
            renderApp();
        }

        function handleFilterChange(filterValue) {
            state.activityFilter = filterValue;
            renderApp();
        }

        function getActividadesFiltradas() {
            if (state.activityFilter === 'ALL') {
                return state.actividades;
            }
            return state.actividades.filter(a => a.ESTADO === state.activityFilter);
        }

        function getCurrentChecklist() {
            return state.checklists[state.selectedContractId] || [];
        }

        function getManagerChecklist(managerId) {
            const managerContracts = state.actividades
                .filter(a => a.GESTOR_ASIGNADO === managerId)
                .map(a => a.ID_CONTRATO);

            return managerContracts.flatMap(contractId => state.checklists[contractId] || []);
        }

        // --- Funciones de Exportaci√≥n (Simulaci√≥n) ---

        function exportToCSV(filename, data, headers) {
            const csvRows = [];
            
            // Agregar encabezados
            csvRows.push(headers.map(h => `"${h.label}"`).join(';'));
            
            // Agregar filas de datos
            for (const row of data) {
                const values = headers.map(h => {
                    let value = row[h.key] !== undefined ? row[h.key] : '';
                    if (typeof value === 'string') {
                        value = value.replace(/"/g, '""'); // Escapar comillas dobles
                    }
                    return `"${value}"`;
                });
                csvRows.push(values.join(';'));
            }
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportDACPActivitiesToExcel() {
            const activities = state.actividades;
            const headers = [
                { key: 'ID_CONTRATO', label: 'ID Contrato' },
                { key: 'NOMBRE_CONTRATISTA', label: 'Contratista' },
                { key: 'ESTADO', label: 'Estado' },
                { key: 'MONTO', label: 'Monto' },
                { key: 'FECHA_INICIO', label: 'F. Inicio' },
                { key: 'FECHA_FIN', label: 'F. Fin' },
                { key: 'GESTOR_ASIGNADO', label: 'Gestor' }
            ];
            exportToCSV('DACP_Actividades.csv', activities, headers);
        }

        function exportChecklistToExcel(contractId) {
            const checklist = state.checklists[contractId] || [];
            if (checklist.length === 0) {
                alert(`No hay checklist para exportar para el contrato ${contractId}.`);
                return;
            }

            const headers = [
                { key: 'ID', label: 'ID' },
                { key: 'EtapaCriterio', label: 'Etapa / Criterio' },
                { key: 'Aspecto', label: 'Aspecto a Verificar' },
                { key: 'SECOPCumple', label: 'SECOP II (Cumple)' },
                { key: 'SECOPNoCumple', label: 'SECOP II (No Cumple)' },
                { key: 'CARPETACumple', label: 'CARPETA FISICA (Cumple)' },
                { key: 'CARPETANoCumple', label: 'CARPETA FISICA (No Cumple)' },
                { key: 'CARPETAParcialNA', label: 'CARPETA FISICA (Parcial/N/A)' },
                { key: 'ObsCarpeta', label: 'Observaciones Carpeta Fisica' },
                { key: 'ObsSECOP', label: 'Observaciones SECOP II' }
            ];

            const data = checklist.map(item => ({
                ...item,
                SECOPCumple: item.SECOPCumple ? 'X' : '',
                SECOPNoCumple: item.SECOPNoCumple ? 'X' : '',
                CARPETACumple: item.CARPETACumple ? 'X' : '',
                CARPETANoCumple: item.CARPETANoCumple ? 'X' : '',
                CARPETAParcialNA: item.CARPETAParcialNA ? 'X' : ''
            }));

            exportToCSV(`Checklist_Contrato_${contractId}.csv`, data, headers);
        }

        function calculateManagerStats() {
            const stats = {};
            const allAspects = ['SECOPCumple', 'SECOPNoCumple', 'CARPETACumple', 'CARPETANoCumple', 'CARPETAParcialNA'];

            state.actividades.forEach(activity => {
                const manager = activity.GESTOR_ASIGNADO;
                const contractId = activity.ID_CONTRATO;
                const checklist = state.checklists[contractId] || [];

                if (manager && manager !== 'SIN ASIGNAR') {
                    if (!stats[manager]) {
                        stats[manager] = { totalContratos: 0, totalAspectos: 0, totalCumple: 0, totalNoCumple: 0, totalParcial: 0, contratos: [] };
                    }
                    
                    stats[manager].totalContratos++;
                    stats[manager].contratos.push(contractId);

                    checklist.forEach(item => {
                        stats[manager].totalAspectos++;
                        // L√≥gica simplificada de cumplimiento para estad√≠sticas
                        const isCompliant = item.CARPETACumple || item.SECOPCumple;
                        const isNonCompliant = item.CARPETANoCumple || item.SECOPNoCumple;
                        const isPartial = item.CARPETAParcialNA;

                        if (isCompliant) {
                            stats[manager].totalCumple++;
                        } else if (isNonCompliant) {
                            stats[manager].totalNoCumple++;
                        } else if (isPartial) {
                            stats[manager].totalParcial++;
                        }
                    });
                }
            });

            // Calcular porcentajes
            Object.keys(stats).forEach(manager => {
                const s = stats[manager];
                s.pctCumple = s.totalAspectos > 0 ? ((s.totalCumple / s.totalAspectos) * 100).toFixed(1) : 0;
                s.pctNoCumple = s.totalAspectos > 0 ? ((s.totalNoCumple / s.totalAspectos) * 100).toFixed(1) : 0;
                s.pctParcial = s.totalAspectos > 0 ? ((s.totalParcial / s.totalAspectos) * 100).toFixed(1) : 0;
            });

            return stats;
        }

        function exportManagerStatsToExcel() {
            const stats = calculateManagerStats();
            const data = Object.keys(stats).map(managerId => {
                const s = stats[managerId];
                return {
                    GESTOR: managerId,
                    TOTAL_CONTRATOS: s.totalContratos,
                    TOTAL_ASPECTOS_REVISADOS: s.totalAspectos,
                    TOTAL_CUMPLE: s.totalCumple,
                    PCT_CUMPLE: `${s.pctCumple}%`,
                    TOTAL_NO_CUMPLE: s.totalNoCumple,
                    PCT_NO_CUMPLE: `${s.pctNoCumple}%`,
                    TOTAL_PARCIAL_NA: s.totalParcial,
                    PCT_PARCIAL_NA: `${s.pctParcial}%`,
                    CONTRATOS_INVOLUCRADOS: s.contratos.join(', ')
                };
            });

            const headers = [
                { key: 'GESTOR', label: 'Gestor' },
                { key: 'TOTAL_CONTRATOS', label: 'Total Contratos' },
                { key: 'TOTAL_ASPECTOS_REVISADOS', label: 'Total Aspectos Revisados' },
                { key: 'TOTAL_CUMPLE', label: 'Total Cumple' },
                { key: 'PCT_CUMPLE', label: '% Cumple' },
                { key: 'TOTAL_NO_CUMPLE', label: 'Total No Cumple' },
                { key: 'PCT_NO_CUMPLE', label: '% No Cumple' },
                { key: 'TOTAL_PARCIAL_NA', label: 'Total Parcial/N/A' },
                { key: 'PCT_PARCIAL_NA', label: '% Parcial/N/A' },
                { key: 'CONTRATOS_INVOLUCRADOS', label: 'Contratos Involucrados' }
            ];

            exportToCSV('DACP_Estadisticas_Gestores.csv', data, headers);
        }
        
        // --- Funciones de Renderizado ---
        // (Se asumen estas funciones para que el resto del c√≥digo funcione)

        let chartInstance = null;
        
        function renderOverviewChart() {
            const ctx = document.getElementById('overview-chart-canvas').getContext('2d');
            if (chartInstance) {
                chartInstance.destroy();
            }

            const totalActividades = state.actividades.length;
            const estados = state.actividades.reduce((acc, act) => {
                acc[act.ESTADO] = (acc[act.ESTADO] || 0) + 1;
                return acc;
            }, {});

            const data = {
                labels: Object.keys(estados),
                datasets: [{
                    label: 'N√∫mero de Contratos',
                    data: Object.values(estados),
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.6)', // Blue
                        'rgba(251, 191, 36, 0.6)', // Yellow
                        'rgba(16, 185, 129, 0.6)', // Green
                        'rgba(239, 68, 68, 0.6)'   // Red
                    ],
                    borderColor: [
                        'rgb(59, 130, 246)',
                        'rgb(251, 191, 36)',
                        'rgb(16, 185, 129)',
                        'rgb(239, 68, 68)'
                    ],
                    borderWidth: 1
                }]
            };

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `Distribuci√≥n de Contratos (${totalActividades} Total)`
                        }
                    }
                },
            });
        }
        
        function renderOverviewTab() {
            const container = document.getElementById('content-container');
            const totalContratos = state.actividades.length;
            const gestores = [...new Set(state.actividades.map(a => a.GESTOR_ASIGNADO).filter(g => g && g !== 'SIN ASIGNAR'))];
            const stats = calculateManagerStats();
            const totalAspectos = Object.values(stats).reduce((sum, s) => sum + s.totalAspectos, 0);

            let statsHtml = '';
            if (Object.keys(stats).length > 0) {
                statsHtml = `
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 mt-6">Cumplimiento por Gestor</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${Object.keys(stats).map(manager => {
                            const s = stats[manager];
                            return `
                                <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                                    <h4 class="font-bold text-lg text-blue-600">${manager}</h4>
                                    <p class="text-sm text-gray-500">Contratos: ${s.totalContratos}</p>
                                    <p class="text-sm text-gray-500">Aspectos Revisados: ${s.totalAspectos}</p>
                                    <div class="mt-2">
                                        <p class="text-sm text-green-600">‚úÖ Cumple: ${s.totalCumple} (${s.pctCumple}%)</p>
                                        <p class="text-sm text-red-600">‚ùå No Cumple: ${s.totalNoCumple} (${s.pctNoCumple}%)</p>
                                        <p class="text-sm text-yellow-600">‚ö†Ô∏è Parcial/N/A: ${s.totalParcial} (${s.pctParcial}%)</p>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Resumen de Contrataci√≥n DACP</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 shadow-sm">
                            <p class="text-sm font-medium text-gray-500">Total Contratos</p>
                            <p class="text-2xl font-bold text-blue-800">${totalContratos}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500 shadow-sm">
                            <p class="text-sm font-medium text-gray-500">Gestores Asignados</p>
                            <p class="text-2xl font-bold text-green-800">${gestores.length}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-gray-500 shadow-sm">
                            <p class="text-sm font-medium text-gray-500">Total Aspectos Revisados</p>
                            <p class="text-2xl font-bold text-gray-800">${totalAspectos}</p>
                        </div>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-6">
                        <div class="lg:w-1/2 bg-gray-50 p-4 rounded-lg shadow border border-gray-200">
                            <canvas id="overview-chart-canvas"></canvas>
                        </div>
                        <div class="lg:w-1/2">
                            ${statsHtml}
                        </div>
                    </div>
                </div>
            `;
            
            // Renderizar el gr√°fico despu√©s de que el canvas est√© en el DOM
            if (totalContratos > 0) {
                renderOverviewChart();
            }
        }

        function renderActivitiesTab() {
            const container = document.getElementById('content-container');
            const actividades = getActividadesFiltradas();
            const gestores = [...new Set(state.actividades.map(a => a.GESTOR_ASIGNADO).filter(g => g))];
            
            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Matriz de Contrataci√≥n</h2>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="space-x-4">
                            <label for="filter-status" class="text-gray-600 font-medium">Filtrar por Estado:</label>
                            <select id="filter-status" onchange="window.handleFilterChange(this.value)" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="ALL" ${state.activityFilter === 'ALL' ? 'selected' : ''}>Todos</option>
                                <option value="PENDIENTE" ${state.activityFilter === 'PENDIENTE' ? 'selected' : ''}>Pendiente</option>
                                <option value="EN PROGRESO" ${state.activityFilter === 'EN PROGRESO' ? 'selected' : ''}>En Progreso</option>
                                <option value="FINALIZADO" ${state.activityFilter === 'FINALIZADO' ? 'selected' : ''}>Finalizado</option>
                            </select>
                        </div>
                        <div class="space-x-2">
                            <button onclick="window.handleCreateNewContract()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-150">
                                + Nuevo Contrato
                            </button>
                            <button onclick="window.exportDACPActivitiesToExcel()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-150">
                                Exportar Matriz
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Contrato</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contratista</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gestor Asignado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">F. Inicio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">F. Fin</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">D√≠as Duraci√≥n</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${actividades.map(act => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${act.ID_CONTRATO}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <input type="text" value="${act.NOMBRE_CONTRATISTA}" 
                                                   onchange="window.handleActivityChange('${act.ID_ACTIVIDAD}', 'NOMBRE_CONTRATISTA', this.value)"
                                                   class="table-textarea min-w-[200px]" />
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <select onchange="window.handleActivityChange('${act.ID_ACTIVIDAD}', 'ESTADO', this.value)" 
                                                    class="p-1 border border-gray-300 rounded text-sm w-full">
                                                <option value="PENDIENTE" ${act.ESTADO === 'PENDIENTE' ? 'selected' : ''}>Pendiente</option>
                                                <option value="EN PROGRESO" ${act.ESTADO === 'EN PROGRESO' ? 'selected' : ''}>En Progreso</option>
                                                <option value="FINALIZADO" ${act.ESTADO === 'FINALIZADO' ? 'selected' : ''}>Finalizado</option>
                                            </select>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <select onchange="window.handleActivityChange('${act.ID_ACTIVIDAD}', 'GESTOR_ASIGNADO', this.value)" 
                                                    class="p-1 border border-gray-300 rounded text-sm w-full min-w-[150px]">
                                                <option value="SIN ASIGNAR" ${act.GESTOR_ASIGNADO === 'SIN ASIGNAR' ? 'selected' : ''}>Sin Asignar</option>
                                                ${gestores.map(g => `<option value="${g}" ${act.GESTOR_ASIGNADO === g ? 'selected' : ''}>${g}</option>`).join('')}
                                                <option value="Nuevo..." data-action="new-manager">Nuevo...</option>
                                            </select>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <input type="number" value="${act.MONTO || 0}" 
                                                   onchange="window.handleActivityChange('${act.ID_ACTIVIDAD}', 'MONTO', parseFloat(this.value) || 0)"
                                                   class="table-textarea min-w-[100px] text-right" />
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <input type="date" value="${act.FECHA_INICIO || ''}" 
                                                   onchange="window.handleActivityChange('${act.ID_ACTIVIDAD}', 'FECHA_INICIO', this.value)"
                                                   class="table-textarea min-w-[120px]" />
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <input type="date" value="${act.FECHA_FIN || ''}" 
                                                   onchange="window.handleActivityChange('${act.ID_ACTIVIDAD}', 'FECHA_FIN', this.value)"
                                                   class="table-textarea min-w-[120px]" />
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${act.DURACION_DIAS || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderChecklistTab() {
            const container = document.getElementById('content-container');
            const checklist = getCurrentChecklist();
            const contractId = state.selectedContractId;
            
            if (!contractId) {
                container.innerHTML = `<p class="text-center text-gray-500 p-8">Por favor, seleccione un contrato.</p>`;
                return;
            }

            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Lista de Chequeo - Contrato ${contractId}</h2>
                    
                    <div class="flex justify-end mb-4 space-x-2">
                        <input type="file" id="import-csv-file" accept=".csv" class="hidden" onchange="window.importChecklistFromCSV(event)">
                        <button onclick="document.getElementById('import-csv-file').click()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded transition duration-150">
                            Importar Checklist (CSV)
                        </button>
                        <button onclick="window.exportChecklistToExcel('${contractId}')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-150">
                            Exportar Checklist
                        </button>
                    </div>

                    ${checklist.length === 0 ? 
                        '<p class="text-center text-gray-500 p-8">No hay aspectos en la lista de chequeo para este contrato. Importe un archivo CSV o cree nuevos aspectos.</p>' 
                        : 
                        `<div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th rowspan="2" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[10%]">ID/Etapa/Aspecto</th>
                                        <th colspan="2" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-r">SECOP II</th>
                                        <th colspan="3" class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r">CARPETA FISICA</th>
                                        <th rowspan="2" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[20%]">Obs. Carpeta</th>
                                        <th rowspan="2" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-[20%]">Obs. SECOP</th>
                                    </tr>
                                    <tr class="bg-gray-100">
                                        <th class="px-2 py-1 text-center text-xs font-medium text-gray-500">Cumple</th>
                                        <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 border-r">No Cumple</th>
                                        <th class="px-2 py-1 text-center text-xs font-medium text-gray-500">Cumple</th>
                                        <th class="px-2 py-1 text-center text-xs font-medium text-gray-500">No Cumple</th>
                                        <th class="px-2 py-1 text-center text-xs font-medium text-gray-500 border-r">Parcial/N/A</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${checklist.map(item => `
                                        <tr>
                                            <td class="p-2 align-top text-sm font-medium text-gray-900">
                                                <div class="font-bold">${item.ID}. ${item.EtapaCriterio}</div>
                                                <div class="text-xs text-gray-600">${item.Aspecto}</div>
                                            </td>
                                            
                                            <td class="p-2 text-center align-top border-l">
                                                <input type="checkbox" ${item.SECOPCumple ? 'checked' : ''} 
                                                       onchange="window.handleChecklistChange('${contractId}', '${item.ID}', 'SECOPCumple', this.checked)"
                                                       class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            </td>
                                            <td class="p-2 text-center align-top border-r">
                                                <input type="checkbox" ${item.SECOPNoCumple ? 'checked' : ''} 
                                                       onchange="window.handleChecklistChange('${contractId}', '${item.ID}', 'SECOPNoCumple', this.checked)"
                                                       class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                            </td>
                                            
                                            <td class="p-2 text-center align-top">
                                                <input type="checkbox" ${item.CARPETACumple ? 'checked' : ''} 
                                                       onchange="window.handleChecklistChange('${contractId}', '${item.ID}', 'CARPETACumple', this.checked)"
                                                       class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            </td>
                                            <td class="p-2 text-center align-top">
                                                <input type="checkbox" ${item.CARPETANoCumple ? 'checked' : ''} 
                                                       onchange="window.handleChecklistChange('${contractId}', '${item.ID}', 'CARPETANoCumple', this.checked)"
                                                       class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                            </td>
                                            <td class="p-2 text-center align-top border-r">
                                                <input type="checkbox" ${item.CARPETAParcialNA ? 'checked' : ''} 
                                                       onchange="window.handleChecklistChange('${contractId}', '${item.ID}', 'CARPETAParcialNA', this.checked)"
                                                       class="w-4 h-4 text-yellow-600 focus:ring-yellow-500 border-gray-300 rounded">
                                            </td>

                                            <td class="p-2 align-top">
                                                <textarea onchange="window.handleChecklistChange('${contractId}', '${item.ID}', 'ObsCarpeta', this.value)"
                                                          class="table-textarea">${item.ObsCarpeta || ''}</textarea>
                                            </td>
                                            <td class="p-2 align-top">
                                                <textarea onchange="window.handleChecklistChange('${contractId}', '${item.ID}', 'ObsSECOP', this.value)"
                                                          class="table-textarea">${item.ObsSECOP || ''}</textarea>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>`
                    }
                </div>
            `;
        }
        
        function renderStatsTab() {
            const container = document.getElementById('content-container');
            const stats = calculateManagerStats();
            const gestores = Object.keys(stats);

            if (gestores.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 p-8">No hay gestores asignados a contratos con checklists para generar estad√≠sticas.</p>`;
                return;
            }

            container.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Estad√≠sticas de Cumplimiento por Gestor</h2>
                    
                    <div class="flex justify-end mb-4">
                        <button onclick="window.exportManagerStatsToExcel()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-150">
                            Exportar Estad√≠sticas
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gestor</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Contratos</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aspectos Revisados</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-green-600 uppercase tracking-wider">Total Cumple (%)</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-red-600 uppercase tracking-wider">Total No Cumple (%)</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-yellow-600 uppercase tracking-wider">Total Parcial/N/A (%)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contratos</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${gestores.map(manager => {
                                    const s = stats[manager];
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${manager}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm">${s.totalContratos}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm">${s.totalAspectos}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-green-600">${s.totalCumple} (${s.pctCumple}%)</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-red-600">${s.totalNoCumple} (${s.pctNoCumple}%)</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-yellow-600">${s.totalParcial} (${s.pctParcial}%)</td>
                                            <td class="px-6 py-4 text-sm text-gray-500 max-w-xs overflow-hidden text-ellipsis">${s.contratos.join(', ')}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderTab(tabName) {
            state.currentTab = tabName;
            
            // Remover la clase 'tab-active' de todas las pesta√±as
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('tab-active');
            });

            // Agregar la clase 'tab-active' a la pesta√±a seleccionada
            const selectedTab = document.getElementById(`tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('tab-active');
            }

            // Renderizar el contenido de la pesta√±a
            const contentContainer = document.getElementById('content-container');
            if (!contentContainer) return;

            // Destruir el gr√°fico anterior si existe
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }

            switch (tabName) {
                case 'overview':
                    renderOverviewTab();
                    break;
                case 'activities':
                    renderActivitiesTab();
                    break;
                case 'checklist':
                    renderChecklistTab();
                    break;
                case 'stats':
                    renderStatsTab();
                    break;
                default:
                    contentContainer.innerHTML = '<p class="text-center text-gray-500 p-8">Contenido no encontrado.</p>';
            }
        }

        function renderApp() {
            // Actualizar el selector de contratos
            const selectEl = document.getElementById('contract-select');
            if (selectEl) {
                const currentSelected = state.selectedContractId;
                selectEl.innerHTML = state.actividades.map(act => 
                    `<option value="${act.ID_CONTRATO}" ${act.ID_CONTRATO === currentSelected ? 'selected' : ''}>${act.ID_CONTRATO}</option>`
                ).join('');
                
                // Asegurar que el contrato seleccionado se actualice si la lista cambi√≥
                if (state.actividades.length > 0 && !state.selectedContractId) {
                    state.selectedContractId = state.actividades[0].ID_CONTRATO;
                } else if (state.actividades.length === 0) {
                    state.selectedContractId = null;
                }
            }

            // Renderizar la pesta√±a actual
            renderTab(state.currentTab);
        }

        // =================================================================
        // === INICIALIZACI√ìN ===
        // =================================================================

        window.onload = async function() {
            // Exponer las funciones al √°mbito global para que el HTML pueda llamarlas
            window.handleActivityChange = handleActivityChange;
            window.handleChecklistChange = handleChecklistChange;
            window.handleCreateNewContract = handleCreateNewContract;
            window.handleContractSelectChange = handleContractSelectChange;
            window.handleManagerSelectChange = handleManagerSelectChange; 
            window.handleFilterChange = handleFilterChange;
            window.importChecklistFromCSV = importChecklistFromCSV;
            window.exportDACPActivitiesToExcel = exportDACPActivitiesToExcel;
            window.exportChecklistToExcel = exportChecklistToExcel;
            window.exportManagerStatsToExcel = exportManagerStatsToExcel;
            window.getActividadesFiltradas = getActividadesFiltradas;
            window.getCurrentChecklist = getCurrentChecklist;
            window.getManagerChecklist = getManagerChecklist;
            window.renderTab = renderTab; // A√±adir renderTab a la ventana

            
            // ‚ö†Ô∏è NUEVO: Mostrar mensaje de carga
            const root = document.getElementById('root');
            const loadingMessage = document.createElement('div');
            loadingMessage.id = 'initial-loading-message';
            loadingMessage.innerHTML = '<p class="text-center text-xl text-blue-600 mt-20">Cargando datos de la nube, por favor espere...</p>';
            root.appendChild(loadingMessage);

            // Esperar a cargar los datos de la nube antes de renderizar
            await fetchStateFromCloud();
            
            // Remover el mensaje de carga
            const initialLoadingMessage = document.getElementById('initial-loading-message');
            if (initialLoadingMessage) {
                root.removeChild(initialLoadingMessage);
            }

            // Finalmente, renderizar la aplicaci√≥n con los datos cargados
            renderApp();
            
            // üöÄ NUEVO: Iniciar el guardado autom√°tico despu√©s de la carga inicial
            startAutoSave(); 
        };

    </script>
</body>
</html>
