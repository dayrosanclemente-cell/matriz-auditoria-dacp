// ... CONTINUACIÓN DEL CÓDIGO JavaScript

                const statsExterna = calcularEstadisticas(externa);

                state.charts.barChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Interna', 'Externa'],
                        datasets: [
                            {
                                label: 'Cumple',
                                data: [statsInterna.cumple, statsExterna.cumple],
                                backgroundColor: 'rgb(34, 197, 94)',
                            },
                            {
                                label: 'No Cumple',
                                data: [statsInterna.noCumple, statsExterna.noCumple],
                                backgroundColor: 'rgb(239, 68, 68)',
                            },
                            {
                                label: 'Parcial',
                                data: [statsInterna.parcial, statsExterna.parcial],
                                backgroundColor: 'rgb(245, 158, 11)',
                            },
                            {
                                label: 'Pendiente',
                                data: [statsInterna.pendiente, statsExterna.pendiente],
                                backgroundColor: 'rgb(107, 114, 128)',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function renderChecklistStageRadar(checklist) {
            // Destruir gráfico anterior
            if (state.charts.stageChart) state.charts.stageChart.destroy();
            
            const stats = calculateChecklistStats(checklist);
            const etapas = Object.keys(stats.porEtapa);
            const scores = etapas.map(e => stats.porEtapa[e].pctCumplimiento);

            const ctx = document.getElementById('checklistRadarChart')?.getContext('2d');
            if (ctx) {
                state.charts.stageChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: etapas,
                        datasets: [{
                            label: '% Cumplimiento (SECOP + Carpeta Física)',
                            data: scores,
                            backgroundColor: 'rgba(16, 185, 129, 0.2)', // emerald-500
                            borderColor: 'rgba(16, 185, 129, 1)',
                            pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                            pointBorderColor: '#fff',
                            borderWidth: 1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                suggestedMin: 0,
                                suggestedMax: 100,
                                pointLabels: {
                                    font: { size: 10 }
                                },
                                ticks: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: true, position: 'bottom' }
                        }
                    }
                });
            }
        }

        // NUEVA FUNCIÓN: Renderiza el gráfico de Radar para el Manager
        function renderManagerRadarChart(stats) {
            if (state.charts.managerRadarChart) state.charts.managerRadarChart.destroy();
            
            const etapas = Object.keys(stats.porEtapa);
            const scores = etapas.map(e => stats.porEtapa[e].pctCumplimiento);

            const ctx = document.getElementById('managerRadarChart')?.getContext('2d');
            if (ctx) {
                state.charts.managerRadarChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: etapas,
                        datasets: [{
                            label: '% Cumplimiento por Etapa',
                            data: scores,
                            backgroundColor: 'rgba(251, 191, 36, 0.4)', // amber-400
                            borderColor: 'rgb(251, 191, 36)',
                            pointBackgroundColor: 'rgb(251, 191, 36)',
                            pointBorderColor: '#fff',
                            borderWidth: 1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                suggestedMin: 0,
                                suggestedMax: 100,
                                pointLabels: {
                                    font: { size: 12 }
                                },
                                ticks: { 
                                    display: true, 
                                    stepSize: 25, 
                                    backdropColor: 'rgba(0, 0, 0, 0)' // Fondo transparente para los ticks
                                } 
                            }
                        },
                        plugins: {
                            legend: { display: true, position: 'bottom' }
                        }
                    }
                });
            }
        }

        // NUEVA FUNCIÓN: Renderiza el gráfico de Pastel/Donut para el Manager
        function renderManagerPieChart(stats) {
            if (state.charts.managerPieChart) state.charts.managerPieChart.destroy();
            
            const cumplidas = stats.cumplidasSECOP + stats.cumplidasFISICA;
            const noCumplidas = stats.noCumplidasSECOP + stats.noCumplidasFISICA;
            const noAplicaParcial = stats.noAplicaParcial;
            const pendienteNoEvaluado = stats.pendienteNoEvaluado;

            const ctx = document.getElementById('managerPieChart')?.getContext('2d');
            if (ctx) {
                state.charts.managerPieChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['✓ Cumple', '✗ No Cumple', '◐ N/A o Parcial', 'Pendiente Evaluar'],
                        datasets: [{
                            data: [cumplidas, noCumplidas, noAplicaParcial, pendienteNoEvaluado > 0 ? pendienteNoEvaluado : 0],
                            backgroundColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)', 'rgb(251, 191, 36)', 'rgb(107, 114, 128)'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: `Cumplimiento Total (${stats.pctCumplimientoTotal.toFixed(1)}%)`,
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
            }
        }


        // --- Componentes de UI (Cards) ---

        function renderStatsCard(stats) {
            return `
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    ${renderStatItem('Total Actividades', stats.total, 'bg-blue-100 text-blue-800')}
                    ${renderStatItem('Evaluadas', stats.evaluadas, 'bg-indigo-100 text-indigo-800')}
                    ${renderStatItem('Pendientes', stats.pendiente, 'bg-gray-100 text-gray-800')}
                    ${renderStatItem('Cumplimiento (%)', stats.evaluadas > 0 ? (stats.cumple / stats.evaluadas * 100).toFixed(1) : 0, 'bg-green-100 text-green-800')}
                </div>
            `;
        }

        function renderStatItem(title, value, colorClass) {
            return `
                <div class="p-4 bg-white rounded-lg shadow-md border border-gray-200">
                    <p class="text-sm font-medium text-gray-500">${title}</p>
                    <p class="text-2xl font-bold ${colorClass}">${value}</p>
                </div>
            `;
        }

        // --- Funciones de Renderización de Pestañas ---

        function renderDACPActivities() {
            const filteredActivities = getActividadesFiltradas();
            const stats = calcularEstadisticas(state.dacpActivities);
            const activitiesHtml = filteredActivities.map(act => {
                const bgColor = act.cumplimiento === 'Cumple' ? 'bg-green-50' : 
                                act.cumplimiento === 'No Cumple' ? 'bg-red-50' : 
                                act.cumplimiento === 'Parcial' ? 'bg-amber-50' : 
                                'bg-white';
                
                return `
                    <tr class="hover:bg-gray-50 ${bgColor}">
                        <td class="p-3 whitespace-nowrap text-sm font-medium text-gray-900">${act.id}</td>
                        <td class="p-3 whitespace-nowrap text-xs text-gray-500">${act.tipo}</td>
                        <td class="p-3 text-sm text-gray-500">${act.proceso}</td>
                        <td class="p-3 text-sm text-gray-700 font-medium">${act.actividad}</td>
                        <td class="p-3 whitespace-nowrap text-center text-sm font-semibold text-indigo-600">${act.importancia}</td>
                        <td class="p-3 whitespace-nowrap w-32">
                            <select name="cumplimiento_${act.id}" onchange="handleActivityChange(event)" class="p-1 border rounded-md text-xs w-full ${act.cumplimiento === 'Cumple' ? 'bg-green-100 border-green-400' : act.cumplimiento === 'No Cumple' ? 'bg-red-100 border-red-400' : act.cumplimiento === 'Parcial' ? 'bg-amber-100 border-amber-400' : 'bg-white border-gray-300'}">
                                <option value="">Pendiente</option>
                                <option value="Cumple" ${act.cumplimiento === 'Cumple' ? 'selected' : ''}>Cumple</option>
                                <option value="No Cumple" ${act.cumplimiento === 'No Cumple' ? 'selected' : ''}>No Cumple</option>
                                <option value="Parcial" ${act.cumplimiento === 'Parcial' ? 'selected' : ''}>Parcial</option>
                            </select>
                        </td>
                        <td class="p-3 text-sm text-gray-500">${act.fechaEvaluacion || 'N/A'}</td>
                        <td class="p-3">
                            <textarea 
                                name="observaciones_${act.id}" 
                                onchange="handleActivityChange(event)" 
                                rows="2" 
                                class="table-textarea text-gray-700" 
                                placeholder="Escriba aquí las observaciones..."
                            >${act.observaciones}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');

            // Dibuja los gráficos del dashboard
            renderDashboardCharts(stats);

            return `
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Matriz de Actividades DACP</h2>
                    
                    ${renderStatsCard(stats)}
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Distribución General de Cumplimiento</h3>
                            <div style="height: 300px;">
                                <canvas id="compliancePieChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Cumplimiento por Tipo de Actividad</h3>
                            <div style="height: 250px;">
                                <canvas id="typeBarChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-center space-x-4 mb-6 p-4 bg-white rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="filtroTipo" class="text-sm font-medium text-gray-700">Filtrar por Tipo:</label>
                            <select id="filtroTipo" name="filtroTipo" onchange="handleActivityChange(event)" class="p-2 border rounded-lg text-sm">
                                <option value="Todos" ${state.filtroTipo === 'Todos' ? 'selected' : ''}>Todos</option>
                                <option value="Interna" ${state.filtroTipo === 'Interna' ? 'selected' : ''}>Interna</option>
                                <option value="Externa" ${state.filtroTipo === 'Externa' ? 'selected' : ''}>Externa</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="filtroCumplimiento" class="text-sm font-medium text-gray-700">Filtrar por Cumplimiento:</label>
                            <select id="filtroCumplimiento" name="filtroCumplimiento" onchange="handleActivityChange(event)" class="p-2 border rounded-lg text-sm">
                                <option value="Todos" ${state.filtroCumplimiento === 'Todos' ? 'selected' : ''}>Todos</option>
                                <option value="Cumple" ${state.filtroCumplimiento === 'Cumple' ? 'selected' : ''}>Cumple</option>
                                <option value="No Cumple" ${state.filtroCumplimiento === 'No Cumple' ? 'selected' : ''}>No Cumple</option>
                                <option value="Parcial" ${state.filtroCumplimiento === 'Parcial' ? 'selected' : ''}>Parcial</option>
                                <option value="Pendiente" ${state.filtroCumplimiento === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                            </select>
                        </div>
                        <button onclick="exportToExcel(getActividadesFiltradas(), 'Matriz_DACP_Auditoria.csv')" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 text-sm">
                            Exportar a Excel
                        </button>
                    </div>

                    <div class="overflow-x-auto bg-white shadow-lg rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">ID</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Tipo</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Proceso</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Actividad</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Imp.</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase w-32">Cumplimiento</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">F. Evaluación</th>
                                    <th scope="col" class="p-3 text-left text-xs font-semibold text-gray-600 uppercase w-64">Observaciones</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${activitiesHtml}
                            </tbody>
                        </table>
                        ${filteredActivities.length === 0 ? '<p class="text-center p-4 text-gray-500">No hay actividades que coincidan con los filtros.</p>' : ''}
                    </div>
                </div>
            `;
        }

        function renderContractChecklist() {
            const contractIds = Object.keys(state.contracts);
            const checklist = getCurrentChecklist();
            const stats = calculateChecklistStats(checklist);

            // Dibuja el gráfico de radar
            renderChecklistStageRadar(checklist);

            const checklistHtml = checklist.map(item => {
                const etapa = item.etapa;
                const isEtapaHeader = item.id === checklist.find(i => i.etapa === etapa)?.id; // Solo el primer ítem de cada etapa

                return `
                    <tr class="hover:bg-gray-50 ${isEtapaHeader ? 'border-t-4 border-blue-200' : ''}">
                        ${isEtapaHeader ? `<td rowspan="${checklist.filter(i => i.etapa === etapa).length}" class="p-3 text-center text-sm font-semibold text-blue-700 align-top bg-blue-50">${etapa}</td>` : ''}
                        
                        <td class="p-3 whitespace-nowrap text-sm font-medium text-gray-900">${item.id}</td>
                        <td class="p-3 text-sm text-gray-700">${item.aspecto}</td>
                        
                        <td class="p-3 text-center">
                            <input type="checkbox" name="secop_cumple_${item.id}" 
                                   onchange="handleChecklistChange(${item.id}, 'SECOP II - Cumple', this.checked ? 'X' : '')"
                                   ${item["SECOP II - Cumple"] === 'X' ? 'checked' : ''} 
                                   class="form-checkbox h-5 w-5 text-green-600 rounded">
                        </td>
                        <td class="p-3 text-center">
                            <input type="checkbox" name="secop_no_cumple_${item.id}"
                                   onchange="handleChecklistChange(${item.id}, 'SECOP II - No Cumple', this.checked ? 'X' : '')"
                                   ${item["SECOP II - No Cumple"] === 'X' ? 'checked' : ''} 
                                   class="form-checkbox h-5 w-5 text-red-600 rounded">
                        </td>

                        <td class="p-3 text-center">
                            <input type="checkbox" name="fisica_cumple_${item.id}" 
                                   onchange="handleChecklistChange(${item.id}, 'CARPETA FISICA - Cumple', this.checked ? 'X' : '')"
                                   ${item["CARPETA FISICA - Cumple"] === 'X' ? 'checked' : ''} 
                                   class="form-checkbox h-5 w-5 text-green-600 rounded">
                        </td>
                        <td class="p-3 text-center">
                            <input type="checkbox" name="fisica_no_cumple_${item.id}" 
                                   onchange="handleChecklistChange(${item.id}, 'CARPETA FISICA - No Cumple', this.checked ? 'X' : '')"
                                   ${item["CARPETA FISICA - No Cumple"] === 'X' ? 'checked' : ''} 
                                   class="form-checkbox h-5 w-5 text-red-600 rounded">
                        </td>
                        <td class="p-3 text-center">
                            <input type="checkbox" name="fisica_no_aplica_${item.id}" 
                                   onchange="handleChecklistChange(${item.id}, 'CARPETA FISICA - No Aplica/ Parcialmente', this.checked ? 'X' : '')"
                                   ${item["CARPETA FISICA - No Aplica/ Parcialmente"] === 'X' ? 'checked' : ''} 
                                   class="form-checkbox h-5 w-5 text-amber-600 rounded">
                        </td>
                        
                        <td class="p-3 w-48">
                            <textarea 
                                onchange="handleChecklistChange(${item.id}, 'evidencia', this.value)" 
                                rows="1" 
                                class="table-textarea text-xs" 
                                placeholder="Evidencia (Ej. Link/Doc)"
                            >${item.evidencia}</textarea>
                        </td>

                        <td class="p-3 w-48">
                            <textarea 
                                onchange="handleChecklistChange(${item.id}, 'obs_fisica', this.value)" 
                                rows="1" 
                                class="table-textarea text-xs" 
                                placeholder="Obs. Carpeta Física"
                            >${item.obs_fisica}</textarea>
                        </td>

                        <td class="p-3 w-48">
                            <textarea 
                                onchange="handleChecklistChange(${item.id}, 'obs_secop', this.value)" 
                                rows="1" 
                                class="table-textarea text-xs" 
                                placeholder="Obs. SECOP II"
                            >${item.obs_secop}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Lista de Chequeo de Contratación</h2>
                    
                    <div class="flex flex-wrap items-center space-x-4 mb-6 p-4 bg-white rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="contract-select" class="text-sm font-medium text-gray-700">Contrato Activo:</label>
                            <select id="contract-select" onchange="handleContractSelectChange(event)" class="p-2 border rounded-lg text-sm font-bold">
                                ${contractIds.map(id => 
                                    `<option value="${id}" ${state.currentContractId === id ? 'selected' : ''}>${id}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <button onclick="handleCreateNewContract()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 text-sm">
                            + Nuevo Contrato
                        </button>
                        <button onclick="exportChecklistToExcel(state.currentContractId, getCurrentChecklist())" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 text-sm">
                            Exportar Checklist a Excel
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        ${renderStatItem('Total Ítems', stats.total, 'bg-blue-100 text-blue-800')}
                        ${renderStatItem('SECOP Cumple', stats.cumplidasSECOP, 'bg-green-100 text-green-800')}
                        ${renderStatItem('FÍSICA Cumple', stats.cumplidasFISICA, 'bg-green-100 text-green-800')}
                        ${renderStatItem('Cumplimiento Global', `${stats.pctCumplimientoTotal.toFixed(1)}%`, 'bg-indigo-100 text-indigo-800')}
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg mb-6 max-w-xl mx-auto">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">Cumplimiento por Etapa del Contrato</h3>
                        <div style="height: 350px;">
                            <canvas id="checklistRadarChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto bg-white shadow-lg rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200 text-xs">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th rowspan="2" scope="col" class="p-3 text-left font-semibold text-gray-600 uppercase border-b-2">Etapa / Criterio</th>
                                    <th rowspan="2" scope="col" class="p-3 text-left font-semibold text-gray-600 uppercase border-b-2">N°</th>
                                    <th rowspan="2" scope="col" class="p-3 text-left font-semibold text-gray-600 uppercase border-b-2 w-48">Aspecto a Verificar</th>
                                    <th colspan="2" scope="colgroup" class="p-3 text-center font-semibold text-gray-600 uppercase border-b-2 bg-blue-100">SECOP II</th>
                                    <th colspan="3" scope="colgroup" class="p-3 text-center font-semibold text-gray-600 uppercase border-b-2 bg-green-100">CARPETA FÍSICA</th>
                                    <th rowspan="2" scope="col" class="p-3 text-left font-semibold text-gray-600 uppercase border-b-2 w-48">Evidencia</th>
                                    <th rowspan="2" scope="col" class="p-3 text-left font-semibold text-gray-600 uppercase border-b-2 w-48">Obs. Carpeta Física</th>
                                    <th rowspan="2" scope="col" class="p-3 text-left font-semibold text-gray-600 uppercase border-b-2 w-48">Obs. SECOP II</th>
                                </tr>
                                <tr>
                                    <th scope="col" class="p-3 text-center font-semibold text-green-700 uppercase bg-blue-100">Cumple</th>
                                    <th scope="col" class="p-3 text-center font-semibold text-red-700 uppercase bg-blue-100">No Cumple</th>
                                    <th scope="col" class="p-3 text-center font-semibold text-green-700 uppercase bg-green-100">Cumple</th>
                                    <th scope="col" class="p-3 text-center font-semibold text-red-700 uppercase bg-green-100">No Cumple</th>
                                    <th scope="col" class="p-3 text-center font-semibold text-amber-700 uppercase bg-green-100">N/A o Parcial</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${checklistHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // NUEVA FUNCIÓN: Renderiza la pestaña Manager/Consolidado
        function renderConsolidatedManager() {
            const contractIds = Object.keys(state.contracts);
            const selectedContract = state.consolidatedContractId;

            if (!selectedContract) {
                return `<p class="text-center text-xl text-gray-500 mt-20">No hay contratos disponibles para consolidar.</p>`;
            }
            
            const checklist = getManagerChecklist();
            const stats = calculateChecklistStats(checklist);

            // Dibuja los gráficos del manager
            renderManagerRadarChart(stats);
            renderManagerPieChart(stats);

            return `
                <div class="mt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Módulo Manager: Consolidación por Contrato</h2>
                    <p class="text-gray-600 mb-6">Seleccione un contrato para ver su resumen estadístico de cumplimiento.</p>

                    <div class="flex flex-wrap items-center space-x-4 mb-6 p-4 bg-white rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="manager-select" class="text-sm font-medium text-gray-700">Contrato Seleccionado:</label>
                            <select id="manager-select" onchange="handleManagerSelectChange(event)" class="p-2 border rounded-lg text-sm font-bold text-blue-700">
                                ${contractIds.map(id => 
                                    `<option value="${id}" ${selectedContract === id ? 'selected' : ''}>${id}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <button onclick="exportManagerStatsToExcel(state.consolidatedContractId, calculateChecklistStats(getManagerChecklist()))" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 text-sm">
                            Exportar Resumen
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                        ${renderStatItem('ID Contrato', selectedContract, 'bg-blue-100 text-blue-800 col-span-1')}
                        ${renderStatItem('Cumplimiento Total', `${stats.pctCumplimientoTotal.toFixed(1)}%`, 'bg-green-100 text-green-800 col-span-2')}
                        ${renderStatItem('Ítems Pendientes', stats.pendienteNoEvaluado, 'bg-gray-100 text-gray-800 col-span-1')}
                        ${renderStatItem('N/A o Parcial', stats.noAplicaParcial, 'bg-amber-100 text-amber-800 col-span-1')}
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">Cumplimiento por Etapa del Contrato</h3>
                            <div style="height: 350px;">
                                <canvas id="managerRadarChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col justify-center">
                            <div style="height: 300px;">
                                <canvas id="managerPieChart"></canvas>
                            </div>
                            <p class="text-center text-sm text-gray-500 mt-4">La gráfica muestra la distribución de cumplimiento de los 31 ítems.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Función principal que renderiza el contenido según la pestaña activa.
         */
        function renderApp() {
            const root = document.getElementById('root');
            if (!root) return;

            // 1. Renderizar la estructura base y la navegación (fuera del 'root' pero en el mismo div)
            const navHtml = `
                <header class="bg-white shadow-sm sticky top-0 z-10 border-b border-gray-200">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center py-4">
                            <h1 class="text-3xl font-extrabold text-blue-700">Auditoría DACP</h1>
                            <nav class="flex space-x-6">
                                <a href="#" id="tab-dashboard" onclick="setState({ activeTab: 'dashboard' })" class="py-2 text-lg font-medium text-gray-500 hover:text-blue-600 transition duration-150 ${state.activeTab === 'dashboard' ? 'tab-active' : ''}">Dashboard</a>
                                <a href="#" id="tab-checklist" onclick="setState({ activeTab: 'checklist' })" class="py-2 text-lg font-medium text-gray-500 hover:text-blue-600 transition duration-150 ${state.activeTab === 'checklist' ? 'tab-active' : ''}">Lista de Chequeo</a>
                                <a href="#" id="tab-manager" onclick="setState({ activeTab: 'manager' })" class="py-2 text-lg font-medium text-gray-500 hover:text-blue-600 transition duration-150 ${state.activeTab === 'manager' ? 'tab-active' : ''}">Manager</a>
                            </nav>
                        </div>
                    </div>
                </header>
            `;
            // Reemplazar el contenido de 'root' con la navegación + contenido de la pestaña
            
            let contentHtml = '';
            if (state.activeTab === 'checklist') {
                contentHtml = renderContractChecklist();
            } else if (state.activeTab === 'manager') {
                contentHtml = renderConsolidatedManager();
            } else {
                contentHtml = renderDACPActivities();
            }
            
            root.innerHTML = navHtml + `<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-10">${contentHtml}</div>`;
        }


        // =================================================================
        // 6. INICIO DE LA APLICACIÓN
        // =================================================================

        window.onload = async function() {
            // 1. Exponer las funciones al ámbito global para que el HTML pueda llamarlas
            window.setState = setState;
            window.handleActivityChange = handleActivityChange;
            window.handleChecklistChange = handleChecklistChange;
            window.handleCreateNewContract = handleCreateNewContract;
            window.handleContractSelectChange = handleContractSelectChange;
            window.handleManagerSelectChange = handleManagerSelectChange; // NUEVO
            window.exportToExcel = exportToExcel;
            window.exportChecklistToExcel = exportChecklistToExcel;
            window.exportManagerStatsToExcel = exportManagerStatsToExcel; // NUEVO
            window.getActividadesFiltradas = getActividadesFiltradas;
            window.getCurrentChecklist = getCurrentChecklist;
            window.getManagerChecklist = getManagerChecklist; // NUEVO
            
            // ⚠️ NUEVO: Mostrar mensaje de carga
            const root = document.getElementById('root');
            const loadingMessage = document.createElement('div');
            loadingMessage.innerHTML = '<p class="text-center text-xl text-blue-600 mt-20">Cargando datos de la nube, por favor espere...</p>';
            root.appendChild(loadingMessage);

            // 2. Esperar a cargar los datos de la nube antes de renderizar
            await fetchStateFromCloud();
            
            // 3. Remover el mensaje de carga
            root.removeChild(loadingMessage);

            // 4. Finalmente, renderizar la aplicación con los datos cargados
            renderApp();
        };

    </script>
</body>
</html>
