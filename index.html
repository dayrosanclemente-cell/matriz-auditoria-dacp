<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Auditoría DACP - Contratación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        /* Estilos base */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        /* Estilos para el texto y textarea de la tabla */
        .table-textarea {
            width: 100%;
            min-height: 40px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 0.875rem; /* sm */
        }
        /* Estilo para el input de fecha */
        .date-input {
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.875rem;
            width: 120px; /* Ancho fijo para mejorar la visualización */
        }
        /* Clase para pestañas activas */
        .tab-active {
            border-bottom-width: 2px;
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6; /* blue-500 */
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-800 border-b pb-2">Panel de Control de Auditoría DACP</h1>
            <p class="text-slate-500">Gestión y seguimiento de actividades de Contratación Pública y Auditoría de Contratos.</p>
        </header>

        <nav class="flex space-x-4 mb-8 border-b border-slate-200">
            <button id="tab-dashboard" class="py-2 px-4 text-slate-600 hover:text-blue-500 focus:outline-none">Dashboard</button>
            <button id="tab-evaluacion" class="py-2 px-4 text-slate-600 hover:text-blue-500 focus:outline-none">Evaluación DACP</button>
            <button id="tab-lista_de_chequeo" class="py-2 px-4 text-slate-600 hover:text-blue-500 focus:outline-none">Lista de Chequeo (Auditor)</button>
        </nav>

        <main id="content-container">
            </main>
    </div>

    <script>
        // Registrar el plugin de datalabels para Chart.js
        Chart.register(ChartDataLabels);

        // =================================================================
        // 1. DATOS INICIALES (ACTIVIDADES Y CHECKLIST)
        // =================================================================

        // Plantilla de Actividades DACP (16 Actividades)
        // **NOTA: fecha_evaluacion debe ser YYYY-MM-DD para input type="date"**
        const INITIAL_DACP_ACTIVITIES = [
            { id: 1, tipo: "Interna", proceso: "GESTIÓN CONTRACTUAL", actividad: "ESTRUCTURACIÓN DEL PROCESO DE CONTRATACIÓN", frecuencia: "TRIMESTRAL", importancia: "95%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 2, tipo: "Interna", proceso: "GESTIÓN CONTRACTUAL", actividad: "VALIDACION APLICATIVO CONTRATISTA", frecuencia: "Mensualizada", importancia: "85%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 3, tipo: "Interna", proceso: "GESTIÓN CONTRACTUAL", actividad: "VALIDACION HOJA DE VIDA DE SIGEP", frecuencia: "Mensualizada", importancia: "80%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 4, tipo: "Interna", proceso: "GESTIÓN CONTRACTUAL", actividad: "VALIDACION DE DOCUMENTOS CONTRACTUALES", frecuencia: "3 DIAS A LA EJECUCIÓN DEL CONTRATO", importancia: "90%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 5, tipo: "Interna", proceso: "GESTIÓN CONTRACTUAL", actividad: "AFILIACIÓN ARL", frecuencia: "5 primeros dias de cada mes (mes vencido)", importancia: "75%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 6, tipo: "Interna", proceso: "GESTIÓN CONTRACTUAL", actividad: "REQUERIR Y APOYAR EN LA ELABORACION DEL PLAN DE TRABAJO", frecuencia: "Mensualizada", importancia: "85%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 7, tipo: "Interna", proceso: "GESTIÓN CONTRACTUAL", actividad: "REVISION DE INFORMES DE GESTIÓN", frecuencia: "Mensualizada", importancia: "85%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 8, tipo: "Interna", proceso: "GESTIÓN CONTRACTUAL", actividad: "SEGUIMIENTO A ACTIVIDADES DESIGNADAS", frecuencia: "Mensualizada", importancia: "80%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 9, tipo: "Interna", proceso: "GESTIÓN CONTRACTUAL", actividad: "Actividades contractuales vs actividades presentadas", frecuencia: "Mensualizada", importancia: "90%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 10, tipo: "Interna", proceso: "GESTIÓN CONTRACTUAL", actividad: "Informes mensual contratos de prestacion de servicios", frecuencia: "Mensualizada", importancia: "85%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 11, tipo: "Interna", proceso: "DELEGACIONES", actividad: "Gestión de solicitudes de delegación especial de facultades contractuales", frecuencia: "Según necesidad", importancia: "95%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 12, tipo: "Externa", proceso: "GESTIÓN CONTRACTUAL", actividad: "Publicaciones informes de supervision en el SECOP II", frecuencia: "Mensualizada", importancia: "90%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 13, tipo: "Externa", proceso: "DELEGACIONES", actividad: "Remisión de solicitud formal con documentos precontractuales", frecuencia: "Según necesidad", importancia: "90%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 14, tipo: "Externa", proceso: "EVALUACIÓN DE PROVEEDORES", actividad: "Revaluación de proveedores - Consolidación en hoja de cálculo", frecuencia: "Semestralmente", importancia: "70%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 15, tipo: "Externa", proceso: "GESTIÓN DEL CONOCIMIENTO", actividad: "Lecciones Aprendidas - Compras públicas frecuentes, riesgosas, complejas", frecuencia: "Anualmente", importancia: "65%", status: "Pendiente", observacion: "", fecha_evaluacion: "" },
            { id: 16, tipo: "Externa", proceso: "COMPRAS RESPONSABLES", actividad: "Formatos de seguimiento - Sostenibilidad Ambiental, Inclusión Social e Innovación", frecuencia: "Febrero y julio", importancia: "70%", status: "Pendiente", observacion: "", fecha_evaluacion: "" }
        ];

        // Plantilla de Lista de Chequeo (31 ÍTEMS)
        const INITIAL_ACTIVITIES = [
            { id: 1, etapa: "Planeación del Contrato", aspecto: "Se cuenta con certificado de idoneidad", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 2, etapa: "Planeación del Contrato", aspecto: "Acto de delegación para contratar", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 3, etapa: "Planeación del Contrato", aspecto: "Ficha tecnica", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 4, etapa: "Planeación del Contrato", aspecto: "La necesidad del servicio está justificada y documentada.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 5, etapa: "Planeación del Contrato", aspecto: "El contrato está incluido en el Plan Anual de Adquisiciones (PAA).", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 6, etapa: "Planeación del Contrato", aspecto: "Se cuenta con estudio previo (El perfil, los costos, requisitos minimos de formación y experiencia, tabla de honorarios acorde al valor asignado) y estudio de mercado.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 7, etapa: "Planeación del Contrato", aspecto: "El objeto contractual está claramente definido y alineado con las funciones del área.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 8, etapa: "Planeación del Contrato", aspecto: "Existen CDP y RP debidamente aprobados.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 9, etapa: "Planeación del Contrato", aspecto: "Se verificaron inhabilidades e incompatibilidades del contratista.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 10, etapa: "Selección y Contratación", aspecto: "La modalidad de contratación fue correctamente aplicada (OPS).", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 11, etapa: "Selección y Contratación", aspecto: "El proceso fue publicado en SECOP con los documentos requeridos.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 12, etapa: "Selección y Contratación", aspecto: "El contrato está firmado con todas las cláusulas exigidas.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 13, etapa: "Selección y Contratación", aspecto: "Existe acta de inicio y designación formal de supervisor.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 14, etapa: "Ejecución del Contrato", aspecto: "ARL (Afiliación).", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 15, etapa: "Ejecución del Contrato", aspecto: "Documento equivalente (Seguridad Social).", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 16, etapa: "Ejecución del Contrato", aspecto: "El contratista entrega informes mensuales de gestión de actividades.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 17, etapa: "Ejecución del Contrato", aspecto: "Los productos o entregables cumplen con el objeto contractual.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 18, etapa: "Ejecución del Contrato", aspecto: "Los pagos se realizan solo contra informes aprobados por el supervisor (SECOP).", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 19, etapa: "Control y Supervisión", aspecto: "El supervisor tiene designación oficial y cumple sus funciones.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 20, etapa: "Control y Supervisión", aspecto: "Existen informes de supervisión con fechas y firmas.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 21, etapa: "Control y Supervisión", aspecto: "Entrega de documentos por parte del Supervisor a la DACP.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 22, etapa: "Cierre y Liquidación", aspecto: "Existe acta de recibo final o informe de cumplimiento.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 23, etapa: "Cierre y Liquidación", aspecto: "Se realizó la liquidación del contrato (bilateral o unilateral).", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 24, etapa: "Cierre y Liquidación", aspecto: "El cierre y liquidación están publicados en SECOP.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 25, etapa: "Calidad (ISO 9001)", aspecto: "Se controla la documentación y registros del proceso.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 26, etapa: "Calidad (ISO 9001)", aspecto: "El personal a cargo del proceso es competente y tiene formación adecuada.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 27, etapa: "Calidad (ISO 9001)", aspecto: "Se hace seguimiento a indicadores del proceso (tiempos, cumplimiento, satisfacción).", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 28, etapa: "Transparencia y Cumplimiento", aspecto: "Cumple con la Ley 80, Ley 1150 y Decreto 1082 de 2015.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 29, etapa: "Transparencia y Cumplimiento", aspecto: "Toda la información contractual está publicada en SECOP.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 30, etapa: "Transparencia y Cumplimiento", aspecto: "Se aplica la Ley 1712 de 2014 (Transparencia).", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
            { id: 31, etapa: "Transparencia y Cumplimiento", aspecto: "Contratista y supervisor declaran ausencia de conflicto de intereses.", secop: "Pendiente", fisica: "Pendiente", obs_fisica: "", obs_secop: "" },
        ];


        // =================================================================
        // 2. ESTADO DE LA APLICACIÓN Y PERSISTENCIA (LOCAL STORAGE)
        // =================================================================

        const INITIAL_CONTRACT_ID = "4125.010.26.1.001-2025";
        
        // Función para cargar los datos iniciales de los contratos con datos de ejemplo
        function loadInitialContracts() {
            return {
                [INITIAL_CONTRACT_ID]: {
                    id: INITIAL_CONTRACT_ID,
                    name: "Contrato 4125.010.26.1.001-2025 (OPS)",
                    checklist: INITIAL_ACTIVITIES.map(item => {
                        let secop = "Pendiente";
                        let fisica = "Pendiente";
                        let obs_fisica = "";
                        let obs_secop = "";

                        // Aplicar datos iniciales de ejemplo
                        if (item.id === 1) { fisica = "Cumple"; obs_secop = "Folio 1 y 2"; secop = "No Cumple";
                        } else if (item.id === 2) { fisica = "No Cumple"; obs_fisica = "En el estudio previo se hace mención al Decreto 4112.010.20.0009 del 7-01-25, pero no esta el decreto en fisico";
                        } else if (item.id === 3) { fisica = "Cumple";
                        } else if (item.id === 4) { fisica = "Parcialmente"; obs_fisica = "Existe y esta justificada, pero de manera generica dado que se hace referencia a la necesidad de fortalecer los diferentes procesos del Departamento de Juzgamiento...";
                        } else if (item.id === 5) { fisica = "Cumple"; }
                        
                        return { ...item, secop, fisica, obs_fisica, obs_secop };
                    }),
                }
            };
        }


        // Cargar actividades DACP desde localStorage o usar la plantilla inicial
        let storedDACPActivities = JSON.parse(localStorage.getItem('dacp_activities'));
        if (!storedDACPActivities || storedDACPActivities.length !== INITIAL_DACP_ACTIVITIES.length) {
            storedDACPActivities = INITIAL_DACP_ACTIVITIES;
            localStorage.setItem('dacp_activities', JSON.stringify(storedDACPActivities));
        }

        // Cargar contratos desde localStorage o inicializar
        let storedContracts = JSON.parse(localStorage.getItem('contracts'));
        if (!storedContracts || Object.keys(storedContracts).length === 0) {
            storedContracts = loadInitialContracts();
            localStorage.setItem('contracts', JSON.stringify(storedContracts));
        }


        let state = {
            activeTab: localStorage.getItem('activeTab') || 'dashboard',
            dacpActivities: storedDACPActivities, 
            contracts: storedContracts, 
            currentContractId: localStorage.getItem('currentContractId') || INITIAL_CONTRACT_ID, 
            charts: {
                barChart: null,
                pieChart: null,
                radarChart: null,
            },
        };

        function saveState() {
            localStorage.setItem('activeTab', state.activeTab);
            localStorage.setItem('dacp_activities', JSON.stringify(state.dacpActivities));
            localStorage.setItem('contracts', JSON.stringify(state.contracts));
            localStorage.setItem('currentContractId', state.currentContractId);
        }

        function setState(newState) {
            // Eliminar gráficas existentes antes de actualizar el DOM
            destroyCharts();
            state = { ...state, ...newState };
            saveState();
            renderApp();
        }


        // =================================================================
        // 3. LÓGICA DE DATOS Y HANDLERS
        // =================================================================

        /**
         * Maneja el cambio de estado (status y observación) para una actividad DACP.
         * Se elimina la lógica de autoguardar fecha para dejarla en un control dedicado.
         */
        function handleActivityChange(id, field, value) {
            const newActivities = state.dacpActivities.map(act => {
                if (act.id === id) {
                    // Si cambia el status, solo actualiza el status y no la fecha.
                    // La fecha se actualiza con handleDateChange (separado).
                    if (field === 'status' || field === 'observacion') {
                        return { ...act, [field]: value };
                    }
                }
                return act;
            });
            setState({ dacpActivities: newActivities });
        }

        /**
         * Maneja el cambio directo en el campo de fecha.
         */
        function handleDateChange(id, dateValue) {
            const newActivities = state.dacpActivities.map(act => {
                if (act.id === id) {
                    // dateValue debe estar en formato YYYY-MM-DD para el input type="date"
                    return { ...act, fecha_evaluacion: dateValue };
                }
                return act;
            });
            setState({ dacpActivities: newActivities });
        }
        
        // --- FUNCIONES DE LÓGICA DE DATOS ADICIONALES (Mantenidas del código anterior) ---
        function calcularEstadisticas(activities) { 
            const total = activities.length;
            const evaluadas = activities.filter(a => a.status !== 'Pendiente').length;
            const pendiente = total - evaluadas;
            const cumple = activities.filter(a => a.status === 'Cumple').length;
            const noCumple = activities.filter(a => a.status === 'No Cumple').length;
            const parcial = activities.filter(a => a.status === 'Parcialmente').length;

            return {
                total, evaluadas, pendiente, cumple, noCumple, parcial,
                pctCumple: total > 0 ? ((cumple / total) * 100).toFixed(1) : 0,
                pctNoCumple: total > 0 ? ((noCumple / total) * 100).toFixed(1) : 0,
                pctParcial: total > 0 ? ((parcial / total) * 100).toFixed(1) : 0,
            };
        }

        function calculateChecklistStats(checklist) {
            const total = checklist.length;
            const cumplidasSECOP = checklist.filter(i => i.secop === 'Cumple').length;
            const noCumplidasSECOP = checklist.filter(i => i.secop === 'No Cumple').length;
            const cumplidasFISICA = checklist.filter(i => i.fisica === 'Cumple').length;
            const noCumplidasFISICA = checklist.filter(i => i.fisica === 'No Cumple').length;
            const parcialesFISICA = checklist.filter(i => i.fisica === 'Parcialmente').length;

            const porEtapa = checklist.reduce((acc, item) => {
                const etapa = item.etapa;
                if (!acc[etapa]) {
                    acc[etapa] = { total: 0, cumple: 0, noCumple: 0, parcial: 0 };
                }
                acc[etapa].total += 1;
                if (item.fisica === 'Cumple') acc[etapa].cumple += 1;
                if (item.fisica === 'No Cumple') acc[etapa].noCumple += 1;
                if (item.fisica === 'Parcialmente') acc[etapa].parcial += 1;
                return acc;
            }, {});

            return { total, cumplidasSECOP, noCumplidasSECOP, cumplidasFISICA, noCumplidasFISICA, parcialesFISICA, porEtapa };
        }

        function handleChecklistChange(itemId, field, value) {
            const currentContract = state.contracts[state.currentContractId];
            if (!currentContract) return;

            const newChecklist = currentContract.checklist.map(item => {
                if (item.id === itemId) {
                    return { ...item, [field]: value };
                }
                return item;
            });

            const newContracts = {
                ...state.contracts,
                [state.currentContractId]: {
                    ...currentContract,
                    checklist: newChecklist,
                }
            };
            setState({ contracts: newContracts });
        }

        function handleCreateNewContract() { 
            const contractId = prompt("Ingrese el NÚMERO DE CONTRATO (Ej: 4125.010.26.1.002-2025):");
            if (!contractId || state.contracts[contractId]) {
                alert("Número de contrato inválido o ya existente.");
                return;
            }
            const contractName = prompt("Ingrese el nombre/descripción del Contrato (Ej: Contrato 002-2025 OPS):") || `Contrato ${contractId}`;

            const newContract = {
                id: contractId,
                name: contractName,
                checklist: INITIAL_ACTIVITIES.map(item => ({...item, secop: 'Pendiente', fisica: 'Pendiente', obs_fisica: '', obs_secop: ''})),
            };

            const newContracts = {
                ...state.contracts,
                [contractId]: newContract
            };

            setState({ contracts: newContracts, currentContractId: contractId });
        }

        function exportChecklistToCSV(contract) { 
            let csv = "ID,Etapa,Aspecto,SECOP,FÍSICA,Observaciones FÍSICA,Observaciones SECOP\n";
            contract.checklist.forEach(item => {
                const escape = (str) => `"${(str || '').toString().replace(/"/g, '""')}"`;
                const row = [
                    item.id,
                    escape(item.etapa),
                    escape(item.aspecto),
                    item.secop,
                    item.fisica,
                    escape(item.obs_fisica),
                    escape(item.obs_secop)
                ];
                csv += row.join(',') + "\n";
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `Auditoria_Contrato_${contract.id}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }


        // =================================================================
        // 4. RENDERING (GENERACIÓN DE HTML Y GRÁFICOS)
        // =================================================================

        /**
         * Renderiza la tabla de las 16 Actividades DACP.
         * **ACTUALIZADO: La fecha es un input type="date".**
         */
        function renderDACPActivities(activities) {
            let tableHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-slate-700 mb-4">Matriz de Evaluación de Actividades DACP (Total: ${activities.length})</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actividad</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Proceso</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Frecuencia</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Importancia</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Estado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Fecha Evaluación</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Observación</th>
                                </tr>
                            </thead>
                            <tbody id="dacp-activities-body" class="bg-white divide-y divide-slate-200">
            `;
            
            activities.forEach(act => {
                const statusColor = act.status === 'Cumple' ? 'bg-green-100 text-green-800' :
                                    act.status === 'No Cumple' ? 'bg-red-100 text-red-800' :
                                    act.status === 'Parcialmente' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-slate-100 text-slate-800';

                tableHTML += `
                    <tr class="hover:bg-slate-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${act.id}</td>
                        <td class="px-6 py-4 text-sm text-slate-700">${act.actividad}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${act.proceso}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${act.frecuencia}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${act.importancia}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select 
                                class="status-select p-2 rounded text-xs ${statusColor} focus:outline-none focus:ring-2 focus:ring-blue-500"
                                data-id="${act.id}" 
                                data-field="status"
                                onchange="window.handleActivityChange(${act.id}, 'status', this.value)"
                            >
                                <option value="Pendiente" ${act.status === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="Cumple" ${act.status === 'Cumple' ? 'selected' : ''}>Cumple</option>
                                <option value="No Cumple" ${act.status === 'No Cumple' ? 'selected' : ''}>No Cumple</option>
                                <option value="Parcialmente" ${act.status === 'Parcialmente' ? 'selected' : ''}>Parcialmente</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                            <input
                                type="date"
                                class="date-input"
                                value="${act.fecha_evaluacion || ''}"
                                onchange="window.handleDateChange(${act.id}, this.value)"
                            >
                        </td>
                        <td class="px-6 py-4">
                            <textarea 
                                class="table-textarea text-xs" 
                                data-id="${act.id}" 
                                data-field="observacion"
                                onchange="window.handleActivityChange(${act.id}, 'observacion', this.value)"
                            >${act.observacion}</textarea>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            return tableHTML;
        }

        // --- FUNCIONES DE RENDERING Y GRÁFICOS (Mantenidas del código anterior) ---
        function renderContractSelect(contracts, currentId) { /* ... (código anterior) */
            let optionsHTML = '';
            const contractIds = Object.keys(contracts).sort();
            contractIds.forEach(id => {
                optionsHTML += `<option value="${id}" ${id === currentId ? 'selected' : ''}>${contracts[id].name}</option>`;
            });

            return `
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6 bg-white p-4 rounded-lg shadow-sm items-center">
                    <label for="contract-select" class="font-medium text-slate-700 w-full sm:w-auto">Contrato Auditado:</label>
                    <select id="contract-select" class="flex-grow p-2 border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        ${optionsHTML}
                    </select>
                    <button id="add-contract-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out w-full sm:w-auto">
                        + Nuevo Contrato
                    </button>
                    <button id="export-contract-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out w-full sm:w-auto">
                        Exportar a CSV
                    </button>
                </div>
            `;
        }

        function renderChecklistTable(checklist) { /* ... (código anterior) */
            let tableHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold text-slate-700 mb-4">Lista de Chequeo de Auditoría Contractual (Total: ${checklist.length} Ítems)</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider w-1/12">ID</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-2/12">Etapa / Criterio</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-3/12">Aspecto a Verificar</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider w-1/12">SECOP II</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider w-1/12">CARPETA FÍSICA</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-2/12">Obs. SECOP II</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-2/12">Obs. Carpeta FÍSICA</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-slate-200">
            `;
            
            let currentEtapa = "";
            checklist.forEach(item => {
                const rowClass = item.fisica === 'Cumple' ? 'bg-green-50' :
                                 item.fisica === 'No Cumple' ? 'bg-red-50' :
                                 item.fisica === 'Parcialmente' ? 'bg-yellow-50' : '';
                
                // Agrupar por Etapa/Criterio
                let etapaRow = '';
                if (item.etapa !== currentEtapa) {
                    etapaRow = `<tr class="bg-slate-200"><td colspan="7" class="px-3 py-2 text-left text-xs font-semibold text-slate-700">${item.etapa.toUpperCase()}</td></tr>`;
                    currentEtapa = item.etapa;
                }

                tableHTML += etapaRow;
                tableHTML += `
                    <tr class="${rowClass}">
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-slate-900 text-center">${item.id}</td>
                        <td class="px-3 py-2 text-sm text-slate-700">${item.etapa}</td>
                        <td class="px-3 py-2 text-sm text-slate-700">${item.aspecto}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">
                            ${renderSelect('secop', item.id, item.secop)}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">
                            ${renderSelect('fisica', item.id, item.fisica)}
                        </td>
                        <td class="px-3 py-2">
                            <textarea 
                                class="table-textarea text-xs" 
                                onchange="window.handleChecklistChange(${item.id}, 'obs_secop', this.value)"
                            >${item.obs_secop}</textarea>
                        </td>
                        <td class="px-3 py-2">
                            <textarea 
                                class="table-textarea text-xs" 
                                onchange="window.handleChecklistChange(${item.id}, 'obs_fisica', this.value)"
                            >${item.obs_fisica}</textarea>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            return tableHTML;
        }

        function renderSelect(field, id, value) { 
            const options = ['Pendiente', 'Cumple', 'No Cumple', 'Parcialmente'];
            const selectClass = value === 'Cumple' ? 'bg-green-100 text-green-800' :
                                value === 'No Cumple' ? 'bg-red-100 text-red-800' :
                                value === 'Parcialmente' ? 'bg-yellow-100 text-yellow-800' : 'bg-slate-100 text-slate-800';

            let optionsHTML = options.map(opt => 
                `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`
            ).join('');

            return `
                <select 
                    class="p-1 rounded text-xs ${selectClass} focus:outline-none focus:ring-2 focus:ring-blue-500"
                    onchange="window.handleChecklistChange(${id}, '${field}', this.value)"
                >
                    ${optionsHTML}
                </select>
            `;
        }
        
        function renderStatCard(title, value, detail, bgColor) { 
            return `
                <div class="${bgColor} p-4 rounded-lg flex flex-col justify-center border border-slate-200">
                    <p class="text-sm font-medium text-slate-500">${title}</p>
                    <p class="text-2xl font-bold text-slate-800">${value}</p>
                    <p class="text-xs text-slate-500">${detail === 'total' ? '' : detail}</p>
                </div>
            `;
        }

        function renderDashboard(actStats, checkStats) { 
            const checklistStatsHtml = Object.entries(checkStats.porEtapa).map(([etapa, stats]) => {
                const total = stats.total;
                const cumplePct = total > 0 ? ((stats.cumple / total) * 100).toFixed(0) : 0;
                const noCumplePct = total > 0 ? ((stats.noCumple / total) * 100).toFixed(0) : 0;
                const parcialPct = total > 0 ? ((stats.parcial / total) * 100).toFixed(0) : 0;
                
                return `
                    <div class="col-span-1 bg-white p-4 rounded-lg shadow-sm border-t-4 border-slate-300">
                        <h3 class="text-md font-semibold text-slate-700 mb-2">${etapa}</h3>
                        <p class="text-sm text-slate-500 mb-1">Total Ítems: <strong>${total}</strong></p>
                        <p class="text-xs text-green-600">Cumple: ${stats.cumple} (${cumplePct}%)</p>
                        <p class="text-xs text-red-600">No Cumple: ${stats.noCumple} (${noCumplePct}%)</p>
                        <p class="text-xs text-yellow-600">Parcial: ${stats.parcial} (${parcialPct}%)</p>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold text-blue-600 mb-4 border-b pb-2">Evaluación Actividades DACP (${actStats.total})</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            ${renderStatCard('Total Actividades', actStats.total, 'total', 'bg-slate-100')}
                            ${renderStatCard('Evaluadas', actStats.evaluadas, `${actStats.evaluadas} (${(actStats.evaluadas / actStats.total * 100).toFixed(0)}%)`, 'bg-blue-100')}
                            ${renderStatCard('Pendientes', actStats.pendiente, `${actStats.pendiente}`, 'bg-yellow-100')}
                            ${renderStatCard('Cumplimiento (%)', actStats.pctCumple + '%', 'total', 'bg-green-100')}
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-slate-50 p-4 rounded-lg">
                                <canvas id="barChart"></canvas>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-lg flex flex-col justify-center items-center">
                                <h3 class="text-lg font-medium text-slate-700 mb-2">Evaluación por Estado</h3>
                                <div class="w-full max-w-xs">
                                    <canvas id="pieChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-semibold text-slate-700 mt-8 mb-4">Cumplimiento por Proceso</h3>
                        <div class="bg-slate-50 p-4 rounded-lg flex flex-col items-center">
                            <div class="w-full max-w-xl">
                                <canvas id="radarChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold text-blue-600 mb-4 border-b pb-2">Auditoría Contractual - ${state.contracts[state.currentContractId].name}</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            ${renderStatCard('Total Ítems Checklist', checkStats.total, 'total', 'bg-slate-100')}
                            ${renderStatCard('Cumple Carpeta Física', checkStats.cumplidasFISICA, `${checkStats.cumplidasFISICA}`, 'bg-green-100')}
                            ${renderStatCard('No Cumple Carpeta Física', checkStats.noCumplidasFISICA, `${checkStats.noCumplidasFISICA}`, 'bg-red-100')}
                            ${renderStatCard('Parcialmente Carpeta Física', checkStats.parcialesFISICA, `${checkStats.parcialesFISICA}`, 'bg-yellow-100')}
                        </div>
                        <h3 class="text-xl font-semibold text-slate-700 mt-8 mb-4">Cumplimiento por Etapa de Auditoría (Carpeta Física)</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            ${checklistStatsHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- FUNCIONES DE GRÁFICOS (Mantenidas del código anterior) ---
        function renderPieChart(actStats) { 
            const ctxPie = document.getElementById('pieChart');
            if (!ctxPie) return;
            if (state.charts.pieChart) state.charts.pieChart.destroy();
            
            const totalEvaluadas = actStats.cumple + actStats.noCumple + actStats.parcial;
            
            state.charts.pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['Cumple', 'No Cumple', 'Parcialmente'],
                    datasets: [{
                        data: [actStats.cumple, actStats.noCumple, actStats.parcial],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', },
                        title: { display: true, text: `Evaluadas: ${totalEvaluadas}/${actStats.total}` },
                        datalabels: {
                            formatter: (value, context) => {
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? (value * 100 / total).toFixed(0) + '%' : '';
                                return percentage;
                            },
                            color: '#fff',
                        }
                    }
                }
            });
        }
        
        function renderBarChart(actStats) { 
            const ctxBar = document.getElementById('barChart');
            if (!ctxBar) return;
            if (state.charts.barChart) state.charts.barChart.destroy();
            
            state.charts.barChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['Cumple', 'No Cumple', 'Parcialmente', 'Pendiente'],
                    datasets: [{
                        label: 'Actividades DACP por Estado',
                        data: [actStats.cumple, actStats.noCumple, actStats.parcial, actStats.pendiente],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#94a3b8'], // green, red, yellow, slate
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Distribución de las 16 Actividades DACP' },
                        datalabels: { color: '#fff', formatter: (value, context) => value > 0 ? value : '', }
                    }
                }
            });
        }

        function renderRadarChart(activities) { 
            const ctxRadar = document.getElementById('radarChart');
            if (!ctxRadar) return;
            if (state.charts.radarChart) state.charts.radarChart.destroy();

            const statuses = ['Cumple', 'No Cumple', 'Parcialmente'];
            const labels = ['GESTIÓN CONTRACTUAL', 'DELEGACIONES', 'EVALUACIÓN DE PROVEEDORES', 'GESTIÓN DEL CONOCIMIENTO', 'COMPRAS RESPONSABLES'];
            
            const dataSets = statuses.map(status => {
                const data = labels.map(process => {
                    const filtered = activities.filter(a => a.proceso === process);
                    const totalProcess = filtered.length;
                    const compliantProcess = filtered.filter(a => a.status === status).length;
                    return totalProcess > 0 ? (compliantProcess / totalProcess) * 100 : 0; 
                });

                return {
                    label: status,
                    data: data,
                    backgroundColor: status === 'Cumple' ? 'rgba(16, 185, 129, 0.2)' : status === 'No Cumple' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(245, 158, 11, 0.2)',
                    borderColor: status === 'Cumple' ? '#10b981' : status === 'No Cumple' ? '#ef4444' : '#f59e0b',
                    pointBackgroundColor: status === 'Cumple' ? '#10b981' : status === 'No Cumple' ? '#ef4444' : '#f59e0b',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: status === 'Cumple' ? '#10b981' : status === 'No Cumple' ? '#ef4444' : '#f59e0b',
                };
            });

            state.charts.radarChart = new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: dataSets
                },
                options: {
                    responsive: true,
                    elements: { line: { borderWidth: 3 } },
                    scales: { r: { angleLines: { display: false }, suggestedMin: 0, suggestedMax: 100, ticks: { callback: (value) => value + '%', } } },
                    plugins: { title: { display: true, text: 'Distribución de Cumplimiento por Proceso (%)' } }
                }
            });
        }


        // =================================================================
        // 5. CONTROL PRINCIPAL DE LA APLICACIÓN
        // =================================================================

        function destroyCharts() {
            Object.values(state.charts).forEach(chart => {
                if (chart) chart.destroy();
            });
        }

        function attachContractListeners() {
            document.getElementById('contract-select')?.addEventListener('change', (e) => {
                setState({ currentContractId: e.target.value });
            });
            
            document.getElementById('add-contract-btn')?.addEventListener('click', handleCreateNewContract);
            
            document.getElementById('export-contract-btn')?.addEventListener('click', () => {
                const currentContract = state.contracts[state.currentContractId];
                if (currentContract) {
                    exportChecklistToCSV(currentContract);
                } else {
                    alert('No hay contrato seleccionado para exportar.');
                }
            });
        }

        function renderApp() {
            const contentContainer = document.getElementById('content-container');
            if (!contentContainer) return;
            
            ['dashboard', 'evaluacion', 'lista_de_chequeo'].forEach(tab => {
                const tabElement = document.getElementById(`tab-${tab}`);
                if (tabElement) {
                    tabElement.classList.remove('tab-active');
                    if (tab === state.activeTab) {
                        tabElement.classList.add('tab-active');
                    }
                }
            });
            
            if (state.activeTab === 'evaluacion') {
                contentContainer.innerHTML = renderDACPActivities(state.dacpActivities);
            } else if (state.activeTab === 'lista_de_chequeo') {
                const currentContract = state.contracts[state.currentContractId];
                if (currentContract) {
                    contentContainer.innerHTML = renderContractSelect(state.contracts, state.currentContractId) + renderChecklistTable(currentContract.checklist);
                } else {
                    contentContainer.innerHTML = renderContractSelect(state.contracts, state.currentContractId) + '<p class="text-slate-500 mt-4 p-4 bg-white rounded-lg shadow-md">Seleccione un contrato o cree uno nuevo para empezar la auditoría.</p>';
                }
            } else if (state.activeTab === 'dashboard') {
                const actStats = calcularEstadisticas(state.dacpActivities);
                const currentContract = state.contracts[state.currentContractId];
                const checkStats = currentContract ? calculateChecklistStats(currentContract.checklist) : { total: 0, cumplidasSECOP: 0, noCumplidasSECOP: 0, cumplidasFISICA: 0, noCumplidasFISICA: 0, parcialesFISICA: 0, porEtapa: {} };
                
                contentContainer.innerHTML = renderDashboard(actStats, checkStats);
            }

            setTimeout(() => {
                // Listeners Generales (Pestañas)
                document.getElementById('tab-dashboard')?.addEventListener('click', () => {
                    setState({ activeTab: 'dashboard' });
                });
                document.getElementById('tab-evaluacion')?.addEventListener('click', () => {
                    setState({ activeTab: 'evaluacion' });
                });
                document.getElementById('tab-lista_de_chequeo')?.addEventListener('click', () => {
                    setState({ activeTab: 'lista_de_chequeo' });
                });
                
                // Listeners específicos y Renderizado de Gráficas
                if (state.activeTab === 'lista_de_chequeo') {
                    attachContractListeners();
                } else if (state.activeTab === 'dashboard') {
                    const actStats = calcularEstadisticas(state.dacpActivities);
                    renderBarChart(actStats);
                    renderPieChart(actStats);
                    renderRadarChart(state.dacpActivities);
                }
            }, 50); 
        }


        // =================================================================
        // 6. INICIO DE LA APLICACIÓN (Exponer funciones al ámbito global)
        // =================================================================

        // Se exponen las funciones al objeto 'window' para que puedan ser llamadas
        // directamente desde los atributos 'onchange' del HTML renderizado (tablas).
        window.handleActivityChange = handleActivityChange;
        window.handleDateChange = handleDateChange; // Nueva función para la fecha
        window.handleChecklistChange = handleChecklistChange;

        window.onload = function() {
            renderApp();
        };

    </script>
</body>
</html>
