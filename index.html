<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Auditor铆a DACP - Contrataci贸n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <style>
        /* Estilos base */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        /* === CSS para campos editables en tabla === */
        .table-textarea {
            width: 100%;
            min-height: 40px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 0.875rem; /* sm */
        }
        /* Clase para pesta帽as activas */
        .tab-active {
            border-bottom-width: 2px;
            border-bottom-color: #3b82f6; /* blue-600 */
            color: #1e40af; /* blue-800 */
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="root" class="min-h-screen bg-gray-50">
        <header class="bg-white shadow-md p-4 sticky top-0 z-10">
            <h1 class="text-2xl font-bold text-gray-800">Dashboard de Auditor铆a DACP</h1>
            <div id="tab-container" class="mt-4 border-b border-gray-200">
                <button id="tab-dashboard" onclick="setActiveTab('dashboard')" class="px-4 py-2 text-sm text-gray-600 hover:text-blue-700 hover:border-blue-300 border-b-2 border-transparent">Dashboard</button>
                <button id="tab-manager" onclick="setActiveTab('manager')" class="px-4 py-2 text-sm text-gray-600 hover:text-blue-700 hover:border-blue-300 border-b-2 border-transparent">Manager</button>
                <button id="tab-checklist" onclick="setActiveTab('checklist')" class="px-4 py-2 text-sm text-gray-600 hover:text-blue-700 hover:border-blue-300 border-b-2 border-transparent">Lista de Chequeo</button>
            </div>
        </header>

        <main class="p-6">
            <div id="dashboard-view" class="tab-view" style="display: none;">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-4 shadow rounded-lg">
                        <h2 class="text-lg font-semibold mb-2">Resumen de Cumplimiento DACP</h2>
                        <canvas id="complianceChart"></canvas>
                    </div>
                    <div class="bg-white p-4 shadow rounded-lg lg:col-span-2">
                        <h2 class="text-lg font-semibold mb-2">Importancia vs Cumplimiento</h2>
                        <canvas id="importanceChart"></canvas>
                    </div>
                </div>
                <div id="summary-section" class="bg-white p-6 shadow rounded-lg">
                    <h2 class="text-xl font-bold mb-4">Resumen General</h2>
                    <p id="summary-text" class="text-gray-700">Calculando resumen...</p>
                </div>
            </div>

            <div id="manager-view" class="tab-view" style="display: none;">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Actividades por Gestor</h2>
                    <button onclick="exportManagerStatsToExcel()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-150">
                        Exportar Estad铆sticas
                    </button>
                </div>
                
                <div class="mb-6 bg-white p-4 shadow rounded-lg">
                    <label for="manager-select" class="block text-sm font-medium text-gray-700">Seleccionar Gestor</label>
                    <select id="manager-select" onchange="handleManagerSelectChange(this.value)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    
                    <div id="manager-stats" class="mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                        <p class="text-sm font-semibold">Resumen de Cumplimiento del Gestor:</p>
                        <p id="manager-stats-text" class="text-gray-700">Seleccione un gestor para ver sus estad铆sticas.</p>
                    </div>
                </div>

                <div class="bg-white shadow rounded-lg overflow-x-auto">
                    <table id="manager-table" class="min-w-full divide-y divide-gray-200">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div id="checklist-view" class="tab-view" style="display: none;">
                <h2 class="text-xl font-bold mb-4">Lista de Chequeo por Contrato (31 铆tems)</h2>
                <div class="flex items-center space-x-4 mb-4">
                    <div class="flex-grow">
                        <label for="contract-select" class="block text-sm font-medium text-gray-700">Contrato Actual</label>
                        <select id="contract-select" onchange="handleContractSelectChange(this.value)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    </div>
                    <button onclick="handleCreateNewContract()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-150 mt-5 whitespace-nowrap">
                        Crear Nuevo Contrato
                    </button>
                    <button onclick="exportChecklistToExcel()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-150 mt-5 whitespace-nowrap">
                        Exportar Checklist
                    </button>
                </div>

                <div class="bg-white shadow rounded-lg overflow-x-auto">
                    <table id="checklist-table" class="min-w-full divide-y divide-gray-200">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 1. CONFIGURACIN CRTICA Y DATOS INICIALES
        // -----------------------------------------------------------------

        // 锔 隆IMPORTANTE! REEMPLAZA ESTA URL con la URL de tu Web App de Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbxgOKML7_LAQ8BaEZC1Q1-3CmOxlCU5oSpuNQSgIpubX3je7G_o6cXYmiKXvTNAM_Ak/exec'; 

        // Los datos iniciales contienen un campo 'gestor' para la vista Manager
        const initialActivities = [
            {id:1, tipo:'Interna', proceso:'GESTIN CONTRACTUAL', funcion:'PENDIENTE DEFINIR', actividad:'ESTRUCTURACIN DEL PROCESO DE CONTRATACIN', informe:'PENDIENTE DEFINIR', frecuencia:'TRIMESTRAL', reportaA:'PENDIENTE DEFINIR', importancia:95, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Ana'},
            {id:2, tipo:'Interna', proceso:'GESTIN CONTRACTUAL', funcion:'PENDIENTE DEFINIR', actividad:'VALIDACION APLICATIVO CONTRATISTA', informe:'PENDIENTE DEFINIR', frecuencia:'Mensualizada', reportaA:'PENDIENTE DEFINIR', importancia:85, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Ana'},
            {id:3, tipo:'Interna', proceso:'GESTIN CONTRACTUAL', funcion:'PENDIENTE DEFINIR', actividad:'VALIDACION HOJA DE VIDA DE SIGEP', informe:'PENDIENTE DEFINIR', frecuencia:'Mensualizada', reportaA:'PENDIENTE DEFINIR', importancia:80, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Carlos'},
            {id:4, tipo:'Interna', proceso:'GESTIN CONTRACTUAL', funcion:'PENDIENTE DEFINIR', actividad:'VALIDACION DE DOCUMENTOS CONTRACTUALES', informe:'PENDIENTE DEFINIR', frecuencia:'3 DIAS A LA EJECUCIN DEL CONTRATO', reportaA:'PENDIENTE DEFINIR', importancia:90, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Ana'},
            {id:5, tipo:'Interna', proceso:'GESTIN CONTRACTUAL', funcion:'PENDIENTE DEFINIR', actividad:'AFILIACIN ARL', informe:'PENDIENTE DEFINIR', frecuencia:'5 primeros dias de cada mes (mes vencido)', reportaA:'PENDIENTE DEFINIR', importancia:75, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Carlos'},
            {id:6, tipo:'Interna', proceso:'GESTIN CONTRACTUAL', funcion:'PENDIENTE DEFINIR', actividad:'REQUERIR Y APOYAR EN LA ELABORACION DEL PLAN DE TRABAJO', informe:'PENDIENTE DEFINIR', frecuencia:'Mensualizada', reportaA:'PENDIENTE DEFINIR', importancia:85, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Benito'},
            {id:7, tipo:'Interna', proceso:'GESTIN CONTRACTUAL', funcion:'PENDIENTE DEFINIR', actividad:'REVISION DE INFORMES DE GESTIN', informe:'PENDIENTE DEFINIR', frecuencia:'Mensualizada', reportaA:'PENDIENTE DEFINIR', importancia:85, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Benito'},
            {id:8, tipo:'Interna', proceso:'GESTIN CONTRACTUAL', funcion:'PENDIENTE DEFINIR', actividad:'SEGUIMIENTO A ACTIVIDADES DESIGNADAS', informe:'PENDIENTE DEFINIR', frecuencia:'Mensualizada', reportaA:'PENDIENTE DEFINIR', importancia:80, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Ana'},
            {id:9, tipo:'Interna', proceso:'GESTIN CONTRACTUAL', funcion:'PENDIENTE DEFINIR', actividad:'Actividades contractuales vs actividades presentadas', informe:'PENDIENTE DEFINIR', frecuencia:'Mensualizada', reportaA:'PENDIENTE DEFINIR', importancia:90, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Carlos'},
            {id:10, tipo:'Interna', proceso:'GESTIN CONTRACTUAL', funcion:'PENDIENTE DEFINIR', actividad:'Informes mensual contratos de prestacion de servicios', informe:'PENDIENTE DEFINIR', frecuencia:'Mensualizada', reportaA:'PENDIENTE DEFINIR', importancia:85, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Benito'},
            {id:11, tipo:'Interna', proceso:'DELEGACIONES', funcion:'PENDIENTE DEFINIR', actividad:'Gesti贸n de solicitudes de delegaci贸n especial de facultades contractuales', informe:'PENDIENTE DEFINIR', frecuencia:'Seg煤n necesidad', reportaA:'PENDIENTE DEFINIR', importancia:95, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Ana'},
            {id:12, tipo:'Externa', proceso:'GESTIN CONTRACTUAL', funcion:'PENDIENTE DEFINIR', actividad:'Publicaciones informes de supervision en el SECOP II', informe:'PENDIENTE DEFINIR', frecuencia:'Mensualizada', reportaA:'PENDIENTE DEFINIR', importancia:90, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Benito'},
            {id:13, tipo:'Externa', proceso:'DELEGACIONES', funcion:'PENDIENTE DEFINIR', actividad:'Remisi贸n de solicitud formal con documentos precontractuales', informe:'PENDIENTE DEFINIR', frecuencia:'Seg煤n necesidad', reportaA:'PENDIENTE DEFINIR', importancia:90, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Carlos'},
            {id:14, tipo:'Externa', proceso:'EVALUACIN DE PROVEEDORES', funcion:'PENDIENTE DEFINIR', actividad:'Revaluaci贸n de proveedores - Consolidaci贸n en hoja de c谩lculo', informe:'PENDIENTE DEFINIR', frecuencia:'Semestralmente', reportaA:'PENDIENTE DEFINIR', importancia:70, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Ana'},
            {id:15, tipo:'Externa', proceso:'GESTIN DEL CONOCIMIENTO', funcion:'PENDIENTE DEFINIR', actividad:'Lecciones Aprendidas - Compras p煤blicas frecuentes, riesgosas, complejas', informe:'PENDIENTE DEFINIR', frecuencia:'Anualmente', reportaA:'PENDIENTE DEFINIR', importancia:65, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Benito'},
            {id:16, tipo:'Externa', proceso:'COMPRAS RESPONSABLES', funcion:'PENDIENTE DEFINIR', actividad:'Formatos de seguimiento - Sostenibilidad Ambiental, Inclusi贸n Social e Innovaci贸n', informe:'PENDIENTE DEFINIR', frecuencia:'Febrero y julio', reportaA:'PENDIENTE DEFINIR', importancia:70, cumplimiento:null, observaciones:'', fechaEvaluacion:'', gestor:'Carlos'}
        ];
        
        // Plantilla de lista de chequeo (31 铆tems)
        const initialChecklistTemplate = [
            {id:1, etapa:"Planeaci贸n del Contrato", aspecto:"Se cuenta con certificado de idoneidad", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:2, etapa:"Planeaci贸n del Contrato", aspecto:"Acto de delegaci贸n para contratar", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:3, etapa:"Planeaci贸n del Contrato", aspecto:"Ficha tecnica", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:4, etapa:"Planeaci贸n del Contrato", aspecto:"La necesidad del servicio est谩 justificada y documentada.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:5, etapa:"Planeaci贸n del Contrato", aspecto:"El contrato est谩 incluido en el Plan Anual de Adquisiciones (PAA).", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:6, etapa:"Planeaci贸n del Contrato", aspecto:"Se cuenta con estudio previo (El perfil, los costos, requisitos minimos de formaci贸n y experiencia, tabla de honorarios acorde al valor asignado) y estudio de mercado.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:7, etapa:"Planeaci贸n del Contrato", aspecto:"El objeto contractual est谩 claramente definido y alineado con las funciones del 谩rea.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:8, etapa:"Planeaci贸n del Contrato", aspecto:"Existen CDP y RP debidamente aprobados.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:9, etapa:"Planeaci贸n del Contrato", aspecto:"Se verificaron inhabilidades e incompatibilidades del contratista.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:10, etapa:"Selecci贸n y Contrataci贸n", aspecto:"La modalidad de contrataci贸n fue correctamente aplicada (OPS).", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:11, etapa:"Selecci贸n y Contrataci贸n", aspecto:"El proceso fue publicado en SECOP con los documentos requeridos.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:12, etapa:"Selecci贸n y Contrataci贸n", aspecto:"El contrato est谩 firmado con todas las cl谩usulas exigidas.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:13, etapa:"Selecci贸n y Contrataci贸n", aspecto:"Existe acta de inicio y designaci贸n formal de supervisor.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:14, etapa:"Ejecuci贸n del Contrato", aspecto:"ARL (Afiliaci贸n).", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:15, etapa:"Ejecuci贸n del Contrato", aspecto:"Documento equivalente (Seguridad Social).", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:16, etapa:"Ejecuci贸n del Contrato", aspecto:"El contratista entrega informes mensuales de gesti贸n de actividades.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:17, etapa:"Ejecuci贸n del Contrato", aspecto:"Los productos o entregables cumplen con el objeto contractual.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:18, etapa:"Ejecuci贸n del Contrato", aspecto:"Los pagos se realizan solo contra informes aprobados por el supervisor (SECOP).", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:19, etapa:"Control y Supervisi贸n", aspecto:"El supervisor tiene designaci贸n oficial y cumple sus funciones.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:20, etapa:"Control y Supervisi贸n", aspecto:"Existen informes de supervisi贸n con fechas y firmas.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:21, etapa:"Control y Supervisi贸n", aspecto:"Entrega de documentos por parte del Supervisor a la DACP.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:22, etapa:"Cierre y Liquidaci贸n", aspecto:"Existe acta de recibo final o informe de cumplimiento.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:23, etapa:"Cierre y Liquidaci贸n", aspecto:"Se realiz贸 la liquidaci贸n del contrato (bilateral o unilateral).", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:24, etapa:"Cierre y Liquidaci贸n", aspecto:"El cierre y liquidaci贸n est谩n publicados en SECOP.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:25, etapa:"Calidad (ISO 9001)", aspecto:"Se controla la documentaci贸n y registros del proceso.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:26, etapa:"Calidad (ISO 9001)", aspecto:"El personal a cargo del proceso es competente y tiene formaci贸n adecuada.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:27, etapa:"Calidad (ISO 9001)", aspecto:"Se hace seguimiento a indicadores del proceso (tiempos, cumplimiento, satisfacci贸n).", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:28, etapa:"Transparencia y Cumplimiento", aspecto:"Cumple con la Ley 80, Ley 1150 y Decreto 1082 de 2015.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:29, etapa:"Transparencia y Cumplimiento", aspecto:"Toda la informaci贸n contractual est谩 publicada en SECOP.", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:30, etapa:"Transparencia y Cumplimiento", aspecto:"Se aplica la Ley 1712 de 2014 (Transparencia).", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""},
            {id:31, etapa:"Transparencia y Cumplimiento", aspecto:"Contratista y supervisor declaran ausencia de conflicto de intereses", "SECOP II - Cumple":"", "SECOP II - No Cumple":"", "CARPETA FISICA - Cumple":"", "CARPETA FISICA - No Cumple":"", "CARPETA FISICA - No Aplica/ Parcialmente":"", evidencia:"", obs_fisica:"", obs_secop":""}
        ];

        let state = {
            activeTab: 'dashboard',
            dacpActivities: initialActivities,
            contracts: {}, 
            currentContractId: null, 
            currentManager: null, // NUEVO: Gestor seleccionado en la vista Manager
        };

        // 2. GESTIN DE ESTADO (REACTIVIDAD)
        // -----------------------------------------------------------------

        function setState(updater) {
            const newState = typeof updater === 'function' ? updater(state) : updater;
            state = { ...state, ...newState };
            console.log("Estado Actualizado:", state);
            renderApp();
            saveStateToCloud(state); 
        }
        
        // 3. COMUNICACIN CON GOOGLE APPS SCRIPT (APIs)
        // -----------------------------------------------------------------

        /**
         * Lee el estado completo de la nube (funci贸n doGet del Apps Script).
         * @returns {Promise<void>}
         */
        async function fetchStateFromCloud() {
            // ... (Funci贸n fetchStateFromCloud, omitida por espacio, mantener igual) ...
            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    cache: 'no-cache',
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const loadedActivities = data.dacpActivities && data.dacpActivities.length > 0
                        ? data.dacpActivities 
                        : initialActivities;
                        
                    const loadedContracts = data.contracts || {};

                    let currentContractId = state.currentContractId;
                    const contractIds = Object.keys(loadedContracts);
                    if (!currentContractId && contractIds.length > 0) {
                        currentContractId = contractIds[contractIds.length - 1];
                    } else if (contractIds.length === 0) {
                         // Si no hay contratos cargados, creamos uno inicial solo para que el selector funcione
                         handleCreateNewContract('CONTRATO-INICIAL-001', true); // No guardar en la nube inmediatamente
                    }
                    
                    // Inicializar el gestor actual si hay actividades cargadas
                    const availableGestores = [...new Set(loadedActivities.map(a => a.gestor))].sort();
                    const currentManager = state.currentManager || availableGestores[0] || null;

                    // Se necesita reasignar el estado para actualizar las matrices, ya que fue cargado por fetch.
                    state = {
                        ...state,
                        dacpActivities: loadedActivities,
                        contracts: loadedContracts,
                        currentContractId: currentContractId || Object.keys(state.contracts)[0] || null,
                        currentManager: currentManager // Inicializa o mantiene el gestor
                    };
                    console.log("Datos cargados exitosamente de la nube.");
                } else {
                    console.error(" Error al cargar datos:", response.status);
                    alert("Error al cargar datos. Verifique el URL del despliegue. Usando datos iniciales de emergencia.");
                }
            } catch (error) {
                console.error(" Error CRTICO de conexi贸n al cargar datos:", error); 
                alert("Error de conexi贸n (CORS o API). Verifique que su Apps Script est茅 bien desplegado y que la API_URL sea la correcta.");
            }
        }

        /**
         * Guarda el estado completo en la nube (funci贸n doPost del Apps Script).
         * @param {Object} newState - El estado completo de la aplicaci贸n a guardar.
         */
        async function saveStateToCloud(newState) {
            // ... (Funci贸n saveStateToCloud, omitida por espacio, mantener igual) ...
            console.log("Intentando guardar datos en la nube...");
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newState)
                });
                console.log("Guardado exitoso (Respuesta opaca).");
            } catch (error) {
                console.error(" Error CRTICO de conexi贸n al guardar:", error);
                alert("Error al guardar los datos. Verifique su conexi贸n y la URL de la API en el HTML.");
            }
        }

        // 4. MANEJADORES DE EVENTOS
        // -----------------------------------------------------------------

        /** Cambia la pesta帽a activa. */
        function setActiveTab(tab) {
            setState({ activeTab: tab });
        }
        
        /** Maneja el cambio en las actividades DACP (tabla principal). */
        function handleActivityChange(id, field, value) {
            setState(prevState => {
                const newActivities = prevState.dacpActivities.map(activity => {
                    if (activity.id === id) {
                        return { ...activity, [field]: value };
                    }
                    return activity;
                });
                return { dacpActivities: newActivities };
            });
        }
        
        /** Maneja el cambio en la Lista de Chequeo (contratos). */
        function handleChecklistChange(contractId, itemId, field, value) {
            setState(prevState => {
                const newContracts = { ...prevState.contracts };
                
                if (newContracts[contractId]) {
                    newContracts[contractId] = newContracts[contractId].map(item => {
                        if (item.id === itemId) {
                            return { ...item, [field]: value };
                        }
                        return item;
                    });
                }
                
                return { contracts: newContracts };
            });
        }

        /** Crea un nuevo registro de contrato (lista de chequeo). */
        function handleCreateNewContract(optionalId, skipSave = false) {
            const newId = optionalId || prompt("Ingrese el ID del nuevo contrato (ej: 4125.010.26.1.001-2025):");
            if (!newId || state.contracts[newId]) {
                if (newId) alert("Ese ID de contrato ya existe o no es v谩lido.");
                return;
            }

            const newContracts = {
                ...state.contracts,
                [newId]: JSON.parse(JSON.stringify(initialChecklistTemplate)) // Copia profunda
            };

            if (skipSave) {
                 state.contracts = newContracts;
                 state.currentContractId = newId;
                 return; 
            }
            
            setState({
                contracts: newContracts,
                currentContractId: newId
            });
        }
        
        /** Cambia el contrato seleccionado en la vista de Checklist. */
        function handleContractSelectChange(newId) {
            setState({ currentContractId: newId });
        }
        
        /** Cambia el gestor seleccionado en la vista de Manager. */
        function handleManagerSelectChange(newManager) {
            setState({ currentManager: newManager });
        }
        
        // 5. LGICA DE DATOS Y AYUDANTES
        // -----------------------------------------------------------------

        function calculateDACPStats(activities) {
            const total = activities.length;
            const cumplidos = activities.filter(a => a.cumplimiento === 'Cumple').length;
            const noCumplidos = activities.filter(a => a.cumplimiento === 'No Cumple').length;
            const noEvaluados = total - cumplidos - noCumplidos;
            const porcentajeCumplimiento = total > 0 ? ((cumplidos / total) * 100).toFixed(1) : 0;


            return { total, cumplidos, noCumplidos, noEvaluados, porcentajeCumplimiento };
        }
        
        /** Obtiene las actividades filtradas por el gestor seleccionado. */
        function getActividadesFiltradas() {
            if (!state.currentManager) return [];
            return state.dacpActivities.filter(a => a.gestor === state.currentManager);
        }
        
        /** Obtiene la lista de chequeo del contrato actualmente seleccionado. */
        function getCurrentChecklist() {
            return state.contracts[state.currentContractId] || [];
        }
        
        /** Obtiene la lista de todos los gestores 煤nicos. */
        function getUniqueManagers() {
            return [...new Set(state.dacpActivities.map(a => a.gestor))].sort();
        }


        // 6. RENDERIZADO (ACTUALIZACIN DEL DOM)
        // -----------------------------------------------------------------

        let complianceChartInstance = null;
        let importanceChartInstance = null;

        function renderComplianceChart(activities) {
            // ... (Funci贸n renderComplianceChart, mantener igual) ...
            const stats = calculateDACPStats(activities);
            const ctx = document.getElementById('complianceChart').getContext('2d');
            
            if (complianceChartInstance) {
                complianceChartInstance.destroy();
            }

            complianceChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Cumple', 'No Cumple', 'No Evaluado'],
                    datasets: [{
                        data: [stats.cumplidos, stats.noCumplidos, stats.noEvaluados],
                        backgroundColor: ['#10b981', '#ef4444', '#9ca3af'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    }
                }
            });
            
            // Actualizar Resumen General
            document.getElementById('summary-text').textContent = 
                `Total de actividades: ${stats.total}. Cumplidas: ${stats.cumplidos}. No Cumplidas: ${stats.noCumplidos}. Porcentaje de Cumplimiento General: ${stats.porcentajeCumplimiento}%.`;

        }
        
        function renderImportanceChart(activities) {
            // ... (Funci贸n renderImportanceChart, omitida por espacio, pero es necesaria para el dashboard) ...
            const importanceGroups = activities.reduce((acc, curr) => {
                const key = curr.importancia;
                if (!acc[key]) {
                    acc[key] = { cumplidos: 0, total: 0 };
                }
                acc[key].total++;
                if (curr.cumplimiento === 'Cumple') {
                    acc[key].cumplidos++;
                }
                return acc;
            }, {});

            const labels = Object.keys(importanceGroups).sort((a, b) => a - b);
            const complianceData = labels.map(label => {
                const group = importanceGroups[label];
                return group.total > 0 ? (group.cumplidos / group.total) * 100 : 0;
            });

            const ctx = document.getElementById('importanceChart').getContext('2d');

            if (importanceChartInstance) {
                importanceChartInstance.destroy();
            }

            importanceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% de Cumplimiento por Nivel de Importancia',
                        data: complianceData,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)', // blue-500
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Porcentaje de Cumplimiento (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Nivel de Importancia (0-100)'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: true },
                        title: { display: false }
                    }
                }
            });
        }

        // Funci贸n de renderizado para la tabla del Manager
        function renderManagerTable(activities) {
            const tableBody = document.getElementById('manager-table').querySelector('tbody');
            const tableHead = document.getElementById('manager-table').querySelector('thead');
            tableBody.innerHTML = '';
            
            if (activities.length > 0) {
                 // Encabezados para la vista Manager (excluimos el gestor de la tabla)
                 const headers = Object.keys(activities[0]).filter(h => h !== 'gestor'); 
                 const headerRow = `<tr>${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr>`;
                 tableHead.innerHTML = headerRow;
            } else {
                 tableHead.innerHTML = '<tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No hay actividades asignadas a este gestor o no se ha seleccionado uno.</th></tr>';
            }
            
            activities.forEach(activity => {
                const row = tableBody.insertRow();
                const fields = Object.keys(activity).filter(k => k !== 'gestor'); 

                fields.forEach(key => {
                    const cell = row.insertCell();
                    cell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700 border-b';
                    
                    if (key === 'cumplimiento') {
                        // Campo de selecci贸n para cumplimiento
                        cell.innerHTML = `
                            <select onchange="handleActivityChange(${activity.id}, 'cumplimiento', this.value)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option value="" ${activity[key] === null || activity[key] === '' ? 'selected' : ''}>Seleccione</option>
                                <option value="Cumple" ${activity[key] === 'Cumple' ? 'selected' : ''}>Cumple</option>
                                <option value="No Cumple" ${activity[key] === 'No Cumple' ? 'selected' : ''}>No Cumple</option>
                            </select>
                        `;
                    } else if (key === 'observaciones' || key === 'fechaEvaluacion') {
                        // Campos de texto para observaciones y fecha
                        cell.innerHTML = `<input type="text" value="${activity[key] || ''}" onchange="handleActivityChange(${activity.id}, '${key}', this.value)" class="table-textarea" />`;
                    } else {
                        // Otros campos solo lectura
                        cell.textContent = activity[key];
                    }
                });
            });
        }
        
        // Funci贸n de renderizado para la tabla de lista de chequeo
        function renderChecklistTable(checklist, contractId) {
            // ... (Funci贸n renderChecklistTable, mantener igual) ...
            const tableBody = document.getElementById('checklist-table').querySelector('tbody');
            const tableHead = document.getElementById('checklist-table').querySelector('thead');
            tableBody.innerHTML = '';

            const headers = ["ID", "Etapa", "Aspecto", "SECOP II - Cumple", "SECOP II - No Cumple", "CARPETA FISICA - Cumple", "CARPETA FISICA - No Cumple", "CARPETA FISICA - No Aplica/ Parcialmente", "Evidencia", "Obs. F铆sica", "Obs. SECOP"];
            const headerRow = `<tr>${headers.map(h => `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr>`;
            tableHead.innerHTML = headerRow;

            checklist.forEach(item => {
                const row = tableBody.insertRow();
                const fields = ["id", "etapa", "aspecto", "SECOP II - Cumple", "SECOP II - No Cumple", "CARPETA FISICA - Cumple", "CARPETA FISICA - No Cumple", "CARPETA FISICA - No Aplica/ Parcialmente", "evidencia", "obs_fisica", "obs_secop"];

                fields.forEach(field => {
                    const cell = row.insertCell();
                    cell.className = 'px-3 py-2 whitespace-nowrap text-sm text-gray-700 border-b';

                    if (field === 'id' || field === 'etapa' || field === 'aspecto') {
                        cell.textContent = item[field];
                    } else if (field.includes('Cumple') || field.includes('No Cumple') || field.includes('No Aplica')) {
                        cell.innerHTML = `<input type="text" value="${item[field] || ''}" onchange="handleChecklistChange('${contractId}', ${item.id}, '${field}', this.value)" class="table-textarea text-center h-8" maxlength="1" style="width: 40px;" />`;
                    } else if (field === 'evidencia' || field === 'obs_fisica' || field === 'obs_secop') {
                         cell.innerHTML = `<textarea onchange="handleChecklistChange('${contractId}', ${item.id}, '${field}', this.value)" class="table-textarea">${item[field] || ''}</textarea>`;
                    }
                });
            });
        }
        
        // Funci贸n que renderiza la lista de contratos en el select
        function renderContractSelect(contractIds, currentId) {
            // ... (Funci贸n renderContractSelect, mantener igual) ...
            const selectElement = document.getElementById('contract-select');
            selectElement.innerHTML = ''; 

            if (contractIds.length === 0) {
                 selectElement.innerHTML = '<option value="">No hay contratos</option>';
            }
            
            contractIds.forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = id;
                if (id === currentId) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }
        
        // Funci贸n que renderiza la lista de gestores en el select
        function renderManagerSelect(managers, currentManager) {
            const selectElement = document.getElementById('manager-select');
            selectElement.innerHTML = '<option value="" selected>--- Seleccione un Gestor ---</option>'; 

            managers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                if (manager === currentManager) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }
        
        // Renderiza las estad铆sticas del gestor actual
        function renderManagerStats(managerActivities, manager) {
            const statsElement = document.getElementById('manager-stats-text');
            if (!manager) {
                statsElement.textContent = "Seleccione un gestor para ver sus estad铆sticas.";
                return;
            }
            
            if (managerActivities.length === 0) {
                 statsElement.textContent = `El gestor ${manager} no tiene actividades asignadas o evaluadas.`;
                 return;
            }
            
            const stats = calculateDACPStats(managerActivities);
            statsElement.innerHTML = `
                <span class="font-bold">${manager}</span> tiene asignadas ${stats.total} actividades.
                <br>Cumplidas: ${stats.cumplidos}.
                <br>No Cumplidas: ${stats.noCumplidos}.
                <br>Porcentaje de Cumplimiento: <span class="font-bold text-xl ${stats.porcentajeCumplimiento >= 80 ? 'text-green-600' : 'text-red-600'}">${stats.porcentajeCumplimiento}%</span>
            `;
        }


        /** Renderiza la aplicaci贸n completa basado en el estado actual. */
        function renderApp() {
            // 1. Manejo de Pesta帽as
            document.querySelectorAll('.tab-view').forEach(view => {
                view.style.display = 'none';
            });
            const activeView = document.getElementById(`${state.activeTab}-view`);
            if (activeView) activeView.style.display = 'block';

            document.querySelectorAll('#tab-container button').forEach(button => {
                button.classList.remove('tab-active');
            });
            const activeTabButton = document.getElementById(`tab-${state.activeTab}`);
            if (activeTabButton) activeTabButton.classList.add('tab-active');


            // 2. Renderizado Condicional
            if (state.activeTab === 'dashboard') {
                renderComplianceChart(state.dacpActivities);
                renderImportanceChart(state.dacpActivities);
            } else if (state.activeTab === 'manager') {
                const availableManagers = getUniqueManagers();
                renderManagerSelect(availableManagers, state.currentManager);
                const filteredActivities = getActividadesFiltradas();
                renderManagerTable(filteredActivities);
                renderManagerStats(filteredActivities, state.currentManager);
            } else if (state.activeTab === 'checklist') {
                const contractIds = Object.keys(state.contracts);
                renderContractSelect(contractIds, state.currentContractId);
                const currentChecklist = getCurrentChecklist();
                renderChecklistTable(currentChecklist, state.currentContractId);
            }
        }
        
        // 7. EXPORTACIN DE DATOS
        // -----------------------------------------------------------------

        function jsonToCsv(arr) {
            // ... (Funci贸n jsonToCsv, mantener igual) ...
            if (arr.length === 0) return '';
            
            const headers = Object.keys(arr[0]).filter(h => h !== 'gestor'); 
            
            const cleanValue = (value) => {
                const str = String(value || '').replace(/\n/g, ' ').replace(/"/g, '""');
                return str.includes(';') || str.includes('"') || str.includes('\n') ? `"${str}"` : str;
            };

            const csv = [
                headers.map(cleanValue).join(';'), 
                ...arr.map(row => headers.map(fieldName => cleanValue(row[fieldName])).join(';'))
            ].join('\n');
            return csv;
        }

        function downloadCsv(csv, filename) {
            // ... (Funci贸n downloadCsv, mantener igual) ...
            const bom = '\ufeff'; 
            const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function exportToExcel() {
            // Funci贸n para exportar las actividades DACP completas
            const csv = jsonToCsv(state.dacpActivities);
            downloadCsv(csv, "Actividades_DACP_Completas.csv");
        }
        
        function exportChecklistToExcel() {
            const checklist = getCurrentChecklist();
            if (checklist.length === 0) {
                alert("No hay lista de chequeo para exportar. Seleccione un contrato.");
                return;
            }
            const csv = jsonToCsv(checklist);
            downloadCsv(csv, `Checklist_${state.currentContractId}.csv`);
        }
        
        function exportManagerStatsToExcel() {
            const managerActivities = getActividadesFiltradas();
            if (managerActivities.length === 0 || !state.currentManager) {
                alert("Seleccione un gestor y aseg煤rese de que tenga actividades asignadas antes de exportar.");
                return;
            }
            const csv = jsonToCsv(managerActivities);
            downloadCsv(csv, `Actividades_Gestor_${state.currentManager}.csv`);
        }


        // 8. INICIO DE LA APLICACIN
        // -----------------------------------------------------------------

        window.onload = async function() {
            // Exponer las funciones al 谩mbito global para que el HTML pueda llamarlas
            window.setActiveTab = setActiveTab;
            window.handleActivityChange = handleActivityChange;
            window.handleChecklistChange = handleChecklistChange;
            window.handleCreateNewContract = handleCreateNewContract;
            window.handleContractSelectChange = handleContractSelectChange;
            window.handleManagerSelectChange = handleManagerSelectChange; 
            window.exportToExcel = exportToExcel;
            window.exportChecklistToExcel = exportChecklistToExcel;
            window.exportManagerStatsToExcel = exportManagerStatsToExcel; 
            window.getActividadesFiltradas = getActividadesFiltradas;
            window.getCurrentChecklist = getCurrentChecklist;
            
            // 锔 Mostrar mensaje de carga
            const root = document.getElementById('root');
            const loadingMessage = document.createElement('div');
            loadingMessage.innerHTML = '<p class="text-center text-xl text-blue-600 mt-20">Cargando datos de la nube, por favor espere...</p>';
            root.appendChild(loadingMessage);

            // Esperar a cargar los datos de la nube antes de renderizar
            await fetchStateFromCloud();
            
            // Remover el mensaje de carga
            root.removeChild(loadingMessage);

            // Finalmente, renderizar la aplicaci贸n con los datos cargados
            renderApp();
        };

    </script>
</body>
</html>
