<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Auditoría DACP - Contratación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <style>
        /* Estilos base y fuentes */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* Color de fondo suave */
            margin: 0;
            padding: 0;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        /* Estilo para áreas de texto dentro de la tabla */
        .table-textarea {
            width: 100%;
            min-height: 40px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 0.875rem; /* sm */
        }
        /* Clase para pestañas activas */
        .tab-active {
            border-bottom-width: 2px;
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6; /* blue-500 */
            font-weight: 600;
        }
        /* Clase para pestañas inactivas */
        .tab-inactive {
            color: #4b5563; /* gray-600 */
            border-bottom-width: 2px;
            border-bottom-color: transparent;
        }
        .tab-inactive:hover {
            border-bottom-color: #9ca3af; /* gray-400 */
        }
        /* Estilo para el contenedor principal */
        #root {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Estilos para el select de múltiples contratos */
        .select-contract-manager {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 0.375rem;
            background-color: white;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        /* Estilos para el input de tipo archivo */
        .file-input {
            border: 1px solid #ccc;
            border-radius: 0.375rem;
            padding: 0.5rem;
            background-color: white;
            cursor: pointer;
        }
        .file-input:hover {
            background-color: #f9fafb;
        }

    </style>
</head>
<body>
    <div id="root">
        </div>

    <script>
        // =================================================================
        // ESTRUCTURA DE DATOS
        // =================================================================

        // Estructura de datos global para el estado de la aplicación
        let state = {
            actividades: [
                { id: 1, etapa: 'Planeación del Contrato', criterio: 'Se cuenta con certificado de idoneidad', responsable: 'DACP', indicador: 'No Cumple', observacionesDACP: 'Pendiente de gestión', observacionesGestion: 'Se requiere solicitar a la oficina de talento humano', fechaCumplimiento: '2025-03-01', hallazgo: 'No se cuenta con el certificado' },
                // ... (más actividades omitidas por brevedad)
            ],
            checklistContratos: {}, // Almacena checklists de contratos por ID
            contratos: [], // Lista de todos los contratos
            gerentes: ['Gerente A', 'Gerente B', 'Gerente C'], // Lista de gerentes
            currentContract: null,
            currentManager: null, // Nuevo campo para el gerente seleccionado
            currentTab: 'DACP', // Pestañas: 'DACP' (Actividades DACP), 'Checklist', 'Gerencia'
            filterEtapa: 'Todas', // Filtro de etapa para actividades DACP
            filterResponsable: 'Todos', // Filtro de responsable para actividades DACP
        };

        // =================================================================
        // PERSISTENCIA (Simulación de Nube)
        // =================================================================

        /**
         * Simula la carga del estado desde una "nube" (localStorage en este caso).
         * @returns {Promise<void>}
         */
        async function fetchStateFromCloud() {
            return new Promise(resolve => {
                setTimeout(() => { // Simular latencia de red
                    const storedState = localStorage.getItem('dacpAuditState');
                    if (storedState) {
                        state = JSON.parse(storedState);
                        // Asegurar valores por defecto si no existen
                        state.currentManager = state.currentManager || null;
                        state.currentTab = state.currentTab || 'DACP';
                        state.filterEtapa = state.filterEtapa || 'Todas';
                        state.filterResponsable = state.filterResponsable || 'Todos';
                    }
                    resolve();
                }, 500); // 500ms de retraso
            });
        }

        /**
         * Simula la sincronización del estado a la "nube" (localStorage).
         */
        function syncStateToCloud() {
            localStorage.setItem('dacpAuditState', JSON.stringify(state));
        }

        // =================================================================
        // LÓGICA DE NEGOCIO Y MANEJO DE ESTADO
        // =================================================================

        /**
         * Maneja el cambio en el select de contrato.
         * @param {string} contractId - El ID del contrato seleccionado.
         */
        function handleContractSelectChange(contractId) {
            state.currentContract = contractId === 'Todos' ? null : contractId;
            renderApp();
            syncStateToCloud();
        }
        
        /**
         * Maneja el cambio en el select de gerente.
         * @param {string} managerName - El nombre del gerente seleccionado.
         */
        function handleManagerSelectChange(managerName) {
            state.currentManager = managerName === 'Todos' ? null : managerName;
            renderApp();
            syncStateToCloud();
        }

        /**
         * Maneja el cambio de una actividad DACP (indicador, observaciones o fecha).
         * @param {number} id - ID de la actividad.
         * @param {string} field - Campo a actualizar ('indicador', 'observacionesDACP', 'observacionesGestion', 'fechaCumplimiento', 'hallazgo').
         * @param {string} value - Nuevo valor.
         */
        function handleActivityChange(id, field, value) {
            const activity = state.actividades.find(a => a.id === id);
            if (activity) {
                activity[field] = value;
                syncStateToCloud();
                renderActividadesDACP(); // Solo renderizar la sección afectada
            }
        }

        /**
         * Maneja el cambio en un aspecto de la lista de chequeo de un contrato.
         * @param {string} contractId - El ID del contrato.
         * @param {number} itemId - El ID del aspecto a verificar.
         * @param {string} field - El campo a actualizar ('SECOP II (Cumple)', 'CARPETA FISICA (No Cumple)', etc.).
         * @param {string} value - El nuevo valor.
         */
        function handleChecklistChange(contractId, itemId, field, value) {
            const checklist = state.checklistContratos[contractId];
            if (checklist) {
                const item = checklist.find(i => i.ID === itemId);
                if (item) {
                    // Limpiar el estado de cumplimiento para el campo 'Observaciones Carpeta Fisica' y 'Observaciones SECOP II'
                    if (field.startsWith('CARPETA FISICA') || field.startsWith('SECOP II')) {
                        // Limpiar todos los campos de cumplimiento relacionados con la Carpeta Física o SECOP II
                        const baseField = field.split('(')[0].trim(); // 'CARPETA FISICA' o 'SECOP II'
                        const complianceFields = [
                            `${baseField} (Cumple)`,
                            `${baseField} (No Cumple)`,
                            `${baseField} (Parcial/N/A)` // Solo para CARPETA FISICA
                        ].filter(f => item.hasOwnProperty(f));

                        complianceFields.forEach(f => {
                            if (f !== field) {
                                item[f] = '';
                            }
                        });
                    }

                    item[field] = value;
                    syncStateToCloud();
                    renderChecklist(); // Renderizar la lista de chequeo para reflejar los cambios
                }
            }
        }
        
        /**
         * Maneja el cambio de filtros en la sección de actividades DACP.
         * @param {string} filterType - El tipo de filtro ('etapa' o 'responsable').
         * @param {string} value - El valor del filtro.
         */
        function handleFilterChange(filterType, value) {
            if (filterType === 'etapa') {
                state.filterEtapa = value;
            } else if (filterType === 'responsable') {
                state.filterResponsable = value;
            }
            renderActividadesDACP(); // Solo renderizar la sección de actividades
            syncStateToCloud();
        }


        /**
         * Simula la creación de un nuevo contrato y su lista de chequeo inicial.
         * @param {string} contractId - El ID del nuevo contrato.
         */
        function handleCreateNewContract(contractId) {
            if (!state.contratos.includes(contractId) && contractId.trim() !== '') {
                state.contratos.push(contractId);
                // Inicializar una lista de chequeo vacía para el nuevo contrato
                state.checklistContratos[contractId] = [];
                state.currentContract = contractId;
                renderApp();
                syncStateToCloud();
            } else {
                alert('El ID del contrato no es válido o ya existe.');
            }
        }

        /**
         * Obtiene las actividades DACP filtradas según el estado actual.
         * @returns {Array} - Lista de actividades filtradas.
         */
        function getActividadesFiltradas() {
            return state.actividades.filter(act => {
                const byEtapa = state.filterEtapa === 'Todas' || act.etapa === state.filterEtapa;
                const byResponsable = state.filterResponsable === 'Todos' || act.responsable === state.filterResponsable;
                return byEtapa && byResponsable;
            });
        }
        
        /**
         * Obtiene la lista de chequeo del contrato actualmente seleccionado.
         * @returns {Array} - La lista de chequeo o un array vacío si no hay contrato seleccionado.
         */
        function getCurrentChecklist() {
            return state.currentContract ? state.checklistContratos[state.currentContract] || [] : [];
        }

        /**
         * Obtiene los datos consolidados de la lista de chequeo para el gerente actual.
         * @returns {Array<Object>} - Datos consolidados por etapa.
         */
        function getManagerChecklist() {
            if (!state.currentManager) {
                return [];
            }

            // 1. Filtrar los contratos que el gerente tiene a cargo (simulación: por ahora, todos)
            // Lógica de negocio: Habría que asignar contratos a gerentes. Por ahora, asumimos que el dashboard muestra todos los contratos.
            const contractsToAnalyze = state.contratos; 
            
            const managerStats = {}; // { etapa: { cumple: 0, noCumple: 0, parcial: 0, total: 0 } }

            contractsToAnalyze.forEach(contractId => {
                const checklist = state.checklistContratos[contractId];
                if (checklist) {
                    checklist.forEach(item => {
                        const etapa = item['Etapa / Criterio'];
                        if (!managerStats[etapa]) {
                            managerStats[etapa] = { cumple: 0, noCumple: 0, parcial: 0, total: 0 };
                        }

                        // Considerar el cumplimiento de CARPETA FISICA como el principal indicador
                        // Esto se debe adaptar a la lógica de negocio real.
                        const cumple = item['CARPETA FISICA (Cumple)'] === 'X' || item['SECOP II (Cumple)'] === 'X';
                        const noCumple = item['CARPETA FISICA (No Cumple)'] === 'X' || item['SECOP II (No Cumple)'] === 'X';
                        const parcial = item['CARPETA FISICA (Parcial/N/A)'] === 'X';

                        if (cumple) {
                            managerStats[etapa].cumple++;
                        } else if (noCumple) {
                            managerStats[etapa].noCumple++;
                        } else if (parcial) {
                            managerStats[etapa].parcial++;
                        }
                        
                        managerStats[etapa].total++;
                    });
                }
            });

            // Convertir el objeto de estadísticas a un array para la visualización
            return Object.keys(managerStats).map(etapa => ({
                etapa: etapa,
                ...managerStats[etapa]
            }));
        }


        // =================================================================
        // FUNCIONES DE IMPORTACIÓN DE CSV (NUEVO)
        // =================================================================

        /**
         * Parsea un archivo CSV (separado por ';') y lo convierte en un array de objetos.
         * @param {string} csvText - El contenido del archivo CSV como texto.
         * @returns {Array<Object>} - Array de objetos con las cabeceras como claves.
         */
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            // La primera línea son las cabeceras, separadas por ';' y posiblemente encerradas en comillas
            const headers = lines[0].split(';').map(h => h.trim().replace(/^"|"$/g, '').trim());
            const result = [];

            for (let i = 1; i < lines.length; i++) {
                // Usar una expresión regular para manejar los delimitadores ';' y los contenidos entre comillas.
                const values = lines[i].match(/(".*?"|[^;]+)(;|$)/g);
                
                if (!values || values.length !== headers.length) {
                    console.warn(`Saltando línea CSV ${i + 1} debido a un número incorrecto de columnas: ${lines[i]}`);
                    continue; // Saltar líneas con formato incorrecto
                }

                const item = {};
                for (let j = 0; j < headers.length; j++) {
                    let value = values[j].replace(/;$/, '').trim(); // Eliminar el separador final
                    // Eliminar comillas dobles al principio y al final del valor
                    value = value.replace(/^"|"$/g, '').trim(); 
                    
                    // Convertir ID a número
                    if (headers[j] === 'ID') {
                        item[headers[j]] = parseInt(value, 10);
                    } else {
                        item[headers[j]] = value;
                    }
                }
                result.push(item);
            }
            return result;
        }

        /**
         * Maneja la importación de un archivo CSV de lista de chequeo.
         * El nombre del archivo se usa para obtener el ID del contrato.
         * @param {Event} event - El evento de cambio del input file.
         */
        function importChecklistFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Extraer el ID del contrato del nombre del archivo: Checklist_Contrato_4125.010.26.1.003-2025.csv
            const filenameMatch = file.name.match(/Checklist_Contrato_([0-9\.\-]{1,})-2025\.csv/);
            if (!filenameMatch) {
                alert('El nombre del archivo CSV debe seguir el formato: Checklist_Contrato_X.Y.Z-2025.csv');
                return;
            }
            const contractId = filenameMatch[1];

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csvContent = e.target.result;
                    const checklistData = parseCSV(csvContent);

                    if (checklistData.length === 0) {
                        alert(`El archivo CSV para el contrato ${contractId} está vacío o no se pudo parsear.`);
                        return;
                    }

                    // 1. Agregar el contrato a la lista si no existe
                    if (!state.contratos.includes(contractId)) {
                        state.contratos.push(contractId);
                    }

                    // 2. Almacenar la lista de chequeo
                    state.checklistContratos[contractId] = checklistData;
                    
                    // 3. Establecer como contrato actual y renderizar
                    state.currentContract = contractId;
                    state.currentTab = 'Checklist'; // Ir a la pestaña de Checklist
                    syncStateToCloud();
                    renderApp();

                    alert(`Lista de chequeo para el contrato ${contractId} importada exitosamente!`);

                } catch (error) {
                    console.error('Error al importar CSV:', error);
                    alert('Error al procesar el archivo CSV.');
                }
            };

            reader.readAsText(file, 'ISO-8859-1'); // Usar codificación ISO-8859-1 para manejar caracteres especiales
        }


        // =================================================================
        // FUNCIONES DE EXPORTACIÓN A EXCEL (Simulación con CSV)
        // =================================================================

        /**
         * Convierte un array de objetos a formato CSV (separado por ';') para exportar.
         * @param {Array<Object>} data - Los datos a exportar.
         * @param {Array<string>} headers - El orden y nombre de las cabeceras.
         * @returns {string} - El contenido CSV como texto.
         */
        function convertToCSV(data, headers) {
            // Función para citar correctamente valores que contienen el delimitador o comillas
            const escapeValue = (value) => {
                if (value === null || value === undefined) return '""';
                let str = String(value);
                // Si el valor contiene comas, comillas dobles o saltos de línea, encuéntralo.
                if (str.includes(';') || str.includes('"') || str.includes('\n')) {
                    // Duplicar comillas dobles y encerrar la cadena en comillas
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };

            const headerRow = headers.map(h => escapeValue(h)).join(';');
            
            const dataRows = data.map(row => 
                headers.map(header => escapeValue(row[header])).join(';')
            );

            return [headerRow, ...dataRows].join('\n');
        }

        /**
         * Crea y dispara la descarga de un archivo CSV/Excel.
         * @param {string} csvContent - El contenido CSV a descargar.
         * @param {string} fileName - El nombre del archivo.
         */
        function downloadCSV(csvContent, fileName) {
            // BOM para asegurar que Excel reconozca UTF-8
            const BOM = '\uFEFF'; 
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");

            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        /**
         * Exporta las Actividades DACP filtradas a un archivo Excel (CSV).
         */
        function exportDACPActivitiesToExcel() {
            const actividadesFiltradas = getActividadesFiltradas();
            if (actividadesFiltradas.length === 0) {
                alert('No hay actividades para exportar con los filtros actuales.');
                return;
            }

            const headers = ['id', 'etapa', 'criterio', 'responsable', 'indicador', 'observacionesDACP', 'observacionesGestion', 'fechaCumplimiento', 'hallazgo'];
            const csvContent = convertToCSV(actividadesFiltradas, headers);
            downloadCSV(csvContent, 'Actividades_DACP_Filtradas.csv');
        }


        /**
         * Exporta la lista de chequeo del contrato actual a un archivo Excel (CSV).
         */
        function exportChecklistToExcel() {
            const checklist = getCurrentChecklist();
            if (checklist.length === 0 || !state.currentContract) {
                alert('No hay lista de chequeo para exportar. Seleccione un contrato.');
                return;
            }
            
            // Obtener todas las cabeceras del primer elemento (asumiendo que todas tienen las mismas)
            const headers = Object.keys(checklist[0]);
            const csvContent = convertToCSV(checklist, headers);
            downloadCSV(csvContent, `Checklist_Contrato_${state.currentContract}.csv`);
        }
        
        /**
         * Exporta las estadísticas de gerencia consolidadas a un archivo Excel (CSV).
         */
        function exportManagerStatsToExcel() {
            const stats = getManagerChecklist();
            if (stats.length === 0 || !state.currentManager) {
                alert('No hay estadísticas de gerencia para exportar. Seleccione un gerente.');
                return;
            }
            
            const headers = ['etapa', 'cumple', 'noCumple', 'parcial', 'total'];
            const csvContent = convertToCSV(stats, headers);
            downloadCSV(csvContent, `Estadisticas_Gerencia_${state.currentManager}.csv`);
        }

        // =================================================================
        // LÓGICA DE RENDERIZADO
        // =================================================================

        /**
         * Renderiza la tabla de actividades DACP.
         */
        function renderActividadesDACP() {
            const activities = getActividadesFiltradas();
            
            // Renderizado de filtros
            const etapasUnicas = [...new Set(state.actividades.map(a => a.etapa))];
            const responsablesUnicos = [...new Set(state.actividades.map(a => a.responsable))];
            
            const filterControls = `
                <div class="flex space-x-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Filtrar por Etapa:</label>
                        <select onchange="handleFilterChange('etapa', this.value)" class="select-contract-manager">
                            <option value="Todas" ${state.filterEtapa === 'Todas' ? 'selected' : ''}>Todas las Etapas</option>
                            ${etapasUnicas.map(e => `<option value="${e}" ${state.filterEtapa === e ? 'selected' : ''}>${e}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Filtrar por Responsable:</label>
                        <select onchange="handleFilterChange('responsable', this.value)" class="select-contract-manager">
                            <option value="Todos" ${state.filterResponsable === 'Todos' ? 'selected' : ''}>Todos los Responsables</option>
                            ${responsablesUnicos.map(r => `<option value="${r}" ${state.filterResponsable === r ? 'selected' : ''}>${r}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex items-end">
                         <button onclick="exportDACPActivitiesToExcel()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow">
                            Exportar Actividades (CSV)
                        </button>
                    </div>
                </div>
            `;

            const tableHtml = activities.length > 0 ? `
                <div class="bg-white shadow overflow-hidden sm:rounded-lg mt-4">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Etapa / Criterio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aspecto a Verificar</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Responsable</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Indicador</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Observaciones DACP</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Observaciones Gestión</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Fecha Cumplimiento</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Hallazgo</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${activities.map(act => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${act.id}</td>
                                        <td class="px-6 py-4 text-sm text-gray-500">${act.etapa}</td>
                                        <td class="px-6 py-4 text-sm text-gray-500">${act.criterio}</td>
                                        <td class="px-6 py-4 text-sm text-gray-500">${act.responsable}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <select 
                                                class="select-contract-manager text-xs" 
                                                onchange="handleActivityChange(${act.id}, 'indicador', this.value)"
                                            >
                                                <option value="Pendiente" ${act.indicador === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                                <option value="En Proceso" ${act.indicador === 'En Proceso' ? 'selected' : ''}>En Proceso</option>
                                                <option value="Cumplido" ${act.indicador === 'Cumplido' ? 'selected' : ''}>Cumplido</option>
                                                <option value="No Aplica" ${act.indicador === 'No Aplica' ? 'selected' : ''}>No Aplica</option>
                                            </select>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-500">
                                            <textarea 
                                                class="table-textarea text-xs"
                                                onchange="handleActivityChange(${act.id}, 'observacionesDACP', this.value)"
                                            >${act.observacionesDACP}</textarea>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-500">
                                            <textarea 
                                                class="table-textarea text-xs"
                                                onchange="handleActivityChange(${act.id}, 'observacionesGestion', this.value)"
                                            >${act.observacionesGestion}</textarea>
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-500">
                                            <input 
                                                type="date" 
                                                class="table-textarea text-xs"
                                                value="${act.fechaCumplimiento}" 
                                                onchange="handleActivityChange(${act.id}, 'fechaCumplimiento', this.value)"
                                            >
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-500">
                                            <textarea 
                                                class="table-textarea text-xs"
                                                onchange="handleActivityChange(${act.id}, 'hallazgo', this.value)"
                                            >${act.hallazgo}</textarea>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            ` : '<p class="text-center text-gray-500 mt-4">No hay actividades DACP que coincidan con los filtros.</p>';
            
            return `
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Actividades de Seguimiento DACP</h2>
                <p class="text-gray-600 mb-6">Registre el estado y las observaciones de las actividades de seguimiento a la auditoría.</p>
                ${filterControls}
                ${tableHtml}
            `;
        }

        /**
         * Renderiza la tabla de lista de chequeo para el contrato seleccionado.
         */
        function renderChecklist() {
            const checklist = getCurrentChecklist();
            const contractId = state.currentContract;

            if (!contractId) {
                return `
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Lista de Chequeo de Contratos</h2>
                    <p class="text-gray-600 mb-6">Seleccione un contrato para ver o ingresar su lista de chequeo.</p>
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                        <p class="font-bold">Contrato no Seleccionado</p>
                        <p>Por favor, utilice el selector de contratos en la parte superior para cargar una lista de chequeo.</p>
                    </div>
                `;
            }

            if (checklist.length === 0) {
                // Opción para importar si no hay datos
                return `
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Lista de Chequeo de Contrato: ${contractId}</h2>
                    <p class="text-gray-600 mb-6">No hay datos de lista de chequeo para este contrato.</p>
                    <div class="mt-4 p-6 bg-white shadow rounded-lg">
                        <p class="font-bold text-lg mb-4 text-red-600">Importar Checklist</p>
                        <p class="mb-4">Para importar la lista de chequeo, suba un archivo CSV con el formato correcto (separador ';') y cuyo nombre contenga el ID del contrato (ej: Checklist_Contrato_${contractId}.csv).</p>
                        <input type="file" id="checklist-csv-upload" class="file-input" accept=".csv" onchange="importChecklistFromCSV(event)">
                    </div>
                    <div class="mt-6">
                        <button onclick="exportChecklistToExcel()" class="bg-gray-400 text-white font-bold py-2 px-4 rounded shadow cursor-not-allowed" disabled>
                            Exportar Checklist (CSV)
                        </button>
                    </div>
                `;
            }

            // Encabezados dinámicos (asumiendo que son los mismos para todos los ítems)
            const headers = Object.keys(checklist[0]).filter(h => h !== 'ID');
            
            const tableHtml = `
                <div class="bg-white shadow overflow-hidden sm:rounded-lg mt-4">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">ID</th>
                                    ${headers.map(h => `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${checklist.map(item => `
                                    <tr>
                                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.ID}</td>
                                        ${headers.map(header => {
                                            const cellValue = item[header] || '';
                                            let content;
                                            // Lógica para campos de cumplimiento (checkboxes simulados con input type="text" con valor 'X')
                                            if (header.includes('(Cumple)') || header.includes('(No Cumple)') || header.includes('(Parcial/N/A)')) {
                                                content = `
                                                    <input 
                                                        type="text"
                                                        class="table-textarea text-xs text-center font-bold"
                                                        style="width: 50px; height: 30px; padding: 0.2rem;"
                                                        value="${cellValue}"
                                                        placeholder="X"
                                                        onchange="handleChecklistChange('${contractId}', ${item.ID}, '${header}', this.value.toUpperCase() === 'X' ? 'X' : '')"
                                                        maxlength="1"
                                                    />
                                                `;
                                            } 
                                            // Lógica para campos de observaciones (textarea)
                                            else if (header.startsWith('Observaciones')) {
                                                content = `
                                                    <textarea 
                                                        class="table-textarea text-xs"
                                                        rows="2"
                                                        onchange="handleChecklistChange('${contractId}', ${item.ID}, '${header}', this.value)"
                                                    >${cellValue}</textarea>
                                                `;
                                            }
                                            // Campos de solo lectura (ID, Etapa, Aspecto)
                                            else {
                                                content = `<span class="text-xs">${cellValue}</span>`;
                                            }

                                            return `<td class="px-3 py-4 text-sm text-gray-500 align-top">${content}</td>`;
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            return `
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Lista de Chequeo de Contrato: <span class="text-blue-600">${contractId}</span></h2>
                <p class="text-gray-600 mb-6">Audite el cumplimiento del contrato en los registros de SECOP II y Carpeta Física.</p>
                <div class="flex justify-between items-center mb-4">
                    <div class="mt-4 p-4 bg-white shadow rounded-lg w-1/3">
                        <p class="font-bold text-lg mb-2 text-red-600">Importar Checklist</p>
                        <p class="text-sm mb-4">Suba un archivo CSV para este contrato.</p>
                        <input type="file" id="checklist-csv-upload" class="file-input text-sm" accept=".csv" onchange="importChecklistFromCSV(event)">
                    </div>
                    <button onclick="exportChecklistToExcel()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow h-10">
                        Exportar Checklist (CSV)
                    </button>
                </div>
                ${tableHtml}
            `;
        }
        
        /**
         * Renderiza el dashboard de estadísticas de gerencia.
         */
        function renderManagerDashboard() {
            const managerStats = getManagerChecklist();
            const managerName = state.currentManager;

            if (!managerName) {
                return `
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Dashboard de Gerencia</h2>
                    <p class="text-gray-600 mb-6">Seleccione un gerente para ver el estado consolidado de sus contratos.</p>
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                        <p class="font-bold">Gerente no Seleccionado</p>
                        <p>Por favor, utilice el selector de gerentes en la parte superior para cargar sus estadísticas.</p>
                    </div>
                `;
            }

            // 1. Crear HTML de la tabla de estadísticas
            const tableHtml = managerStats.length > 0 ? `
                <div class="bg-white shadow overflow-hidden sm:rounded-lg mt-4">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Etapa / Criterio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aspectos Cumplidos</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aspectos No Cumplidos</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aspectos Parciales/N/A</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total de Aspectos</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${managerStats.map(stat => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${stat.etapa}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-bold">${stat.cumple}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-bold">${stat.noCumple}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-600 font-bold">${stat.parcial}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${stat.total}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            ` : '<p class="text-center text-gray-500 mt-4">No hay datos de lista de chequeo para analizar en este momento.</p>';


            // 2. Preparar datos para el gráfico de barras (usando Chart.js)
            let chartContainer = '<canvas id="managerBarChart" class="mt-8"></canvas>';
            
            // Si hay datos, generar el código JS para crear el gráfico
            let chartScript = '';
            if (managerStats.length > 0) {
                const labels = managerStats.map(s => s.etapa);
                const cumpleData = managerStats.map(s => s.cumple);
                const noCumpleData = managerStats.map(s => s.noCumple);
                const parcialData = managerStats.map(s => s.parcial);

                chartScript = `
                    <script>
                        // Destruir el gráfico anterior si existe
                        const oldChart = Chart.getChart('managerBarChart');
                        if (oldChart) {
                            oldChart.destroy();
                        }

                        const ctx = document.getElementById('managerBarChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ${JSON.stringify(labels)},
                                datasets: [
                                    {
                                        label: 'Cumplido',
                                        data: ${JSON.stringify(cumpleData)},
                                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                                        borderColor: 'rgba(75, 192, 192, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'No Cumple',
                                        data: ${JSON.stringify(noCumpleData)},
                                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'Parcial/N/A',
                                        data: ${JSON.stringify(parcialData)},
                                        backgroundColor: 'rgba(255, 206, 86, 0.8)',
                                        borderColor: 'rgba(255, 206, 86, 1)',
                                        borderWidth: 1
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    x: {
                                        stacked: true,
                                        title: {
                                            display: true,
                                            text: 'Etapa / Criterio'
                                        }
                                    },
                                    y: {
                                        stacked: true,
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Número de Aspectos'
                                        }
                                    }
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Cumplimiento Consolidado por Etapa'
                                    }
                                }
                            }
                        });
                    </script>
                `;
            } else {
                chartContainer = ''; // No renderizar canvas si no hay datos
            }
            
            return `
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Dashboard de Gerencia: <span class="text-blue-600">${managerName}</span></h2>
                <p class="text-gray-600 mb-6">Resumen consolidado del estado de las listas de chequeo para los contratos gestionados.</p>
                <div class="flex justify-end mb-4">
                    <button onclick="exportManagerStatsToExcel()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow">
                        Exportar Estadísticas (CSV)
                    </button>
                </div>
                
                <div class="p-6 bg-white shadow rounded-lg">
                    ${chartContainer}
                </div>
                ${tableHtml}
                ${chartScript}
            `;
        }

        /**
         * Renderiza el contenido principal de la aplicación.
         */
        function renderApp() {
            const root = document.getElementById('root');
            if (!root) return;
            
            // 1. Controles principales (Selectores y Botón)
            const controls = `
                <div class="bg-white p-6 rounded-lg shadow-xl mb-8">
                    <header class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-900">${document.title}</h1>
                        <div class="w-1/4">
                            <label for="manager-select" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Gerente:</label>
                            <select 
                                id="manager-select" 
                                class="select-contract-manager"
                                onchange="handleManagerSelectChange(this.value)"
                            >
                                <option value="Todos">-- Seleccionar Gerente --</option>
                                ${state.gerentes.map(g => `<option value="${g}" ${state.currentManager === g ? 'selected' : ''}>${g}</option>`).join('')}
                            </select>
                        </div>
                    </header>
                    
                    <div class="flex items-center space-x-4">
                        <div class="w-1/3">
                            <label for="contract-select" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Contrato:</label>
                            <select 
                                id="contract-select" 
                                class="select-contract-manager"
                                onchange="handleContractSelectChange(this.value)"
                            >
                                <option value="Todos">-- Seleccionar Contrato --</option>
                                ${state.contratos.map(c => `<option value="${c}" ${state.currentContract === c ? 'selected' : ''}>${c}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="flex items-end w-1/3 space-x-2">
                            <div class="flex-grow">
                                <label for="new-contract-id" class="block text-sm font-medium text-gray-700 mb-1">Nuevo Contrato ID:</label>
                                <input type="text" id="new-contract-id" placeholder="Ej: 4125.010.26.1.XXX-2025" class="select-contract-manager">
                            </div>
                            <button 
                                onclick="handleCreateNewContract(document.getElementById('new-contract-id').value)" 
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow h-[42px]"
                            >
                                Crear Nuevo
                            </button>
                        </div>
                        
                    </div>
                </div>
            `;
            
            // 2. Pestañas de Navegación
            const tabs = [
                { id: 'DACP', label: 'Actividades DACP', renderer: renderActividadesDACP },
                { id: 'Checklist', label: 'Lista de Chequeo', renderer: renderChecklist },
                { id: 'Gerencia', label: 'Dashboard Gerencia', renderer: renderManagerDashboard }
            ];
            
            const tabsHtml = `
                <div class="flex border-b border-gray-200 mb-6">
                    ${tabs.map(tab => `
                        <button 
                            class="px-4 py-2 text-sm font-medium ${state.currentTab === tab.id ? 'tab-active' : 'tab-inactive'}"
                            onclick="state.currentTab = '${tab.id}'; renderApp(); syncStateToCloud();"
                        >
                            ${tab.label}
                        </button>
                    `).join('')}
                </div>
            `;
            
            // 3. Contenido de la Pestaña Activa
            const currentTab = tabs.find(t => t.id === state.currentTab);
            const contentHtml = currentTab ? currentTab.renderer() : '<div>Seleccione una pestaña.</div>';

            // 4. Montar todo en el root
            root.innerHTML = controls + tabsHtml + contentHtml;

            // Si la pestaña de Gerencia está activa, re-ejecutar el script del gráfico
            if (state.currentTab === 'Gerencia') {
                const managerDashboardContent = document.getElementById('root').innerHTML;
                const chartScriptMatch = managerDashboardContent.match(/<script>([\s\S]*?)<\/script>/);
                if (chartScriptMatch) {
                    // Evaluar el script del gráfico para que se ejecute después de que el DOM esté actualizado
                    eval(chartScriptMatch[1]);
                }
            }
        }

        // =================================================================
        // INICIALIZACIÓN
        // =================================================================

        window.onload = async function() {
            // Exponer las funciones al ámbito global para que el HTML pueda llamarlas
            window.handleActivityChange = handleActivityChange;
            window.handleChecklistChange = handleChecklistChange;
            window.handleCreateNewContract = handleCreateNewContract;
            window.handleContractSelectChange = handleContractSelectChange;
            window.handleManagerSelectChange = handleManagerSelectChange; // NUEVO
            window.handleFilterChange = handleFilterChange; // NUEVO
            window.importChecklistFromCSV = importChecklistFromCSV; // 🚀 NUEVO: FUNCIÓN DE IMPORTACIÓN
            window.exportDACPActivitiesToExcel = exportDACPActivitiesToExcel; // NUEVO
            window.exportChecklistToExcel = exportChecklistToExcel;
            window.exportManagerStatsToExcel = exportManagerStatsToExcel; // NUEVO
            window.getActividadesFiltradas = getActividadesFiltradas;
            window.getCurrentChecklist = getCurrentChecklist;
            window.getManagerChecklist = getManagerChecklist; // NUEVO
            
            // ⚠️ NUEVO: Mostrar mensaje de carga
            const root = document.getElementById('root');
            const loadingMessage = document.createElement('div');
            loadingMessage.innerHTML = '<p class="text-center text-xl text-blue-600 mt-20">Cargando datos de la nube, por favor espere...</p>';
            root.appendChild(loadingMessage);

            // Esperar a cargar los datos de la nube antes de renderizar
            await fetchStateFromCloud();
            
            // Remover el mensaje de carga
            root.removeChild(loadingMessage);

            // Finalmente, renderizar la aplicación con los datos cargados
            renderApp();
        };

    </script>
</body>
</html>
