<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Auditoría DACP - Contratación</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <style>
        /* Estilos base */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
        /* Estilos para el texto y textarea de la tabla */
        .table-textarea {
            width: 100%;
            min-height: 40px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 0.875rem; /* sm */
        }
        /* Clase para pestañas activas */
        .tab-active {
            border-bottom-width: 2px;
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6; /* blue-500 */
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">

    <div id="root" class="p-4 sm:p-6 max-w-7xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6">Dashboard de Auditoría Contractual DACP</h1>
    </div>

    <script>
        // =================================================================
        // 1. DATA PRINCIPAL: MATRIZ DE ACTIVIDADES DACP (16 ÍTEMS) - CONSERVADA
        // =================================================================

        const DEFAULT_DACP_ACTIVITIES = [
            { id: 1, tipo: 'Interna', proceso: 'GESTIÓN CONTRACTUAL', actividad: 'ESTRUCTURACIÓN DEL PROCESO DE CONTRATACIÓN', frecuencia: 'TRIMESTRAL', importancia: 95, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 2, tipo: 'Interna', proceso: 'GESTIÓN CONTRACTUAL', actividad: 'VALIDACION APLICATIVO CONTRATISTA', frecuencia: 'Mensualizada', importancia: 85, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 3, tipo: 'Interna', proceso: 'GESTIÓN CONTRACTUAL', actividad: 'VALIDACION HOJA DE VIDA DE SIGEP', frecuencia: 'Mensualizada', importancia: 80, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 4, tipo: 'Interna', proceso: 'GESTIÓN CONTRACTUAL', actividad: 'VALIDACION DE DOCUMENTOS CONTRACTUALES', frecuencia: '3 DIAS A LA EJECUCIÓN DEL CONTRATO', importancia: 90, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 5, tipo: 'Interna', proceso: 'GESTIÓN CONTRACTUAL', actividad: 'AFILIACIÓN ARL', frecuencia: '5 primeros dias de cada mes (mes vencido)', importancia: 75, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 6, tipo: 'Interna', proceso: 'GESTIÓN CONTRACTUAL', actividad: 'REQUERIR Y APOYAR EN LA ELABORACION DEL PLAN DE TRABAJO', frecuencia: 'Mensualizada', importancia: 85, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 7, tipo: 'Interna', proceso: 'GESTIÓN CONTRACTUAL', actividad: 'REVISION DE INFORMES DE GESTIÓN', frecuencia: 'Mensualizada', importancia: 85, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 8, tipo: 'Interna', proceso: 'GESTIÓN CONTRACTUAL', actividad: 'SEGUIMIENTO A ACTIVIDADES DESIGNADAS', frecuencia: 'Mensualizada', importancia: 80, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 9, tipo: 'Interna', proceso: 'GESTIÓN CONTRACTUAL', actividad: 'Actividades contractuales vs actividades presentadas', frecuencia: 'Mensualizada', importancia: 90, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 10, tipo: 'Interna', proceso: 'GESTIÓN CONTRACTUAL', actividad: 'Informes mensual contratos de prestacion de servicios', frecuencia: 'Mensualizada', importancia: 85, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 11, tipo: 'Interna', proceso: 'DELEGACIONES', actividad: 'Gestión de solicitudes de delegación especial de facultades contractuales', frecuencia: 'Según necesidad', importancia: 95, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 12, tipo: 'Externa', proceso: 'GESTIÓN CONTRACTUAL', actividad: 'Publicaciones informes de supervision en el SECOP II', frecuencia: 'Mensualizada', importancia: 90, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 13, tipo: 'Externa', proceso: 'DELEGACIONES', actividad: 'Remisión de solicitud formal con documentos precontractuales', frecuencia: 'Según necesidad', importancia: 90, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 14, tipo: 'Externa', proceso: 'EVALUACIÓN DE PROVEEDORES', actividad: 'Revaluación de proveedores - Consolidación en hoja de cálculo', frecuencia: 'Semestralmente', importancia: 70, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 15, tipo: 'Externa', proceso: 'GESTIÓN DEL CONOCIMIENTO', actividad: 'Lecciones Aprendidas - Compras públicas frecuentes, riesgosas, complejas', frecuencia: 'Anualmente', importancia: 65, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
            { id: 16, tipo: 'Externa', proceso: 'COMPRAS RESPONSABLES', actividad: 'Formatos de seguimiento - Sostenibilidad Ambiental, Inclusión Social e Innovación', frecuencia: 'Febrero y julio', importancia: 70, cumplimiento: null, observaciones: '', fechaEvaluacion: '' },
        ];
        const ACTIVITY_STORAGE_KEY = 'auditActivities_DACP';


        // =================================================================
        // 2. DATA CHECKLIST: LISTA DE CHEQUEO - COMPLETA Y ORDENADA (31 ÍTEMS)
        // =================================================================

        const INITIAL_CHECKLIST_ACTIVITIES = [
            // -------------------------
            // 1. Planeación del Contrato (Ítems 1 al 9)
            // -------------------------
            { id: 1, etapa: "Planeación del Contrato", aspecto: "Se cuenta con certificado de idoneidad", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 2, etapa: "Planeación del Contrato", aspecto: "Acto de delegación para contratar", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 3, etapa: "Planeación del Contrato", aspecto: "Ficha tecnica", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 4, etapa: "Planeación del Contrato", aspecto: "La necesidad del servicio está justificada y documentada.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 5, etapa: "Planeación del Contrato", aspecto: "El contrato está incluido en el Plan Anual de Adquisiciones (PAA).", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 6, etapa: "Planeación del Contrato", aspecto: "Se cuenta con estudio previo (El perfil, los costos, requisitos minimos de formación y experiencia, tabla de honorarios acorde al valor asignado) y estudio de mercado.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 7, etapa: "Planeación del Contrato", aspecto: "El objeto contractual está claramente definido y alineado con las funciones del área.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 8, etapa: "Planeación del Contrato", aspecto: "Existen CDP y RP debidamente aprobados.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 9, etapa: "Planeación del Contrato", aspecto: "Se verificaron inhabilidades e incompatibilidades del contratista.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },

            // -------------------------
            // 2. Selección y Contratación (Ítems 10 al 13)
            // -------------------------
            { id: 10, etapa: "Selección y Contratación", aspecto: "La modalidad de contratación fue correctamente aplicada (OPS).", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 11, etapa: "Selección y Contratación", aspecto: "El proceso fue publicado en SECOP con los documentos requeridos.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 12, etapa: "Selección y Contratación", aspecto: "El contrato está firmado con todas las cláusulas exigidas.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 13, etapa: "Selección y Contratación", aspecto: "Existe acta de inicio y designación formal de supervisor.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },

            // -------------------------
            // 3. Ejecución del Contrato (Ítems 14 al 18)
            // -------------------------
            { id: 14, etapa: "Ejecución del Contrato", aspecto: "ARL", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 15, etapa: "Ejecución del Contrato", aspecto: "Documento equivalente", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 16, etapa: "Ejecución del Contrato", aspecto: "El contratista entrega informes mensuales de gestión de actividades.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 17, etapa: "Ejecución del Contrato", aspecto: "Los productos o entregables cumplen con el objeto contractual.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 18, etapa: "Ejecución del Contrato", aspecto: "Los pagos se realizan solo contra informes aprobados por el supervisor (SECOP).", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },

            // -------------------------
            // 4. Control y Supervisión (Ítems 19 al 21)
            // -------------------------
            { id: 19, etapa: "Control y Supervisión", aspecto: "El supervisor tiene designación oficial y cumple sus funciones.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 20, etapa: "Control y Supervisión", aspecto: "Existen informes de supervisión con fechas y firmas.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 21, etapa: "Control y Supervisión", aspecto: "Entrega de documentos por parte del Supervisor a la DACP.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },

            // -------------------------
            // 5. Cierre y Liquidación (Ítems 22 al 24)
            // -------------------------
            { id: 22, etapa: "Cierre y Liquidación", aspecto: "Existe acta de recibo final o informe de cumplimiento.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 23, etapa: "Cierre y Liquidación", aspecto: "Se realizó la liquidación del contrato (bilateral o unilateral).", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 24, etapa: "Cierre y Liquidación", aspecto: "El cierre y liquidación están publicados en SECOP.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },

            // -------------------------
            // 6. Calidad (ISO 9001) (Ítems 25 al 27)
            // -------------------------
            { id: 25, etapa: "Calidad (ISO 9001)", aspecto: "Se controla la documentación y registros del proceso.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 26, etapa: "Calidad (ISO 9001)", aspecto: "El personal a cargo del proceso es competente y tiene formación adecuada.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 27, etapa: "Calidad (ISO 9001)", aspecto: "Se hace seguimiento a indicadores del proceso (tiempos, cumplimiento, satisfacción).", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },

            // -------------------------
            // 7. Transparencia y Cumplimiento (Ítems 28 al 31)
            // -------------------------
            { id: 28, etapa: "Transparencia y Cumplimiento", aspecto: "Cumple con la Ley 80, Ley 1150 y Decreto 1082 de 2015.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 29, etapa: "Transparencia y Cumplimiento", aspecto: "Toda la información contractual está publicada en SECOP.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 30, etapa: "Transparencia y Cumplimiento", aspecto: "Se aplica la Ley 1712 de 2014 (Transparencia).", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' },
            { id: 31, etapa: "Transparencia y Cumplimiento", aspecto: "Contratista y supervisor declaran ausencia de conflicto de intereses.", SECOP_CUM: null, SECOP_NCUM: null, FISICA_CUM: null, FISICA_NCUM: null, FISICA_PARCIAL: null, obs_fisica: '', obs_secop: '' }
        ];

        // =================================================================
        // 3. ESTADO Y LÓGICA DE ALMACENAMIENTO (Se mantienen sin cambios)
        // =================================================================
        const getActivitiesStorageKey = (contractId) => `contract_${contractId}_checklist`;
        const ALL_CONTRACT_DATA_KEY = 'all_contract_data';

        function loadActivities(contractId) {
            if (!contractId) return INITIAL_CHECKLIST_ACTIVITIES;
            const storedActivities = localStorage.getItem(getActivitiesStorageKey(contractId));
            if (storedActivities) {
                try {
                    const parsedData = JSON.parse(storedActivities);
                    const updatedData = INITIAL_CHECKLIST_ACTIVITIES.map(defaultItem => {
                        const savedItem = parsedData.find(item => item.id === defaultItem.id);
                        return savedItem ? { ...defaultItem, ...savedItem } : defaultItem;
                    });
                    return updatedData;
                } catch (e) {
                    console.error(`Error al parsear datos de checklist para ${contractId}:`, e);
                    return INITIAL_CHECKLIST_ACTIVITIES;
                }
            }
            return INITIAL_CHECKLIST_ACTIVITIES;
        }

        function saveActivities(contractId, activities) {
            if (contractId && activities) {
                localStorage.setItem(getActivitiesStorageKey(contractId), JSON.stringify(activities));
                if (!state.allContracts.includes(contractId)) {
                    state.allContracts.push(contractId);
                    saveContractList();
                }
            }
        }

        function loadAllContractData() {
            const storedData = localStorage.getItem(ALL_CONTRACT_DATA_KEY);
            try {
                return storedData ? JSON.parse(storedData) : {};
            } catch (e) {
                console.error("Error al cargar la base de datos de consolidación:", e);
                return {};
            }
        }

        function saveAllContractData(data) {
            localStorage.setItem(ALL_CONTRACT_DATA_KEY, JSON.stringify(data));
        }

        function loadData(key, defaultData) {
            const savedData = localStorage.getItem(key);
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    const updatedData = defaultData.map(defaultItem => {
                        const savedItem = parsedData.find(item => item.id === defaultItem.id);
                        return savedItem ? { ...defaultItem, ...savedItem } : defaultItem;
                    });
                    return updatedData;
                } catch (e) {
                    return defaultData;
                }
            }
            return defaultData;
        }

        function loadContractList() {
            const contractIds = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('contract_') && key.endsWith('_checklist')) {
                    const id = key.replace('contract_', '').replace('_checklist', '');
                    if (!contractIds.includes(id)) {
                        contractIds.push(id);
                    }
                }
            }
            const allConsolidatedData = loadAllContractData();
            Object.keys(allConsolidatedData).forEach(id => {
                 if (!contractIds.includes(id)) contractIds.push(id);
            });
            return contractIds.sort();
        }

        function saveContractList() { /* No se usa directamente ya que se deriva de las keys */ }


        // ESTADO INICIAL
        let state = {
            activeTab: 'dashboard',
            dacpActivities: loadData(ACTIVITY_STORAGE_KEY, DEFAULT_DACP_ACTIVITIES),
            filtroTipo: 'Todos',
            filtroCumplimiento: 'Todos',
            contractChecklist: [],
            allContracts: [],
            currentContractId: null,
            consolidatedData: loadAllContractData(),
            consolidatedContractId: null
        };

        function loadChecklistInitialState() {
            state.allContracts = loadContractList();
            let contractId = localStorage.getItem('current_contract_id');

            if (contractId && (state.allContracts.includes(contractId))) {
                 state.currentContractId = contractId;
                 state.contractChecklist = loadActivities(contractId);
                 if (state.contractChecklist.every(item => item.SECOP_CUM === null)) {
                    state.contractChecklist = state.consolidatedData[contractId] || INITIAL_CHECKLIST_ACTIVITIES;
                 }
            } else if (state.allContracts.length > 0) {
                state.currentContractId = state.allContracts[0];
                state.contractChecklist = loadActivities(state.currentContractId);
                 if (state.contractChecklist.every(item => item.SECOP_CUM === null)) {
                    state.contractChecklist = state.consolidatedData[state.currentContractId] || INITIAL_CHECKLIST_ACTIVITIES;
                 }
            } else {
                state.currentContractId = null;
                state.contractChecklist = INITIAL_CHECKLIST_ACTIVITIES;
            }

            if (state.allContracts.length > 0) {
                state.consolidatedContractId = state.allContracts[0];
            }
        }
        loadChecklistInitialState();


        function setState(newState) {
            const newDacpActivities = newState.dacpActivities ? JSON.parse(JSON.stringify(newState.dacpActivities)) : state.dacpActivities;

            const newChecklistState = {
                contractChecklist: newState.contractChecklist || state.contractChecklist,
                allContracts: newState.allContracts || state.allContracts,
                currentContractId: newState.currentContractId === undefined ? state.currentContractId : newState.currentContractId,
                activeTab: newState.activeTab || state.activeTab,
                filtroTipo: newState.filtroTipo || state.filtroTipo,
                filtroCumplimiento: newState.filtroCumplimiento || state.filtroCumplimiento,
                consolidatedData: newState.consolidatedData || state.consolidatedData,
                consolidatedContractId: newState.consolidatedContractId === undefined ? state.consolidatedContractId : newState.consolidatedContractId
            };

            state = { ...state, dacpActivities: newDacpActivities, ...newChecklistState };

            if (newState.dacpActivities) {
                localStorage.setItem(ACTIVITY_STORAGE_KEY, JSON.stringify(state.dacpActivities));
            }
            if (newState.currentContractId !== undefined) {
                if (state.currentContractId) {
                    localStorage.setItem('current_contract_id', state.currentContractId);
                } else {
                    localStorage.removeItem('current_contract_id');
                }
            }
            if (newState.consolidatedData) {
                saveAllContractData(state.consolidatedData);
            }

            renderApp();
        }


        // =================================================================
        // 4. LÓGICA DE NEGOCIO Y UTILIDADES (DACP Y CHECKLIST)
        // =================================================================

        /**
         * LÓGICA DACP ACTIVITIES (MATRIZ DE EVALUACIÓN) (Se mantienen sin cambios)
         */

        // Función para actualizar items de la Matriz DACP
        function actualizarItem(id, campo, valor) {
            const activityId = parseInt(id);
            const newActivities = state.dacpActivities.map(item => {
                if (item.id === activityId) {
                    let updatedItem = { ...item };
                    if (campo === 'cumplimiento') {
                        updatedItem.cumplimiento = valor; // 'CUMPLE', 'NO_CUMPLE', 'PENDIENTE'
                        updatedItem.fechaEvaluacion = valor !== 'PENDIENTE' ? new Date().toLocaleDateString('es-CO') : '';
                    } else if (campo === 'observaciones') {
                        updatedItem.observaciones = valor;
                    }
                    return updatedItem;
                }
                return item;
            });

            setState({ dacpActivities: newActivities });
        }

        window.actualizarItem = actualizarItem;

        // Función para filtrar actividades DACP
        function getActividadesFiltradas() {
            return state.dacpActivities.filter(item => {
                const matchesTipo = state.filtroTipo === 'Todos' || item.tipo === state.filtroTipo;
                // Si el filtro es PENDIENTE, muestra los que no tienen cumplimiento
                const cumpleStatus = item.cumplimiento || 'PENDIENTE';
                const matchesCumplimiento = state.filtroCumplimiento === 'Todos' || cumpleStatus === state.filtroCumplimiento;
                return matchesTipo && matchesCumplimiento;
            });
        }

        // Función para exportar la Matriz DACP a CSV
        function exportToExcel(activities) {
            const headers = ["ID", "Tipo", "Proceso", "Actividad", "Frecuencia", "Importancia", "Cumplimiento", "Observaciones", "Fecha Evaluacion"];
            const data = activities.map(item => [
                item.id,
                `"${item.tipo}"`,
                `"${item.proceso}"`,
                `"${item.actividad.replace(/"/g, '""')}"`,
                `"${item.frecuencia}"`,
                item.importancia,
                item.cumplimiento || 'PENDIENTE',
                `"${(item.observaciones || '').replace(/"/g, '""').replace(/\n/g, ' | ')}"`,
                item.fechaEvaluacion || ''
            ]);

            let csvContent = headers.join(";") + "\n" + data.map(row => row.join(";")).join("\n");

            const blob = new Blob(["\uFEFF", csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `Evaluacion_DACP_${new Date().toLocaleDateString('es-CO')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        window.exportToExcel = exportToExcel;

        // Función para calcular estadísticas DACP
        function calcularEstadisticas(activities) {
            const total = activities.length;
            let cumple = 0;
            let noCumple = 0;
            let pendiente = 0;

            activities.forEach(item => {
                if (item.cumplimiento === 'CUMPLE') {
                    cumple++;
                } else if (item.cumplimiento === 'NO_CUMPLE') {
                    noCumple++;
                } else {
                    pendiente++;
                }
            });

            const pctCumple = total > 0 ? (cumple / total) * 100 : 0;
            const pctNoCumple = total > 0 ? (noCumple / total) * 100 : 0;
            const pctPendiente = total > 0 ? (pendiente / total) * 100 : 0;

            return {
                total,
                evaluadas: cumple + noCumple,
                pendiente,
                cumple,
                noCumple,
                pctCumple: pctCumple.toFixed(2),
                pctNoCumple: pctNoCumple.toFixed(2),
                pctPendiente: pctPendiente.toFixed(2)
            };
        }


        /**
         * LÓGICA CHECKLIST
         */

        // Función para actualizar items del Checklist de Contratos (Auditor y Consolidador)
        function actualizarChecklistItem(id, campo, valor) {
            const activityId = parseInt(id);
            const contractId = state.activeTab === 'lista_de_chequeo' ? state.currentContractId : state.consolidatedContractId;
            const targetData = state.activeTab === 'lista_de_chequeo' ? state.contractChecklist : state.consolidatedData[contractId];

            if (!targetData) return;

            const newChecklist = targetData.map(item => {
                if (item.id === activityId) {
                    let updatedItem = { ...item };

                    if (campo.startsWith('SECOP_') && valor !== null) {
                        updatedItem.SECOP_CUM = null;
                        updatedItem.SECOP_NCUM = null;
                        updatedItem[campo] = valor;
                    } else if (campo.startsWith('FISICA_') && valor !== null) {
                        updatedItem.FISICA_CUM = null;
                        updatedItem.FISICA_NCUM = null;
                        updatedItem.FISICA_PARCIAL = null;
                        updatedItem[campo] = valor;
                    } else if (valor === null) {
                         // Manejo de la deselección (toggle)
                         if (campo.startsWith('SECOP_')) {
                             updatedItem.SECOP_CUM = null;
                             updatedItem.SECOP_NCUM = null;
                         } else if (campo.startsWith('FISICA_')) {
                             updatedItem.FISICA_CUM = null;
                             updatedItem.FISICA_NCUM = null;
                             updatedItem.FISICA_PARCIAL = null;
                         }
                    } else {
                        updatedItem[campo] = valor;
                    }

                    return updatedItem;
                }
                return item;
            });

            if (state.activeTab === 'lista_de_chequeo') {
                saveActivities(state.currentContractId, newChecklist);
                setState({ contractChecklist: newChecklist });
            } else if (state.activeTab === 'consolidacion') {
                const newConsolidatedData = { ...state.consolidatedData, [contractId]: newChecklist };
                setState({ consolidatedData: newConsolidatedData });
            }
        }

        window.actualizarChecklistItem = actualizarChecklistItem;
        
        // =================================================================
        // FIX: FUNCIÓN PARA GESTIONAR EL CLICK EN EL RADIO BUTTON (SOPORTA TOGGLE) (Se mantiene sin cambios)
        // =================================================================
        window.handleChecklistRadioClick = function(id, campo, value) {
            const isConsolidatedView = state.activeTab === 'consolidacion';
            const contractId = isConsolidatedView ? state.consolidatedContractId : state.currentContractId;
            const targetData = isConsolidatedView ? state.consolidatedData[contractId] : state.contractChecklist;

            const currentItem = targetData?.find(item => item.id === id);
            if (!currentItem) return;

            // Si el valor en el estado actual es igual al valor que se está intentando establecer (ya está marcado),
            // el nuevo valor debe ser null (para desmarcar). Si no, establece el nuevo valor.
            const isAlreadyChecked = currentItem[campo] === value;
            const newValue = isAlreadyChecked ? null : value;

            // Llama a la función de actualización principal con el nuevo valor (que puede ser null para desmarcar)
            actualizarChecklistItem(id, campo, newValue);
        };
        // =================================================================

        // Exportación a CSV para el CHECKLIST (AUDITOR) (Se mantienen sin cambios)
        function exportChecklistToExcel(contractId, checklist) {
            const headers = ["ID_ITEM", "ID_CONTRATO", "Etapa", "Aspecto", "SECOP_CUM", "SECOP_NCUM", "FISICA_CUM", "FISICA_NCUM", "FISICA_PARCIAL", "OBS_FISICA", "OBS_SECOP"];
            const data = checklist.map(item => [
                item.id,
                contractId,
                `"${item.etapa.replace(/"/g, '""')}"`,
                `"${item.aspecto.replace(/"/g, '""')}"`,
                item.SECOP_CUM ? 'X' : '',
                item.SECOP_NCUM ? 'X' : '',
                item.FISICA_CUM ? 'X' : '',
                item.FISICA_NCUM ? 'X' : '',
                item.FISICA_PARCIAL ? 'X' : '',
                `"${(item.obs_fisica || '').replace(/"/g, '""').replace(/\n/g, ' | ')}"`,
                `"${(item.obs_secop || '').replace(/"/g, '""').replace(/\n/g, ' | ')}"`
            ]);

            let csvContent = headers.join(";") + "\n" + data.map(row => row.join(";")).join("\n");

            const blob = new Blob(["\uFEFF", csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `Checklist_Contrato_${contractId}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Función para calcular estadísticas del Checklist (Se mantienen sin cambios)
        function calculateChecklistStats(checklist) {
            const total = checklist.length;
            let cumplidasSECOP = 0;
            let noCumplidasSECOP = 0;
            let cumplidasFISICA = 0;
            let noCumplidasFISICA = 0;
            let parcialesFISICA = 0;
            let porEtapa = {};

            checklist.forEach(item => {
                // SECOP Stats
                if (item.SECOP_CUM === 'CUM') cumplidasSECOP++;
                if (item.SECOP_NCUM === 'NCUM') noCumplidasSECOP++;

                // FISICA Stats
                if (item.FISICA_CUM === 'CUM') cumplidasFISICA++;
                if (item.FISICA_NCUM === 'NCUM') noCumplidasFISICA++;
                if (item.FISICA_PARCIAL) parcialesFISICA++;

                // Stats por Etapa
                if (!porEtapa[item.etapa]) {
                    porEtapa[item.etapa] = { total: 0, cumplidas: 0, noCumplidas: 0 };
                }
                porEtapa[item.etapa].total++;

                // Lógica de cumplimiento general para la etapa: si al menos una es NCUM, se marca como no cumplida.
                if (item.SECOP_NCUM === 'NCUM' || item.FISICA_NCUM === 'NCUM') {
                    porEtapa[item.etapa].noCumplidas++;
                } else if (item.SECOP_CUM === 'CUM' && item.FISICA_CUM === 'CUM') {
                    porEtapa[item.etapa].cumplidas++;
                }
            });

            return {
                total,
                cumplidasSECOP,
                noCumplidasSECOP,
                cumplidasFISICA,
                noCumplidasFISICA,
                parcialesFISICA,
                porEtapa
            };
        }

        // =================================================================
        // 5. LÓGICA DE IMPORTACIÓN Y CONSOLIDACIÓN (Se mantienen sin cambios)
        // =================================================================

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return [];

            const headers = lines[0].split(';').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const row = [];
                let currentField = '';
                let inQuotes = false;

                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];

                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ';' && !inQuotes) {
                        row.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                row.push(currentField.trim());

                if (row.length === headers.length) {
                    const item = {};
                    headers.forEach((header, index) => {
                        item[header] = row[index].replace(/^"|"$/g, '').trim();
                    });
                    data.push(item);
                }
            }
            return data;
        }

        function importChecklistCSV(file) {
            const reader = new FileReader();

            reader.onload = (e) => {
                const csvText = e.target.result;
                const parsedData = parseCSV(csvText);

                if (parsedData.length === 0) {
                    alert('Error: No se pudo leer el archivo CSV o está vacío.');
                    return;
                }

                const contractId = parsedData[0].ID_CONTRATO;
                if (!contractId) {
                    alert('Error: El archivo CSV no contiene la columna "ID_CONTRATO".');
                    return;
                }

                const newChecklist = INITIAL_CHECKLIST_ACTIVITIES.map(templateItem => {
                    const importedItem = parsedData.find(d => parseInt(d.ID_ITEM) === templateItem.id);

                    if (importedItem) {
                        return {
                            id: templateItem.id,
                            etapa: templateItem.etapa,
                            aspecto: templateItem.aspecto,
                            SECOP_CUM: importedItem.SECOP_CUM === 'X' ? 'CUM' : null,
                            SECOP_NCUM: importedItem.SECOP_NCUM === 'X' ? 'NCUM' : null,
                            FISICA_CUM: importedItem.FISICA_CUM === 'X' ? 'CUM' : null,
                            FISICA_NCUM: importedItem.FISICA_NCUM === 'X' ? 'NCUM' : null,
                            FISICA_PARCIAL: importedItem.FISICA_PARCIAL === 'X' ? 'PARCIAL' : null,
                            obs_fisica: importedItem.OBS_FISICA.replace(/ \| /g, '\n'),
                            obs_secop: importedItem.OBS_SECOP.replace(/ \| /g, '\n'),
                        };
                    }
                    return templateItem;
                });

                const newConsolidatedData = { ...state.consolidatedData, [contractId]: newChecklist };
                let newAllContracts = state.allContracts;
                if (!state.allContracts.includes(contractId)) {
                     newAllContracts = [...state.allContracts, contractId].sort();
                }

                alert(`¡Archivo de Contrato ${contractId} importado y consolidado exitosamente!`);

                setState({
                    consolidatedData: newConsolidatedData,
                    allContracts: newAllContracts,
                    consolidatedContractId: contractId
                });
            };

            reader.onerror = () => {
                alert('Error al leer el archivo.');
            };

            reader.readAsText(file, 'utf-8');
        }


        // =================================================================
        // 6. FUNCIONES DE RENDERIZADO (DACP y Dashboard) (Se mantienen sin cambios)
        // =================================================================

        // Variables globales para las instancias de Chart.js
        let dacpChartInstance = null;
        let checklistChartInstance = null;
        let radarChartInstance = null;

        function renderDashboardCharts(dacpStats, checklistStats) {
            // Destruir instancias anteriores
            if (dacpChartInstance) dacpChartInstance.destroy();
            if (checklistChartInstance) checklistChartInstance.destroy();
            if (radarChartInstance) radarChartInstance.destroy();

            // 1. Gráfico de Cumplimiento DACP (Barra)
            const dacpCtx = document.getElementById('dacpCumplimientoChart');
            if (dacpCtx) {
                dacpChartInstance = new Chart(dacpCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Cumple', 'No Cumple', 'Pendiente'],
                        datasets: [{
                            label: 'Evaluación DACP (%)',
                            data: [dacpStats.pctCumple, dacpStats.pctNoCumple, dacpStats.pctPendiente],
                            backgroundColor: ['rgba(52, 211, 163, 0.8)', 'rgba(248, 113, 113, 0.8)', 'rgba(251, 191, 36, 0.8)'],
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
                });
            }

            // 2. Gráfico de Cumplimiento Checklist (Donut)
            const checklistCtx = document.getElementById('checklistCumplimientoChart');
            if (checklistCtx) {
                const totalItems = checklistStats.total;
                const pctSECOP_CUM = totalItems > 0 ? (checklistStats.cumplidasSECOP / totalItems) * 100 : 0;
                const pctSECOP_NCUM = totalItems > 0 ? (checklistStats.noCumplidasSECOP / totalItems) * 100 : 0;
                const pctPendiente = 100 - pctSECOP_CUM - pctSECOP_NCUM;

                checklistChartInstance = new Chart(checklistCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Cumple (SECOP)', 'No Cumple (SECOP)', 'Pendiente'],
                        datasets: [{
                            label: 'Checklist Contratación (%)',
                            data: [pctSECOP_CUM.toFixed(2), pctSECOP_NCUM.toFixed(2), pctPendiente.toFixed(2)],
                            backgroundColor: ['rgba(52, 211, 163, 0.8)', 'rgba(248, 113, 113, 0.8)', 'rgba(209, 213, 219, 0.8)'],
                            hoverOffset: 4
                        }]
                    },
                    options: { responsive: true }
                });
            }
        }

        function renderRadarChart(activities) {
            const radarCtx = document.getElementById('radarChart');
            if (!radarCtx) return;

            if (radarChartInstance) radarChartInstance.destroy();

            const processMap = activities.reduce((acc, item) => {
                const key = item.proceso;
                if (!acc[key]) acc[key] = { total: 0, cumple: 0 };
                acc[key].total++;
                if (item.cumplimiento === 'CUMPLE') acc[key].cumple++;
                return acc;
            }, {});

            const labels = Object.keys(processMap);
            const dataPoints = labels.map(key => {
                const { total, cumple } = processMap[key];
                return total > 0 ? (cumple / total) * 100 : 0;
            });

            radarChartInstance = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% Cumplimiento por Proceso',
                        data: dataPoints,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: { suggestedMin: 0, suggestedMax: 100, ticks: { beginAtZero: true, stepSize: 25 } }
                    },
                    plugins: { legend: { display: true } }
                }
            });
        }


        function renderDashboard() {
            const dacpStats = calcularEstadisticas(state.dacpActivities);
            const checklistStats = calculateChecklistStats(state.contractChecklist);

            let dacpCards = `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg shadow">
                        <p class="text-sm font-medium text-blue-700">Total Actividades DACP</p>
                        <p class="text-2xl font-bold text-blue-900">${dacpStats.total}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg shadow">
                        <p class="text-sm font-medium text-green-700">DACP: Cumplidas</p>
                        <p class="text-2xl font-bold text-green-900">${dacpStats.cumple} (${dacpStats.pctCumple}%)</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg shadow">
                        <p class="text-sm font-medium text-red-700">DACP: No Cumplidas</p>
                        <p class="text-2xl font-bold text-red-900">${dacpStats.noCumple} (${dacpStats.pctNoCumple}%)</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg shadow">
                        <p class="text-sm font-medium text-yellow-700">DACP: Pendientes</p>
                        <p class="text-2xl font-bold text-yellow-900">${dacpStats.pendiente} (${dacpStats.pctPendiente}%)</p>
                    </div>
                </div>
            `;

            let checklistCards = `
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                    <div class="bg-gray-100 p-4 rounded-lg shadow">
                        <p class="text-sm font-medium text-gray-700">Total Ítems Checklist</p>
                        <p class="text-2xl font-bold text-gray-900">${checklistStats.total}</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg shadow">
                        <p class="text-sm font-medium text-blue-700">Cumplimiento SECOP</p>
                        <p class="text-2xl font-bold text-blue-900">${checklistStats.cumplidasSECOP} de ${checklistStats.total}</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg shadow">
                        <p class="text-sm font-medium text-yellow-700">Ítems Carpeta Física Parcial/N.A.</p>
                        <p class="text-2xl font-bold text-yellow-900">${checklistStats.parcialesFISICA}</p>
                    </div>
                </div>
            `;

            let chartsSection = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Cumplimiento por Proceso (DACP)</h2>
                        <div class="h-80"><canvas id="radarChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Evaluación DACP (General)</h2>
                        <div class="h-80"><canvas id="dacpCumplimientoChart"></canvas></div>
                    </div>
                     <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Cumplimiento Checklist (SECOP)</h2>
                        <div class="h-80"><canvas id="checklistCumplimientoChart"></canvas></div>
                    </div>
                </div>
            `;

            return `
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Métricas de la Evaluación DACP</h2>
                ${dacpCards}
                <h2 class="text-2xl font-bold text-gray-700 mb-4 mt-8">Métricas de la Lista de Chequeo (Contrato Actual: ${state.currentContractId || 'N/A'})</h2>
                ${checklistCards}
                ${chartsSection}
            `;
        }

        function renderDACPActivities() {
            const actividades = getActividadesFiltradas();
            const stats = calcularEstadisticas(state.dacpActivities);

            let html = `
                <div class="flex space-x-4 mb-6 p-4 bg-white shadow rounded-lg">
                    <div class="w-1/3">
                        <label for="filtroTipo" class="block text-sm font-medium text-gray-700">Filtrar por Tipo</label>
                        <select id="filtroTipo" onchange="setState({ filtroTipo: this.value })" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="Todos" ${state.filtroTipo === 'Todos' ? 'selected' : ''}>Todos</option>
                            <option value="Interna" ${state.filtroTipo === 'Interna' ? 'selected' : ''}>Interna</option>
                            <option value="Externa" ${state.filtroTipo === 'Externa' ? 'selected' : ''}>Externa</option>
                        </select>
                    </div>
                    <div class="w-1/3">
                        <label for="filtroCumplimiento" class="block text-sm font-medium text-gray-700">Filtrar por Cumplimiento</label>
                        <select id="filtroCumplimiento" onchange="setState({ filtroCumplimiento: this.value })" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="Todos" ${state.filtroCumplimiento === 'Todos' ? 'selected' : ''}>Todos</option>
                            <option value="CUMPLE" ${state.filtroCumplimiento === 'CUMPLE' ? 'selected' : ''}>CUMPLIDAS</option>
                            <option value="NO_CUMPLE" ${state.filtroCumplimiento === 'NO_CUMPLE' ? 'selected' : ''}>NO CUMPLIDAS</option>
                            <option value="PENDIENTE" ${state.filtroCumplimiento === 'PENDIENTE' ? 'selected' : ''}>PENDIENTES</option>
                        </select>
                    </div>
                     <button onclick="exportToExcel(state.dacpActivities)" class="px-4 py-2 self-end bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 transition duration-150">
                                Exportar a Excel ⬇️
                    </button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg shadow">
                        <p class="text-sm font-medium text-blue-700">Total de Actividades</p>
                        <p class="text-2xl font-bold text-blue-900">${stats.total}</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg shadow">
                        <p class="text-sm font-medium text-green-700">Cumplidas</p>
                        <p class="text-2xl font-bold text-green-900">${stats.cumple} (${stats.pctCumple}%)</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg shadow">
                        <p class="text-sm font-medium text-red-700">No Cumplidas</p>
                        <p class="text-2xl font-bold text-red-900">${stats.noCumple} (${stats.pctNoCumple}%)</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg shadow">
                        <p class="text-sm font-medium text-yellow-700">Pendientes</p>
                        <p class="text-2xl font-bold text-yellow-900">${stats.pendiente} (${stats.pctPendiente}%)</p>
                    </div>
                </div>

                <div class="overflow-x-auto shadow-md sm:rounded-lg">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">ID</th>
                                <th scope="col" class="px-6 py-3">Tipo</th>
                                <th scope="col" class="px-6 py-3 min-w-[300px]">Actividad DACP</th>
                                <th scope="col" class="px-6 py-3">Importancia</th>
                                <th scope="col" class="px-6 py-3 text-center">Cumple</th>
                                <th scope="col" class="px-6 py-3 text-center">No Cumple</th>
                                <th scope="col" class="px-6 py-3 text-center">Pendiente</th>
                                <th scope="col" class="px-6 py-3 min-w-[250px]">Observaciones</th>
                                <th scope="col" class="px-6 py-3">Fecha Ev.</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${actividades.map(item => `
                                <tr class="bg-white border-b hover:bg-gray-50">
                                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${item.id}</td>
                                    <td class="px-6 py-4">${item.tipo}</td>
                                    <td class="px-6 py-4">${item.actividad}</td>
                                    <td class="px-6 py-4 text-center">${item.importancia}</td>
                                    <td class="px-6 py-4 text-center">
                                        <input type="radio" name="cumplimiento_${item.id}" value="CUMPLE" ${item.cumplimiento === 'CUMPLE' ? 'checked' : ''} data-id="${item.id}" onclick="actualizarItem(${item.id}, 'cumplimiento', this.value)" class="w-4 h-4 text-green-600">
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <input type="radio" name="cumplimiento_${item.id}" value="NO_CUMPLE" ${item.cumplimiento === 'NO_CUMPLE' ? 'checked' : ''} data-id="${item.id}" onclick="actualizarItem(${item.id}, 'cumplimiento', this.value)" class="w-4 h-4 text-red-600">
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <input type="radio" name="cumplimiento_${item.id}" value="PENDIENTE" ${!item.cumplimiento || item.cumplimiento === 'PENDIENTE' ? 'checked' : ''} data-id="${item.id}" onclick="actualizarItem(${item.id}, 'cumplimiento', this.value)" class="w-4 h-4 text-gray-400">
                                    </td>
                                    <td class="px-6 py-4">
                                        <textarea onblur="actualizarItem(${item.id}, 'observaciones', this.value)" class="table-textarea" placeholder="Observaciones">${item.observaciones || ''}</textarea>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">${item.fechaEvaluacion || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            return html;
        }


        // Función de renderizado para la tabla de Checklist (CORRECCIÓN APLICADA AQUÍ)
        function renderChecklistTable(activities, isConsolidatedView = false) {
             if (!activities || activities.length === 0) return '<p class="text-center py-4 text-gray-500">No hay ítems en la lista de chequeo para este contrato.</p>';

            let html = `
                <div class="overflow-x-auto shadow-md sm:rounded-lg mb-6">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-2 py-3 text-center" rowspan="2">N°</th>
                                <th scope="col" class="px-4 py-3 min-w-[300px]" rowspan="2">Aspecto a Verificar</th>
                                <th scope="col" class="px-4 py-3 text-center bg-blue-100" colspan="2">SECOP II</th>
                                <th scope="col" class="px-4 py-3 text-center bg-yellow-100" colspan="3">CARPETA FÍSICA</th>
                                <th scope="col" class="px-4 py-3 min-w-[200px]" rowspan="2">OBSERVACIONES CARPETA FÍSICA</th>
                                <th scope="col" class="px-4 py-3 min-w-[200px]" rowspan="2">OBSERVACIONES SECOP II</th>
                            </tr>
                            <tr>
                                <th scope="col" class="py-2 text-center bg-blue-100">CUMPLE</th>
                                <th scope="col" class="py-2 text-center bg-blue-100">NO CUMPLE</th>
                                <th scope="col" class="py-2 text-center bg-yellow-100">CUMPLE</th>
                                <th scope="col" class="py-2 text-center bg-yellow-100">NO CUMPLE</th>
                                <th scope="col" class="py-2 text-center bg-yellow-100">PARCIAL/N.A.</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            let currentEtapa = '';

            activities.forEach(item => {
                if (item.etapa !== currentEtapa) {
                    html += `
                        <tr class="bg-gray-200 border-b">
                            <td colspan="9" class="px-4 py-3 font-extrabold text-blue-700">${item.etapa.toUpperCase()}</td>
                        </tr>
                    `;
                    currentEtapa = item.etapa;
                }

                // CORRECCIÓN: Se eliminó `return false;` de todos los onclick para resolver el problema de deselección inmediata.
                html += `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-2 py-2 text-center">${item.id}</td>
                        <td class="px-4 py-2 font-medium text-gray-900">${item.aspecto}</td>

                        <td class="text-center px-2 py-2">
                            <input type="radio" name="secop_status_${item.id}" data-id="${item.id}" data-campo="SECOP_CUM" ${item.SECOP_CUM ? 'checked' : ''} class="w-4 h-4 text-green-600 border-gray-300 input-checklist-radio" 
                                onclick="handleChecklistRadioClick(${item.id}, 'SECOP_CUM', 'CUM');">
                        </td>
                        <td class="text-center px-2 py-2">
                            <input type="radio" name="secop_status_${item.id}" data-id="${item.id}" data-campo="SECOP_NCUM" ${item.SECOP_NCUM ? 'checked' : ''} class="w-4 h-4 text-red-600 border-gray-300 input-checklist-radio" 
                                onclick="handleChecklistRadioClick(${item.id}, 'SECOP_NCUM', 'NCUM');">
                        </td>

                        <td class="text-center px-2 py-2">
                            <input type="radio" name="fisica_status_${item.id}" data-id="${item.id}" data-campo="FISICA_CUM" ${item.FISICA_CUM ? 'checked' : ''} class="w-4 h-4 text-green-600 border-gray-300 input-checklist-radio" 
                                onclick="handleChecklistRadioClick(${item.id}, 'FISICA_CUM', 'CUM');">
                        </td>
                        <td class="text-center px-2 py-2">
                            <input type="radio" name="fisica_status_${item.id}" data-id="${item.id}" data-campo="FISICA_NCUM" ${item.FISICA_NCUM ? 'checked' : ''} class="w-4 h-4 text-red-600 border-gray-300 input-checklist-radio" 
                                onclick="handleChecklistRadioClick(${item.id}, 'FISICA_NCUM', 'NCUM');">
                        </td>
                         <td class="text-center px-2 py-2">
                            <input type="radio" name="fisica_status_${item.id}" data-id="${item.id}" data-campo="FISICA_PARCIAL" ${item.FISICA_PARCIAL ? 'checked' : ''} class="w-4 h-4 text-yellow-600 border-gray-300 input-checklist-radio" 
                                onclick="handleChecklistRadioClick(${item.id}, 'FISICA_PARCIAL', 'PARCIAL');">
                        </td>

                        <td class="px-4 py-2">
                            <textarea data-id="${item.id}" data-campo="obs_fisica" class="table-textarea input-checklist-observacion" placeholder="Obs. Carpeta Física" onblur="actualizarChecklistItem(${item.id}, 'obs_fisica', this.value)">${item.obs_fisica || ''}</textarea>
                        </td>
                         <td class="px-4 py-2">
                            <textarea data-id="${item.id}" data-campo="obs_secop" class="table-textarea input-checklist-observacion" placeholder="Obs. SECOP II" onblur="actualizarChecklistItem(${item.id}, 'obs_secop', this.value)">${item.obs_secop || ''}</textarea>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
            return html;
        }

        // El resto de las funciones (renderMultiContractChecklist, renderConsolidationView, renderTabContent, renderTabs, renderApp, Listeners) se mantienen sin cambios.
        // ... (Omitidas por brevedad, pero deben estar en el código final)

        function renderMultiContractChecklist() {
            let optionsHtml = state.allContracts.filter(id => loadActivities(id).some(item => item.SECOP_CUM !== null)).map(id =>
                `<option value="${id}" ${id === state.currentContractId ? 'selected' : ''}>Contrato ${id}</option>`
            ).join('');

            if (state.currentContractId && !optionsHtml.includes(`value="${state.currentContractId}"`)) {
                 optionsHtml = `<option value="${state.currentContractId}" selected>Contrato ${state.currentContractId}</option>` + optionsHtml;
            }


            let html = `
                <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-white shadow rounded-lg">
                    <label for="contract-select" class="font-semibold text-gray-700">Contrato Actual (Auditoría Local):</label>
                    <select id="contract-select" class="p-2 border border-gray-300 rounded-md shadow-sm bg-white min-w-[150px]">
                        ${optionsHtml || '<option value="">-- Sin Contratos Locales --</option>'}
                    </select>

                    <input type="text" id="new-contract-id" placeholder="Nuevo ID (Ej: 001)" class="p-2 border border-gray-300 rounded-md shadow-sm w-32" />
                    <button id="add-contract-btn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 transition duration-150">
                        Añadir Contrato
                    </button>
                    ${state.currentContractId ? `<button id="export-checklist-btn" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 transition duration-150">
                        Exportar a CSV 📥
                    </button>` : ''}
                </div>
            `;

            if (!state.currentContractId) {
                html += '<p class="text-center text-gray-500 mt-10 p-10 bg-white rounded-lg shadow-md">Por favor, añada un contrato (o seleccione uno) para empezar la auditoría local.</p>';
            } else {
                html += renderChecklistTable(state.contractChecklist, false);
            }
            return html;
        }

        function renderConsolidationView() {
            const consolidatedIds = Object.keys(state.consolidatedData).sort();
            let optionsHtml = consolidatedIds.map(id =>
                `<option value="${id}" ${id === state.consolidatedContractId ? 'selected' : ''}>Contrato ${id}</option>`
            ).join('');

            let currentChecklist = state.consolidatedData[state.consolidatedContractId] || INITIAL_CHECKLIST_ACTIVITIES;

            let html = `
                <div class="bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 p-4 mb-6" role="alert">
                    <p class="font-bold">Vista del Consolidador</p>
                    <p>Utilice esta pestaña para **importar** los archivos CSV de cada auditor y revisar/complementar la información.</p>
                </div>

                <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-white shadow rounded-lg">
                    <label for="import-csv-file" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-md hover:bg-purple-600 transition duration-150 cursor-pointer">
                        Importar Archivo(s) CSV 📤
                    </label>
                    <input type="file" id="import-csv-file" accept=".csv" multiple class="hidden" />

                    <label for="consolidated-contract-select" class="font-semibold text-gray-700 ml-8">Contrato Consolidado:</label>
                    <select id="consolidated-contract-select" class="p-2 border border-gray-300 rounded-md shadow-sm bg-white min-w-[150px]">
                        ${optionsHtml || '<option value="">-- Importe Contratos --</option>'}
                    </select>

                </div>
            `;

            if (consolidatedIds.length === 0) {
                 html += '<p class="text-center text-gray-500 mt-10 p-10 bg-white rounded-lg shadow-md">No hay datos consolidados. Por favor, importe un archivo CSV.</p>';
            } else {
                // La vista de consolidación también usa la lógica de toggle/uncheck
                html += renderChecklistTable(currentChecklist, true);
            }

            return html;
        }


        function renderTabContent(activeTab) {
            switch (activeTab) {
                case 'dashboard':
                    return renderDashboard();
                case 'evaluacion':
                    return renderDACPActivities();
                case 'lista_de_chequeo':
                    return renderMultiContractChecklist();
                case 'consolidacion':
                    return renderConsolidationView();
                default:
                    return '';
            }
        }

        function renderTabs(activeTab) {
            const tabs = [
                { id: 'dashboard', name: 'Dashboard' },
                { id: 'evaluacion', name: 'Evaluación DACP' },
                { id: 'lista_de_chequeo', name: 'Lista de Chequeo Auditor' },
                { id: 'consolidacion', name: 'Consolidación de Datos' }
            ];

            return `
                <div class="text-sm font-medium text-center text-gray-500 border-b border-gray-200 mb-6">
                    <ul class="flex flex-wrap -mb-px">
                        ${tabs.map(tab => `
                            <li class="me-2">
                                <a href="#" id="tab-${tab.id}" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 ${activeTab === tab.id ? 'tab-active' : ''}">${tab.name}</a>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        function renderApp() {
            const root = document.getElementById('root');

            let appContent = renderTabs(state.activeTab);
            appContent += renderTabContent(state.activeTab);

            root.innerHTML = `<h1 class="text-3xl font-extrabold text-gray-800 mb-6">Dashboard de Auditoría Contractual DACP</h1>${appContent}`;

            setTimeout(() => {
                const dacpStats = calcularEstadisticas(state.dacpActivities);
                const checklistStats = calculateChecklistStats(state.contractChecklist);

                if (state.activeTab === 'dashboard') {
                    renderDashboardCharts(dacpStats, checklistStats);
                    renderRadarChart(state.dacpActivities);
                }

                // === LISTENERS GENERALES ===
                document.getElementById('tab-dashboard')?.addEventListener('click', () => { setState({ activeTab: 'dashboard' }); });
                document.getElementById('tab-evaluacion')?.addEventListener('click', () => { setState({ activeTab: 'evaluacion' }); });
                document.getElementById('tab-lista_de_chequeo')?.addEventListener('click', () => { setState({ activeTab: 'lista_de_chequeo' }); });
                document.getElementById('tab-consolidacion')?.addEventListener('click', () => { setState({ activeTab: 'consolidacion' }); });

                // === LISTENERS ESPECÍFICOS POR TAB ===
                if (state.activeTab === 'evaluacion') {
                    attachActivityListeners();
                } else if (state.activeTab === 'lista_de_chequeo') {
                    attachContractListeners();
                } else if (state.activeTab === 'consolidacion') {
                    attachConsolidationListeners();
                }

            }, 50);
        }

        // =================================================================
        // 7. LISTENERS
        // =================================================================

        function attachActivityListeners() {
            // No se necesitan listeners explícitos aquí ya que se usan onclick/onblur inline.
        }

        function attachContractListeners() {
             // Listener para selección de contrato
            document.getElementById('contract-select')?.addEventListener('change', (e) => {
                const newId = e.target.value;
                setState({ currentContractId: newId, contractChecklist: loadActivities(newId) });
            });

            // Listener para añadir nuevo contrato
            document.getElementById('add-contract-btn')?.addEventListener('click', () => {
                const newIdInput = document.getElementById('new-contract-id');
                const newId = newIdInput.value.trim();

                if (!newId) {
                    alert('Por favor, ingrese un número de contrato válido.');
                    return;
                }

                if (state.allContracts.includes(newId)) {
                    alert(`El contrato ${newId} ya existe. Por favor, selecciónelo de la lista o ingrese otro ID.`);
                    return;
                }

                const newAllContracts = [...state.allContracts, newId].sort();
                const newChecklist = INITIAL_CHECKLIST_ACTIVITIES;
                saveActivities(newId, newChecklist);

                newIdInput.value = '';
                setState({
                    allContracts: newAllContracts,
                    currentContractId: newId,
                    contractChecklist: newChecklist
                });
            });

            // Listener para Exportar Checklist
            document.getElementById('export-checklist-btn')?.addEventListener('click', () => {
                if (state.currentContractId && state.contractChecklist.length > 0) {
                    exportChecklistToExcel(state.currentContractId, state.contractChecklist);
                } else {
                    alert('Por favor, seleccione un contrato con datos para exportar.');
                }
            });
        }

        function attachConsolidationListeners() {
            // Listener para el selector de contratos consolidados
            document.getElementById('consolidated-contract-select')?.addEventListener('change', (e) => {
                setState({ consolidatedContractId: e.target.value });
            });

            // Listener para el botón de importar CSV
            document.getElementById('import-csv-file')?.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                files.forEach(file => {
                    importChecklistCSV(file);
                });

                e.target.value = null;
            });
        }

        // =================================================================
        // 8. INICIO DE LA APLICACIÓN
        // =================================================================

        window.onload = function() {
            renderApp();
        };
    </script>
</body>
</html>
